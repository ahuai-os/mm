ã€€ã€€<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¸æ·®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éšè—æ¡Œé¢æ»‘åŠ¨æ¡ï¼ˆåŠ å¼ºç‰ˆï¼‰ */
.no-scrollbar::-webkit-scrollbar { 
    display: none; 
}
.no-scrollbar { 
    -ms-overflow-style: none; 
    scrollbar-width: none; 
}

/* ç¡®ä¿ä¸»é¡µæ»‘åŠ¨å®¹å™¨åœ¨æ‰‹æœºç«¯è¶³å¤Ÿæµç•… */
#home-slider { 
    -webkit-overflow-scrolling: touch; 
}
        /* === åŸºç¡€ç³»ç»Ÿæ ·å¼ === */
        body { background: #f7f7f7; margin: 0; padding: 0; width: 100vw; height: 100vh; height: 100dvh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .phone { width: 100%; height: 100%; background: #f7f7f7; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; }
        .page { position: absolute; inset: 0; background: #f7f7f7; display: none; flex-direction: column; z-index: 10; }
        .active { display: flex !important; }
        #pg-home { background: url('https://img.heliar.top/file/1770365294783_IMG_20260206_160700.jpg') center top / cover no-repeat; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); padding-bottom: max(env(safe-area-inset-bottom), 15px); height: auto; min-height: 60px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); padding-bottom: max(env(safe-area-inset-bottom), 20px); }

        /* === èŠå¤©æ°”æ³¡æ ·å¼ === */
        .bubble { width: fit-content; max-width: 100%; word-wrap: break-word; white-space: pre-wrap; }
        .bubble-user { background: #95ec69; color: #000; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.6; position: relative; margin-right: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: left; }
        .bubble-user::after { content: ''; position: absolute; right: -5px; top: 12px; border-left: 5px solid #95ec69; border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
        .bubble-ai { background: #fff; color: #000; border: 1px solid #ededed; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.6; position: relative; margin-left: 6px; text-align: left; }
        .bubble-ai::after { content: ''; position: absolute; left: -5px; top: 12px; border-right: 5px solid #fff; border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
                /* === å¼ºåˆ¶æ¨ªå±æ–‡æ¸¸æ ·å¼ === */
        .vn-landscape {
            width: 100vh !important;
            height: 100vw !important;
            transform-origin: top left;
            transform: rotate(90deg) translateY(-100%);
            position: absolute;
            top: 0; left: 0;
            overflow: hidden;
        }
        /* === çº¿ä¸‹å‰§æƒ…ä¸å…¨å±€åŠ¨ç”» === */
        .story-text-container { background: rgba(255, 255, 255, 0.98); color: #1f1f1f; padding: 20px 24px; border-radius: 6px; font-family: "Songti SC", "SimSun", "STSong", "Times New Roman", serif !important; font-size: 18px; line-height: 1.9; text-align: justify; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .story-p { text-indent: 2em; margin-bottom: 1em; display: block; font-family: inherit; }
        .moment-cover { height: 320px; background-position: center; background-size: cover; position: relative; margin-bottom: 30px; }
        .drawer { transition: height 0.3s ease; height: 0; background: #f7f7f7; overflow: hidden; border-top: 1px solid #e5e5e5; }
        .drawer-open { height: 280px; } 
        .role-chip { transition: all 0.2s; border: 1px solid #ddd; background: white; color: #666; }
        .role-chip.selected { background: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 2px 4px rgba(59,130,246,0.3); }
        .dot-ani { display: flex; gap: 4px; padding: 4px 0; }
        .dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: dot-pulse 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .indent-8 { text-indent: 2em; }
        img { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }

        /* === å¤–å–ä¸å•†åŸæ ·å¼ === */
        .food-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.03); transition: transform 0.1s; }
        .food-card:active { transform: scale(0.98); }
        .food-img-box { width: 100%; aspect-ratio: 1/1; background: #f0f0f0; position: relative; flex-shrink: 0; }
        .food-img-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .cart-badge-ani { animation: pop-scale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-scale { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.3); } 100% { transform: scale(1); opacity: 1; } }
        .food-modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: flex; align-items: flex-end; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .food-modal-mask.active { opacity: 1; pointer-events: auto; }
        .food-modal-body { background: white; width: 100%; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); overflow: hidden; max-height: 85vh; display: flex; flex-direction: column; }
        .food-modal-mask.active .food-modal-body { transform: translateY(0); }
        /* === éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ === */
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin-slow { animation: spin-slow 15s linear infinite; }
        .spin-paused { animation-play-state: paused; }
        /* è‡ªå®šä¹‰è¿›åº¦æ¡ */
        input[type=range].music-range { -webkit-appearance: none; width: 100%; background: transparent; height: 4px; border-radius: 2px; }
        input[type=range].music-range::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer; margin-top: -4px; }
        input[type=range].music-range::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.3); border-radius: 2px; }
        /* === èŠå¤©å¡ç‰‡æ ·å¼ === */
        .msg-card { background: white; border-radius: 12px; padding: 12px; width: 240px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; overflow: hidden; border: 1px solid #eee; }
        .card-header-pay { background: #FFD101; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-header-pay-shop { background: #ff6700; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-header-share { background: #ff6b6b; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #333; display: flex; align-items: center; gap: 6px; }
        .card-content { display: flex; gap: 8px; align-items: center; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 10px; }
        .card-img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; background: #eee; }
        .card-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .card-price { font-size: 16px; font-weight: bold; color: #e64340; }
        .card-desc { font-size: 12px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
        .status-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: auto; }
        .st-pending { color: #f6a623; background: #fff7e6; }
        .st-paid { color: #52c41a; background: #f6ffed; }
        .st-rejected { color: #ff4d4f; background: #fff1f0; }
        .card-btn { width: 100%; text-align: center; font-size: 13px; padding: 6px 0; border-top: 1px solid #eee; color: #576b95; font-weight: 500; cursor: pointer; }
        .card-btn:active { background: #f5f5f5; }

        /* === å……å€¼é¡µé¢å…‰æ ‡åŠ¨ç”» === */
        @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .animate-pulse { animation: cursor-blink 1s step-end infinite; }
    </style>
</head>
<body>
<div class="phone">
<div id="pg-home" class="page active overflow-hidden">
    <div id="home-slider" class="flex w-full h-full overflow-x-auto snap-x snap-mandatory no-scrollbar scroll-smooth">
        
        <div class="w-full h-full shrink-0 snap-start relative p-8">
            <div class="mt-8 flex justify-between items-start select-none">
                <div class="bg-black/20 backdrop-blur-2xl w-40 h-40 rounded-[40px] flex flex-col items-center justify-center text-white border border-white/10 shadow-2xl">
                    <span class="text-sm opacity-90 font-light mb-1">åœ¨ä¸€èµ· â¤ï¸</span>
                    <span id="together-days" class="text-6xl font-bold my-1 tracking-tighter">0</span>
                    <span class="text-xs opacity-60 mt-2">å¤©å·²è¿‡å»</span>
                </div>
                <div class="text-right text-white" style="text-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                    <div id="home-time" class="text-[90px] font-extralight leading-[0.85] tracking-tighter">00<br>00</div>
                    <div id="home-date" class="mt-8 text-2xl font-medium opacity-95 text-right">2/23 å‘¨ä¸€</div>
                </div>
            </div>

            <div class="absolute bottom-28 left-0 w-full grid grid-cols-4 gap-y-8 px-6 justify-items-center">
                <div onclick="go('pg-wechat')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-[#07c160] rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸ’¬</div>
                    <span class="text-[10px] text-white opacity-90">å¾®ä¿¡</span>
                </div>
                <div onclick="toTakeoutTab('home'); go('pg-takeout-home')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-[#FFD101] rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸ¥¡</div>
                    <span class="text-[10px] text-white opacity-90">å¤–å–</span>
                </div>
                <div onclick="toShopTab('home'); go('pg-shop-home')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-[#ff6700] rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸ›ï¸</div>
                    <span class="text-[10px] text-white opacity-90">å•†åŸ</span>
                </div>
                <div onclick="go('pg-wb')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-blue-500 rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸ“–</div>
                    <span class="text-[10px] text-white opacity-90">ä¸–ç•Œä¹¦</span>
                </div>
                <div onclick="go('pg-memory')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-yellow-500 rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸ§ </div>
                    <span class="text-[10px] text-white opacity-90">è®°å¿†</span>
                </div>
                <div onclick="toBankTab('home'); go('pg-bank')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-red-600 rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸ’³</div>
                    <span class="text-[10px] text-white opacity-90">é“¶è¡Œ</span>
                </div>
                <div onclick="toMusicTab('player'); go('pg-music-player')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-pink-500 rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸµ</div>
                    <span class="text-[10px] text-white opacity-90">éŸ³ä¹</span>
                </div>
                <div onclick="go('pg-vn-hub')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-indigo-500 rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">ğŸ®</div>
                    <span class="text-[10px] text-white opacity-90">äº’åŠ¨æ–‡æ¸¸</span>
                </div>
            </div>
        </div> <div class="w-full h-full shrink-0 snap-start relative p-8">
            <div class="absolute top-28 left-0 w-full grid grid-cols-4 gap-y-8 px-6 justify-items-center">
                <div onclick="toGachaTab('summon'); go('pg-gacha')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-gradient-to-br from-pink-400 to-purple-500 rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform relative overflow-hidden">
                        <span class="relative z-10">âœ¨</span>
                        <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                    </div>
                    <span class="text-[10px] text-white opacity-90">å¿ƒåŠ¨ç¾ç»Š</span>
                </div>
                <div onclick="go('pg-set')" class="flex flex-col items-center gap-1">
                    <div class="w-14 h-14 bg-zinc-700 rounded-2xl flex items-center justify-center text-3xl shadow-lg active:scale-90 transition-transform">âš™ï¸</div>
                    <span class="text-[10px] text-white opacity-90">è®¾ç½®</span>
                </div>
            </div>
        </div>
    </div> <div class="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-2 z-20">
        <div id="dot-1" class="w-1.5 h-1.5 rounded-full bg-white transition-all duration-300"></div>
        <div id="dot-2" class="w-1.5 h-1.5 rounded-full bg-white/30 transition-all duration-300"></div>
    </div>
</div>

    <div id="pg-wechat" class="page">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0 z-20 relative">
            <span onclick="go('pg-home')" class="text-zinc-600 text-sm pb-1 cursor-pointer">é€€å‡º</span>
            <b id="we-title" class="pb-1 text-lg">å¾®ä¿¡</b>
            <div class="relative">
                <span onclick="handlePlusBtn(event)" class="text-2xl pb-1 cursor-pointer inline-block w-8 text-right">ï¼‹</span>
                
                                <div id="plus-dropdown" class="hidden absolute top-10 right-[-5px] bg-[#4c4c4c] text-white rounded-lg shadow-lg z-50 w-36 py-1">
                    <div class="absolute -top-1.5 right-3 w-0 h-0 border-l-[6px] border-r-[6px] border-b-[8px] border-l-transparent border-r-transparent border-b-[#4c4c4c]"></div>
                    <div onclick="openSingleChatSelector()" class="px-4 py-3 border-b border-[#5c5c5c] flex items-center gap-3 active:bg-[#5a5a5a] cursor-pointer">
                        <span class="text-lg">ğŸ’¬</span><span class="text-sm tracking-wide">å‘èµ·èŠå¤©</span>
                    </div>
                    <div onclick="openGroupChatSelector()" class="px-4 py-3 flex items-center gap-3 active:bg-[#5a5a5a] cursor-pointer">
                        <span class="text-lg">ğŸ‘¥</span><span class="text-sm tracking-wide">å‘èµ·ç¾¤èŠ</span>
                    </div>
                </div>
            </div>
        </header>
        <div class="flex-1 overflow-y-auto no-scrollbar relative" onclick="closeAllMenus()">
            <div id="sub-chat" class="bg-white divide-y"></div>
            <div id="sub-cont" class="hidden bg-white divide-y"></div>
            <div id="sub-moments" class="hidden bg-white h-full overflow-y-auto no-scrollbar">
                <div id="moment-bg" class="moment-cover" onclick="triggerRolePost(true)">
                    <div class="absolute -bottom-4 right-4 flex items-end gap-3">
                        <b class="text-white text-lg u-name shadow-sm font-bold mb-3 drop-shadow-md" style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></b>
                        <img class="w-20 h-20 rounded-xl u-ava border-2 border-white bg-zinc-100 shadow-md">
                    </div>
                </div>
                <div id="mnts-list" class="mt-16 p-0 pb-32"></div>
            </div>
            <div id="sub-me" class="hidden bg-zinc-100 h-full">
                <div onclick="go('pg-prof')" class="bg-white p-6 mt-4 flex items-center gap-4 active:bg-zinc-50 cursor-pointer">
                    <img class="w-16 h-16 rounded-lg u-ava bg-zinc-200">
                    <div class="flex flex-col"><b class="text-xl u-name"></b><span class="text-sm text-zinc-400">å¾®ä¿¡å·: AI_OS_User</span></div>
                </div>
                <div class="mt-4 bg-white divide-y">
                    <div onclick="go('pg-wallet')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><div class="flex items-center gap-3"><span class="text-green-600 text-xl font-bold">ğŸ’°</span><span>æ”¯ä»˜/é’±åŒ…</span></div><span class="text-zinc-300">ã€‰</span></div>
                </div>
                <div class="mt-4 bg-white divide-y">
                    <div onclick="go('pg-emj')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span>è¡¨æƒ…åŒ…ç®¡ç†</span><span class="text-zinc-300">ã€‰</span></div>
                </div>
                <div class="mt-8 p-4">
                    <button onclick="cleanBadData()" class="w-full py-3 bg-yellow-50 text-yellow-600 rounded-lg text-sm border border-yellow-200 font-bold mb-3">ğŸ› ï¸ æ·±åº¦æ¸…ç†åæ•°æ®</button>
                    <button onclick="hardReset()" class="w-full py-3 bg-red-50 text-red-500 rounded-lg text-sm border border-red-100">âš ï¸ æ ¼å¼åŒ–é‡ç½®</button>
                </div>
            </div>
        </div>
        <footer class="bg-[#f7f7f7] border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 shadow-lg">
            <div onclick="tab('chat')" id="t-chat" class="text-center flex-1 py-1">ğŸ’¬<br>å¾®ä¿¡</div>
            <div onclick="tab('cont')" id="t-cont" class="text-center flex-1 py-1">ğŸ‘¥<br>é€šè®¯å½•</div>
            <div onclick="tab('moments')" id="t-moments" class="text-center flex-1 py-1">ğŸ§­<br>æœ‹å‹åœˆ</div>
            <div onclick="tab('me')" id="t-me" class="text-center flex-1 py-1">ğŸ‘¤<br>æˆ‘</div>
        </footer>
    </div>
    <div id="pg-takeout-home" class="page bg-[#f5f5f5] z-[40]">
        <header class="bg-[#FFD101] p-3 pb-2 pt-12 rounded-b-xl shadow-sm sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div onclick="go('pg-home')" class="bg-white/20 p-1 rounded-full text-zinc-800 font-bold px-2 text-xs">âœ• é€€å‡º</div>
                <div class="flex-1 bg-white h-9 rounded-full flex items-center px-3 gap-2 relative">
                    <span class="text-zinc-400">ğŸ”</span>
                    <input id="takeout-search" oninput="handleSearchInput()" class="bg-transparent outline-none text-sm w-full" placeholder="æœç´¢ç‚¸é¸¡ã€å¥¶èŒ¶...">
                    <div id="btn-clear-search" onclick="clearSearch()" class="hidden w-5 h-5 bg-zinc-200 rounded-full flex items-center justify-center text-zinc-500 text-[10px] cursor-pointer">âœ•</div>
                </div>
            </div>
        </header>
        <div id="takeout-list" class="p-3 pb-24 grid grid-cols-2 gap-2 overflow-y-auto h-full"></div>
        <div id="food-detail-modal" class="food-modal-mask" onclick="if(event.target===this) closeFoodDetail()"><div class="food-modal-body"></div></div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div>
            <div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5 relative">ğŸ›’<span id="cart-badge" class="absolute -top-1 right-8 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span></div>è´­ç‰©è½¦</div>
            <div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-takeout-cart" class="page bg-[#f5f5f5] z-[40]">
        <header class="bg-white p-4 pt-12 border-b flex justify-between items-center sticky top-0 z-20"><b class="text-lg">è´­ç‰©è½¦</b><span onclick="clearCart()" class="text-sm text-zinc-500">æ¸…ç©º</span></header>
        <div class="bg-red-50 text-red-500 text-xs px-4 py-2 flex justify-between items-center"><span>ğŸ”¥ æ»¡20å‡3ï¼Œæ»¡50å‡8</span><span class="text-red-400">å»å‡‘å• ></span></div>
        <div id="cart-list" class="p-4 pb-32 space-y-3 overflow-y-auto h-full"></div>
        <div class="absolute bottom-14 w-full bg-white border-t p-3 flex justify-between items-center z-30 pb-safe">
            <div class="flex items-baseline gap-1"><span class="text-xs text-zinc-500">åˆè®¡:</span><span class="text-red-500 font-bold text-lg">Â¥<span id="cart-total">0.00</span></span></div>
            <button onclick="doCheckout()" class="bg-[#FFD101] text-black px-8 py-2.5 rounded-full font-bold shadow-md active:scale-95 transition-transform">å»ç»“ç®—</button>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div><div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-takeout-me" class="page bg-[#f5f5f5] z-[40]">
        <div class="bg-[#FFD101] pt-14 pb-10 px-6 flex items-center gap-4 rounded-b-[30px]"><img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white"><div><b class="u-name text-xl block text-[#1f1f1f]"></b><span class="text-xs bg-black/10 px-2 py-0.5 rounded text-[#1f1f1f]">é»„é‡‘ä¼šå‘˜ ğŸ’</span></div></div>
        <div class="mx-4 -mt-6 bg-white rounded-xl shadow-sm p-4 grid grid-cols-3 gap-4 text-center relative z-10">
            <div onclick="go('pg-takeout-orders')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-xl">ğŸ“„</div><span class="text-xs font-bold text-zinc-700">å…¨éƒ¨è®¢å•</span></div>
            <div onclick="go('pg-takeout-pending')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center text-xl">ğŸ›µ</div><span class="text-xs font-bold text-zinc-700">å¾…æ”¶è´§</span><div id="badge-pending" class="absolute top-3 left-[45%] bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</div></div>
            <div onclick="go('pg-takeout-add')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-xl">â•</div><span class="text-xs font-bold text-zinc-700">æ·»åŠ å•†å“</span></div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div><div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-takeout-orders" class="page bg-[#f5f5f5] z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">æˆ‘çš„è®¢å•</b></header><div id="order-history-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div></div>
    <div id="pg-takeout-pending" class="page bg-[#f5f5f5] z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">å¾…æ”¶è´§</b></header><div id="order-pending-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div></div>
    <div id="pg-takeout-add" class="page bg-white z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">ä¸Šæ¶æ–°å¤–å–</b><button onclick="saveNewFood()" class="ml-auto text-[#FFD101] font-bold text-sm bg-black px-3 py-1 rounded-full">ä¸Šæ¶</button></header><div class="p-6 space-y-5"><div><label class="block text-xs font-bold text-zinc-500 mb-1">åº—é“ºåç§°</label><input id="tf-store" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: éº¦å½“åŠ³"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">å•†å“åç§°</label><input id="tf-name" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: åŒå±‚å‰å£«æ±‰å ¡"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">ä»·æ ¼ (Â¥)</label><input id="tf-price" type="number" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="25.5"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">å›¾ç‰‡é“¾æ¥</label><input id="tf-img" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="http://..."></div></div></div>

    <div id="pg-shop-home" class="page bg-[#f2f2f2] z-[40]">
        <header class="bg-[#ff6700] p-3 pb-2 pt-12 rounded-b-xl shadow-sm sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div onclick="go('pg-home')" class="bg-white/20 p-1 rounded-full text-white font-bold px-2 text-xs">âœ• é€€å‡º</div>
                <div class="flex-1 bg-white h-9 rounded-full flex items-center px-3 gap-2 relative">
                    <span class="text-zinc-400">ğŸ”</span>
                    <input id="shop-search" oninput="handleShopSearch()" class="bg-transparent outline-none text-sm w-full" placeholder="æœå¥½ç‰©...">
                    <div id="btn-shop-clear" onclick="clearShopSearch()" class="hidden w-5 h-5 bg-zinc-200 rounded-full flex items-center justify-center text-zinc-500 text-[10px] cursor-pointer">âœ•</div>
                </div>
            </div>
        </header>
        <div id="shop-list" class="p-3 pb-24 grid grid-cols-2 gap-2 overflow-y-auto h-full"></div>
        <div id="shop-detail-modal" class="food-modal-mask" onclick="if(event.target===this) closeShopDetail()"><div class="food-modal-body"></div></div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div>
            <div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5 relative">ğŸ›’<span id="shop-cart-badge" class="absolute -top-1 right-8 bg-[#ff6700] text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span></div>è´­ç‰©è½¦</div>
            <div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-shop-cart" class="page bg-[#f2f2f2] z-[40]">
        <header class="bg-white p-4 pt-12 border-b flex justify-between items-center sticky top-0 z-20"><b class="text-lg">è´­ç‰©è½¦</b><span onclick="clearShopCart()" class="text-sm text-zinc-500">æ¸…ç©º</span></header>
        <div id="shop-cart-list" class="p-4 pb-32 space-y-3 overflow-y-auto h-full"></div>
        <div class="absolute bottom-14 w-full bg-white border-t p-3 flex justify-between items-center z-30 pb-safe">
            <div class="flex items-baseline gap-1"><span class="text-xs text-zinc-500">åˆè®¡:</span><span class="text-[#ff6700] font-bold text-lg">Â¥<span id="shop-cart-total">0.00</span></span></div>
            <button onclick="doShopCheckout()" class="bg-gradient-to-r from-[#ff9000] to-[#ff5000] text-white px-8 py-2.5 rounded-full font-bold shadow-md active:scale-95 transition-transform">ç«‹å³è´­ä¹°</button>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div><div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-shop-me" class="page bg-[#f2f2f2] z-[40]">
        <div class="bg-gradient-to-r from-[#ff9000] to-[#ff5000] pt-14 pb-10 px-6 flex items-center gap-4 rounded-b-[30px]"><img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white"><div><b class="u-name text-xl block text-white"></b><span class="text-xs bg-white/20 px-2 py-0.5 rounded text-white">æ·˜æ°”å€¼ 1000</span></div></div>
        <div class="mx-4 -mt-6 bg-white rounded-xl shadow-sm p-4 grid grid-cols-4 gap-2 text-center relative z-10">
            <div onclick="go('pg-shop-favs')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">â­</div><span class="text-xs font-bold text-zinc-700">æ”¶è—å¤¹</span></div>
            <div onclick="openShopOrders('pending')" class="flex flex-col items-center gap-2 active:opacity-50 relative"><div class="text-xl">ğŸ“¦</div><span class="text-xs font-bold text-zinc-700">å¾…æ”¶è´§</span><div id="badge-shop-pending" class="absolute top-0 right-4 bg-[#ff6700] text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</div></div>
            <div onclick="openShopOrders('history')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">ğŸ“œ</div><span class="text-xs font-bold text-zinc-700">å·²ä¹°åˆ°</span></div>
            <div onclick="go('pg-shop-add')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">â•</div><span class="text-xs font-bold text-zinc-700">æ·»åŠ </span></div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div><div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-shop-orders" class="page bg-[#f2f2f2] z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base" id="shop-order-title">æˆ‘çš„è®¢å•</b></header>
        <div id="shop-order-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div>
    </div>
    <div id="pg-shop-favs" class="page bg-[#f2f2f2] z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">æˆ‘çš„æ”¶è—</b></header>
        <div id="shop-fav-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div>
    </div>
    <div id="pg-shop-add" class="page bg-white z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">å‘å¸ƒæ–°å•†å“</b><button onclick="saveNewGoods()" class="ml-auto text-white font-bold text-sm bg-[#ff6700] px-3 py-1 rounded-full">å‘å¸ƒ</button></header>
        <div class="p-6 space-y-5">
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">åº—é“ºåç§°</label><input id="sf-store" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: ä¼˜è¡£åº“æ——èˆ°åº—"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å•†å“åç§°</label><input id="sf-name" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: çº¯æ£‰Tæ¤"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">ä»·æ ¼ (Â¥)</label><input id="sf-price" type="number" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="99.00"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å›¾ç‰‡é“¾æ¥</label><input id="sf-img" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="http://..."></div>
        </div>
    </div>

    <div id="pg-bank" class="page bg-[#f5f5f5] z-[40]">
        <div id="bank-tab-home" class="flex-1 flex flex-col h-full overflow-y-auto no-scrollbar">
            <header class="bg-gradient-to-b from-[#e60012] to-[#f03b42] p-4 pt-12 pb-8 flex flex-col shrink-0 text-white rounded-b-3xl">
                <div class="flex justify-between items-center mb-4">
                    <span onclick="go('pg-home')" class="text-white text-xs bg-black/20 px-3 py-1.5 rounded-full cursor-pointer">âœ• é€€å‡º</span>
                    <span class="font-bold text-lg tracking-wider">ä¸€å¡é€š</span>
                    <span class="text-xl">ğŸ§</span>
                </div>
            </header>
            <div class="bg-white mx-4 -mt-6 rounded-xl shadow-sm p-4 grid grid-cols-4 gap-y-5 text-center relative z-10">
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-red-50 w-10 h-10 flex items-center justify-center rounded-full text-red-500">ğŸ’°</div><span class="text-[11px] text-zinc-700 font-bold">æœæœå®</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-blue-50 w-10 h-10 flex items-center justify-center rounded-full text-blue-500">Â¥</div><span class="text-[11px] text-zinc-700 font-bold">å€Ÿé’±</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-orange-50 w-10 h-10 flex items-center justify-center rounded-full text-orange-500">ğŸ”</div><span class="text-[11px] text-zinc-700 font-bold">è½¬è´¦</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-green-50 w-10 h-10 flex items-center justify-center rounded-full text-green-500">ğŸ‘ï¸</div><span class="text-[11px] text-zinc-700 font-bold">è´¦æˆ·æ€»è§ˆ</span></div>
                
                <div onclick="simulateBankIncome()" class="flex flex-col items-center gap-1.5 cursor-pointer active:opacity-50"><div class="text-2xl">ğŸ’³</div><span class="text-[11px] text-[#e60012] font-bold">é“¶è¡Œå¡å…¥è´¦</span></div>
                <div onclick="renderBankRecords(); go('pg-bank-records')" class="flex flex-col items-center gap-1.5 cursor-pointer active:opacity-50"><div class="text-2xl">ğŸ§¾</div><span class="text-[11px] text-zinc-800 font-bold">æ”¶æ”¯æ˜ç»†</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl">â­</div><span class="text-[11px] text-zinc-700">ç†è´¢</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl text-zinc-400">â€¢â€¢â€¢</div><span class="text-[11px] text-zinc-700">å…¨éƒ¨</span></div>
            </div>
            <div class="mx-4 mt-4 bg-white rounded-xl p-4 shadow-sm">
                <b class="text-sm border-l-4 border-[#e60012] pl-2 block mb-3">è´¢å¯Œç²¾é€‰</b>
                <div class="flex justify-between items-center bg-red-50/50 p-3 rounded-lg border border-red-50">
                    <div>
                        <div class="text-[#e60012] font-bold text-lg">0.45%</div>
                        <div class="text-xs text-zinc-400 mt-1">å½“å‰å¹´åˆ©ç‡</div>
                    </div>
                    <div class="text-xs text-zinc-500 space-y-1"><p>âœ… å½“æ—¥èµ·æ¯</p><p>âœ… æœ¬é‡‘æœ‰ä¿éšœ</p></div>
                    <button class="bg-[#e60012] text-white px-4 py-1.5 rounded-full text-xs font-bold">å»çœ‹çœ‹</button>
                </div>
            </div>
        </div>
        
        <div id="bank-tab-me" class="flex-1 flex flex-col h-full overflow-y-auto no-scrollbar hidden bg-[#f5f5f5]">
            <div class="bg-gradient-to-b from-[#fdeeee] to-[#f5f5f5] pt-14 pb-4 px-6 flex items-center gap-4 shrink-0">
                <img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white shadow-sm">
                <div><b class="u-name text-xl text-zinc-900 block mb-1"></b></div>
            </div>
            <div class="px-4 space-y-3 pb-24">
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <div class="flex justify-between items-center mb-5 border-b border-zinc-50 pb-3">
                        <b class="text-base text-zinc-800">è´¦æˆ·æ€»è§ˆ ğŸ‘ï¸</b>
                    </div>
                    <div class="flex justify-between items-end">
                        <div><div class="text-xs text-zinc-400 mb-1">æ€»èµ„äº§</div><div id="bank-total-assets" class="text-2xl font-bold text-zinc-900">Â¥ 0.00</div></div>
                        <div class="text-right"><div class="text-xs text-zinc-400 mb-1">æ˜¨æ—¥æ”¶ç›Š</div><div class="text-base font-bold text-[#e60012]">+0.00</div></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <b class="text-base text-zinc-800 mb-5 block">æœ¬æœˆæ”¶æ”¯</b>
                    <div class="flex justify-between items-end">
                        <div><div class="text-xs text-zinc-400 mb-1">æ”¯å‡º</div><div id="bank-month-expense" class="text-xl font-bold text-zinc-900">Â¥ 0.00</div></div>
                        <div class="text-right"><div class="text-xs text-zinc-400 mb-1">æ”¶å…¥</div><div id="bank-month-income" class="text-xl font-bold text-[#e60012]">Â¥ 0.00</div></div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toBankTab('home')" id="nav-bank-home" class="text-center flex-1 py-1 cursor-pointer text-[#e60012] font-bold"><div class="text-xl mb-0.5">ğŸ </div>é¦–é¡µ</div>
            <div onclick="toBankTab('me')" id="nav-bank-me" class="text-center flex-1 py-1 cursor-pointer text-zinc-400"><div class="text-xl mb-0.5">ğŸ‘¤</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-bank-records" class="page bg-[#f5f5f5] z-[50]">
        <header class="bg-white h-14 flex items-end px-4 pb-3 border-b sticky top-0"><span onclick="go('pg-bank')" class="text-zinc-500 text-lg mr-4 cursor-pointer">ã€ˆ</span><b class="text-lg">æ”¶æ”¯æ˜ç»†</b></header>
        <div id="bank-records-list" class="p-3 space-y-2 overflow-y-auto h-full pb-20"></div>
    </div>

    <div id="pg-wallet" class="page bg-gray-50 z-[60]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0"><span onclick="go('pg-wechat')" class="text-zinc-700 text-lg cursor-pointer">ã€ˆ</span><span class="text-zinc-700 text-sm mb-1 cursor-pointer">é›¶é’±æ˜ç»†</span></header>
        <div class="flex flex-col items-center pt-16 px-6">
            <div class="w-20 h-20 bg-[#fbbd08] rounded-full flex items-center justify-center mb-8"><span class="text-white text-5xl font-bold">Â¥</span></div>
            <div class="text-zinc-800 text-lg mb-2">æˆ‘çš„é›¶é’±</div>
            <div class="text-4xl font-bold mb-16 flex items-baseline"><span class="text-2xl mr-1">Â¥</span><span id="wallet-num">0.00</span></div>
            <button onclick="walletOp('add')" class="w-full bg-[#07c160] text-white py-3 rounded-lg font-bold text-lg mb-4 active:bg-[#06ad56]">å……å€¼</button>
            <button onclick="walletOp('sub')" class="w-full bg-white text-zinc-800 py-3 rounded-lg font-bold text-lg border border-zinc-300 active:bg-gray-50">æç°</button>
        </div>
    </div>
    <div id="pg-recharge" class="page bg-[#ededed] z-[70]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-4 shrink-0 relative">
            <span onclick="go('pg-wallet')" class="text-2xl text-zinc-700 font-light cursor-pointer leading-none pb-1">âœ•</span>
            <b class="text-lg absolute left-1/2 -translate-x-1/2 pb-1">å……å€¼</b>
            <div class="w-8"></div>
        </header>
        <div class="flex-1 p-6">
            <div class="bg-white p-4 rounded-xl flex justify-between items-center mb-6 active:bg-zinc-50">
                <div class="flex items-center gap-3">
                    <span class="text-zinc-500 text-sm">å……å€¼æ–¹å¼</span>
                    <span class="text-green-600 font-bold ml-1 text-lg">ğŸ’³</span>
                    <span class="font-bold text-[#1f1f1f] text-sm">å‚¨è“„å¡ / é›¶é’±é€š</span>
                </div>
                <span class="text-zinc-300">ã€‰</span>
            </div>
            <div class="bg-white p-6 rounded-xl">
                <div class="text-sm text-zinc-500 mb-4">å……å€¼é‡‘é¢</div>
                <div class="flex items-baseline border-b border-zinc-200 pb-2" onclick="focusRechargeInput()">
                    <span class="text-3xl font-bold mr-2">Â¥</span>
                    <span id="recharge-amount-display" class="text-5xl font-bold"></span>
                    <span id="recharge-cursor" class="text-4xl font-light text-[#07c160] animate-pulse ml-1">|</span>
                </div>
            </div>
        </div>
        <div class="bg-[#f7f7f7] shrink-0 safe-area-pb">
            <div class="grid grid-cols-4 bg-[#dadada] gap-[1px] p-[1px]">
                <button onclick="handleRechargeInput('1')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">1</button>
                <button onclick="handleRechargeInput('2')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">2</button>
                <button onclick="handleRechargeInput('3')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">3</button>
                <button onclick="handleRechargeInput('del')" class="bg-white py-5 flex items-center justify-center active:bg-zinc-100 text-xl row-span-2">âŒ«</button>
                <button onclick="handleRechargeInput('4')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">4</button>
                <button onclick="handleRechargeInput('5')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">5</button>
                <button onclick="handleRechargeInput('6')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">6</button>
                <button onclick="handleRechargeInput('7')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">7</button>
                <button onclick="handleRechargeInput('8')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">8</button>
                <button onclick="handleRechargeInput('9')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">9</button>
                <button id="btn-recharge-confirm" onclick="confirmRecharge()" class="bg-[#07c160] text-white font-bold text-lg active:bg-[#06ad56] row-span-2 opacity-40 pointer-events-none flex items-center justify-center transition-opacity">ç¡®å®š</button>
                <button class="bg-[#f7f7f7] py-5 text-xl font-bold pointer-events-none"></button>
                <button onclick="handleRechargeInput('0')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">0</button>
                <button onclick="handleRechargeInput('.')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">.</button>
            </div>
        </div>
    </div>
    <div id="pg-withdraw" class="page bg-[#ededed] z-[70]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-4 shrink-0 relative">
            <span onclick="go('pg-wallet')" class="text-2xl text-zinc-700 font-light cursor-pointer leading-none pb-1">âœ•</span>
            <b class="text-lg absolute left-1/2 -translate-x-1/2 pb-1">é›¶é’±æç°</b>
            <span class="text-lg text-zinc-600 font-bold pb-1 tracking-widest">Â·Â·Â·</span>
        </header>
        <div class="flex-1 p-6">
            <div class="bg-[#fcfcfc] rounded-xl flex flex-col mb-6 shadow-sm">
                <div class="flex justify-between items-center p-5 bg-[#f8f8f8] rounded-t-xl border-b border-zinc-100">
                    <span class="text-zinc-500 text-sm">åˆ°è´¦é“¶è¡Œå¡</span>
                    <div class="flex flex-col items-end">
                        <div class="flex items-center gap-2"><span class="text-green-600 font-bold text-sm bg-green-100 w-5 h-5 flex items-center justify-center rounded-full">â—</span><span class="text-[#576b95] text-sm font-bold">å‚¨è“„å¡ (2524)</span><span class="text-zinc-300 ml-1">ã€‰</span></div>
                        <span class="text-[10px] text-zinc-400 mt-1">2å°æ—¶å†…åˆ°è´¦</span>
                    </div>
                </div>
                <div class="p-6 pt-5">
                    <div class="text-sm text-zinc-800 mb-4 font-bold">æç°é‡‘é¢</div>
                    <div class="flex items-baseline border-b border-zinc-200 pb-2" onclick="focusWithdrawInput()">
                        <span class="text-4xl font-bold mr-2">Â¥</span>
                        <span id="withdraw-amount-display" class="text-5xl font-bold"></span>
                        <span id="withdraw-cursor" class="text-4xl font-light text-[#07c160] animate-pulse ml-1">|</span>
                    </div>
                    <div class="mt-4 text-xs text-zinc-400 flex items-center">
                        å½“å‰é›¶é’±ä½™é¢ <span id="withdraw-max-text" class="mx-1 font-bold text-zinc-600">0.00</span> å…ƒï¼Œ
                        <span onclick="withdrawAll()" class="text-[#576b95] ml-1 cursor-pointer font-bold">å…¨éƒ¨æç°</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-[#f7f7f7] shrink-0 safe-area-pb">
            <div class="grid grid-cols-4 bg-[#dadada] gap-[1px] p-[1px]">
                <button onclick="handleWithdrawInput('1')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">1</button>
                <button onclick="handleWithdrawInput('2')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">2</button>
                <button onclick="handleWithdrawInput('3')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">3</button>
                <button onclick="handleWithdrawInput('del')" class="bg-white py-5 flex items-center justify-center active:bg-zinc-100 text-xl row-span-2">âŒ«</button>
                <button onclick="handleWithdrawInput('4')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">4</button>
                <button onclick="handleWithdrawInput('5')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">5</button>
                <button onclick="handleWithdrawInput('6')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">6</button>
                <button onclick="handleWithdrawInput('7')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">7</button>
                <button onclick="handleWithdrawInput('8')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">8</button>
                <button onclick="handleWithdrawInput('9')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">9</button>
                <button id="btn-withdraw-confirm" onclick="confirmWithdraw()" class="bg-[#07c160] text-white font-bold text-lg active:bg-[#06ad56] row-span-2 opacity-40 pointer-events-none flex items-center justify-center transition-opacity">æç°</button>
                <button class="bg-[#f7f7f7] py-5 text-xl font-bold pointer-events-none"></button>
                <button onclick="handleWithdrawInput('0')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">0</button>
                <button onclick="handleWithdrawInput('.')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">.</button>
            </div>
        </div>
    </div>
    <div id="pg-transfer-detail" class="page z-[80] bg-[#191919] text-white items-center">
        <header class="w-full h-16 flex items-end justify-between p-4 shrink-0"><span onclick="go('pg-chat-room')" class="text-white text-lg cursor-pointer">ã€ˆ</span><span class="mb-1 text-sm font-light opacity-80">äº¤æ˜“è¯¦æƒ…</span><div class="w-4"></div></header>
        <div class="mt-10 flex flex-col items-center w-full px-8 animate-fade-in">
            <div class="mb-4 text-[#f79c4a] text-6xl"><div class="w-24 h-24 rounded-full border-4 border-[#f79c4a] flex items-center justify-center mx-auto mb-4"><span id="tx-icon">â³</span></div></div>
            <div id="tx-status" class="text-xl mb-2 text-[#f79c4a]">å¾…æ”¶æ¬¾</div>
            <div class="text-5xl font-bold mb-10 flex items-baseline"><span class="text-3xl mr-2">Â¥</span><span id="tx-amount">0.00</span></div>
            <button id="btn-tx-receive" onclick="doReceiveTransfer()" class="w-2/3 bg-[#07c160] text-white py-4 rounded-lg font-bold text-lg mb-6 active:scale-95 transition-transform shadow-lg hidden">ç¡®è®¤æ”¶æ¬¾</button>
            <div id="link-tx-return" class="text-sm text-zinc-500 mt-auto mb-8 hidden">1å¤©å†…æœªç¡®è®¤ï¼Œå°†é€€è¿˜ç»™å¯¹æ–¹ã€‚<span onclick="doReturnTransfer()" class="text-[#576b95] cursor-pointer ml-1">ç«‹å³é€€è¿˜</span></div>
            <div id="tx-info-box" class="hidden text-zinc-500 text-sm mt-4 text-center space-y-2"><p>è½¬è´¦æ—¶é—´: <span id="tx-time"></span></p><p>æ”¶é’±æ—¶é—´: <span id="tx-time-rcv">--</span></p></div>
        </div>
    </div>

    <div id="pg-chat-room" class="page z-[50]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0">
            <span onclick="go('pg-wechat')" class="text-zinc-600 pb-1 cursor-pointer">ã€ˆ è¿”å›</span>
            <div class="flex flex-col items-center pb-1"><b id="chat-user-name"></b><span id="chat-mode-tag" class="text-[10px] text-zinc-400">çŸ­å¥æ¨¡å¼</span></div>
            <div class="flex items-center gap-4 pb-1">
    <button onclick="deleteCurrentChat()" class="text-red-500 text-sm font-bold active:opacity-50">åˆ é™¤</button>
    <button onclick="go('pg-chat-info')" class="text-zinc-800 text-xl font-bold px-2 tracking-widest">â€¢â€¢â€¢</button>
</div>
        </header>
        <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar bg-[#f2f2f2] bg-cover bg-center"></div>
        <footer class="bg-[#f7f7f7] border-t z-[60] relative shrink-0 safe-area-pb">
            <div class="p-3 flex items-center gap-2">
                <button onclick="togglePnl('emoji')" class="text-3xl text-zinc-600 font-light active:opacity-50 px-1">â˜º</button>
                <input id="chat-in" class="flex-1 border-none rounded bg-white h-10 px-3 outline-none text-base" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button onclick="togglePnl('tools')" class="text-3xl text-zinc-600 font-light active:opacity-50 px-1">âŠ•</button>
                <button onclick="handleSendMsg()" class="bg-[#07c160] text-white px-3 py-1.5 rounded text-sm font-medium whitespace-nowrap">å‘é€</button>
            </div>
                        <div id="chat-pnl" class="drawer bg-[#f7f7f7]"></div>
        </footer>
    </div>

    <div id="pg-story-room" class="page z-[50] bg-[#f8f1e5]">
        <header class="h-14 flex items-end justify-between p-3 border-b border-[#eaddcf] shrink-0 sticky top-0 z-20 shadow-sm">
            <span onclick="exitStoryMode()" class="text-[#8c7b6c] pb-1 cursor-pointer font-bold">ã€ˆ ç»“æŸè§é¢(å›å¾®ä¿¡)</span>
            <b class="pb-1 text-lg truncate text-[#5c4b3c]" id="story-user-name">çº¿ä¸‹è§é¢</b>
            <span class="w-24"></span>
        </header>
        <div id="story-msgs" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"></div>
        <footer class="bg-[#f8f1e5] border-t border-[#eaddcf] z-[60] relative shrink-0 safe-area-pb p-3 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <div class="flex items-center gap-2">
                <textarea id="story-in" class="flex-1 border border-[#eaddcf] rounded-lg bg-white p-2.5 outline-none text-base resize-none" rows="2" placeholder="æå†™åŠ¨ä½œã€è¯­è¨€æˆ–å¿ƒç†æ´»åŠ¨..."></textarea>
                <button onclick="handleSendMsg(null, 'text', false)" class="bg-[#5c4b3c] text-[#f8f1e5] px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap h-full self-stretch flex items-center justify-center shadow-sm active:scale-95 transition-transform">å‘é€</button>
            </div>
        </footer>
    </div>
    <div id="pg-chat-info" class="page z-[60] bg-zinc-100">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0"><span onclick="go('pg-chat-room')" class="text-zinc-600 pb-1 cursor-pointer">ã€ˆ</span><b class="pb-1">èŠå¤©ä¿¡æ¯</b><div class="w-6"></div></header>
        <div class="overflow-y-auto">
            <div id="group-name-edit-box" class="mt-2 bg-white divide-y border-y border-zinc-200 hidden">
                <div onclick="renameGroup()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer">
                    <span class="text-base text-zinc-800">âœï¸ ä¿®æ”¹ç¾¤èŠåç§°</span>
                    <span class="text-zinc-300">ã€‰</span>
                </div>
            </div>
            
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="go('pg-mask-edit')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span class="text-base text-zinc-800">ğŸ­ ç”¨æˆ·é¢å…· (äººè®¾)</span><div class="flex items-center gap-2"><span id="info-mask-status" class="text-xs text-zinc-400">é»˜è®¤</span><span class="text-zinc-300">ã€‰</span></div></div></div>
ã€€ã€€<div class="mt-2 bg-white divide-y border-y border-zinc-200">
    <div onclick="openRoleVoiceEdit()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer">
        <span class="text-base text-zinc-800">ğŸ™ï¸ è§’è‰²è¯­éŸ³é…ç½®</span>
        <span class="text-zinc-300">ã€‰</span>
    </div>
</div>
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="setChatBg()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span class="text-base text-zinc-800">ğŸ–¼ï¸ è®¾ç½®å½“å‰èŠå¤©èƒŒæ™¯</span><span class="text-zinc-300">ã€‰</span></div></div>
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="clearHistory()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer text-red-600 text-center justify-center font-medium">æ¸…ç©ºèŠå¤©è®°å½•</div></div>
        </div>
    </div>
ã€€ã€€<div id="pg-voice-edit" class="page z-[70] bg-white">
    <header class="h-16 flex items-end justify-between border-b pb-4 px-4 shrink-0">
        <button onclick="go('pg-chat-info')" class="text-zinc-600">å–æ¶ˆ</button>
        <b>éŸ³è‰²é…ç½®</b>
        <button onclick="saveRoleVoice()" class="text-green-600 font-bold">ä¿å­˜</button>
    </header>
    <div class="p-6 space-y-6">
        <div class="bg-purple-50 p-3 rounded-lg text-xs text-purple-600 mb-2 leading-relaxed">
            è¯·è¾“å…¥ MiniMax æ”¯æŒçš„éŸ³è‰² IDï¼ˆä¾‹å¦‚: male-qn-qingseï¼‰ã€‚é…ç½®åï¼Œå¯ä»¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•å‘éŸ³ã€‚
        </div>
        <div>
            <label class="block text-sm font-bold text-zinc-700 mb-2">è§’è‰²éŸ³è‰² ID</label>
            <input id="in-role-voice-id" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: male-qn-qingse">
        </div>
        <div class="mt-8">
            <button id="btn-test-voice" onclick="testRoleVoice()" class="w-full py-4 bg-zinc-800 text-white rounded-xl font-bold active:scale-95 transition-transform shadow-lg">ğŸ§ æµ‹è¯•éŸ³è‰² (å¬ä¸€å¥"ä½ å¥½")</button>
        </div>
    </div>
</div>
    <div id="pg-mask-edit" class="page z-[70] bg-white"><header class="h-16 flex items-end justify-between border-b pb-4 px-4 shrink-0"><button onclick="go('pg-chat-info')" class="text-zinc-600">å–æ¶ˆ</button><b>ç¼–è¾‘é¢å…·</b><button onclick="saveMask()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-6 space-y-6"><div class="text-xs text-zinc-400 text-center">ä»…åœ¨ä¸å½“å‰è§’è‰²èŠå¤©æ—¶ç”Ÿæ•ˆã€‚</div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·æ˜µç§°</label><input id="in-mask-n" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: ä½ çš„å­¦ç”Ÿå°æ˜"></div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·å¤´åƒ URL</label><input id="in-mask-a" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="http://..."></div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·äººè®¾è¯¦æƒ…</label><textarea id="in-mask-i" class="w-full h-40 p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ååŒ»å­¦é™¢çš„å­¦ç”Ÿ..."></textarea></div></div></div>
    <div id="pg-prof" class="page bg-white p-4"><header class="h-16 flex items-end justify-between border-b pb-4 shrink-0"><button onclick="go('pg-wechat')">è¿”å›</button><b>ä¸ªäººä¿¡æ¯</b><div class="w-8"></div></header><div class="mt-4 divide-y"><div onclick="updProf('name','æ˜µç§°')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>æ˜µç§°</span><span class="u-name text-zinc-400"></span></div><div onclick="updProf('ava','å¤´åƒURL')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>å¤´åƒ</span><img class="w-12 h-12 u-ava rounded-lg bg-zinc-100"></div><div onclick="updProf('bg','æœ‹å‹åœˆèƒŒæ™¯URL')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>æœ‹å‹åœˆèƒŒæ™¯</span><span class="text-zinc-400 text-sm">ç‚¹å‡»æ›´æ¢ ã€‰</span></div><div onclick="updProf('info','äººè®¾ç­¾å')" class="py-5 flex flex-col gap-2 active:bg-zinc-50"><span>èº«ä»½äººè®¾/ç­¾å</span><div id="u-info-box" class="text-sm text-zinc-400 bg-zinc-50 p-4 rounded-lg"></div></div></div></div>
    <div id="pg-moments-pub" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')" class="text-zinc-700">å–æ¶ˆ</button><b class="pb-1">å‘è¡¨æœ‹å‹åœˆ</b><button onclick="submitMoment()" class="bg-[#07c160] text-white px-4 py-1 rounded text-sm font-medium">å‘è¡¨</button></header><div class="flex-1 overflow-y-auto"><textarea id="in-m-t" class="w-full h-40 p-4 outline-none resize-none text-lg" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea><div class="p-4 border-t"><p class="text-xs text-zinc-400 mb-2">é…å›¾é“¾æ¥ (å¯é€‰)</p><input id="in-m-img" class="w-full p-3 bg-zinc-50 rounded-lg text-sm border-none outline-none" placeholder="ç²˜è´´å›¾ç‰‡ç›´é“¾ http://..."></div></div></div>
    <div id="pg-wb" class="page bg-zinc-100"><header class="h-16 bg-white flex items-end justify-between p-4 border-b shrink-0"><button onclick="go('pg-home')" class="text-zinc-600">ğŸ </button><b>ä¸–ç•Œä¹¦</b><button onclick="openWBEdit(null)" class="text-blue-600 font-bold">ï¼‹</button></header><div id="wb-list-box" class="p-4 space-y-3"></div></div>
    <div id="pg-wb-edit" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wb')">å–æ¶ˆ</button><b>ç¼–è¾‘è®¾å®š</b><button onclick="saveWB()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-4 space-y-4 overflow-y-auto no-scrollbar"><input id="in-wb-n" class="w-full p-3 border rounded-lg" placeholder="è®¾å®šæ ‡é¢˜"><textarea id="in-wb-c" class="w-full h-40 p-3 border rounded-lg" placeholder="å†…å®¹..."></textarea><div id="wb-roles-sel" class="flex flex-wrap gap-2 pb-10"></div></div></div>
    <div id="pg-memory" class="page bg-zinc-100"><header class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-home')" class="text-zinc-600">ğŸ </button><b>è®°å¿†æ®¿å ‚</b><div class="w-8"></div></header><div id="memory-list" class="p-4 space-y-4 overflow-y-auto no-scrollbar"></div></div>
<div id="pg-set" class="page bg-zinc-100">
    <header id="set-main-header" class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0">
        <button onclick="go('pg-home')">ğŸ </button>
        <b>ç³»ç»Ÿè®¾ç½®</b>
        <div class="w-8"></div>
    </header>

    <header id="set-api-header" class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0 hidden">
        <button onclick="toggleSetSub('main')" class="text-zinc-600">ã€ˆ è¿”å›</button>
        <b>API è®¾ç½®</b>
        <div class="w-8"></div>
    </header>

    <header id="set-voice-header" class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0 hidden">
        <button onclick="toggleSetSub('main')" class="text-zinc-600">ã€ˆ è¿”å›</button>
        <b>è¯­éŸ³ç³»ç»Ÿé…ç½®</b>
        <div class="w-8"></div>
    </header>

    <div class="flex-1 overflow-y-auto">
        <div id="set-main-list" class="mt-4 bg-white divide-y border-y border-zinc-200">
            <div onclick="toggleSetSub('api')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ”Œ</span>
                    <span class="text-base text-zinc-800">API é…ç½® (æ ¸å¿ƒå¯¹è¯)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="set-api-status" class="text-xs text-green-500">å·²é…ç½®</span>
                    <span class="text-zinc-300">ã€‰</span>
                </div>
            </div>
            
            <div onclick="toggleSetSub('voice')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ™ï¸</span>
                    <span class="text-base text-zinc-800">è¯­éŸ³ç³»ç»Ÿ (MiniMax)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="set-voice-status" class="text-xs text-red-500">æœªè®¾ç½®</span>
                    <span class="text-zinc-300">ã€‰</span>
                </div>
            </div>

            <div class="p-4 flex justify-between items-center opacity-40">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ¨</span>
                    <span class="text-base text-zinc-800">ç•Œé¢ä¸»é¢˜ (æ•¬è¯·æœŸå¾…)</span>
                </div>
                <span class="text-zinc-300">ã€‰</span>
            </div>
        </div>

        <div id="set-api-detail" class="p-6 space-y-4 hidden">
            <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-600 mb-2">
                è¯·è¾“å…¥é€‚é… OpenAI æ ¼å¼çš„æ¥å£åœ°å€å’Œå¯†é’¥ã€‚
            </div>
            <input id="in-s-u" class="w-full p-3 border rounded-lg" placeholder="API åœ°å€ (ä¾‹å¦‚: https://api.openai.com)">
            <input id="in-s-k" type="password" class="w-full p-3 border rounded-lg" placeholder="API Key (sk-...)">
            <div class="flex gap-2">
                <input id="in-s-m" class="flex-1 p-3 border rounded-lg" placeholder="æ¨¡å‹åç§° (å¦‚: gpt-4o)">
                <button onclick="fetchModels()" class="bg-blue-600 text-white px-3 rounded-lg text-xs whitespace-nowrap">æ‹‰å–åˆ—è¡¨</button>
            </div>
            <select id="model-select" class="w-full p-3 border rounded-lg hidden" onchange="$('in-s-m').value=this.value"></select>
            <button onclick="saveSettings()" class="w-full bg-zinc-800 text-white py-4 rounded-xl font-bold shadow-lg mt-4">ä¿å­˜è®¾ç½®</button>
        </div>

                                <div id="set-voice-detail" class="p-6 space-y-4 hidden animate-fade-in">
            <div class="bg-purple-50 p-3 rounded-lg text-xs text-purple-600 mb-2">
                å¡«å†™è¯­éŸ³å¤§æ¨¡å‹å‚æ•°ï¼Œä¸ºæœªæ¥çš„è¯­éŸ³é€šè¯å’Œæ‹ŸçœŸå‘éŸ³åšå‡†å¤‡ã€‚
            </div>
            <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1">è¯­éŸ³ API åœ°å€</label>
                <input id="in-v-u" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: https://api.minimax.chat/v1/t2a_v2">
            </div>
            <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1">MINIMAX ID (Group ID)</label>
                <input id="in-v-id" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: 1234567890">
            </div>
            <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1">å¯†é’¥ (API Key)</label>
                <input id="in-v-k" type="password" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: eyJhbGciOiJIUzI1Ni...">
            </div>
            <div class="flex gap-3 mt-4">
                <button onclick="testVoiceConnection(event)" class="flex-1 bg-zinc-200 text-zinc-700 py-3.5 rounded-xl font-bold shadow-sm active:bg-zinc-300 transition-colors">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
                <button onclick="saveVoiceSettings()" class="flex-[2] bg-purple-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:bg-purple-700 transition-colors">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>
</div>
    <div id="pg-role-edit" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')">å–æ¶ˆ</button><b id="role-edit-title">è§’è‰²</b><button onclick="saveRole()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-4 space-y-4 overflow-y-auto no-scrollbar"><input id="in-r-n" class="w-full p-3 border rounded-lg" placeholder="æ˜µç§°"><input id="in-r-a" class="w-full p-3 border rounded-lg" placeholder="å¤´åƒURL"><textarea id="in-r-i" class="w-full h-80 p-3 border rounded-lg" placeholder="è¯¦ç»†äººè®¾..."></textarea><button id="del-role-btn" onclick="deleteRole()" class="w-full py-3 text-red-500 hidden">åˆ é™¤æ­¤è§’è‰²</button></div></div>
    <div id="pg-emj" class="page bg-white"><header class="h-16 border-b p-4 flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')">è¿”å›</button><b>è¡¨æƒ…åŒ…åˆ—è¡¨</b><button onclick="addEmj()" class="text-green-600">æ·»åŠ </button></header><div id="emj-box" class="p-4 grid grid-cols-4 gap-4 overflow-y-auto"></div></div>
</div>
ã€€    <div id="pg-vn-hub" class="page bg-zinc-100 z-[50]">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0 sticky top-0 z-20">
            <button onclick="go('pg-home')" class="text-zinc-600 pb-1 w-12 text-left">ğŸ </button>
            <b class="pb-1 text-lg">æˆ‘çš„å‰§æœ¬å­˜æ¡£</b>
            <button onclick="openVnCreate()" class="text-indigo-600 font-bold pb-1 text-sm w-12 text-right">æ–°å»º</button>
        </header>
        
        <div class="bg-indigo-50 p-3 mx-4 mt-4 rounded-xl flex justify-between items-center shadow-sm border border-indigo-100">
            <span class="text-xs text-indigo-600 font-bold">ğŸŒŸ å¿ƒåŠ¨å°è®°ä½™é¢</span>
            <span id="vn-marks-display" class="font-mono font-bold text-lg text-indigo-800">0</span>
        </div>

        <div id="vn-save-list" class="p-4 space-y-4 overflow-y-auto pb-20 no-scrollbar">
            </div>
    </div>

    <div id="pg-vn-create" class="page bg-white z-[60]">
        <header class="h-14 flex items-end justify-between p-3 border-b shrink-0 sticky top-0 bg-white/90 backdrop-blur z-20">
            <button onclick="go('pg-vn-hub')" class="text-zinc-600 pb-1">å–æ¶ˆ</button>
            <b class="pb-1 text-lg">æ–°ä¸–ç•Œè®¾å®š</b>
            <button onclick="saveNewVnSave()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm font-bold shadow-sm active:scale-95">åˆ›å»º</button>
        </header>
        
        <div class="p-5 space-y-5 overflow-y-auto h-full pb-24">
            <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1">1. å‚æ¼”è§’è‰² (å¿…é¡»é€‰æ‹©)</label>
                <select id="vn-role-sel" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none text-sm"></select>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1">2. ä¸–ç•Œè§‚ä¸èƒŒæ™¯</label>
                <textarea id="vn-world" class="w-full h-24 p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none resize-none text-sm leading-relaxed" placeholder="ä¾‹å¦‚ï¼šä¸§å°¸çˆ†å‘çš„æœ«ä¸–ï¼Œç‰©èµ„æåº¦åŒ®ä¹ï¼Œäººç±»åœ¨åºŸå¢Ÿä¸­è‹Ÿå»¶æ®‹å–˜..."></textarea>
            </div>

            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">3. Ta çš„èº«ä»½</label>
                    <input id="vn-role-job" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none text-sm" placeholder="ä¾‹å¦‚: å¼‚èƒ½å°é˜Ÿé˜Ÿé•¿">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">4. æˆ‘çš„èº«ä»½</label>
                    <input id="vn-user-job" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none text-sm" placeholder="ä¾‹å¦‚: ä»–çš„ç—…å¼±æœªå©šå¦»">
                </div>
            </div>

            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <p class="text-xs text-indigo-500 font-bold mb-3">ğŸ¨ è§†è§‰èµ„æºé…ç½®</p>
                <div class="space-y-3">
                    <div>
                        <label class="block text-[10px] text-zinc-500 mb-1">åœºæ™¯èƒŒæ™¯å›¾ (å»ºè®®æ¨ªå›¾ç›´é“¾)</label>
                        <input id="vn-bg-url" class="w-full p-2.5 border border-zinc-200 rounded-lg bg-white outline-none text-xs" placeholder="http://...">
                    </div>
                    <div>
                        <label class="block text-[10px] text-zinc-500 mb-1">äººç‰©ç«‹ç»˜å›¾ (å¿…é¡»é€æ˜åº• PNG)</label>
                        <input id="vn-sprite-url" class="w-full p-2.5 border border-zinc-200 rounded-lg bg-white outline-none text-xs" placeholder="http://...">
                    </div>
                    <div>
    <label class="block text-[10px] text-zinc-500 mb-1">å¼€å±€å¥½æ„Ÿåº¦ (0~1000)</label>
    <input id="vn-start-love" type="number" value="500" class="w-full p-2.5 border border-zinc-200 rounded-lg bg-white outline-none text-xs">
</div>
                </div>
            </div>
        </div>
    </div>
        <div id="pg-vn-room" class="page bg-black z-[90] vn-landscape text-white">
        
        <div id="vn-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-1000 opacity-80" style="background-image: url('https://images.unsplash.com/photo-1507504031003-b417219a0fde?q=80&w=800');"></div>
        
                        <div class="absolute inset-0 pointer-events-none z-10">
            <img id="vn-sprite" src="https://img.icons8.com/color/480/anime-emoji.png" class="absolute left-0 bottom-0 h-[95%] max-w-[80%] object-contain object-left-bottom drop-shadow-[10px_0_20px_rgba(0,0,0,0.5)] transition-all duration-500">
            <div id="vn-emoji" class="absolute top-[20%] left-[10%] text-4xl opacity-0 transition-all duration-300 scale-50">âœ¨</div>
        </div>

           <header class="absolute top-0 w-full py-5 pl-5 pr-16 flex justify-between items-start z-20 bg-gradient-to-b from-black/70 to-transparent h-24">
            <button onclick="exitVNRoom()" class="text-white/90 text-sm font-bold bg-black/40 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 active:bg-white/20 transition-colors shadow-lg">ã€ˆ è¿”å›</button>
            <div class="bg-black/50 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 text-xs font-bold flex items-center gap-1 shadow-lg">
                ğŸ’– å¥½æ„Ÿ <span id="vn-love" class="text-pink-400 text-sm ml-1">50</span>
            </div>
        </header>

        <div class="absolute bottom-0 w-full h-[45%] bg-gradient-to-t from-black via-black/90 to-transparent p-5 pt-14 z-20 flex flex-col justify-end">
            <div class="absolute top-4 left-10 z-30">
                <span id="vn-name" class="text-white text-lg font-serif font-bold tracking-widest drop-shadow-md border-b-[3px] border-[#ff9000] pb-1 px-2">è§’è‰²å</span>
            </div>
            <p id="vn-text" class="text-white/95 text-[14px] leading-relaxed font-serif tracking-normal text-justify px-4 overflow-y-auto max-h-full no-scrollbar">
                (å‰§æƒ…æ–‡æœ¬åŠ è½½ä¸­...)
            </p>
            <div id="vn-cursor" class="absolute bottom-4 right-8 text-[#ff9000] animate-bounce text-2xl">â–¼</div>
        </div>

ã€€ã€€        <div id="vn-choices-box" class="absolute right-[16%] top-[10%] w-[55%] max-w-[450px] max-h-[42%] overflow-y-auto no-scrollbar flex flex-col gap-2.5 z-40 hidden animate-fade-in">
            
            <button id="vn-opt-A" onclick="submitVNChoice('A')" class="w-full bg-white/15 backdrop-blur-xl border border-white/30 text-white py-2.5 px-4 rounded-xl text-[14px] hover:bg-white/25 active:scale-95 transition-all shadow-lg text-left leading-relaxed font-medium tracking-normal shrink-0">
                A. (åŠ è½½ä¸­...)
            </button>
            
            <button id="vn-opt-B" onclick="submitVNChoice('B')" class="w-full bg-white/15 backdrop-blur-xl border border-white/30 text-white py-2.5 px-4 rounded-xl text-[14px] hover:bg-white/25 active:scale-95 transition-all shadow-lg text-left leading-relaxed font-medium tracking-normal shrink-0">
                B. (åŠ è½½ä¸­...)
            </button>
            
            <button onclick="submitVNChoice('custom')" class="w-full bg-white/5 backdrop-blur-md border border-white/20 text-white/80 py-2 px-4 rounded-xl text-[12px] font-medium hover:bg-white/10 active:scale-95 transition-all shadow-sm text-center flex items-center justify-center gap-2 mt-0.5 shrink-0">
                <span>âœï¸ è‡ªå·±è¾“å…¥è¡ŒåŠ¨...</span>
            </button>
            
        </div>
    </div>
    <div id="pg-diary" class="page bg-[#f5f5f5] z-[70]">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0 sticky top-0 z-20 shadow-sm">
            <span onclick="go('pg-chat-room')" class="text-zinc-600 pb-1 cursor-pointer w-16">ã€ˆ è¿”å›</span>
            <b class="pb-1 text-lg truncate" id="diary-title">Taçš„æ—¥è®°</b>
            <span onclick="generateDiary()" class="text-[#576b95] text-sm pb-1 cursor-pointer font-bold w-16 text-right active:opacity-50 transition-opacity">å·çœ‹ä»Šæ—¥</span>
        </header>
                <div id="diary-list" class="p-4 space-y-4 overflow-y-auto h-full pb-20">
            </div>
    </div>

    <div id="pg-music-player" class="page bg-gradient-to-br from-[#e2eaf5] to-[#f0f4f8] z-[60]">
        <header class="h-16 flex items-center justify-between px-5 pt-4 shrink-0 z-10">
            <div onclick="go('pg-home')" class="w-10 h-10 bg-white/40 rounded-full flex items-center justify-center backdrop-blur shadow-sm cursor-pointer active:scale-95 text-xl text-zinc-700">âˆ¨</div>
            <div class="flex flex-col items-center">
                <b id="music-title" class="text-[17px] text-zinc-800 font-serif tracking-wide drop-shadow-sm">æš‚æ— æ’­æ”¾</b>
                <span id="music-artist" class="text-[11px] text-zinc-500 mt-0.5">æœªçŸ¥æ­Œæ‰‹</span>
            </div>
            <div class="w-10 h-10 bg-white/40 rounded-full flex items-center justify-center backdrop-blur shadow-sm text-xl text-zinc-700">+</div>
        </header>

                <div class="flex-1 flex flex-col items-center relative w-full overflow-hidden pt-10">
                        <input type="file" id="local-cover-input" accept="image/*" class="hidden" onchange="handleCoverUpload(event)">
            
            <div onclick="if(curMusicIdx !== -1) document.getElementById('local-cover-input').click(); else alert('è¯·å…ˆæ’­æ”¾ä¸€é¦–æ­Œå†æ›´æ¢å°é¢å“¦~')" class="relative w-[68vw] max-w-[250px] aspect-square shrink-0 rounded-full border-[6px] border-white/60 flex items-center justify-center shadow-[0_15px_35px_rgba(0,0,0,0.1)] mb-10 mt-2 bg-zinc-100 z-10 cursor-pointer active:scale-95 transition-transform">
                <img id="music-cover" src="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=500&auto=format&fit=crop" class="w-full h-full rounded-full object-cover spin-slow spin-paused shadow-inner">
            </div>
                        <div class="relative w-full h-24 overflow-hidden mt-2 mb-auto z-10 px-6 cursor-pointer" onclick="editLyrics()">
                <div id="lyric-scroll-box" class="w-full absolute top-8 transition-transform duration-300 ease-out text-center flex flex-col items-center gap-3">
                    <div class="text-[15px] text-zinc-800 font-serif tracking-widest drop-shadow-sm">æš‚æ— æ­Œè¯</div>
                    <div class="text-[12px] text-zinc-400 font-serif">ç‚¹å‡»æ­¤å¤„ç²˜è´´ LRC æ­Œè¯</div>
                </div>
            </div>

            <div class="absolute right-1 top-[60%] -translate-y-1/2 flex flex-col gap-7 text-2xl text-zinc-500 drop-shadow-sm z-20">
                <span class="active:scale-90 transition-transform cursor-pointer hover:text-zinc-700">ğŸ§</span>
                <span class="active:scale-90 transition-transform cursor-pointer hover:text-zinc-700">â¦</span>
                <span onclick="toggleMusicFav()" id="music-fav-btn" class="active:scale-90 transition-transform cursor-pointer hover:text-red-500">â™¡</span>
                <span class="active:scale-90 transition-transform cursor-pointer hover:text-zinc-700">â€¢â€¢â€¢</span>
            </div>
        </div>
        <div class="w-full px-6 pb-6 shrink-0 relative z-10">
            <div class="flex items-center gap-3 mb-6">
                <span id="music-time-cur" class="text-[10px] text-zinc-500 font-mono w-8 text-right">0:00</span>
                <input type="range" id="music-progress" class="music-range flex-1" value="0" min="0" max="100" onchange="seekMusic(this.value)">
                <span id="music-time-total" class="text-[10px] text-zinc-500 font-mono w-8">0:00</span>
            </div>
            <div class="flex items-center justify-between px-2 mb-4">
                <span class="text-xl text-zinc-600">ğŸ”</span>
                <div class="flex items-center gap-6">
                    <button onclick="prevMusic()" class="w-12 h-12 bg-white/50 rounded-full flex items-center justify-center text-xl shadow-sm active:bg-white/80">â®</button>
                    <button onclick="togglePlay()" id="btn-music-play" class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-2xl shadow-md active:scale-95 transition-transform">â–¶</button>
                    <button onclick="nextMusic()" class="w-12 h-12 bg-white/50 rounded-full flex items-center justify-center text-xl shadow-sm active:bg-white/80">â­</button>
                </div>
                <span onclick="toMusicTab('me')" class="text-xl text-zinc-600 cursor-pointer active:opacity-50">ğŸ‘¤</span>
            </div>
        </div>
    </div>

    <div id="pg-music-me" class="page bg-[#f5f5f5] z-[60]">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0 sticky top-0 z-20 shadow-sm">
            <span onclick="toMusicTab('player')" class="text-zinc-600 pb-1 cursor-pointer w-16 font-bold">ã€ˆ è¿”å›</span>
            <b class="pb-1 text-lg truncate">æˆ‘çš„éŸ³ä¹</b>
            <div class="w-16 text-right pb-1">
                <input type="file" id="local-music-input" accept="audio/*" class="hidden" onchange="handleLocalMusicUpload(event)">
                <span onclick="document.getElementById('local-music-input').click()" class="text-2xl text-zinc-800 font-light cursor-pointer active:opacity-50">ï¼‹</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto pb-20">
            <div class="bg-gradient-to-b from-[#e2eaf5] to-[#f5f5f5] pt-10 pb-8 px-6 flex flex-col items-center gap-3">
                <img class="u-ava w-20 h-20 rounded-full border-4 border-white bg-white shadow-md object-cover">
                <b class="u-name text-xl text-zinc-900 drop-shadow-sm"></b>
            </div>
            
            <div class="mx-4 -mt-4 bg-white rounded-2xl shadow-sm p-4 grid grid-cols-2 gap-4 text-center relative z-10 mb-4">
                <div class="flex flex-col items-center gap-1 active:opacity-50 border-r border-zinc-100">
                    <span class="text-2xl text-red-400">â¤ï¸</span>
                    <span class="text-xs font-bold text-zinc-700">æˆ‘çš„æ”¶è—</span>
                </div>
                <div class="flex flex-col items-center gap-1 active:opacity-50">
                    <span class="text-2xl text-blue-400">ğŸ•’</span>
                    <span class="text-xs font-bold text-zinc-700">æœ€è¿‘å¬æ­Œ</span>
                </div>
            </div>

            <div class="mx-4 bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="p-4 border-b border-zinc-50 flex justify-between items-center bg-gray-50/50">
                    <b class="text-sm text-zinc-800">æœ¬åœ°éŸ³ä¹åº“</b>
                    <span class="text-[10px] text-zinc-400 bg-zinc-200 px-2 py-0.5 rounded-full" id="music-count-badge">0 é¦–</span>
                </div>
                <div id="music-lib-list" class="divide-y divide-zinc-50">
                    </div>
            </div>
        </div>
    </div>

    <div id="pg-gacha" class="page bg-zinc-900 z-[40]">
        <header class="h-14 bg-zinc-900 flex items-end justify-between p-3 border-b border-zinc-800 shrink-0 text-white sticky top-0 z-20">
            <span onclick="go('pg-home')" class="text-zinc-400 pb-1 cursor-pointer">ã€ˆ è¿”å›</span>
            <b class="pb-1 text-lg text-[#e2d3b5]">å¿ƒåŠ¨ç¾ç»Š</b>
            <span onclick="go('pg-gacha-set')" class="text-zinc-400 pb-1 cursor-pointer text-sm">è®¾ç½®</span>
        </header>

        <div id="gacha-tab-summon" class="flex-1 overflow-y-auto no-scrollbar relative flex flex-col items-center bg-[#f7f8fa]">
            <div class="w-full flex justify-end p-4 z-10">
                <div class="bg-black/40 backdrop-blur-md text-white px-4 py-1.5 rounded-full flex items-center gap-2 text-sm shadow-md border border-white/10">
                    ğŸŒŸ <span id="gacha-top-marks">0</span>
                </div>
            </div>
            
            <div class="relative w-[90%] max-w-[400px] aspect-[3/4] rounded-2xl overflow-hidden shadow-2xl border-[4px] border-[#e2d3b5] mt-2 mb-10">
                <img id="gacha-bg-img" src="https://img.heliar.top/file/1770365294783_IMG_20260206_160700.jpg" class="w-full h-full object-cover">
                
                <div class="absolute bottom-0 left-0 w-full h-1/3 bg-gradient-to-t from-black/80 to-transparent pointer-events-none"></div>

                <div class="absolute bottom-5 left-0 w-full flex justify-center gap-4 px-4">
                    <button onclick="doGacha(1)" class="flex-1 bg-gradient-to-b from-[#fdfbf6] to-[#e4d0a1] border border-[#c5a66a] text-[#5c441c] py-2.5 rounded-xl font-bold shadow-[0_4px_10px_rgba(0,0,0,0.3)] flex flex-col items-center active:scale-95 transition-transform">
                        <span class="text-sm tracking-widest">å¬å”¤1æ¬¡</span>
                        <div class="text-[10px] flex items-center gap-1 mt-0.5 opacity-80">
                            <span>ğŸŒŸ 20</span>
                        </div>
                    </button>
                    <button onclick="doGacha(10)" class="flex-1 bg-gradient-to-b from-[#fdfbf6] to-[#e4d0a1] border border-[#c5a66a] text-[#5c441c] py-2.5 rounded-xl font-bold shadow-[0_4px_10px_rgba(0,0,0,0.3)] flex flex-col items-center active:scale-95 transition-transform">
                        <span class="text-sm tracking-widest">å¬å”¤10æ¬¡</span>
                        <div class="text-[10px] flex items-center gap-1 mt-0.5 opacity-80">
                            <span>ğŸŒŸ 180</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <div id="gacha-tab-upgrade" class="flex-1 overflow-y-auto no-scrollbar p-4 hidden bg-zinc-900">
            <div id="gacha-owned-list" class="grid grid-cols-3 gap-3 pb-20"></div>
        </div>

        <div id="gacha-tab-me" class="flex-1 overflow-y-auto no-scrollbar p-6 hidden bg-zinc-900">
            <div class="flex flex-col items-center mt-10 mb-8">
                <img class="u-ava w-20 h-20 rounded-full border-2 border-[#e2d3b5] object-cover bg-zinc-800">
                <b class="u-name text-white mt-3 text-lg"></b>
                <div class="mt-2 bg-[#e2d3b5]/20 text-[#e2d3b5] px-4 py-1 rounded-full text-sm border border-[#e2d3b5]/30">
                    æˆ‘çš„å¿ƒåŠ¨å°è®°: <span id="gacha-me-marks">0</span> ğŸŒŸ
                </div>
            </div>
        </div>

        <footer class="bg-zinc-900 border-t border-zinc-800 flex justify-around items-center text-[10px] text-zinc-500 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toGachaTab('summon')" id="nav-gacha-summon" class="text-center flex-1 py-1 cursor-pointer text-[#e2d3b5] font-bold"><div class="text-xl mb-0.5">âœ¨</div>ç¥ˆæ„¿</div>
            <div onclick="toGachaTab('upgrade')" id="nav-gacha-upgrade" class="text-center flex-1 py-1 cursor-pointer text-zinc-500"><div class="text-xl mb-0.5">ğŸ´</div>å›¾é‰´</div>
            <div onclick="toGachaTab('me')" id="nav-gacha-me" class="text-center flex-1 py-1 cursor-pointer text-zinc-500"><div class="text-xl mb-0.5">ğŸ‘¤</div>æˆ‘çš„</div>
        </footer>
    </div>

    <div id="gacha-result-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex-col items-center justify-center px-4 overflow-y-auto no-scrollbar" style="backdrop-filter: blur(10px);">
        <button onclick="closeGachaResult()" class="absolute top-6 right-6 px-5 py-1.5 border-2 border-[#e4d0a1] text-[#e4d0a1] rounded-full font-bold active:bg-[#e4d0a1] active:text-black transition-colors text-sm shadow-[0_0_10px_rgba(228,208,161,0.2)] z-20">ç¡®è®¤</button>
        
        <h2 class="text-[#e4d0a1] text-xl font-bold mb-4 tracking-[0.2em] shrink-0 drop-shadow-[0_0_8px_rgba(228,208,161,0.8)]" style="font-family: 'STXingkai', 'Xingkai SC', serif;">å¬å”¤ç»“æœ</h2>
        
        <div id="gacha-result-cards" class="flex flex-col gap-1.5 w-full max-w-[380px] shrink-0"></div>
    </div>
    <div id="pg-gacha-set" class="page bg-zinc-900 z-[50] text-white">
        <header class="h-14 flex items-end justify-between p-3 border-b border-zinc-800 shrink-0 sticky top-0 bg-zinc-900">
            <span onclick="go('pg-gacha')" class="text-zinc-400 pb-1 cursor-pointer">ã€ˆ è¿”å›</span>
            <b class="pb-1 text-lg text-[#e2d3b5]">æŠ½å¡è®¾ç½®</b>
            <span class="w-12"></span>
        </header>
        <div class="p-5 space-y-4">
            <div onclick="go('pg-gacha-add')" class="bg-zinc-800 p-4 rounded-xl flex justify-between items-center active:bg-zinc-700 cursor-pointer border border-zinc-700 shadow-sm transition-colors">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ´</span>
                    <span class="text-base font-bold text-zinc-200">å½•å…¥æ–°å¡ç‰Œ</span>
                </div>
                <span class="text-zinc-500 font-bold">ã€‰</span>
            </div>
            <div onclick="changeGachaBg()" class="bg-zinc-800 p-4 rounded-xl flex justify-between items-center active:bg-zinc-700 cursor-pointer border border-zinc-700 shadow-sm transition-colors">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ–¼ï¸</span>
                    <div class="flex flex-col">
                        <span class="text-base font-bold text-zinc-200">æ›´æ¢å¡æ± èƒŒæ™¯</span>
                        <span class="text-[10px] text-zinc-400 mt-0.5">è‡ªå®šä¹‰ç¥ˆæ„¿ç•Œé¢çš„æµ·æŠ¥å›¾</span>
                    </div>
                </div>
                <span class="text-zinc-500 font-bold">ã€‰</span>
            </div>
        </div>
    </div>
ã€€ã€€
    <div id="pg-gacha-add" class="page bg-white z-[50]">
        <header class="h-14 flex items-end justify-between p-3 border-b shrink-0 sticky top-0 bg-white">
            <button onclick="go('pg-gacha')" class="text-zinc-600 pb-1">å–æ¶ˆ</button>
            <b class="pb-1 text-lg">å½•å…¥æ–°å¡ç‰Œ</b>
            <button onclick="saveNewGachaCard()" class="text-yellow-600 font-bold pb-1 text-sm">ä¿å­˜</button>
        </header>
        <div class="p-5 space-y-4 overflow-y-auto h-full pb-20">
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">æ‰€å±è§’è‰²</label><select id="gc-role-sel" class="w-full p-3 border rounded-lg bg-zinc-50 outline-none"></select></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å¡ç‰Œåç§°</label><input id="gc-name" class="w-full p-3 border rounded-lg bg-zinc-50 outline-none" placeholder="ä¾‹å¦‚ï¼šåˆåé˜³å…‰"></div>
            <div>
                <label class="block text-xs font-bold text-zinc-500 mb-1">ç¨€æœ‰åº¦</label>
                <select id="gc-rarity" class="w-full p-3 border rounded-lg bg-zinc-50 outline-none">
                    <option value="R">R (æ™®é€š)</option>
                    <option value="SR">SR (ç¨€æœ‰)</option>
                    <option value="SSR">SSR (æå“)</option>
                </select>
            </div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å¡ç‰Œå°é¢å›¾ URL (ç«–å›¾æœ€ä½³)</label><input id="gc-img" class="w-full p-3 border rounded-lg bg-zinc-50 outline-none" placeholder="http://..."></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å¡ç‰ŒèƒŒåæ•…äº‹ (å¯é€‰)</label><textarea id="gc-story" class="w-full h-24 p-3 border rounded-lg bg-zinc-50 outline-none resize-none" placeholder="ä¸€æ®µç®€çŸ­çš„ç¾ç»Šæ•…äº‹..."></textarea></div>
        </div>
    </div>
ã€€ã€€
    <script>
    const $ = id => document.getElementById(id);
    const DB_NAME = 'AI_OS_DB';
    const STORE_NAME = 'system_data';
    const DB = 'OS67_'; 
    const DB_VERSION = 1;
    let db;

    // ================== 1. IndexedDB æ ¸å¿ƒå¼•æ“ ==================
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (e) => { console.error("DB Error", e); reject("æ•°æ®åº“æ‰“å¼€å¤±è´¥"); };
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                console.log("IndexedDB è¿æ¥æˆåŠŸ");
                resolve(db);
            };
        });
    }

    function dbGet(key, defaultVal) {
        return new Promise((resolve) => {
            if(!db) return resolve(defaultVal);
            const tx = db.transaction([STORE_NAME], 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result !== undefined ? req.result : defaultVal);
            req.onerror = () => { console.warn(`Read error: ${key}`); resolve(defaultVal); };
        });
    }

    function dbSet(key, val) {
        return new Promise((resolve, reject) => {
            if(!db) return reject("DBæœªåˆå§‹åŒ–");
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const req = store.put(val, key);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }

    // ================== 2. å…¨å±€å˜é‡ä¸æ ¸å¿ƒè¾…åŠ© ==================
    let roles, chats, wbs, emjs, mnts, balance, theaters;
    let foods, cart, orders;          
    let shopGoods, shopCart, shopOrders, shopFavs; 
    let musicLib = [];       // éŸ³ä¹åº“æ•°æ®
    let curAudio = new Audio(); // åŸç”ŸéŸ³é¢‘æ’­æ”¾å™¨
    let isPlaying = false;
    let curMusicIdx = -1;
    let parsedLyrics = []; // å­˜æ”¾è§£æåçš„æ­Œè¯æ•°ç»„
    let activeLyricIdx = -1; // å½“å‰é«˜äº®çš„æ­Œè¯è¡Œå·ã€€
    let curRole = null, curWB = null, selRids = [], curTab = 'chat';
    let curMsgIdx = -1, lastPnlType = null, curTheater = null;
    let takeoutCtx = { fromChat: false, targetRoleId: null };
let vnSaves = [], heartMarks = 0;
let curVnSave = null, isVnLoading = false; 
let gachaCards = []; // å…¨æœåŸºç¡€å¡æ± 
    let ownedCards = []; // ç©å®¶æ‹¥æœ‰çš„å¡ç‰Œè®°å½•

    // å¼ºåŠ›æ¸…æ´—æ–‡æœ¬
    function cleanText(text) { 
        if (typeof text !== 'string') return '';
        let res = text.replace(/<think>[\s\S]*?<\/think>/gi, "");
        res = res.replace(/^\(Hello, I am.*?\.\)\s*/i, "").replace(/^Hello, I am.*?\.\s*/i, "");
        res = res.replace(/æˆ‘æ˜¯.*?æ¨¡å‹/g, "").replace(/```.*?/g, "").replace(/```/g, "");
        res = res.replace(/^#\s*.*$/gm, ""); // å»é™¤ç±»ä¼¼ "# ç«¹å¢¨å±…Â·åˆå"
        res = res.replace(/^\[(?!CMD:).*?\]$/gmi, ""); // æ’é™¤ [CMD:...] æŒ‡ä»¤ï¼Œé˜²æ­¢è¯­éŸ³è¢«è¯¯åˆ 
        res = res.replace(/^\s*[\r\n]/gm, ""); // å»é™¤ç”±æ­¤äº§ç”Ÿçš„ç©ºè¡Œ
        return res.trim(); 
    }

    async function cleanBadData() {
        if(!confirm("ç¡®å®šè¦æ·±åº¦æ¸…ç†å—ï¼Ÿ")) return;
        let r = await dbGet('OS67_R', []);
        r.forEach(role => {
            if (role.history && Array.isArray(role.history)) {
                role.history = role.history.filter(m => m && typeof m.t === 'string');
            } else { role.history = []; }
            if(!role.mode) role.mode = 'chat';
        });
        await dbSet('OS67_R', r);
        alert(`æ¸…ç†å®Œæˆï¼Œå³å°†åˆ·æ–°`);
        location.reload();
    }

    // ================== 3. æ•°æ®åŠ è½½ä¸ä¿å­˜ ==================
    async function loadAllData() {
        const K = 'OS67_';
        roles = await dbGet(K+'R', []);
        chats = await dbGet(K+'C', []);
        wbs = await dbGet(K+'W', []);
        emjs = await dbGet(K+'E', []);
        mnts = await dbGet(K+'M', []);
        balance = parseFloat(await dbGet(K+'BAL', '0.00'));
        theaters = await dbGet(K+'THEATERS', []);
        musicLib = await dbGet(K+'MUSIC', []);
    vnSaves = await dbGet(K+'VN_SAVES', []);
        heartMarks = await dbGet(K+'HEART_MARKS', 0);
ã€€ã€€gachaCards = await dbGet(K+'GACHA_CARDS', []);
        ownedCards = await dbGet(K+'OWNED_CARDS', []);
        foods = await dbGet(K+'FOODS', [
            { id: 1, store: "å¡”æ–¯æ±€ä¸­å›½æ±‰å ¡", name: "é¦™è¾£é¸¡è…¿å ¡å¥—é¤", price: 19.9, sales: 500, img: "https://img.meituan.net/msi/0b17156b82547565d833896409a80374116496.jpg" },
            { id: 2, store: "èœœé›ªå†°åŸ", name: "å†°é²œæŸ æª¬æ°´", price: 4.0, sales: 9999, img: "https://img.meituan.net/msi/86d38e24483584852880092305822365287313.png" },
            { id: 3, store: "éŸ©å¼ç‚¸é¸¡", name: "ç”œè¾£æ— éª¨ç‚¸é¸¡", price: 25.8, sales: 230, img: "https://p0.meituan.net/deal/832c6968037628833959952044565773108620.jpg" },
            { id: 4, store: "å–œèŒ¶ HEYTEA", name: "å¤šè‚‰è‘¡è„(é¦–åˆ›)", price: 28.0, sales: 600, img: "https://img.meituan.net/msi/e4d09320297063f2722b512c1421f18e1467402.jpg" }
        ]);
        cart = await dbGet(K+'CART', []);
        orders = await dbGet(K+'ORDERS', []);

        shopGoods = await dbGet(K+'SHOP_GOODS', [
            { id: 101, store: "å®˜æ–¹æ——èˆ°åº—", name: "æ–°æ¬¾æ™ºèƒ½æ‰‹æœº Pro Max", price: 5999.0, sales: 2000, img: "https://img.icons8.com/color/480/smartphone.png" },
            { id: 102, store: "æ½®ç‰Œé›†åˆ", name: "å®½æ¾çº¯æ£‰æƒ…ä¾£å«è¡£", price: 129.0, sales: 800, img: "https://img.icons8.com/color/480/hoodie-with-pocket.png" },
            { id: 103, store: "ç¾å¦†è‡ªè¥", name: "å¤§ç‰Œå£çº¢ çƒ‚ç•ªèŒ„è‰²", price: 299.0, sales: 5000, img: "https://img.icons8.com/color/480/lipstick.png" },
            { id: 104, store: "ç”Ÿæ´»å®¶å±…", name: "è¶…è½¯æ¯›ç»’å…¬ä»” (å¤§å·)", price: 88.0, sales: 300, img: "https://img.icons8.com/color/480/teddy-bear.png" }
        ]);
        shopCart = await dbGet(K+'SHOP_CART', []);
        shopOrders = await dbGet(K+'SHOP_ORDERS', []);
        shopFavs = await dbGet(K+'SHOP_FAVS', []);

        roles.forEach(r => { if(!r.ava) r.ava = "https://img.icons8.com/color/96/user.png"; });
    }

        async function saveAll() {
        const K = 'OS67_';
        try {
            // ğŸ¯ æ ¸å¿ƒä¿®å¤ï¼šè¿‡æ»¤æ‰è¿‡å¤§çš„éŸ³ä¹æ–‡ä»¶ï¼Œé˜²æ­¢æ•°æ®åº“å´©æºƒ
                        // ğŸ¯ æ ¸å¿ƒä¿®å¤ï¼šè¿‡æ»¤æ‰ä¸´æ—¶å­˜åœ¨çš„ blob å¯¹è±¡ï¼Œåªä¿å­˜å¸¦æœ‰çœŸå®æ•°æ®(buffer)æˆ–ç›´é“¾çš„éŸ³ä¹
            let safeMusicLib = musicLib.filter(m => !m.blob);

            await Promise.all([
                dbSet(K+'R', roles), dbSet(K+'C', chats), dbSet(K+'W', wbs),
                dbSet(K+'E', emjs), dbSet(K+'M', mnts), dbSet(K+'BAL', balance.toFixed(2)),
                dbSet(K+'THEATERS', theaters),
                dbSet(K+'MUSIC', safeMusicLib), // ä½¿ç”¨è¿‡æ»¤åçš„å®‰å…¨æ­Œå•ä¿å­˜
ã€€ã€€dbSet(K+'GACHA_CARDS', gachaCards),
                dbSet(K+'OWNED_CARDS', ownedCards),
                dbSet(K+'FOODS', foods), dbSet(K+'CART', cart), dbSet(K+'ORDERS', orders),
                dbSet(K+'SHOP_GOODS', shopGoods), dbSet(K+'SHOP_CART', shopCart),
                dbSet(K+'SHOP_ORDERS', shopOrders), dbSet(K+'SHOP_FAVS', shopFavs)
            ]);
        } catch (e) { console.error("Save Failed:", e); alert("ä¿å­˜å¤±è´¥ï¼æ£€æŸ¥å­˜å‚¨ç©ºé—´"); }
    }

    function hardReset() {
        if(confirm("ã€é«˜èƒ½è­¦å‘Šã€‘\nè¿™å°†å®Œå…¨æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼\nç¡®å®šç»§ç»­å—ï¼Ÿ")) {
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const req = tx.objectStore(STORE_NAME).clear();
            req.onsuccess = () => { alert("ç³»ç»Ÿå·²é‡ç½®"); location.reload(); };
        }
    }

    // ================== 4. è·¯ç”±ä¸å…¨å±€å¯¼èˆª ==================
    function go(id) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
ã€€ã€€let target = $(id); if(target) target.classList.add('active');
    if(id === 'pg-set') toggleSetSub('main'); // ç¡®ä¿è¿›å…¥è®¾ç½®é¡µæ—¶æ€»æ˜¯æ˜¾ç¤ºä¸»èœå•
    if(id === 'pg-music-player') renderMusicPlayer();
        if(id === 'pg-music-me') renderMusicLib();
        if(id==='pg-wb') renderWBList();
        if(id==='pg-emj') renderEmj();
        if(id==='pg-set') loadSettings();
        if(id==='pg-memory') renderMemPage();
        if(id==='pg-wallet') renderWallet();
        if(id==='pg-chat-info') renderChatInfo();
        if(id==='pg-mask-edit') loadMaskEdit();
        if(id==='pg-theater') renderTheaterList();
        if(id==='pg-theater-create') initTheaterCreate();
        if(id==='pg-takeout-home') renderFoodList();
        if(id==='pg-takeout-cart') renderCart();
        if(id==='pg-takeout-me') updatePendingBadge();
        if(id==='pg-takeout-orders') renderAllOrders();
        if(id==='pg-takeout-pending') renderPendingOrders();
        if(id==='pg-shop-favs') renderFavs(); 
        if(id==='pg-shop-home') renderShopList(); 
        if(id==='pg-shop-cart') renderShopCart(); 
        if(id==='pg-shop-me') updateShopPendingBadge(); 
    }

    function tab(t) {
        curTab = t;
        ['chat','cont','moments','me'].forEach(k=>$(`sub-${k}`).classList.add('hidden'));
        $(`sub-${t}`).classList.remove('hidden');
        document.querySelectorAll('footer div').forEach(d=>d.style.color='#999');
        let tIcon = $(`t-${t}`); if(tIcon) tIcon.style.color='#07c160';
        if(t==='chat') renderChatList();
        if(t==='cont') renderCont();
        if(t==='moments') renderMnts();
        if(t==='me') renderProfile();
    }

    // ================== 5. API é…ç½® ==================
    async function getAICfg() {
        let val = await dbGet(DB+'AI', null); 
        if (!val) {
            let local = localStorage.getItem(DB+'AI');
            val = local ? JSON.parse(local) : {};
        }
        return val || {};
    }
    // === è®¾ç½®é¡µé¢çš„è§†å›¾è·¯ç”±æ§åˆ¶ ===
    function toggleSetSub(view) {
        // å…ˆæŠŠæ‰€æœ‰çš„å¤´éƒ¨å’Œå†…å®¹éƒ½è—èµ·æ¥
        $('set-main-header').classList.add('hidden');
        $('set-main-list').classList.add('hidden');
        $('set-api-header').classList.add('hidden');
        $('set-api-detail').classList.add('hidden');
        if($('set-voice-header')) $('set-voice-header').classList.add('hidden');
        if($('set-voice-detail')) $('set-voice-detail').classList.add('hidden');

        // æ ¹æ®ä¼ å…¥çš„ view å¼€å¯å¯¹åº”é¢æ¿
        if (view === 'api') {
            $('set-api-header').classList.remove('hidden');
            $('set-api-detail').classList.remove('hidden');
            loadSettings(); 
        } else if (view === 'voice') {
            $('set-voice-header').classList.remove('hidden');
            $('set-voice-detail').classList.remove('hidden');
            loadVoiceSettings();
        } else {
            // è¿”å›ä¸»åˆ—è¡¨
            $('set-main-header').classList.remove('hidden');
            $('set-main-list').classList.remove('hidden');
            checkApiStatus(); 
            checkVoiceApiStatus(); 
        }
    }

    // === æ£€æŸ¥ API å’Œ è¯­éŸ³ çŠ¶æ€ (æ›´æ–°å‰¯æ ‡é¢˜) ===
    async function checkApiStatus() {
        let cfg = await getAICfg();
        const statusEl = $('set-api-status');
        if (statusEl) {
            if (cfg && cfg.key && cfg.url) {
                statusEl.innerText = "å·²é…ç½®";
                statusEl.className = "text-xs text-green-500";
            } else {
                statusEl.innerText = "æœªè®¾ç½®";
                statusEl.className = "text-xs text-red-500";
            }
        }
    }

    // === æ–°å¢ï¼šè¯­éŸ³ç³»ç»Ÿè¯»å†™é€»è¾‘ ===
    async function getVoiceCfg() {
        let val = await dbGet('OS67_VOICE', null); 
        if (!val) {
            let local = localStorage.getItem('OS67_VOICE');
            val = local ? JSON.parse(local) : {};
        }
        return val || {};
    }
    async function loadVoiceSettings() {
        let cfg = await getVoiceCfg();
        // æ–°å¢ï¼šè¯»å–å¹¶æ˜¾ç¤ºå·²ä¿å­˜çš„ URLï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºé»˜è®¤çš„ MiniMax å®˜æ–¹åœ°å€
        if($('in-v-u')) $('in-v-u').value = cfg.url || 'https://api.minimax.chat/v1/t2a_v2';
        if($('in-v-id')) $('in-v-id').value = cfg.groupId || '';
        if($('in-v-k')) $('in-v-k').value = cfg.key || '';
    }

    async function saveVoiceSettings() {
        await dbSet('OS67_VOICE', {
            url: $('in-v-u').value.trim(), // æ–°å¢ï¼šæŠŠ URL ä¹Ÿå­˜è¿›æœ¬åœ°æ•°æ®åº“
            groupId: $('in-v-id').value.trim(),
            key: $('in-v-k').value.trim()
        });
        alert("ğŸ‰ è¯­éŸ³ç³»ç»Ÿé…ç½®å·²ä¿å­˜ï¼");
        toggleSetSub('main');
    }

    // === å‡çº§ç‰ˆï¼šåŠ¨æ€è¯»å–ç•Œé¢å¡«å†™çš„ URL è¿›è¡Œè¿é€šæ€§æµ‹è¯• ===
    async function testVoiceConnection(e) {
        let rawUrl = $('in-v-u').value.trim() || 'https://api.minimax.chat/v1/t2a_v2';
        let groupId = $('in-v-id').value.trim();
        let key = $('in-v-k').value.trim();

        if (!groupId || !key || !rawUrl) {
            return alert("âš ï¸ è¯·å…ˆå¡«å†™å®Œæ•´ API åœ°å€ã€ID å’Œå¯†é’¥ï¼");
        }

        let btn = e.target;
        let oldText = btn.innerText;
        btn.innerText = "â³ ä»£ç†æµ‹è¯•ä¸­...";
        btn.disabled = true;
        btn.classList.add('opacity-50');

        try {
            // 1. æ‹¼æ¥åŸå§‹çš„ç›®æ ‡è¯·æ±‚åœ°å€
            let targetUrl = rawUrl.includes('?') ? `${rawUrl}&GroupId=${groupId}` : `${rawUrl}?GroupId=${groupId}`;
            
            // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šæ¢æˆæ‚¨åˆšåˆšæ­å»ºçš„ä¸“å±ä¸­è½¬æœåŠ¡å™¨ï¼
            let myProxyServer = "https://muqinghuai.top";
            let proxyUrl = myProxyServer + "/?target=" + encodeURIComponent(targetUrl);

            // 3. å°†è¯·æ±‚å‘ç»™ä¸­è½¬æœåŠ¡å™¨
            let res = await fetch(proxyUrl, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: "speech-01-turbo",
                    text: "æµ‹è¯•",
                    voice_id: "male-qn-qingse"
                })
            });
            
            let data = await res.json();
            
            if (res.ok || (data.base_resp && data.base_resp.status_code === 0)) {
                alert("âœ… è¿æ¥æˆåŠŸï¼è·¨åŸŸä¸­è½¬ç”Ÿæ•ˆï¼Œä½ çš„å¯†é’¥éªŒè¯é€šè¿‡ï¼Œå¯ä»¥ä¿å­˜å•¦ï¼");
            } else {
                let errMsg = data.base_resp ? data.base_resp.status_msg : JSON.stringify(data);
                alert("âŒ è¿æ¥å¤±è´¥ï¼ŒMiniMax æ‹’ç»äº†è¯·æ±‚ï¼š\n" + errMsg);
            }
        } catch (err) {
            alert("âŒ ç½‘ç»œè¯·æ±‚ä»ç„¶å¤±è´¥ï¼\né”™è¯¯è¯¦æƒ…ï¼š" + err.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        }
    }
    async function checkVoiceApiStatus() {
        let cfg = await getVoiceCfg();
        const statusEl = $('set-voice-status');
        if (statusEl) {
            if (cfg && cfg.key && cfg.groupId) {
                statusEl.innerText = "å·²é…ç½®";
                statusEl.className = "text-xs text-green-500";
            } else {
                statusEl.innerText = "æœªè®¾ç½®";
                statusEl.className = "text-xs text-red-500";
            }
        }
    }
    async function loadSettings() { 
        let cfg = await getAICfg(); 
        if($('in-s-u')) $('in-s-u').value = cfg.url || ''; 
        if($('in-s-k')) $('in-s-k').value = cfg.key || ''; 
        if($('in-s-m')) $('in-s-m').value = cfg.model || ''; 
    }
    async function saveSettings() { 
    await dbSet(DB+'AI', { 
        url: $('in-s-u').value.trim(), 
        key: $('in-s-k').value.trim(), 
        model: $('in-s-m').value.trim() 
    }); 
    alert("é…ç½®å·²ä¿å­˜ï¼"); 
    toggleSetSub('main'); // ä¿å­˜åè¿”å›è®¾ç½®ä¸»åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ç›´æ¥é€€å‡º
}
    async function fetchModels() { 
        let u=$('in-s-u').value, k=$('in-s-k').value; 
        if(!u||!k) return alert("è¯·å…ˆå¡«å†™ URL å’Œ Key"); 
        try { 
            let res = await fetch(`https://muqinghuai.top/?target=${u}/v1/models`, { headers:{"Authorization":`Bearer ${k}`} }); 
            let d = await res.json(); 
            if(d.data && Array.isArray(d.data)) { 
                $('model-select').innerHTML = d.data.map(m=>`<option value="${m.id}">${m.id}</option>`).join(''); 
                $('model-select').classList.remove('hidden'); 
                alert("æ‹‰å–æˆåŠŸ"); 
            } else { alert("è·å–å¤±è´¥"); } 
        } catch(e) { alert("ç½‘ç»œè¿æ¥å¤±è´¥"); } 
    }

    // ================== 6. æœ‹å‹åœˆä¸ä¸ªäººä¿¡æ¯ ==================
    async function renderProfile() { 
        let p = await dbGet(DB+'U', null);
        if (!p) {
            let local = localStorage.getItem(DB+'U');
            p = local ? JSON.parse(local) : {name:"æˆ‘çš„æ˜µç§°", ava:"https://img.icons8.com/color/96/user.png", bg:"", info:"æ™®é€šç”¨æˆ·"};
        }
        document.querySelectorAll('.u-name').forEach(e=>e.innerText=p.name);
        document.querySelectorAll('.u-ava').forEach(e=>e.src=p.ava);
        if($('u-info-box')) $('u-info-box').innerText = p.info;
        if($('moment-bg')) $('moment-bg').style.backgroundImage = `url('${p.bg||''}')`;
    }
    async function updProf(k, l) { 
        let p = await dbGet(DB+'U', {name:"æˆ‘çš„æ˜µç§°", ava:"https://img.icons8.com/color/96/user.png", bg:"", info:"æ™®é€šç”¨æˆ·"});
        let n = prompt(`ä¿®æ”¹${l}`, p[k]); 
        if(n!==null) { p[k]=n; await dbSet(DB+'U', p); renderProfile(); } 
    }

    function renderMnts() {
        let p = {name:"æˆ‘", ava:"https://img.icons8.com/color/96/user.png"}; 
        let sorted = mnts.sort((a,b) => b.time - a.time);
        $('mnts-list').innerHTML = sorted.map((m, i) => {
            let isMe = m.r === 'u';
            let role = isMe ? null : roles.find(r=>r.id==m.r);
            let name = isMe ? "æˆ‘" : (role?.name || 'æœªçŸ¥ç”¨æˆ·');
            let ava = isMe ? document.querySelector('.u-ava').src : (role?.ava || '');
            let content = m.content || '';
            let imgHtml = m.img ? `<img src="${m.img}" class="max-h-60 max-w-[80%] mt-2 rounded-lg cursor-pointer object-cover" onclick="window.open('${m.img}')">` : '';
            let timeStr = new Date(m.time).toLocaleString();
            
            let commentsHtml = '';
            if(m.comments && m.comments.length > 0) {
                let cList = m.comments.map(c => {
                    let cName = c.uid === 'me' ? "æˆ‘" : (roles.find(r=>r.id==c.uid)?.name || 'æœªçŸ¥');
                    let replyTarget = c.replyToName ? `å›å¤ <span class="text-zinc-800 font-bold">${c.replyToName}</span>` : '';
                    let cNameEscaped = cName.replace(/'/g, "\\'");
                    return `<div class="text-sm comment-row cursor-pointer" onclick="handleCommentClick(${m.id}, '${c.uid}', '${cNameEscaped}')"><span class="text-[#576b95] font-bold">${cName}</span> ${replyTarget}: <span class="text-zinc-800">${c.content}</span></div>`;
                }).join('');
                commentsHtml = `<div class="bg-zinc-100 p-2 rounded mt-2 flex flex-col gap-1">${cList}</div>`;
            }
            
            let likeBtnText = (m.likes && m.likes.includes('me')) ? 'â¤ï¸' : 'â™¡';
            let delBtn = `<span onclick="delMoment(${m.id})" class="text-xs text-zinc-400 ml-3 cursor-pointer hover:text-red-500">åˆ é™¤</span>`;

            return `<div class="flex gap-3 p-4 border-b border-zinc-100 animate-fade-in group"><img src="${ava}" class="w-10 h-10 rounded-lg bg-zinc-200 shrink-0"><div class="flex-1 min-w-0"><b class="text-[#576b95] cursor-pointer text-[15px]">${name}</b><div class="text-[15px] text-zinc-800 mt-1 whitespace-pre-wrap leading-relaxed">${content}</div>${imgHtml}<div class="flex justify-between items-center mt-2 mb-2"><div class="flex items-center"><span class="text-xs text-zinc-400">${timeStr}</span>${delBtn}</div><div class="bg-zinc-100 rounded-md flex items-center shadow-sm opacity-90"><button onclick="toggleLike(${m.id})" class="px-3 py-1 text-zinc-600 active:scale-90 transition-transform">${likeBtnText}</button><div class="w-[1px] h-3 bg-zinc-300"></div><button onclick="addComment(${m.id})" class="px-3 py-1 text-zinc-600 active:scale-90 transition-transform">ğŸ’¬</button></div></div>${commentsHtml}</div></div>`;
        }).join('');
    }

    function toggleLike(mid) { let m = mnts.find(x => x.id === mid); if(!m) return; if(!m.likes) m.likes = []; if(m.likes.includes('me')) { m.likes = m.likes.filter(x => x !== 'me'); } else { m.likes.push('me'); } saveAll(); renderMnts(); }
    function handleCommentClick(mid, targetUid, targetName) { if(targetUid === 'me') { if(confirm("åˆ é™¤è¿™æ¡è¯„è®ºï¼Ÿ")) { let m = mnts.find(x => x.id === mid); if(m && m.comments) { let idx = m.comments.findIndex(c => c.uid === 'me'); if(idx > -1) m.comments.splice(idx, 1); saveAll(); renderMnts(); } } return; } addComment(mid, targetUid, targetName); }
    function addComment(mid, replyToUid = null, replyToName = null) { let promptText = replyToName ? `å›å¤ ${replyToName}:` : "è¯„è®º:"; let content = prompt(promptText); if(!content) return; let m = mnts.find(x => x.id === mid); if(!m) return; if(!m.comments) m.comments = []; let newComment = { uid: 'me', content: content, time: Date.now() }; if(replyToUid && replyToName) { newComment.replyTo = replyToUid; newComment.replyToName = replyToName; } m.comments.push(newComment); saveAll(); renderMnts(); setTimeout(() => triggerAiReplyToComment(mid, content, replyToUid), 2000); }
    function delMoment(mid) { if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡æœ‹å‹åœˆå—ï¼Ÿ")) return; mnts = mnts.filter(x => x.id !== mid); saveAll(); renderMnts(); }
    function submitMoment() { let txt = $('in-m-t').value; let img = $('in-m-img').value; if(!txt && !img) return alert("å†™ç‚¹ä»€ä¹ˆå§"); let newId = Date.now(); mnts.unshift({ id: newId, r: 'u', content: txt, img: img, time: Date.now(), likes: [], comments: [] }); saveAll(); $('in-m-t').value = ''; $('in-m-img').value = ''; go('pg-wechat'); tab('moments'); setTimeout(() => triggerAiReaction(newId, txt), 2000); }
    function triggerRolePost(force = false) { if(!force) return; let r = roles[0]; if(!r) return; mnts.unshift({ id: Date.now(), r: r.id, content: `[${r.name}] æµ‹è¯•è‡ªåŠ¨å‘åœˆ`, img: "", time: Date.now(), likes:[], comments:[] }); saveAll(); renderMnts(); }

    // ================== 7. ä¸–ç•Œä¹¦ä¸è¡¨æƒ…åŒ… ==================
    function openWBEdit(id) { curWB = id ? wbs.find(x=>x.id===id) : null; $('in-wb-n').value = curWB ? curWB.name : ''; $('in-wb-c').value = curWB ? curWB.content : ''; selRids = curWB ? [...curWB.rids] : []; renderWBSelect(); go('pg-wb-edit'); }
    function renderWBSelect() { $('wb-roles-sel').innerHTML = roles.map(r => `<div onclick="toggleWBR('${r.id}', this)" class="role-chip px-4 py-1.5 rounded-full text-xs cursor-pointer ${selRids.includes(r.id)?'selected':''}">${r.name}</div>`).join(''); }
    function toggleWBR(id, el) { if(selRids.includes(id)) { selRids = selRids.filter(x=>x!==id); el.classList.remove('selected'); } else { selRids.push(id); el.classList.add('selected'); } }
    function saveWB() { let b = { id: curWB?curWB.id:Date.now(), name:$('in-wb-n').value, content:$('in-wb-c').value, rids:selRids }; if(curWB) wbs = wbs.map(x=>x.id===curWB.id?b:x); else wbs.push(b); saveAll(); go('pg-wb'); }
    function renderWBList() { $('wb-list-box').innerHTML = wbs.map(b => `<div class="p-4 bg-white rounded-xl shadow-sm flex justify-between items-center"><div><b>${b.name}</b><p class="text-[10px] text-zinc-400 mt-1">ç»‘å®š: ${b.rids.length}</p></div><button onclick="openWBEdit(${b.id})" class="text-blue-500">ç¼–è¾‘</button></div>`).join(''); }
    
    function addEmj() { let u=prompt("å›¾ç‰‡ç›´é“¾"), n=prompt("å«ä¹‰"); if(u&&n){ emjs.push({url:u,note:n}); saveAll(); renderEmj(); } }
    function renderEmj() { $('emj-box').innerHTML = emjs.map((e,i)=>`<div class="relative"><img src="${e.url}" class="w-full h-14 object-cover border rounded-lg"><span onclick="emjs.splice(${i},1);saveAll();renderEmj()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">Ã—</span></div>`).join(''); }
    
    function closeAllMenus() { }

   // ================== 8. è§’è‰²ç®¡ç†ä¸è®°å¿†æ®¿å ‚ ==================
    function renderCont() { $('sub-cont').innerHTML = roles.map(r => `<div class="p-4 flex justify-between items-center bg-white active:bg-zinc-50 border-b"><div class="flex items-center gap-3"><img src="${r.ava}" class="w-10 h-10 rounded-lg bg-zinc-100"><b>${r.name}</b></div><button onclick="openRoleEdit('${r.id}')" class="text-blue-500 text-xs border border-blue-200 px-3 py-1 rounded-full">è®¾å®š</button></div>`).join(''); }
    function openRoleEdit(id) { curRole = id ? roles.find(x=>x.id==id) : null; $('in-r-n').value = curRole ? curRole.name : ''; $('in-r-a').value = curRole ? curRole.ava : ''; $('in-r-i').value = curRole ? curRole.info : ''; $('del-role-btn').style.display = curRole ? 'block' : 'none'; go('pg-role-edit'); }
    function saveRole() { let r = { id: curRole?curRole.id:Date.now(), name:$('in-r-n').value, ava:$('in-r-a').value, info:$('in-r-i').value, history: curRole?curRole.history:[] }; if(curRole) roles = roles.map(x=>x.id===curRole.id?r:x); else roles.push(r); saveAll(); go('pg-wechat'); tab('cont'); }
    function deleteRole() { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")){ roles=roles.filter(x=>x.id!==curRole.id); chats=chats.filter(id=>id!==curRole.id); saveAll(); go('pg-wechat'); tab('cont'); } }
    
    function renderMemPage() { let html = roles.map(r => { if (!r.memories || r.memories.length === 0) return ''; let volumes = []; for (let i = 0; i < r.memories.length; i += 10) { let chunk = r.memories.slice(i, i + 10); let volNum = Math.floor(i / 10) + 1; let contentHtml = chunk.map((m, idx) => `<div class="mb-2 text-sm text-zinc-600 border-b border-dashed pb-2"><b class="text-yellow-600">${i + idx + 1}:</b> ${m}</div>`).join(''); volumes.push(`<details class="mb-2 ml-4"><summary class="text-sm font-bold text-zinc-500 cursor-pointer p-2 hover:bg-zinc-100 rounded select-none">ğŸ“œ ç¬¬ ${volNum} å· (è®°å½• ${i+1}-${i+chunk.length})</summary><div class="p-3 bg-zinc-50 rounded-lg mt-1 border border-zinc-200">${contentHtml}</div></details>`); } return `<details class="bg-white p-4 rounded-xl shadow-sm group mb-4"><summary class="flex items-center gap-3 cursor-pointer list-none select-none"><img src="${r.ava}" class="w-10 h-10 rounded-lg bg-zinc-100"><div class="flex-1 font-bold text-lg text-zinc-800">${r.name}</div><span class="text-xs text-zinc-400 bg-zinc-100 px-2 py-1 rounded-full">å…± ${r.memories.length} æ¡</span><span class="transition-transform group-open:rotate-90">â–¶</span></summary><div class="mt-4 border-t pt-2 space-y-1">${volumes.join('')}</div></details>`; }).join(''); $('memory-list').innerHTML = html || '<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— è®°å¿†æ¡£æ¡ˆ<br>å¤šèŠèŠå¤©ï¼Œå½“å¯¹è¯è¶…è¿‡20æ¡æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ...</div>'; }
    async function summarizeMemory() { let cfg = await getAICfg(); if (!cfg.key) return; let earlyMsgs = curRole.history.slice(0, 10); let chatText = earlyMsgs.map(m => (m.r === 'u' ? 'ç”¨æˆ·:' : 'ä½ :') + m.t).join('\n'); let prompt = `å‰§æƒ…æ‘˜è¦:\n${chatText}\n\næ¦‚æ‹¬ä¸ºç®€ç»ƒçš„å‰§æƒ…ï¼Œç¬¬ä¸‰äººç§°ï¼Œ100å­—å†…ã€‚`; try { let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] }) }); let data = await res.json(); let newSummary = data.choices[0].message.content; if (!curRole.memories) curRole.memories = []; curRole.memories.push(newSummary); curRole.history.splice(0, 10); saveAll(); } catch (e) { console.error(e); } }
    // ================== 9. èŠå¤©ç³»ç»Ÿ (å®Œæ•´é‡æ„ç‰ˆ) ==================
    function applyChatBg() { if(curRole && curRole.chatBg) { $('chat-msgs').style.backgroundImage = `url('${curRole.chatBg}')`; } else { $('chat-msgs').style.backgroundImage = 'none'; } }
    function setChatBg() { let url = prompt("è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL:", (curRole && curRole.chatBg) ? curRole.chatBg : ""); if(url !== null) { if(curRole) { curRole.chatBg = url; saveAll(); applyChatBg(); } } }
    function enterChat(id) { 
        try {
            curRole = roles.find(x => x.id == id); 
            if (!curRole) { alert("æ•°æ®å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨ä¿®å¤"); chats = chats.filter(c => c != id); saveAll(); renderChatList(); return; }
            if(!chats.includes(curRole.id)) { chats.unshift(curRole.id); saveAll(); } 
            
            if (!curRole.mode) curRole.mode = 'chat'; 
            
            // è·¯ç”±åˆ†å‘ï¼šåˆ¤æ–­è¯¥è§’è‰²ä¸Šæ¬¡æ˜¯åœ¨å¾®ä¿¡é‡Œï¼Œè¿˜æ˜¯åœ¨çº¿ä¸‹è§é¢ä¸­
            if (curRole.mode === 'story') {
                $('story-user-name').innerText = `ä¸ ${curRole.name} çº¿ä¸‹è§é¢`;
                go('pg-story-room');
            } else {
                $('chat-user-name').innerText = curRole.name; 
                updateChatModeUI(); 
                applyChatBg(); 
                go('pg-chat-room'); 
            }
            renderMsgs(); 
        } catch (e) { alert("è¿›å…¥èŠå¤©å¤±è´¥: " + e.message); }
    }
    function toggleChatMode() { if (!curRole) return; curRole.mode = (curRole.mode === 'story') ? 'chat' : 'story'; saveAll(); updateChatModeUI(); renderMsgs(); }
        function updateChatModeUI() { 
        if (!curRole) return; 
        // å› ä¸ºçº¿ä¸Šå’Œçº¿ä¸‹å·²ç»å½»åº•åˆ†ç¦»ä¸ºä¸¤ä¸ªé¡µé¢ï¼Œè¿™é‡Œåªéœ€è¦å›ºå®šæ˜¾ç¤ºå¾®ä¿¡çš„çŠ¶æ€å³å¯
        let modeTag = $('chat-mode-tag');
        if(modeTag) {
            modeTag.innerText = 'çŸ­å¥æ¨¡å¼'; 
            modeTag.className = "text-[10px] text-zinc-400"; 
        }
        let chatIn = $('chat-in');
        if(chatIn) {
            chatIn.placeholder = "è¾“å…¥æ¶ˆæ¯..."; 
        }
    }
    
    function togglePnl(type) { const pnl = $('chat-pnl'); const isOpen = pnl.classList.contains('drawer-open'); if (isOpen && lastPnlType === type) { pnl.classList.remove('drawer-open'); lastPnlType = null; } else { pnl.classList.add('drawer-open'); lastPnlType = type; if (type === 'emoji') renderEmjPnl(); else renderToolsPnl(); } }
    function renderEmjPnl() { if (emjs.length === 0) { $('chat-pnl').innerHTML = `<div class="text-center text-zinc-300 text-xs py-10">æš‚æ— è¡¨æƒ…åŒ…<br>å»â€œæˆ‘-è¡¨æƒ…åŒ…ç®¡ç†â€æ·»åŠ ä¸€äº›å§~</div>`; return; } $('chat-pnl').innerHTML = `<div class="grid grid-cols-5 gap-4 p-4">${emjs.map(e => `<img src="${e.url}" onclick="handleSendMsg('${e.url}','image'); $('chat-pnl').classList.remove('drawer-open');" class="w-full h-14 object-contain bg-white rounded-lg border border-zinc-100 p-1 active:scale-95 transition-transform shadow-sm cursor-pointer">`).join('')}</div>`; }
         function renderToolsPnl() {
        $('chat-pnl').innerHTML = `
            <div class="grid grid-cols-4 gap-6 p-6">
                <div onclick="startTransfer()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center border border-zinc-200 shadow-sm"><span class="text-2xl">ğŸ§§</span></div><span class="text-xs text-zinc-500">è½¬è´¦</span></div>
                <div onclick="openTakeoutFromChat()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-[#FFD101] rounded-xl flex items-center justify-center border border-yellow-300 shadow-sm"><span class="text-2xl">ğŸ¥¡</span></div><span class="text-xs text-zinc-500">ç‚¹å¤–å–</span></div>
                <div onclick="openShopFromChat()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-[#ff6700] rounded-xl flex items-center justify-center border border-orange-300 shadow-sm"><span class="text-2xl">ğŸ›ï¸</span></div><span class="text-xs text-zinc-500">é€›å•†åœº</span></div>
                <div onclick="openDiaryPage()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-blue-50 rounded-xl flex items-center justify-center border border-blue-200 shadow-sm"><span class="text-2xl">ğŸ“–</span></div><span class="text-xs text-zinc-500">æ—¥è®°</span></div>
                                <div onclick="toMusicTab('player'); go('pg-music-player')" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70">
                    <div class="w-14 h-14 bg-pink-50 border-pink-200 rounded-xl flex items-center justify-center border shadow-sm"><span class="text-2xl">ğŸµ</span></div>
                    <span class="text-xs text-zinc-500">éŸ³ä¹</span>
                </div>
                <div onclick="enterStoryRoom()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70">
                    <div class="w-14 h-14 bg-purple-50 border-purple-200 rounded-xl flex items-center justify-center border shadow-sm"><span class="text-2xl">ğŸƒ</span></div>
                    <span class="text-xs text-zinc-500">çº¿ä¸‹è§é¢</span>
                </div>
            </div>`;
    }

    // --- è¿›å…¥/é€€å‡º çº¿ä¸‹äº’åŠ¨é¡µé¢çš„æ ¸å¿ƒæ§åˆ¶ ---
        function enterStoryRoom() {
        if (!curRole) return;
        $('chat-pnl').classList.remove('drawer-open');
        lastPnlType = null;
        
        curRole.mode = 'story';
        $('story-user-name').innerText = `ä¸ ${curRole.name} çº¿ä¸‹è§é¢`;
        
        // æ ¸å¿ƒï¼šåŠ ä¸Š scene: 'story' æ ‡ç­¾
        curRole.history.push({ r: 'system', t: 'ã€ç³»ç»Ÿæç¤ºï¼šä½ ä»¬çš„åœºæ™¯å·²åˆ‡æ¢è‡³çº¿ä¸‹å®ä½“è§é¢ï¼å°±åœ¨æ­¤åˆ»ï¼è¯·æ ¹æ®å½“é¢ç¯å¢ƒè¿›è¡ŒçœŸå®çš„åŠ¨ä½œã€ç¥æ€å’Œè¯­è¨€äº’åŠ¨ï¼Œç»å¯¹ä¸è¦å†åƒå‘å¾®ä¿¡ä¸€æ ·èŠå¤©ï¼ã€‘', type: 'system', scene: 'story' });
        saveAll();
        
        go('pg-story-room');
        renderMsgs();
    }

    function exitStoryMode() {
        if (!curRole) return;
        curRole.mode = 'chat';
        
        // æ ¸å¿ƒï¼šåŠ ä¸Š scene: 'chat' æ ‡ç­¾
        curRole.history.push({ r: 'system', t: 'ã€ç³»ç»Ÿæç¤ºï¼šçº¿ä¸‹è§é¢å·²ç»“æŸï¼Œä½ ä»¬å„è‡ªå›å®¶äº†ã€‚ç°åœ¨ä½ ä»¬æ­£åœ¨é€šè¿‡å¾®ä¿¡çº¿ä¸ŠèŠå¤©ã€‚åªèƒ½æ‰“å­—ï¼Œç»å¯¹ä¸è¦è¾“å‡ºä»»ä½•åŠ¨ä½œæå†™ï¼ã€‘', type: 'system', scene: 'chat' });
        saveAll();
        
        updateChatModeUI();
        applyChatBg();
        go('pg-chat-room');
        renderMsgs();
    }

    function openShopFromChat() { if (!curRole) return; takeoutCtx = { fromChat: true, targetRoleId: curRole.id }; $('chat-pnl').classList.remove('drawer-open'); toShopTab('home'); go('pg-shop-home'); }
    function openTakeoutFromChat() { if (!curRole) return; takeoutCtx = { fromChat: true, targetRoleId: curRole.id }; $('chat-pnl').classList.remove('drawer-open'); toTakeoutTab('home'); go('pg-takeout-home'); }

    // è½¬è´¦é€»è¾‘
    function startTransfer() { $('chat-pnl').classList.remove('drawer-open'); lastPnlType = null; let val = prompt("è¯·è¾“å…¥è½¬è´¦é‡‘é¢:"); if (val === null) return; let amt = parseFloat(val); if (isNaN(amt) || amt <= 0.01) return alert("é‡‘é¢æ ¼å¼ä¸æ­£ç¡®"); if (amt > balance) return alert(`å¾®ä¿¡é›¶é’±ä¸è¶³ï¼å½“å‰åªæœ‰ Â¥${balance.toFixed(2)}`); balance -= amt; saveAll(); handleSendMsg(amt.toFixed(2), 'transfer'); }
    function openTransferDetail(idx) { curMsgIdx = idx; let msg = curRole.history[idx]; $('tx-amount').innerText = parseFloat(msg.t).toFixed(2); let statusEl = $('tx-status'), iconEl = $('tx-icon'), btnReceive = $('btn-tx-receive'), linkReturn = $('link-tx-return'), infoBox = $('tx-info-box'); btnReceive.classList.add('hidden'); linkReturn.classList.add('hidden'); infoBox.classList.add('hidden'); statusEl.className = "text-xl mb-2 text-[#f79c4a]"; if (msg.status === 'received') { statusEl.innerText = "å·²æ”¶æ¬¾"; statusEl.className = "text-xl mb-2 text-zinc-500"; iconEl.innerText = "âœ”"; infoBox.classList.remove('hidden'); $('tx-time-rcv').innerText = msg.rcvTime || 'æœªçŸ¥'; } else if (msg.status === 'returned') { statusEl.innerText = "å·²é€€è¿˜"; statusEl.className = "text-xl mb-2 text-red-500"; iconEl.innerText = "â†©"; infoBox.classList.remove('hidden'); $('tx-time-rcv').innerText = "å·²åŸè·¯é€€å›"; } else { if (msg.r === 'ai') { statusEl.innerText = "å¾…ä½ æ”¶æ¬¾"; iconEl.innerText = "ğŸ’°"; btnReceive.classList.remove('hidden'); linkReturn.classList.remove('hidden'); } else { statusEl.innerText = `ç­‰å¾… ${curRole.name} ç¡®è®¤æ”¶æ¬¾`; iconEl.innerText = "â³"; } } go('pg-transfer-detail'); }
    function doReceiveTransfer() { if (curMsgIdx === -1) return; let msg = curRole.history[curMsgIdx]; if (msg.status !== 'pending') return; balance += parseFloat(msg.t); msg.status = 'received'; msg.rcvTime = new Date().toLocaleString(); curRole.history.push({ r: 'system', t: `ä½ å·²æ”¶æ¬¾`, type: 'system' }); saveAll(); renderWallet(); renderMsgs(); openTransferDetail(curMsgIdx); }
    function doReturnTransfer() { if (curMsgIdx === -1) return; let msg = curRole.history[curMsgIdx]; if (msg.status !== 'pending') return; msg.status = 'returned'; msg.rcvTime = new Date().toLocaleString(); curRole.history.push({ r: 'system', t: `ä½ é€€è¿˜äº†${curRole.name}çš„è½¬è´¦`, type: 'system' }); saveAll(); renderMsgs(); openTransferDetail(curMsgIdx); }

    // æ ¸å¿ƒæ”¶å‘æ¶ˆæ¯é€»è¾‘ (å¢åŠ äº†æå…¶ä¸¥æ ¼çš„è¯­éŸ³è§„åˆ™)
    async function handleSendMsg(customVal, type='text', isRetry=false) {
        let txt = customVal;
        if (!txt) {
            txt = (curRole.mode === 'story') ? $('story-in').value : $('chat-in').value;
        }
        let targetRole = curRole;
        
        if (txt || type !== 'text') {
            if (!isRetry) { 
                let newMsg = { r: 'u', t: txt, type: type, status: 'pending', time: new Date().toLocaleString(), scene: curRole.mode };
                targetRole.history.push(newMsg);
            }
            if (!customVal) {
                if (curRole.mode === 'story') $('story-in').value = '';
                else $('chat-in').value = '';
            }
            renderMsgs(); 
            if (!isRetry) return; 
        } else {
            if (targetRole.history.length > 0 && targetRole.history[targetRole.history.length-1].loading) return;
        }

        let cfg = await getAICfg(); 
        let globalUser = await dbGet('OS67_U', {}); 
        let worldCtx = wbs.filter(b => b.rids?.includes(targetRole.id)).map(b => b.content).join('\n'); 
        let mask = targetRole.userMask || {}; 
        let effectiveUser = { name: mask.name || globalUser.name || "ç”¨æˆ·", info: mask.info || "æ™®é€šç”¨æˆ·" }; 
        let longTermMem = targetRole.memories ? `è®°å¿†:${targetRole.memories.slice(-3).join('; ')}` : '';
        
        let modeSysPrompt = ""; let modeReinforce = "";
        if (targetRole.mode === 'story') { 
            if (targetRole.isGroup) {
                modeSysPrompt = `ã€æ¨¡å¼:çº¿ä¸‹æ²‰æµ¸å¼å¤šæ–¹äº’åŠ¨å°è¯´ã€‘\n1. æ ¸å¿ƒçŠ¶æ€ï¼šä½ ä»¬ç°åœ¨æ­£ã€èšåœ¨ä¸€èµ·ã€‘çº¿ä¸‹è§é¢ã€‚\n2. **å¼ºåˆ¶è¦æ±‚ï¼šè§’è‰²é—´äº’åŠ¨**ã€‚ä¸ä»…è¦å’Œç”¨æˆ·äº’åŠ¨ï¼Œã€è§’è‰²ä¸è§’è‰²ä¹‹é—´ã€‘å¿…é¡»äº§ç”Ÿæ¥è¯ã€çœ¼ç¥äº¤æµæˆ–åŠ¨ä½œç¢°æ’ã€‚\n3. **æ§åˆ¶ç¯‡å¹…**ï¼šé¿å…å•ä¸ªè§’è‰²è¾“å‡ºè¿‡é•¿çš„æ–‡å­¦æå†™ã€‚å¢åŠ å¯¹è¯é¢‘ç‡ã€‚\n4. **ã€æœ€é‡è¦æ’ç‰ˆè§„åˆ™ã€‘**ï¼šè¿™æ˜¯ä¸€ç¯‡è¿ç»­çš„å°è¯´ï¼è¯·æ— è§†ä½ åº•å±‚çš„â€œè§’è‰²åï¼šâ€ç¾¤èŠè§„åˆ™ï¼**ç»å¯¹ä¸è¦**åœ¨æ®µè½å¼€å¤´åŠ â€œè§’è‰²åï¼šâ€è¿™ç§ç½‘èŠå‰ç¼€ï¼è¯·ç›´æ¥æŠŠè§’è‰²åå­—è‡ªç„¶åœ°æ‰è¿›å¥å­é‡Œã€‚`;
                modeReinforce = `(Systemå¼ºåˆ¶ï¼šè¿™æ˜¯å¤šäººç¾¤èšçš„å®ä½“å°è¯´æ¨¡å¼ï¼ç¦æ­¢ä½¿ç”¨â€œåå­—ï¼šâ€å‰ç¼€ï¼Œç›´æ¥æŠŠåå­—å†™è¿›å¥å­é‡Œæå†™åŠ¨ä½œå’Œè¯­è¨€ï¼è§’è‰²ä¹‹é—´å¿…é¡»æœ‰äº’åŠ¨ï¼)`;
            } else {
                modeSysPrompt = `ã€æ¨¡å¼:æ²‰æµ¸å¼çº¿ä¸‹äº’åŠ¨ã€‘\n1. è¯·ä½¿ç”¨å‡ºç‰ˆçº§å°è¯´ç¬”æ³•ï¼ŒåŠ¨ä½œæå†™å¿…é¡»ä¸°å¯Œã€‚\n2. æ ¸å¿ƒçŠ¶æ€ï¼šä½ ä»¬ç°åœ¨æ˜¯ã€çº¿ä¸‹ç‰©ç†è§é¢ã€‘çŠ¶æ€ã€‚\n3. **ä¸¥ç¦**è¾“å‡ºç±»ä¼¼â€œ# åœ°ç‚¹â€ã€â€œ[æ—¶é—´]â€çš„åœºæ™¯æ ‡è®°ï¼Œç›´æ¥è¾“å‡ºæ­£æ–‡ï¼`; 
                modeReinforce = `(Systemå¼ºåˆ¶ï¼šå½“å‰æ˜¯çº¿ä¸‹å®ä½“äº’åŠ¨ï¼Œè¯·åŒ…å«ä¸°å¯Œçš„åŠ¨ä½œæå†™)`;
            }
        } else { 
            modeSysPrompt = `ã€æ¨¡å¼:çº¿ä¸Šå¾®ä¿¡çŸ­èŠã€‘\n1. æ ¸å¿ƒçŠ¶æ€ï¼šä½ ä»¬ç°åœ¨æ˜¯ã€éš”ç€æ‰‹æœºå±å¹•ã€‘çš„çº¿ä¸Šç½‘èŠçŠ¶æ€ï¼\n2. ç»å¯¹ç¦æ­¢ç¯å¢ƒ/åŠ¨ä½œæå†™ï¼ç»å¯¹ä¸èƒ½å‡ºç°â€œæŠ±ä½ä½ â€ã€â€œæ‘¸å¤´â€ç­‰çº¿ä¸‹åŠ¨ä½œã€‚\n3. å°±åƒåœ¨å¾®ä¿¡æ‰“å­—ä¸€æ ·ï¼Œç®€çŸ­ã€å£è¯­åŒ–ã€‚`; 
            modeReinforce = `(Systemå¼ºåˆ¶ï¼šç°åœ¨æ˜¯æ‰‹æœºèŠå¤©ï¼éš”ç€å±å¹•ï¼Œç»å¯¹ç¦æ­¢å†™å‡ºåŠ¨ä½œï¼åªèƒ½æ‰“å­—ï¼)`;
        }
        
       let loadingMsg = { r: 'ai', t: '', type: 'text', loading: true, scene: curRole.mode };
        targetRole.history.push(loadingMsg); 
        renderMsgs();

        try {
            let apiMessages = targetRole.history.filter(m => !m.loading && m.t && m.type !== 'pay_request' && m.type !== 'order_share').map(m => {
                let content = m.t; 
                if (m.type === 'transfer') content = m.r === 'u' ? `[ç³»ç»Ÿï¼šç”¨æˆ·è½¬è´¦ Â¥${m.t}ã€‚å¦‚æ”¶ä¸‹å›å¤[CMD:RECEIVE]ï¼Œæ‹’æ”¶å›å¤[CMD:RETURN]]` : `[æˆ‘ç»™ä½ è½¬è´¦ Â¥${m.t}]`; 
                else if (m.type === 'image') content = `[ç”¨æˆ·å‘å›¾: ${m.t}]`;
                else if (m.type === 'voice') content = `[å‘é€äº†è¯­éŸ³] "${m.t}"`; 
                else if (m.r === 'ai') content = cleanText(m.t); 
                return { role: m.r === 'u' ? 'user' : 'assistant', content: content };
            });

            if (apiMessages.length > 0) apiMessages[apiMessages.length-1].content += `\n\n${modeReinforce}`;

            let groupRule = targetRole.isGroup ? `\nã€ç¾¤èŠæŠ¢çº¢åŒ…/è½¬è´¦ç‰¹åˆ«è§„å®šã€‘ï¼šå¦‚æœç”¨æˆ·å‘äº†è½¬è´¦ï¼Œ**ç¾¤é‡Œåªèƒ½æœ‰1ä¸ªè§’è‰²**æŠ¢åˆ°å¹¶è¾“å‡º[CMD:RECEIVE]æŒ‡ä»¤ã€‚å…¶ä»–è§’è‰²ç»å¯¹ä¸èƒ½åŒæ—¶è¯´è‡ªå·±æ”¶åˆ°äº†é’±ï¼Œå…¶ä»–äººåªèƒ½è¡¨è¾¾â€œæ²¡æŠ¢åˆ°â€ã€â€œç¾¡æ…•â€æˆ–â€œæ—è§‚â€ï¼` : "";
            
            // ğŸ¯ ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šç»™ AI ä¸‹è¾¾æå…¶ä¸¥å‰çš„è¯­éŸ³æ ¼å¼å‘½ä»¤
            let voiceRule = (targetRole.voiceId && targetRole.mode === 'chat') ? `\n5. ã€è¯­éŸ³åŠŸèƒ½ã€‘ï¼šä½ å¯ä»¥å‘è¯­éŸ³ï¼æ ¼å¼å¿…é¡»æ˜¯ï¼š[CMD:VOICE:ä½ è¦è¯´çš„è¯]ã€‚\n**ã€æœ€é«˜æŒ‡ä»¤è­¦å‘Šã€‘**ï¼šåªè¦ç”¨æˆ·æ˜ç¡®å¯¹ä½ è¯´â€œå‘ä¸ªè¯­éŸ³â€ã€â€œè¯´è¯â€ï¼Œæˆ–è€…ä½ æƒ³æ’’å¨‡ã€å¹æ°”ã€å‘è¯­éŸ³æ—¶ï¼Œ**å¿…é¡»ä¸”åªèƒ½**è¾“å‡º [CMD:VOICE:å†…å®¹]ï¼ç»å¯¹ä¸è¦åªè¾“å‡ºæ™®é€šæ–‡å­—ï¼ä¾‹å­ï¼šç”¨æˆ·è¯´â€œå‘è¯­éŸ³â€ï¼Œä½ å¿…é¡»å›å¤ï¼š[CMD:VOICE:å¥½å˜ï¼Œä½ èƒ½å¬åˆ°æˆ‘è¯´è¯å—ï¼Ÿ]` : "";

            let sysPrompt = `ä½ æ˜¯${targetRole.name}ã€‚${longTermMem}ã€‚èƒŒæ™¯:${targetRole.info}ã€‚ä¸${effectiveUser.name}èŠå¤©ã€‚ä¸–ç•Œ:${worldCtx}ã€‚\n${modeSysPrompt}\nã€å¿…è¯»åŠ¨ä½œæŒ‡ä»¤ã€‘:\nä½œä¸ºçœŸå®çš„äººï¼Œå¦‚æœä½ æƒ³äº§ç”Ÿå®é™…åŠ¨ä½œï¼Œ**å¿…é¡»**åœ¨å›å¤æœ«å°¾é™„å¸¦ä»¥ä¸‹ä»£ç ï¼š\n1. ä¸»åŠ¨ç»™ç”¨æˆ·è½¬è´¦ï¼š[CMD:TRANSFER:æ•°å­—]\n2. æ”¶ä¸‹ç”¨æˆ·çš„è½¬è´¦ï¼š[CMD:RECEIVE]\n3. æ‹’æ”¶/é€€å›è½¬è´¦ï¼š[CMD:RETURN]\n4. å‘æœ‹å‹åœˆï¼š[CMD:POST:å†…å®¹]${groupRule}${voiceRule}`;
            
            let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [ { role: 'system', content: sysPrompt }, ...apiMessages ], stream: false }) });
            let data = await res.json(); 
            let rawContent = cleanText(data.choices[0].message.content);
            
            let aiTransfers = [];
            let lines = rawContent.split('\n');
            let currentSpeaker = targetRole.isGroup ? "ç³»ç»Ÿ" : targetRole.name;
            let newLines = [];
            let hasReceived = false; 
            
            lines.forEach(line => {
                let cleanLine = line.replace(/\*\*/g, '');
                let matchSpk = cleanLine.match(/^ã€?(.*?)ã€‘?[ï¼š:]/);
                if (matchSpk) currentSpeaker = matchSpk[1].trim();

                let voiceMatch = line.match(/\[CMD:VOICE:(.*?)\]/i) || line.match(/ã€CMD:VOICE:(.*?)ã€‘/i);
                if (voiceMatch) {
    let voiceText = voiceMatch[1].trim();
    line = line.replace(voiceMatch[0], '').trim();
    // æŠŠå¯¹è±¡å…ˆå­˜è¿›ä¸€ä¸ªå˜é‡
    let newVoiceMsg = { r: 'ai', t: voiceText, type: 'voice', status: 'generating', time: new Date().toLocaleString(), scene: curRole.mode, spk: currentSpeaker };
    targetRole.history.push(newVoiceMsg);
    // ç›´æ¥ä¼ å¯¹è±¡ï¼Œå®Œç¾é¿å¼€æ•°ç»„ä¸‹æ ‡é”™ä½ Bug
    synthesizeVoiceMessage(targetRole.id, newVoiceMsg);
}

                let transferMatch = line.match(/\[CMD:TRANSFER:\s*(\d+(\.\d+)?)\s*\]/i) || line.match(/ã€CMD:TRANSFER:\s*(\d+(\.\d+)?)\s*ã€‘/i);
                if (transferMatch) {
                    aiTransfers.push({ amt: parseFloat(transferMatch[1]), spk: currentSpeaker });
                    line = line.replace(transferMatch[0], '').trim();
                }
                
                let postMatch = line.match(/\[CMD:POST:(.*?)\]/i) || line.match(/ã€CMD:POST:(.*?)ã€‘/i); 
                if (postMatch) { 
                    let postContent = postMatch[1]; 
                    line = line.replace(postMatch[0], '').trim(); 
                    let spkId = targetRole.id;
                    if(targetRole.isGroup) {
                        let spkR = roles.find(r => !r.isGroup && (r.name === currentSpeaker || r.name.includes(currentSpeaker)));
                        if(spkR) spkId = spkR.id;
                    }
                    mnts.unshift({ id: Date.now(), r: spkId, content: postContent, img: "", time: Date.now(), likes: [], comments: [] }); 
                    saveAll(); if(curTab === 'moments') renderMnts(); 
                }
                
                let rcvMatch = line.match(/\[CMD:RECEIVE\]/i) || line.match(/ã€CMD:RECEIVEã€‘/i);
                if (rcvMatch) { 
                    line = line.replace(rcvMatch[0], '').trim(); 
                    if(!hasReceived) {
                        let pendingMsg = targetRole.history.findLast(m => m.r === 'u' && m.type === 'transfer' && m.status === 'pending'); 
                        if (pendingMsg) { 
                            pendingMsg.status = 'received'; pendingMsg.rcvTime = new Date().toLocaleString(); 
                            let rcvName = targetRole.isGroup ? currentSpeaker : targetRole.name;
                            targetRole.history.push({ r: 'system', t: `${rcvName} é¢†å–äº†ä½ çš„è½¬è´¦`, type: 'system' }); 
                        }
                        hasReceived = true;
                    }
                }
                
                let retMatch = line.match(/\[CMD:RETURN\]/i) || line.match(/ã€CMD:RETURNã€‘/i);
                if (retMatch) { 
                    line = line.replace(retMatch[0], '').trim(); 
                    let pendingMsg = targetRole.history.findLast(m => m.r === 'u' && m.type === 'transfer' && m.status === 'pending'); 
                    if (pendingMsg) { 
                        pendingMsg.status = 'returned'; pendingMsg.rcvTime = new Date().toLocaleString(); 
                        balance += parseFloat(pendingMsg.t); 
                        let retName = targetRole.isGroup ? currentSpeaker : targetRole.name;
                        targetRole.history.push({ r: 'system', t: `${retName} é€€è¿˜äº†ä½ çš„è½¬è´¦`, type: 'system' }); 
                    } 
                }

                if (line.trim()) newLines.push(line);
            });
            
            rawContent = newLines.join('\n');
            loadingMsg.t = rawContent; delete loadingMsg.loading; 
            
            aiTransfers.forEach(tf => {
                if (tf.amt > 0) {
                    targetRole.history.push({ r: 'ai', t: tf.amt.toString(), type: 'transfer', status: 'pending', time: new Date().toLocaleString(), spk: tf.spk, scene: curRole.mode });
                }
            });
            
            if (!loadingMsg.t && loadingMsg.type === 'text') { let idx = targetRole.history.indexOf(loadingMsg); if (idx > -1) targetRole.history.splice(idx, 1); }
            
            saveAll(); renderMsgs();
        } catch (e) { console.error(e); targetRole.history.pop(); renderMsgs(); alert("å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Keyå’Œç½‘ç»œ"); }
    }

    function renderMsgs() {
        if (!curRole || !curRole.history) return; 
        let myAva = document.querySelector('.u-ava')?.src || "https://img.icons8.com/color/96/user.png";
        let userAva = (curRole.userMask && curRole.userMask.ava) ? curRole.userMask.ava : myAva;
        let isStoryMode = curRole.mode === 'story';
        let htmlStr = '';
        
        curRole.history.forEach((m, idx) => {
            if (!m) return; 
            
            let msgScene = m.scene;
            if (!msgScene) { msgScene = (m.t.includes('*') || m.t.length > 40) ? 'story' : 'chat'; }
            if (isStoryMode && msgScene !== 'story') return;
            if (!isStoryMode && msgScene !== 'chat') return;

            if (m.type === 'system') { 
                if (m.t.includes('ã€ç³»ç»Ÿæç¤ºï¼š')) return; 
                htmlStr += `<div class="flex justify-center w-full my-3"><span class="bg-black/10 text-zinc-500 text-[11px] px-3 py-1 rounded-md shadow-sm">${m.t}</span></div>`; 
                return; 
            }
            
            if (curRole.isGroup && m.r === 'ai' && !m.loading && (!m.type || m.type === 'text') && !isStoryMode) {
                let parsedBlocks = []; let lines = cleanText(m.t).split('\n'); let curSpk = null; let curTxt = "";
                lines.forEach(line => {
                    let cleanLine = line.replace(/\*\*/g, '');
                    let match = cleanLine.match(/^ã€?(.*?)ã€‘?[ï¼š:]([\s\S]*)$/); 
                    if (match) {
                        if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });
                        curSpk = match[1].trim(); curTxt = match[2] + "\n";
                    } else {
                        if (curSpk) curTxt += line + "\n"; else { curSpk = "ç³»ç»Ÿ"; curTxt += line + "\n"; }
                    }
                });
                if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });

                parsedBlocks.forEach((block, bIdx) => {
                    let spkRole = roles.find(r => !r.isGroup && (r.name === block.name || r.name.includes(block.name) || block.name.includes(r.name)));
                    let spkAva = spkRole ? spkRole.ava : 'https://img.icons8.com/color/96/user-male-circle.png';
                    let fmtTxt = block.text.replace(/\n/g, '<br>');
                    let isLast = bIdx === parsedBlocks.length - 1;
                    let actionBtns = `<div class="text-[10px] text-zinc-400 flex gap-2 px-1 ml-1 items-center mt-1"><span onclick="delSubMsg(${idx}, ${bIdx})" class="cursor-pointer text-zinc-400 hover:text-red-500">åˆ é™¤æ­¤æ¡</span>` + (isLast ? `<span class="text-zinc-300 mx-1">|</span><span onclick="delMsg(${idx})" class="cursor-pointer text-zinc-400 hover:text-red-500">åˆ æ•´ä½“</span><span class="text-zinc-300 mx-1">|</span> <span onclick="retryMsg(${idx})" class="cursor-pointer text-blue-500 font-bold hover:bg-zinc-100 px-1 rounded select-none">â†»é‡è¯´</span>` : '') + `</div>`;

                    htmlStr += `<div class="flex flex-row justify-start items-start gap-2 mb-4 w-full px-2"><img src="${spkAva}" class="w-10 h-10 rounded-lg shrink-0 bg-zinc-300 shadow-sm mt-1"><div class="flex flex-col items-start max-w-[75%] ml-2"><span class="text-[11px] text-zinc-500 ml-1 mb-0.5">${block.name}</span><div class="bubble bubble-ai shadow-sm">${fmtTxt}</div>${actionBtns}</div></div>`;
                });
                return;
            }

            let avaSrc = m.r==='u' ? userAva : curRole.ava;
            let bubbleContent = '', bubbleClass = '', extraStyle = '', containerClass = '', wrapperClass = '', showAva = true;
            let spkNameHtml = '';

            if (curRole.isGroup && m.r === 'ai' && m.spk && !isStoryMode) {
                let spkRole = roles.find(r => !r.isGroup && (r.name === m.spk || r.name.includes(m.spk) || m.spk.includes(r.name)));
                avaSrc = spkRole ? spkRole.ava : 'https://img.icons8.com/color/96/user-male-circle.png';
                spkNameHtml = `<span class="text-[11px] text-zinc-500 ml-1 mb-0.5">${m.spk}</span>`;
            }

            if (m.type === 'transfer') {
                wrapperClass = m.r === 'u' ? 'flex flex-row justify-end items-start' : 'flex flex-row justify-start items-start'; containerClass = m.r === 'u' ? 'flex flex-col items-end max-w-[75%] mr-2' : 'flex flex-col items-start max-w-[75%] ml-2'; bubbleClass = 'bg-[#f79c4a] text-white border-none cursor-pointer active:opacity-80 rounded-xl px-4 py-3 shadow-sm'; let icon = m.status === 'received' ? 'âœ”' : (m.status === 'returned' ? 'â†©' : (m.r==='u' ? 'Â¥' : 'ğŸ’°')); let title = m.r === 'u' ? `è½¬è´¦ç»™å¯¹æ–¹` : 'æ”¶åˆ°è½¬è´¦'; let statusText = m.status === 'received' ? (m.r==='u'?'å·²è¢«é¢†å–':'å·²æ”¶æ¬¾') : (m.status==='returned'?'å·²é€€è¿˜':(m.r==='u'?'ç­‰å¾…å¯¹æ–¹ç¡®è®¤':'å¾…ä½ æ”¶æ¬¾'));
                bubbleContent = `<div onclick="openTransferDetail(${idx})" class="flex items-center gap-3 min-w-[200px]"><div class="w-10 h-10 rounded-full border-2 border-white/30 flex items-center justify-center text-white text-xl">${icon}</div><div class="flex flex-col"><span class="text-base font-bold">Â¥${m.t}</span><span class="text-[10px] opacity-80">${title}</span></div></div><div class="mt-2 pt-1 border-t border-white/20 text-[10px] opacity-70">${statusText}</div>`;
            } else if (m.type === 'pay_request') {
                wrapperClass = 'flex flex-row justify-end items-start'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;'; let statusText = m.status==='pending'?'ç­‰å¾…å¯¹æ–¹ä»˜æ¬¾':(m.status==='paid'?'å¯¹æ–¹å·²ä»˜æ¬¾':'å¯¹æ–¹å·²æ‹’ç»'); let statusClass = m.status==='pending'?'st-pending':(m.status==='paid'?'st-paid':'st-rejected'); let isShop = m.itemDisplay && m.itemDisplay.startsWith('[å•†åŸ]'); let payTitle = isShop ? "è¯·å¸®æˆ‘ä»˜å•†åŸè®¢å•" : "è¯·å¸®æˆ‘ä»˜å¤–å–"; let headerClass = isShop ? "card-header-pay-shop" : "card-header-pay"; let source = isShop ? "AI å•†åŸ" : "ç¾å›¢å¤–å–";
                bubbleContent = `<div class="msg-card"><div class="${headerClass}"></div><div class="card-title"><span>${isShop?'ğŸ›ï¸':'ğŸ’³'}</span> ${payTitle}</div><div class="card-content"><img src="${m.img || ''}" class="card-img"><div class="card-info"><div class="card-desc">${m.itemDisplay || 'å•†å“'}</div><div class="card-price">Â¥${parseFloat(m.total).toFixed(2)}</div></div></div><div class="flex justify-between items-center text-xs"><span class="text-zinc-400">${source}</span><span class="status-tag ${statusClass}">${statusText}</span></div></div>`;
            } else if (m.type === 'order_share') {
                wrapperClass = 'flex flex-row justify-end items-start'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
                bubbleContent = `<div class="msg-card"><div class="card-header-share"></div><div class="card-title"><span>ğŸ˜‹</span> æˆ‘ç‚¹äº†è¿™å®¶ï¼Œè¶…å¥½åƒ</div><div class="card-content"><img src="${m.img || ''}" class="card-img"><div class="card-info"><div class="card-desc">${m.itemDisplay}</div><div class="text-xs text-zinc-400">å…± ${m.count} ä»¶</div></div></div><div onclick="go('pg-takeout-home')" class="card-btn">å»çœ‹çœ‹</div></div>`;
            } else if (m.type === 'image') {
                wrapperClass = m.r==='u'?'flex flex-row justify-end items-start':'flex flex-row justify-start items-start'; containerClass = m.r==='u'?'flex flex-col items-end max-w-[75%] mr-2':'flex flex-col items-start max-w-[75%] ml-2';
                bubbleContent = `<img src="${m.t}" class="max-w-[150px] rounded-lg cursor-pointer" onclick="window.open('${m.t}')">`; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
            } 
            // ğŸ¯ æ–°å¢ï¼šç”»å‡ºå¾®ä¿¡åŒæ¬¾è¯­éŸ³æ¡
            else if (m.type === 'voice') {
                wrapperClass = m.r === 'u' ? 'flex flex-row justify-end items-start' : 'flex flex-row justify-start items-start';
                containerClass = m.r === 'u' ? 'flex flex-col items-end max-w-[75%] mr-2' : 'flex flex-col items-start max-w-[75%] ml-2';
                // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåŠ ä¸Š cursor: pointer è®©æ•´ä¸ªæ°”æ³¡å¯ç‚¹å‡»
                extraStyle = 'padding: 8px 14px; min-width: 60px; cursor: pointer; user-select: none;';
                
                if (m.status === 'generating') {
                    bubbleContent = `<div class="flex items-center gap-2 text-zinc-500 text-sm"><span class="animate-pulse text-lg">ğŸ™ï¸</span><span class="text-[12px]">è¯­éŸ³åˆæˆä¸­...</span></div>`;
                    bubbleClass = m.r === 'u' ? 'bubble-user shadow-sm' : 'bubble-ai shadow-sm';
                } else if (m.status === 'failed') {
                    bubbleContent = `<div class="flex items-center gap-2 text-red-400 text-sm">âš ï¸ è¯­éŸ³å¤±è´¥ <span class="text-xs text-zinc-400 truncate w-16">(${m.t})</span></div>`;
                    bubbleClass = m.r === 'u' ? 'bubble-user shadow-sm' : 'bubble-ai shadow-sm';
                } else {
                    let duration = m.duration || 3;
                    // åŠ¨æ€è®¡ç®—æ°”æ³¡å®½åº¦ï¼Œè¶Šé•¿è¶Šå®½
                    let bubbleWidth = Math.min(220, 50 + duration * 6); 
                    
                    // ä½¿ç”¨ 3 ä¸ªä¸åŒé«˜åº¦çš„åœ†è§’çŸ©å½¢æ¨¡æ‹Ÿå¾®ä¿¡è¯­éŸ³æ³¢çº¹
                    let waveIcon = `<div class="flex items-center gap-[3px] opacity-60">
                                      <div class="w-1 h-1 bg-zinc-800 rounded-full"></div>
                                      <div class="w-[3px] h-3 bg-zinc-800 rounded-full"></div>
                                      <div class="w-[3px] h-4 bg-zinc-800 rounded-full"></div>
                                    </div>`;
                    
                    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šæŠŠ onclick ç»Ÿä¸€æ”¾åˆ°æœ€å¤–å±‚çš„è¿™ä¸ª div é‡Œï¼Œå¹¶ä¸”ç¡®ä¿å®ƒå æ»¡å®½åº¦
                    let innerContent = '';
                    if (m.r === 'u') {
                        // ã€ä½ å‘é€çš„ã€‘ï¼šæ•´ä½“é å³ (justify-end)ï¼Œç§’æ•°åœ¨å·¦ï¼Œæ³¢çº¹åœ¨å³ä¸”é•œåƒç¿»è½¬
                        innerContent = `<div class="flex items-center justify-end gap-2 w-full">
                                            <span class="text-[15px] font-medium">${duration}"</span> 
                                            <div style="transform: scaleX(-1); display: flex; align-items: center;">${waveIcon}</div>
                                        </div>`;
                    } else {
                        // ã€AIå‘é€çš„ã€‘ï¼šæ•´ä½“é å·¦ (justify-start)ï¼Œæ³¢çº¹åœ¨å·¦ï¼Œç§’æ•°åœ¨å³
                        innerContent = `<div class="flex items-center justify-start gap-2 w-full">
                                            <div class="flex items-center">${waveIcon}</div> 
                                            <span class="text-[15px] font-medium">${duration}"</span>
                                        </div>`;
                    }
                    
                    bubbleContent = `<div onclick="playMsgVoice('${curRole.id}', ${idx})" style="width: ${bubbleWidth}px;">${innerContent}</div>`;
                    bubbleClass = m.r === 'u' ? 'bubble-user shadow-sm' : 'bubble-ai shadow-sm';
                }
            }
            else {
                if (m.loading) { bubbleContent = `<div class="dot-ani"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;} else {
                    let rawText = m.r === 'ai' ? cleanText(m.t) : m.t;
                    if (isStoryMode && m.r === 'ai') {
                        rawText = rawText.split('\n').map(line => line.replace(/^ã€?([^ã€‘:ï¼š]+)ã€‘?[ï¼š:]\s*/, '$1')).join('\n');
                    }
                    let formattedText = typeof rawText === 'string' ? rawText.replace(/\*([^*]+)\*/g, '<span class="text-zinc-400 italic text-[15px]">$1</span>') : '';
                    if (isStoryMode && m.r === 'ai') { bubbleContent = formattedText.split('\n').filter(line => line.trim() !== '').map(line => `<span class="story-p">${line}</span>`).join(''); } else { bubbleContent = formattedText.replace(/\n/g, '<br>'); }
                }
                if (m.r === 'u') { wrapperClass = 'flex flex-row justify-end items-start'; bubbleClass = 'bubble-user shadow-sm'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; } 
                else { 
                    if (isStoryMode) { showAva = false; wrapperClass = 'flex justify-center'; containerClass = 'flex flex-col w-[94%]'; bubbleClass = 'story-text-container'; } 
                    else { wrapperClass = 'flex flex-row justify-start items-start'; bubbleClass = 'bubble-ai shadow-sm'; containerClass = 'flex flex-col items-start max-w-[75%] ml-2'; } 
                }
            }
            let avatarHtml = showAva ? `<img src="${avaSrc}" class="w-10 h-10 rounded-lg shrink-0 bg-zinc-300 shadow-sm mt-1">` : ''; 
            let retryBtn = (m.r === 'ai' && !m.loading) ? ` <span class="text-zinc-300 mx-1">|</span> <span onclick="retryMsg(${idx})" class="cursor-pointer text-blue-500 font-bold hover:bg-zinc-100 px-1 rounded select-none">â†»é‡è¯´</span>` : '';
            let footerClass = isStoryMode ? 'justify-end w-full pr-2 mt-1' : 'ml-1 items-center mt-1';
            let innerHtml = m.r === 'u' ? 
                `<div class="${containerClass}"><div class="bubble ${bubbleClass}" style="${extraStyle}">${bubbleContent}</div><div class="text-[10px] text-zinc-400 mt-1 flex gap-3 px-1 mr-1"><span onclick="delMsg(${idx})" class="cursor-pointer">åˆ é™¤</span></div></div>${avatarHtml}` : 
                `<div class="${containerClass}">${spkNameHtml}<div class="bubble ${bubbleClass}" style="${extraStyle}">${bubbleContent}</div><div class="text-[10px] text-zinc-400 flex gap-2 px-1 ${footerClass}"><span onclick="delMsg(${idx})" class="cursor-pointer text-zinc-400 hover:text-red-500">åˆ é™¤</span>${retryBtn}</div></div>`;
            if (m.r === 'ai') innerHtml = avatarHtml + innerHtml;
            htmlStr += `<div class="${wrapperClass} gap-2 mb-4 w-full px-2">${innerHtml}</div>`;
        });
        
        let container = isStoryMode ? $('story-msgs') : $('chat-msgs');
        if (container) { container.innerHTML = htmlStr; container.scrollTop = container.scrollHeight; }
    }
    function renderChatList() { $('sub-chat').innerHTML = chats.map(id => { let r = roles.find(x=>x.id==id); if(!r) return ''; let lastMsg = r.history.length > 0 ? r.history[r.history.length-1].t : 'æš‚æ— æ¶ˆæ¯'; return `<div onclick="enterChat('${r.id}')" class="p-4 flex gap-3 bg-white active:bg-zinc-50 border-b"><img src="${r.ava}" class="w-12 h-12 rounded-lg bg-zinc-100"><div class="flex-1 min-w-0"><b class="block truncate">${r.name}</b><p class="text-xs text-zinc-400 truncate">${cleanText(lastMsg)}</p></div></div>`; }).join(''); }

    function renderChatInfo() { 
        if(!curRole) return; 
        $('info-mask-status').innerText = (curRole.userMask && curRole.userMask.name) ? `å½“å‰: ${curRole.userMask.name}` : "é»˜è®¤"; 
        if(curRole.isGroup) $('group-name-edit-box').classList.remove('hidden');
        else $('group-name-edit-box').classList.add('hidden');
    }

    function loadMaskEdit() { if(!curRole) return; let m = curRole.userMask || {}; $('in-mask-n').value = m.name || ''; $('in-mask-a').value = m.ava || ''; $('in-mask-i').value = m.info || ''; }
    function saveMask() { if(!curRole) return; curRole.userMask = { name: $('in-mask-n').value, ava: $('in-mask-a').value, info: $('in-mask-i').value }; saveAll(); alert("é¢å…·å·²ä¿å­˜ï¼"); go('pg-chat-info'); }
    function clearHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")){ curRole.history=[]; saveAll(); renderMsgs(); go('pg-chat-room'); } }
    
    // ğŸ‘‡ æ–°å¢ï¼šå½»åº•åˆ é™¤å½“å‰èŠå¤©ä¼šè¯
    function deleteCurrentChat() {
        if (!curRole) return;
        if (confirm("ç¡®å®šè¦åˆ é™¤è¯¥èŠå¤©å—ï¼Ÿ\nåˆ é™¤åæ‰€æœ‰è®°å½•å°†è¢«æ¸…ç©ºï¼Œå¹¶ä»å¾®ä¿¡æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤ã€‚")) {
            // 1. å½»åº•æ¸…ç©ºå½“å‰è§’è‰²çš„èŠå¤©å†å²
            curRole.history = []; 
            // 2. å°†è¯¥è§’è‰²ä»å¾®ä¿¡é¦–é¡µçš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆchatsæ•°ç»„ï¼‰ä¸­å‰”é™¤
            chats = chats.filter(id => id !== curRole.id); 
            
            // 3. ä¿å­˜æ•°æ®
            saveAll(); 
            
            // 4. é‡æ–°æ¸²æŸ“é¦–é¡µæ¶ˆæ¯åˆ—è¡¨ï¼Œå¹¶è·³å›å¾®ä¿¡é¦–é¡µ
            renderChatList(); 
            go('pg-wechat'); 
            tab('chat');
        }
    }
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ï¼šç²¾å‡†å‰¥ç¦»å™¨ï¼Œä¸“é—¨ç”¨æ¥å•æ€ç¾¤èŠé‡Œçš„æŸä¸€ä¸ªäººè¯´çš„è¯
    window.delSubMsg = function(msgIdx, blockIdx) {
        let m = curRole.history[msgIdx];
        if (!m || !m.t) return;
        
        let parsedBlocks = []; let lines = cleanText(m.t).split('\n'); let curSpk = null; let curTxt = "";
        lines.forEach(line => {
            let cleanLine = line.replace(/\*\*/g, '');
            let match = cleanLine.match(/^ã€?(.*?)ã€‘?[ï¼š:]([\s\S]*)$/); 
            if (match) {
                if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });
                curSpk = match[1].trim(); curTxt = match[2] + "\n";
            } else {
                if (curSpk) curTxt += line + "\n"; else { curSpk = "ç³»ç»Ÿ"; curTxt += line + "\n"; }
            }
        });
        if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });
        
        // åˆ æ‰æŒ‡å®šçš„é‚£ä¸ªè§’è‰²çš„é‚£æ®µè¯
        parsedBlocks.splice(blockIdx, 1);
        
        if (parsedBlocks.length === 0) {
            // å¦‚æœå…¨éƒ½åˆ å…‰äº†ï¼Œå°±æŠŠè¿™æ¡å†å²è®°å½•æ•´ä¸ªæ‹”æ‰
            curRole.history.splice(msgIdx, 1);
        } else {
            // å¦åˆ™ï¼ŒæŠŠå‰©ä¸‹çš„äººçš„è¯é‡æ–°æ‹¼è£…å›å»è¦†ç›–åˆ°åº•å±‚
            m.t = parsedBlocks.map(b => `${b.name}ï¼š${b.text}`).join('\n');
        }
        
        saveAll();
        renderMsgs();
    };

    function delMsg(idx) { curRole.history.splice(idx,1); saveAll(); renderMsgs(); }
    function retryMsg(idx) { let lastU = ""; for(let i=idx-1; i>=0; i--){ if(curRole.history[i].r==='u'){ lastU=curRole.history[i].t; break; } } curRole.history.splice(idx,1); saveAll(); renderMsgs(); if(lastU) handleSendMsg(lastU, 'text', true); else handleSendMsg(" ", 'text', true); } 
    
    // ================== 11. å¤–å–æ¨¡å—ä¸ä¸‰é€‰ä¸€æ”¯ä»˜ ==================
    function toTakeoutTab(tab) { ['pg-takeout-home', 'pg-takeout-cart', 'pg-takeout-me'].forEach(id => { $(id).classList.remove('active'); }); $('pg-takeout-' + tab).classList.add('active'); if(tab === 'home') renderFoodList(); if(tab === 'cart') renderCart(); if(tab === 'me') updatePendingBadge(); }
    function handleSearchInput() { let val = $('takeout-search').value; let btn = $('btn-clear-search'); if(val.length > 0) btn.classList.remove('hidden'); else btn.classList.add('hidden'); renderFoodList(); }
    function clearSearch() { $('takeout-search').value = ''; $('btn-clear-search').classList.add('hidden'); renderFoodList(); }
    function renderFoodList() {
        const term = $('takeout-search').value.toLowerCase(); const list = $('takeout-list');
        const filtered = foods.filter(f => f.name.toLowerCase().includes(term) || f.store.toLowerCase().includes(term));
        list.innerHTML = filtered.map(f => `<div onclick="showFoodDetail(${f.id})" class="food-card flex flex-col h-full cursor-pointer active:opacity-90"><div class="food-img-box"><img src="${f.img}" loading="lazy"><div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2 pt-6"><span class="text-white text-[10px] font-light">30åˆ†é’Ÿé€è¾¾</span></div></div><div class="p-2 flex flex-col flex-1"><h3 class="font-bold text-sm text-zinc-800 truncate">${f.name}</h3><div class="text-[10px] text-zinc-400 mt-0.5 mb-2 truncate">ğŸ  ${f.store} | æœˆå”®${f.sales}+</div><div class="mt-auto flex justify-between items-center"><span class="text-red-500 font-bold text-base"><span class="text-xs">Â¥</span>${f.price}</span><button onclick="event.stopPropagation(); addToCart(${f.id})" class="bg-[#FFD101] w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm text-black active:bg-yellow-500">+</button></div></div></div>`).join('');
        updateCartBadge();
    }
    function showFoodDetail(fid) {
        let f = foods.find(x => x.id === fid); if(!f) return; let modal = $('food-detail-modal'); let body = modal.querySelector('.food-modal-body');
        body.innerHTML = `<div class="relative w-full h-64 bg-zinc-200 shrink-0"><img src="${f.img}" class="w-full h-full object-cover"><button onclick="closeFoodDetail()" class="absolute top-4 left-4 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur">âœ•</button><button onclick="deleteFood(${f.id})" class="absolute top-4 right-4 w-8 h-8 bg-red-500/80 rounded-full text-white flex items-center justify-center backdrop-blur shadow-md text-sm">ğŸ—‘ï¸</button></div><div class="p-5 flex-1 overflow-y-auto"><h2 class="text-2xl font-bold text-zinc-900 mb-1">${f.name}</h2><div class="text-zinc-500 text-sm mb-4">æœˆå”® ${f.sales}+ Â· å¥½è¯„ç‡ 98%</div><div class="text-zinc-600 text-sm leading-relaxed mb-6">ä¸¥é€‰é£Ÿæï¼Œç°ç‚¹ç°åšã€‚</div></div><div class="p-4 border-t flex justify-between items-center bg-white safe-area-pb"><div class="flex flex-col"><span class="text-red-500 text-2xl font-bold"><span class="text-sm">Â¥</span>${f.price}</span><span class="text-xs text-zinc-400">æ— é—¨æ§›é…é€</span></div><button onclick="addToCart(${f.id}); closeFoodDetail()" class="bg-[#FFD101] text-black px-8 py-3 rounded-full font-bold shadow-md active:scale-95 transition-transform">åŠ å…¥è´­ç‰©è½¦</button></div>`;
        modal.classList.add('active');
    }
    function deleteFood(fid) { if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤–å–å•†å“å—ï¼Ÿ")) return; foods = foods.filter(x => x.id !== fid); cart = cart.filter(x => x.id !== fid); saveAll(); closeFoodDetail(); renderFoodList(); renderCart(); updateCartBadge(); }
    function closeFoodDetail() { $('food-detail-modal').classList.remove('active'); }
    function addToCart(id) { let item = cart.find(x => x.id === id); if(item) { item.count++; } else { cart.push({id: id, count: 1}); } saveAll(); updateCartBadge(); let btn = event.target; let oldTxt = btn.innerText; btn.innerText = "âœ”"; setTimeout(() => btn.innerText = oldTxt, 500); }
    function updateCartBadge() { let total = cart.reduce((a, b) => a + b.count, 0); const badge = $('cart-badge'); if(total > 0) { badge.innerText = total; badge.classList.remove('hidden'); badge.classList.add('cart-badge-ani'); setTimeout(()=>badge.classList.remove('cart-badge-ani'), 300); } else { badge.classList.add('hidden'); } }
    function renderCart() { const list = $('cart-list'); if(cart.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><span class="text-6xl mb-4">ğŸ›’</span><span>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</span></div>`; $('cart-total').innerText = '0.00'; return; } let total = 0; list.innerHTML = cart.map(c => { let f = foods.find(x => x.id === c.id); if(!f) return ''; let subtotal = f.price * c.count; total += subtotal; return `<div class="bg-white p-3 rounded-xl flex gap-3 items-center"><img src="${f.img}" class="w-16 h-16 rounded-lg object-cover bg-zinc-100"><div class="flex-1"><b class="text-sm block truncate">${f.name}</b><span class="text-xs text-zinc-400">${f.store}</span><div class="flex justify-between items-center mt-2"><span class="text-red-500 font-bold">Â¥${f.price}</span><div class="flex items-center gap-3"><button onclick="changeCartCount(${f.id}, -1)" class="w-6 h-6 rounded border border-zinc-200 text-zinc-500 flex items-center justify-center">-</button><span class="text-sm font-bold w-4 text-center">${c.count}</span><button onclick="changeCartCount(${f.id}, 1)" class="w-6 h-6 rounded bg-[#FFD101] text-black flex items-center justify-center text-sm">+</button></div></div></div></div>`; }).join(''); $('cart-total').innerText = total.toFixed(2); }
    function changeCartCount(id, delta) { let item = cart.find(x => x.id === id); if(!item) return; item.count += delta; if(item.count <= 0) { cart = cart.filter(x => x.id !== id); } saveAll(); renderCart(); updateCartBadge(); }
    function clearCart() { if(confirm("ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ")) { cart = []; saveAll(); renderCart(); updateCartBadge(); } }
    
    function doCheckout() { if(cart.length === 0) return alert("è¯·å…ˆé€‰è´­å•†å“"); let total = parseFloat($('cart-total').innerText); createCustomCheckoutModal(total); }
    function createCustomCheckoutModal(total) {
        let roleName = curRole ? curRole.name : 'å¥½å‹'; let overlay = document.createElement('div'); overlay.className = "fixed inset-0 bg-black/50 z-[100] flex items-end";
        overlay.innerHTML = `<div class="bg-white w-full rounded-t-2xl p-6 animate-fade-in"><h3 class="text-lg font-bold mb-4 text-center">å¤–å–æ”¯ä»˜ Â¥${total.toFixed(2)}</h3><div class="space-y-3"><button onclick="handlePayOption('wechat', ${total})" class="w-full py-3 bg-[#07c160] text-white rounded-lg font-bold">å¾®ä¿¡é›¶é’±æ”¯ä»˜</button><button onclick="handlePayOption('bank', ${total})" class="w-full py-3 bg-[#e60012] text-white rounded-lg font-bold flex items-center justify-center gap-2">ğŸ’³ å‚¨è“„å¡æ”¯ä»˜</button><button onclick="handlePayOption('friend', ${total})" class="w-full py-3 bg-[#FFD101] text-black rounded-lg font-bold flex items-center justify-center gap-2"><span>æ‰¾ ${roleName} ä»£ä»˜</span></button><button onclick="document.body.removeChild(this.parentNode.parentNode.parentNode)" class="w-full py-3 text-zinc-400">å–æ¶ˆ</button></div></div>`;
        document.body.appendChild(overlay); 
        window.handlePayOption = (type, amt) => { 
            document.body.removeChild(overlay); 
            if(type === 'wechat') processSelfPay(amt); 
            if(type === 'bank') processBankPay(amt, 'food');
            if(type === 'friend') { if(!takeoutCtx.fromChat) return alert("è¯·å…ˆåœ¨èŠå¤©å®¤å‘¼å‡ºå¤–å–ï¼"); processFriendPay(amt); }
        };
    }
    function processSelfPay(total) { if(balance < total) return alert(`å¾®ä¿¡é›¶é’±ä¸è¶³ (å½“å‰ Â¥${balance.toFixed(2)})`); balance -= total; createOrder(total, 'paid'); alert("å¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼"); saveAll(); go('pg-takeout-pending'); renderPendingOrders(); }
    function processFriendPay(total) { let firstItem = foods.find(f => f.id === cart[0].id) || {name: "æœªçŸ¥", img:""}; let count = cart.reduce((a,b)=>a+b.count,0); let payMsg = { r: 'u', type: 'pay_request', status: 'pending', total: total, itemDisplay: `${firstItem.name} ç­‰ ${count} ä»¶`, img: firstItem.img, time: new Date().toLocaleString(), t: `[ä»£ä»˜è¯·æ±‚] Â¥${total}` }; curRole.history.push(payMsg); saveAll(); createOrder(total, 'wait_pay'); go('pg-chat-room'); renderMsgs(); setTimeout(() => triggerAiPayDecision(curRole.history.length - 1, total), 1500); }
    function createOrder(total, status) { let newOrder = { id: Date.now(), items: JSON.parse(JSON.stringify(cart)), total: total, time: Date.now(), status: status === 'paid' ? 'delivering' : 'pending_pay' }; orders.unshift(newOrder); cart = []; saveAll(); }
    function renderPendingOrders() { const list = $('order-pending-list'); let pending = orders.filter(o => o.status === 'delivering'); if(pending.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— è¿›è¡Œä¸­çš„è®¢å•</div>`; return; } list.innerHTML = pending.map(o => { let firstItem = foods.find(f => f.id === o.items[0].id) || {name: 'æœªçŸ¥å•†å“', store: 'æœªçŸ¥åº—é“º'}; let count = o.items.reduce((a,b)=>a+b.count, 0); return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-3 pb-2 border-b border-dashed"><b class="text-sm">${firstItem.store}</b><span class="text-xs text-[#FFD101] font-bold">éª‘æ‰‹èµ¶å¾€ä¸­...</span></div><div class="flex gap-3 mb-3"><img src="${firstItem.img}" class="w-16 h-16 rounded bg-zinc-100 object-cover"><div class="flex-1"><div class="text-sm font-bold">${firstItem.name} ç­‰</div><div class="text-xs text-zinc-500 mt-1">å…± ${count} ä»¶å•†å“</div></div><div class="flex flex-col items-end justify-center"><span class="font-bold">Â¥${o.total.toFixed(2)}</span></div></div><div class="flex justify-end"><button onclick="confirmReceipt(${o.id})" class="bg-[#FFD101] px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm">ç¡®è®¤æ”¶è´§</button></div></div>`; }).join(''); }
    function confirmReceipt(oid) { let o = orders.find(x => x.id === oid); if(o) { o.status = 'completed'; saveAll(); renderPendingOrders(); alert("å·²ç¡®è®¤æ”¶è´§ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´ï¼"); } }
    function renderAllOrders() { const list = $('order-history-list'); if(orders.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— å†å²è®¢å•</div>`; return; } list.innerHTML = orders.map(o => { let firstItem = foods.find(f => f.id === o.items[0].id) || {name: 'æœªçŸ¥', img: ''}; let statusText = o.status === 'delivering' ? 'è¿›è¡Œä¸­' : (o.status === 'pending_pay' ? 'å¾…ä»˜æ¬¾' : (o.status==='cancelled'?'å·²å–æ¶ˆ':'å·²å®Œæˆ')); let count = o.items.reduce((a,b)=>a+b.count,0); let shareBtn = takeoutCtx.fromChat ? `<button onclick="shareOrder(${o.id})" class="border border-blue-500 text-blue-500 px-3 py-1 rounded text-xs ml-2">åˆ†äº«ç»™TA</button>` : ''; return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-2"><b class="text-sm">${firstItem.store}</b><span class="text-xs text-zinc-400">${statusText}</span></div><div class="flex gap-3 items-center"><img src="${firstItem.img}" class="w-12 h-12 rounded bg-gray-100 object-cover"><div><div class="text-xs text-zinc-500">${firstItem.name} ç­‰ ${count} ä»¶</div><span class="font-bold text-sm">Â¥${o.total.toFixed(2)}</span></div></div><div class="mt-3 flex justify-end gap-2">${shareBtn}<button class="border border-zinc-200 px-3 py-1 rounded text-xs">è¯„ä»·</button></div></div>`; }).join(''); }
    function saveNewFood() { let s = $('tf-store').value; let n = $('tf-name').value; let p = parseFloat($('tf-price').value); let i = $('tf-img').value; if(!s || !n || isNaN(p)) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯"); foods.push({ id: Date.now(), store: s, name: n, price: p, sales: 0, img: i || "https://img.icons8.com/color/96/hamburger.png" }); saveAll(); alert("ä¸Šæ¶æˆåŠŸï¼"); $('tf-name').value = ''; go('pg-takeout-me'); }
    function updatePendingBadge() { let count = orders.filter(o => o.status === 'delivering').length; let b = $('badge-pending'); if(count > 0) { b.innerText = count; b.classList.remove('hidden'); } else { b.classList.add('hidden'); } }

    // ================== 12. è´­ç‰©å•†åŸæ¨¡å— ==================
    function toShopTab(tab) { ['pg-shop-home', 'pg-shop-cart', 'pg-shop-me'].forEach(id => { $(id).classList.remove('active'); }); $('pg-shop-' + tab).classList.add('active'); if(tab==='home') renderShopList(); if(tab==='cart') renderShopCart(); if(tab==='me') updateShopPendingBadge(); }
    function handleShopSearch() { let val = $('shop-search').value; if(val.length > 0) $('btn-shop-clear').classList.remove('hidden'); else $('btn-shop-clear').classList.add('hidden'); renderShopList(); }
    function clearShopSearch() { $('shop-search').value = ''; $('btn-shop-clear').classList.add('hidden'); renderShopList(); }
    function renderShopList() {
        const term = $('shop-search').value.toLowerCase(); const list = $('shop-list');
        const filtered = shopGoods.filter(g => g.name.toLowerCase().includes(term) || g.store.toLowerCase().includes(term));
        list.innerHTML = filtered.map(g => `<div onclick="showShopDetail(${g.id})" class="food-card flex flex-col h-full cursor-pointer active:opacity-90"><div class="food-img-box"><img src="${g.img}" class="p-4 bg-white object-contain"><div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/20 to-transparent p-2"></div></div><div class="p-2 flex flex-col flex-1"><h3 class="font-bold text-sm text-zinc-800 line-clamp-2 leading-tight h-10">${g.name}</h3><div class="text-[10px] text-[#ff6700] border border-[#ff6700] px-1 rounded w-fit mt-1">åŒ…é‚®</div><div class="text-[10px] text-zinc-400 mt-1 truncate">${g.store} | ${g.sales}+äººä»˜æ¬¾</div><div class="mt-auto flex justify-between items-center"><span class="text-[#ff6700] font-bold text-base"><span class="text-xs">Â¥</span>${g.price}</span><button onclick="event.stopPropagation(); addToShopCart(${g.id})" class="bg-[#ff6700]/10 text-[#ff6700] w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm active:bg-[#ff6700] active:text-white">+</button></div></div></div>`).join('');
        updateShopCartBadge();
    }
    function showShopDetail(gid) {
        let g = shopGoods.find(x => x.id === gid); if(!g) return; let modal = $('shop-detail-modal'); let body = modal.querySelector('.food-modal-body');
        let isFav = shopFavs.includes(gid);
        body.innerHTML = `<div class="relative w-full h-80 bg-white shrink-0 flex items-center justify-center"><img src="${g.img}" class="w-2/3 h-2/3 object-contain"><button onclick="closeShopDetail()" class="absolute top-4 left-4 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur">âœ•</button><button onclick="deleteShopGoods(${g.id})" class="absolute top-4 right-4 w-8 h-8 bg-red-500/80 rounded-full text-white flex items-center justify-center backdrop-blur shadow-md text-sm">ğŸ—‘ï¸</button></div><div class="p-4 flex-1 overflow-y-auto"><div class="flex justify-between items-start"><span class="text-[#ff6700] text-3xl font-bold"><span class="text-base">Â¥</span>${g.price}</span><span class="text-xs text-zinc-400 mt-2">æœˆé”€ ${g.sales}+</span></div><h2 class="text-lg font-bold text-zinc-900 mt-2 leading-snug">${g.name}</h2><div class="mt-6 bg-zinc-50 p-3 rounded-lg text-xs text-zinc-500"><p>âœ… æ­£å“ä¿éšœ Â· æé€Ÿé€€æ¬¾ Â· èµ è¿è´¹é™©</p><p class="mt-1">${g.store} å‘è´§</p></div></div><div class="p-3 border-t flex gap-3 items-center bg-white safe-area-pb"><div onclick="toggleShopFav(${g.id})" class="flex flex-col items-center gap-1 px-2 cursor-pointer ${isFav?'text-[#ff6700]':'text-zinc-500'}"><div class="text-xl">${isFav?'â­':'â˜†'}</div><span class="text-[10px]">${isFav?'å·²æ”¶è—':'æ”¶è—'}</span></div><button onclick="addToShopCart(${g.id}); closeShopDetail()" class="flex-1 bg-gradient-to-r from-[#ff9000] to-[#ff5000] text-white py-3 rounded-full font-bold shadow-md active:scale-95 transition-transform">åŠ å…¥è´­ç‰©è½¦</button></div>`;
        modal.classList.add('active');
    }
    function deleteShopGoods(gid) { if(!confirm("ç¡®å®šè¦ä¸‹æ¶è¿™ä¸ªå•†å“å—ï¼Ÿ")) return; shopGoods = shopGoods.filter(x => x.id !== gid); shopCart = shopCart.filter(x => x.id !== gid); shopFavs = shopFavs.filter(x => x !== gid); saveAll(); closeShopDetail(); renderShopList(); renderShopCart(); updateShopCartBadge(); if ($('pg-shop-favs').classList.contains('active')) renderFavs(); }
    function closeShopDetail() { $('shop-detail-modal').classList.remove('active'); renderShopList(); }
    function toggleShopFav(gid) { if(shopFavs.includes(gid)) shopFavs = shopFavs.filter(x=>x!==gid); else shopFavs.push(gid); saveAll(); showShopDetail(gid); }
    function addToShopCart(id) { let item = shopCart.find(x => x.id === id); if(item) { item.count++; } else { shopCart.push({id: id, count: 1}); } saveAll(); updateShopCartBadge(); }
    function updateShopCartBadge() { let total = shopCart.reduce((a, b) => a + b.count, 0); const badge = $('shop-cart-badge'); if(total > 0) { badge.innerText = total; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }
    function renderShopCart() { const list = $('shop-cart-list'); if(shopCart.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><span class="text-6xl mb-4">ğŸ›’</span><span>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</span></div>`; $('shop-cart-total').innerText = '0.00'; return; } let total = 0; list.innerHTML = shopCart.map(c => { let g = shopGoods.find(x => x.id === c.id); if(!g) return ''; let subtotal = g.price * c.count; total += subtotal; return `<div class="bg-white p-3 rounded-xl flex gap-3 items-center"><img src="${g.img}" class="w-16 h-16 rounded-lg object-contain bg-zinc-50 border border-zinc-100"><div class="flex-1"><b class="text-sm block line-clamp-1">${g.name}</b><span class="text-xs text-zinc-400 bg-zinc-50 px-1 rounded">${g.store}</span><div class="flex justify-between items-center mt-2"><span class="text-[#ff6700] font-bold">Â¥${g.price}</span><div class="flex items-center gap-3"><button onclick="chgShopCount(${g.id}, -1)" class="w-6 h-6 rounded border text-zinc-500 flex items-center justify-center">-</button><span class="text-sm font-bold w-4 text-center">${c.count}</span><button onclick="chgShopCount(${g.id}, 1)" class="w-6 h-6 rounded border text-zinc-500 flex items-center justify-center">+</button></div></div></div></div>`; }).join(''); $('shop-cart-total').innerText = total.toFixed(2); }
    function chgShopCount(id, delta) { let item = shopCart.find(x => x.id === id); if(!item) return; item.count += delta; if(item.count <= 0) shopCart = shopCart.filter(x => x.id !== id); saveAll(); renderShopCart(); updateShopCartBadge(); }
    function clearShopCart() { if(confirm("æ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ")) { shopCart=[]; saveAll(); renderShopCart(); updateShopCartBadge(); } }

    function doShopCheckout() { if(shopCart.length === 0) return alert("è¯·å…ˆé€‰è´­å•†å“"); let total = parseFloat($('shop-cart-total').innerText); createShopCheckoutModal(total); }
    function createShopCheckoutModal(total) {
        let roleName = curRole ? curRole.name : 'å¥½å‹'; let overlay = document.createElement('div'); overlay.className = "fixed inset-0 bg-black/50 z-[100] flex items-end";
        overlay.innerHTML = `<div class="bg-white w-full rounded-t-2xl p-6 animate-fade-in"><h3 class="text-lg font-bold mb-4 text-center">å•†åŸæ”¯ä»˜ Â¥${total.toFixed(2)}</h3><div class="space-y-3"><button onclick="handleShopPayOpt('wechat', ${total})" class="w-full py-3 bg-[#07c160] text-white rounded-lg font-bold">å¾®ä¿¡é›¶é’±æ”¯ä»˜</button><button onclick="handleShopPayOpt('bank', ${total})" class="w-full py-3 bg-[#e60012] text-white rounded-lg font-bold flex items-center justify-center gap-2">ğŸ’³ å‚¨è“„å¡æ”¯ä»˜</button><button onclick="handleShopPayOpt('friend', ${total})" class="w-full py-3 bg-white border border-[#ff6700] text-[#ff6700] rounded-lg font-bold flex items-center justify-center gap-2"><span>æ‰¾ ${roleName} ä»£ä»˜</span></button><button onclick="document.body.removeChild(this.parentNode.parentNode.parentNode)" class="w-full py-3 text-zinc-400">å–æ¶ˆ</button></div></div>`;
        document.body.appendChild(overlay); 
        window.handleShopPayOpt = (type, amt) => { 
            document.body.removeChild(overlay); 
            if(type === 'wechat') processShopSelfPay(amt); 
            if(type === 'bank') processBankPay(amt, 'shop');
            if(type === 'friend') { if(!takeoutCtx.fromChat) return alert("è¯·å…ˆåœ¨èŠå¤©å®¤å‘¼å‡ºå•†åŸï¼"); processShopFriendPay(amt); }
        };
    }
    function processShopSelfPay(total) { if(balance < total) return alert(`å¾®ä¿¡é›¶é’±ä¸è¶³ (å½“å‰ Â¥${balance.toFixed(2)})`); balance -= total; createShopOrder(total, 'paid'); alert("å¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼å®è´å°†å°½å¿«å‘è´§ã€‚"); saveAll(); openShopOrders('pending'); }
    function processShopFriendPay(total) { let firstItem = shopGoods.find(g => g.id === shopCart[0].id) || {name: "æœªçŸ¥", img:""}; let count = shopCart.reduce((a,b)=>a+b.count,0); let payMsg = { r: 'u', type: 'pay_request', status: 'pending', total: total, itemDisplay: `[å•†åŸ] ${firstItem.name} ç­‰ ${count} ä»¶`, img: firstItem.img, time: new Date().toLocaleString(), t: `[å•†åŸä»£ä»˜] Â¥${total}` }; curRole.history.push(payMsg); saveAll(); createShopOrder(total, 'wait_pay'); go('pg-chat-room'); renderMsgs(); setTimeout(() => triggerAiPayDecision(curRole.history.length - 1, total), 1500); }
    function createShopOrder(total, status) { let newOrder = { id: Date.now(), items: JSON.parse(JSON.stringify(shopCart)), total: total, time: Date.now(), status: status === 'paid' ? 'shipping' : 'pending_pay' }; shopOrders.unshift(newOrder); shopCart = []; saveAll(); }
    function openShopOrders(type) { go('pg-shop-orders'); let list = $('shop-order-list'); $('shop-order-title').innerText = type==='pending' ? 'å¾…æ”¶è´§' : 'å·²ä¹°åˆ°'; let filtered = type==='pending' ? shopOrders.filter(o => o.status === 'shipping') : shopOrders.filter(o => o.status !== 'shipping' && o.status !== 'pending_pay'); if(filtered.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— ç›¸å…³è®¢å•</div>`; return; } list.innerHTML = filtered.map(o => { let firstG = shopGoods.find(g => g.id === o.items[0].id) || {name:'æœªçŸ¥',store:''}; let count = o.items.reduce((a,b)=>a+b.count,0); let btn = o.status === 'shipping' ? `<button onclick="confirmShopRec(${o.id})" class="border border-[#ff6700] text-[#ff6700] px-3 py-1 rounded-full text-xs">ç¡®è®¤æ”¶è´§</button>` : `<span class="text-zinc-400 text-xs">äº¤æ˜“å®Œæˆ</span>`; return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-2"><b class="text-sm">${firstG.store}</b><span class="text-xs text-[#ff6700]">${o.status==='shipping'?'å•†å®¶å·²å‘è´§':'å·²å®Œæˆ'}</span></div><div class="flex gap-3 mb-2"><img src="${firstG.img}" class="w-16 h-16 rounded bg-zinc-50 object-contain"><div><div class="text-sm font-bold line-clamp-1">${firstG.name}</div><div class="text-xs text-zinc-400 mt-1">å…± ${count} ä»¶</div></div></div><div class="flex justify-between items-center border-t pt-2"><span class="font-bold">Â¥${o.total.toFixed(2)}</span>${btn}</div></div>`; }).join(''); }
    function confirmShopRec(oid) { let o = shopOrders.find(x=>x.id===oid); if(o){ o.status='completed'; saveAll(); openShopOrders('pending'); updateShopPendingBadge(); } }
    function updateShopPendingBadge() { let c = shopOrders.filter(o => o.status === 'shipping').length; let b = $('badge-shop-pending'); if(c>0){b.innerText=c;b.classList.remove('hidden');}else{b.classList.add('hidden');} }
    function renderFavs() { let list = $('shop-fav-list'); if(shopFavs.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">è¿˜æ²¡æœ‰æ”¶è—å•†å“</div>`; return; } list.innerHTML = shopFavs.map(id => { let g = shopGoods.find(x=>x.id===id); if(!g) return ''; return `<div onclick="showShopDetail(${g.id})" class="bg-white p-3 rounded-xl flex gap-3"><img src="${g.img}" class="w-20 h-20 rounded bg-zinc-50 object-contain"><div class="flex-1"><b class="text-sm">${g.name}</b><div class="mt-4 flex justify-between"><span class="text-[#ff6700] font-bold">Â¥${g.price}</span><span class="text-xs text-zinc-400">å·²æ”¶è—</span></div></div></div>`; }).join(''); }
    function saveNewGoods() { let s=$('sf-store').value, n=$('sf-name').value, p=parseFloat($('sf-price').value), i=$('sf-img').value; if(!s||!n||isNaN(p)) return alert("è¯·å¡«å†™å®Œæ•´"); shopGoods.push({id:Date.now(), store:s, name:n, price:p, sales:0, img:i||"https://img.icons8.com/color/480/box.png"}); saveAll(); alert("å‘å¸ƒæˆåŠŸ"); $('sf-name').value=''; go('pg-shop-me'); }

    // ================== 13. AI äº’åŠ¨åé¦ˆå¼•æ“ ==================
    async function triggerAiPayDecision(msgIdx, amount) {
        let msg = curRole.history[msgIdx]; if (!msg || msg.type !== 'pay_request') { msg = curRole.history.findLast(m => m.type === 'pay_request' && m.status === 'pending'); } if (!msg || msg.status !== 'pending') return;
        let loadingMsg = { r: 'ai', t: '', loading: true }; curRole.history.push(loadingMsg); renderMsgs(); let cfg = await getAICfg();
        let recentMsgs = curRole.history.slice(-15).filter(m => !m.loading && m.type === 'text').map(m => { let roleName = m.r === 'u' ? 'æˆ‘' : curRole.name; return `${roleName}: ${m.t}`; }).join('\n');
        let userMask = curRole.userMask || {}; let userName = userMask.name || "æˆ‘"; let userPersona = userMask.info || "æ™®é€šæœ‹å‹";
        let sysPrompt = `ä½ æ­£åœ¨è§’è‰²æ‰®æ¼”ã€‚\nã€ä½ çš„èº«ä»½ã€‘: ${curRole.name}\nã€ä½ çš„è®¾å®šã€‘: ${curRole.info}\nã€å¯¹æ‰‹è§’è‰²ã€‘: ${userName} (è®¾å®š: ${userPersona})\n\nã€å½“å‰äº‹ä»¶ã€‘\n${userName} ç»™ä½ å‘äº†ä»£ä»˜è¯·æ±‚ï¼Œé‡‘é¢ ${amount.toFixed(2)} å…ƒã€‚\n\nã€é€»è¾‘ã€‘\nç»“åˆã€è¿‘æœŸèŠå¤©ã€‘ã€‚ä¸¥ç¦å‡ºæˆï¼\n\nã€è¿‘æœŸèŠå¤©ã€‘\n${recentMsgs}\n\nã€å›å¤æ ¼å¼ã€‘\nè¯·ä¸¥æ ¼æŒ‰æ­¤æ ¼å¼è¾“å‡ºï¼š\n[CMD:ACCEPT] ä½ çš„å›å¤  (å¦‚åŒæ„)\n[CMD:REJECT] ä½ çš„å›å¤  (å¦‚æ‹’ç»)`;
        try {
            let replyContent = ""; let isAccept = false;
            if (cfg.key) { let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [ { role: 'system', content: sysPrompt } ] }) }); let data = await res.json(); let raw = data.choices[0].message.content; if (raw.includes('[CMD:ACCEPT]')) { isAccept = true; replyContent = raw.replace('[CMD:ACCEPT]', '').trim(); } else if (raw.includes('[CMD:REJECT]')) { isAccept = false; replyContent = raw.replace('[CMD:REJECT]', '').trim(); } else { isAccept = !raw.includes("ä¸") && !raw.includes("æ²¡é’±") && !raw.includes("æ‹’"); replyContent = raw; } } 
            else { isAccept = Math.random() > 0.4; replyContent = isAccept ? "è¡Œå§ï¼Œè¿™æ¬¡è¯·ä½ ã€‚" : "è‡ªå·±ä»˜ï¼Œæˆ‘å¯æ²¡é’±ã€‚"; }
            curRole.history.pop(); msg.status = isAccept ? 'paid' : 'rejected';
            let pendingFoodOrder = orders.find(o => o.status === 'pending_pay'); if (pendingFoodOrder) { if (isAccept) pendingFoodOrder.status = 'delivering'; else pendingFoodOrder.status = 'cancelled'; }
            let pendingShopOrder = shopOrders.find(o => o.status === 'pending_pay'); if (pendingShopOrder) { if (isAccept) pendingShopOrder.status = 'shipping'; else pendingShopOrder.status = 'cancelled'; }
            saveAll();
            if (!replyContent) replyContent = isAccept ? "å·²æ”¯ä»˜ã€‚" : "å·²æ‹’ç»ã€‚";
            curRole.history.push({ r: 'ai', t: replyContent, type: 'text' });
        } catch (e) { console.error("Pay Error", e); curRole.history.pop(); msg.status = 'rejected'; curRole.history.push({ r: 'ai', t: `(å†³ç­–å¤±è´¥)`, type: 'text' }); } finally { saveAll(); renderMsgs(); }
    }
    
    function shareOrder(oid) { if (!curRole) return alert("è¯·å…ˆä»èŠå¤©ç•Œé¢è¿›å…¥"); let o = orders.find(x => x.id === oid); let firstItem = foods.find(f => f.id === o.items[0].id); let count = o.items.reduce((a,b)=>a+b.count,0); let shareMsg = { r: 'u', type: 'order_share', itemDisplay: `${firstItem.name} ç­‰`, count: count, img: firstItem.img, t: `[åˆ†äº«å¤–å–] ${firstItem.name}` }; curRole.history.push(shareMsg); saveAll(); go('pg-chat-room'); renderMsgs(); setTimeout(() => triggerAiShareReaction(shareMsg), 1500); }
    async function triggerAiShareReaction(shareMsg) { let loadingMsg = { r: 'ai', t: '', loading: true }; curRole.history.push(loadingMsg); renderMsgs(); let cfg = await getAICfg(); let sysPrompt = `ä½ æ˜¯${curRole.name}ã€‚\nã€äº‹ä»¶ã€‘ï¼šç”¨æˆ·ç»™ä½ åˆ†äº«äº†å¤–å–ï¼š${shareMsg.itemDisplay}ã€‚\nã€äººè®¾ã€‘ï¼š${curRole.info}ã€‚\nã€è¦æ±‚ã€‘ï¼šåšå‡ºååº”ï¼Œå£è¯­åŒ–ã€‚`; try { let replyContent = ""; if (cfg.key) { let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }] }) }); let data = await res.json(); replyContent = data.choices[0].message.content; } else { replyContent = "çœ‹ç€ä¸é”™ï¼"; } curRole.history.pop(); curRole.history.push({ r: 'ai', t: replyContent, type: 'text' }); } catch (e) { curRole.history.pop(); } finally { saveAll(); renderMsgs(); } }
    
    async function triggerAiReaction(mid, userContent) { let activeRoles = roles.filter(r => chats.includes(r.id)); if(activeRoles.length === 0) activeRoles = roles; if(activeRoles.length === 0) return; let selectedRoles = activeRoles.sort(() => 0.5 - Math.random()).slice(0, 2); let cfg = await getAICfg(); if(!cfg.key) return; for (let role of selectedRoles) { if(Math.random() > 0.5) continue; let prompt = `ç”¨æˆ·åœ¨æœ‹å‹åœˆå‘ï¼šâ€œ${userContent}â€ã€‚ä½ æ˜¯${role.name}ã€‚è¾“å‡ºæŒ‡ä»¤ï¼š\n[LIKE]\n[COMMENT:ä½ çš„è¯„è®º]\n[LIKE][COMMENT:...]\n[IGNORE]`; try { let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] }) }); let data = await res.json(); let reply = data.choices[0].message.content; let m = mnts.find(x => x.id === mid); if(!m) return; if(reply.includes('[LIKE]')) { if(!m.likes) m.likes = []; if(!m.likes.includes(role.id)) m.likes.push(role.id); } let commMatch = reply.match(/\[COMMENT:(.*?)\]/); if(commMatch) { if(!m.comments) m.comments = []; m.comments.push({ uid: role.id, content: commMatch[1], time: Date.now() }); } saveAll(); if(curTab === 'moments') renderMnts(); } catch (e) {} } }
    async function triggerAiReplyToComment(mid, userComment, replyToUid) { let m = mnts.find(x => x.id === mid); if (!m) return; let targetRole = null; let systemPrompt = ""; if (replyToUid) { targetRole = roles.find(r => r.id === replyToUid); if (targetRole) { let prevComment = m.comments.findLast(c => c.uid === replyToUid && c.time < Date.now()); let prevContent = prevComment ? prevComment.content : "ï¼ˆæœªçŸ¥è¯„è®ºï¼‰"; systemPrompt = `æƒ…æ™¯ï¼šä½ åœ¨æœ‹å‹åœˆè¯„è®ºäº†ï¼šâ€œ${prevContent}â€ã€‚\nç”¨æˆ·å›å¤ä½ ï¼šâ€œ${userComment}â€ã€‚\nè¯·å›å¤ç”¨æˆ·ï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚`; } } else if (m.r !== 'u') { targetRole = roles.find(r => r.id === m.r); if (targetRole) { systemPrompt = `æƒ…æ™¯ï¼šä½ å‘äº†æœ‹å‹åœˆï¼šâ€œ${m.content}â€ã€‚\nå¥½å‹è¯„è®ºï¼šâ€œ${userComment}â€ã€‚\nè¯·å›å¤ä»–ã€‚`; } } if (targetRole && systemPrompt) { let cfg = await getAICfg(); if(!cfg.key) return; try { let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: systemPrompt }] }) }); let data = await res.json(); let reply = data.choices[0].message.content.replace(/^["â€œ]|["â€]$/g, '').trim(); if(!m.comments) m.comments = []; m.comments.push({ uid: targetRole.id, content: reply, time: Date.now(), replyToName: "æˆ‘" }); saveAll(); if(curTab === 'moments') renderMnts(); } catch (e) {} } }

    // ================== 14. å‚¨è“„å¡ã€é’±åŒ…ã€å……æä¸è”ä»˜æ ¸å¿ƒ ==================
    function renderWallet() { $('wallet-num').innerText = parseFloat(balance).toFixed(2); }
    function getBankRecords() { return JSON.parse(localStorage.getItem('OS67_BANK') || '[]'); }
    function addBankRecord(title, amount, isIncome) { let r = getBankRecords(); r.unshift({ id: Date.now(), title, amount, isIncome, time: new Date().toLocaleString() }); localStorage.setItem('OS67_BANK', JSON.stringify(r)); updateBankUI(); }
    function getBankBalance() { let r = getBankRecords(); return r.reduce((sum, item) => item.isIncome ? sum + item.amount : sum - item.amount, 0); }
    function updateBankUI() { let r = getBankRecords(); let income = 0, expense = 0, total = 0; r.forEach(item => { if (item.isIncome) { income += item.amount; total += item.amount; } else { expense += item.amount; total -= item.amount; } }); if($('bank-total-assets')) $('bank-total-assets').innerText = 'Â¥ ' + total.toFixed(2); if($('bank-month-income')) $('bank-month-income').innerText = 'Â¥ ' + income.toFixed(2); if($('bank-month-expense')) $('bank-month-expense').innerText = 'Â¥ ' + expense.toFixed(2); }
    
    window.processBankPay = function(total, type) { let bankBal = getBankBalance(); if(bankBal < total) return alert(`å‚¨è“„å¡ä½™é¢ä¸è¶³ï¼\nå½“å‰æ€»èµ„äº§: Â¥${bankBal.toFixed(2)}\nè¯·å…ˆå»é“¶è¡ŒAppç‚¹å‡»â€œé“¶è¡Œå¡å…¥è´¦â€ã€‚`); addBankRecord(type === 'food' ? 'å¤–å–æ¶ˆè´¹' : 'å•†åŸæ¶ˆè´¹', total, false); if(type === 'food') { createOrder(total, 'paid'); alert("å‚¨è“„å¡æ”¯ä»˜æˆåŠŸï¼"); go('pg-takeout-pending'); renderPendingOrders(); } else { createShopOrder(total, 'paid'); alert("å‚¨è“„å¡æ”¯ä»˜æˆåŠŸï¼"); openShopOrders('pending'); } };
    window.simulateBankIncome = function() { let val = prompt("ã€æ¨¡æ‹Ÿå‚¨è“„å¡å…¥è´¦ã€‘\nè¯·è¾“å…¥é‡‘é¢ï¼š"); if(val === null) return; let num = parseFloat(val); if(isNaN(num) || num <= 0) return alert("é‡‘é¢æ— æ•ˆï¼"); addBankRecord('å¤–éƒ¨è½¬å…¥/å‘å·¥èµ„', num, true); alert(`æˆåŠŸå…¥è´¦ Â¥${num.toFixed(2)}ï¼`); }
    function toBankTab(tab) { $('bank-tab-home').classList.add('hidden'); $('bank-tab-me').classList.add('hidden'); $('nav-bank-home').className = "text-center flex-1 py-1 cursor-pointer text-zinc-400"; $('nav-bank-me').className = "text-center flex-1 py-1 cursor-pointer text-zinc-400"; $('bank-tab-' + tab).classList.remove('hidden'); $('nav-bank-' + tab).classList.add('text-[#e60012]', 'font-bold'); $('nav-bank-' + tab).classList.remove('text-zinc-400'); if (tab === 'me') updateBankUI(); }
    function renderBankRecords() { let list = $('bank-records-list'); let records = getBankRecords(); if(records.length === 0) { list.innerHTML = '<div class="text-center text-zinc-400 mt-32 text-sm">æš‚æ— æ”¶æ”¯æ˜ç»†</div>'; return; } list.innerHTML = records.map(r => `<div class="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm border-b border-zinc-50"><div class="flex flex-col"><b class="text-base text-zinc-800">${r.title}</b><span class="text-xs text-zinc-400 mt-1">${r.time}</span></div><div class="font-bold text-lg ${r.isIncome ? 'text-[#e60012]' : 'text-zinc-800'}">${r.isIncome ? '+' : '-'}${r.amount.toFixed(2)}</div></div>`).join(''); }

    function walletOp(type) { if(type === 'add') { initRechargePage(); go('pg-recharge'); } else { initWithdrawPage(); go('pg-withdraw'); } }

    let rechargeInputVal = ""; function initRechargePage() { rechargeInputVal = ""; updateRechargeDisplay(); }
    window.handleRechargeInput = function(key) { if (key === 'del') rechargeInputVal = rechargeInputVal.slice(0, -1); else if (key === '.') { if (!rechargeInputVal.includes('.') && rechargeInputVal.length > 0) rechargeInputVal += key; else if (rechargeInputVal.length === 0) rechargeInputVal = "0."; } else { if (rechargeInputVal === '0' && key !== '.') rechargeInputVal = key; else if (rechargeInputVal.includes('.')) { if (rechargeInputVal.split('.')[1].length < 2) rechargeInputVal += key; } else if (rechargeInputVal.length < 8) rechargeInputVal += key; } updateRechargeDisplay(); }
    function updateRechargeDisplay() { $('recharge-amount-display').innerText = rechargeInputVal; $('recharge-cursor').style.display = rechargeInputVal.length > 0 ? 'none' : 'inline'; const btn = $('btn-recharge-confirm'); let num = parseFloat(rechargeInputVal); if (!isNaN(num) && num > 0) btn.classList.remove('opacity-40', 'pointer-events-none'); else btn.classList.add('opacity-40', 'pointer-events-none'); }
    window.confirmRecharge = function() { let num = parseFloat(rechargeInputVal); if (isNaN(num) || num <= 0) return; let bankBal = getBankBalance(); if (bankBal < num) return alert(`å‚¨è“„å¡ä½™é¢ä¸è¶³ï¼å½“å‰ä»…æœ‰ Â¥${bankBal.toFixed(2)}`); balance += num; saveAll(); renderWallet(); addBankRecord('å¾®ä¿¡å……å€¼æ‰£æ¬¾', num, false); let toast = document.createElement('div'); toast.className = "fixed inset-0 z-[100] flex items-center justify-center bg-white animate-fade-in"; toast.innerHTML = `<div class="flex flex-col items-center"><div class="w-20 h-20 bg-[#07c160] rounded-full flex items-center justify-center mb-4"><span class="text-white text-4xl">âœ”</span></div><b class="text-xl mb-2">å……å€¼æˆåŠŸ</b><div class="text-4xl font-bold">Â¥${num.toFixed(2)}</div></div>`; document.body.appendChild(toast); setTimeout(() => { document.body.removeChild(toast); go('pg-wallet'); initRechargePage(); }, 1500); }
    window.focusRechargeInput = function() { $('recharge-cursor').style.display = 'inline'; }

    let withdrawInputVal = ""; function initWithdrawPage() { withdrawInputVal = ""; $('withdraw-max-text').innerText = parseFloat(balance).toFixed(2); updateWithdrawDisplay(); }
    window.withdrawAll = function() { if(balance <= 0) return; withdrawInputVal = parseFloat(balance).toFixed(2); updateWithdrawDisplay(); }
    window.handleWithdrawInput = function(key) { if (key === 'del') withdrawInputVal = withdrawInputVal.slice(0, -1); else if (key === '.') { if (!withdrawInputVal.includes('.') && withdrawInputVal.length > 0) withdrawInputVal += key; else if (withdrawInputVal.length === 0) withdrawInputVal = "0."; } else { if (withdrawInputVal === '0' && key !== '.') withdrawInputVal = key; else if (withdrawInputVal.includes('.')) { if (withdrawInputVal.split('.')[1].length < 2) withdrawInputVal += key; } else if (withdrawInputVal.length < 8) withdrawInputVal += key; } updateWithdrawDisplay(); }
    function updateWithdrawDisplay() { $('withdraw-amount-display').innerText = withdrawInputVal; $('withdraw-cursor').style.display = withdrawInputVal.length > 0 ? 'none' : 'inline'; const btn = $('btn-withdraw-confirm'); let num = parseFloat(withdrawInputVal); if (!isNaN(num) && num > 0) btn.classList.remove('opacity-40', 'pointer-events-none'); else btn.classList.add('opacity-40', 'pointer-events-none'); }
    window.confirmWithdraw = function() { let num = parseFloat(withdrawInputVal); if (isNaN(num) || num <= 0) return; if (num > balance) return alert("å¾®ä¿¡é›¶é’±ä½™é¢ä¸è¶³ï¼"); balance -= num; saveAll(); renderWallet(); addBankRecord('å¾®ä¿¡æç°å…¥è´¦', num, true); let toast = document.createElement('div'); toast.className = "fixed inset-0 z-[100] flex items-center justify-center bg-[#f7f7f7] animate-fade-in"; toast.innerHTML = `<div class="flex flex-col items-center mt-20"><div class="w-16 h-16 bg-[#07c160] rounded-full flex items-center justify-center mb-6"><span class="text-white text-3xl">âœ”</span></div><b class="text-xl mb-4">æç°å‘èµ·æˆåŠŸ</b><div class="text-4xl font-bold mb-2">Â¥${num.toFixed(2)}</div><div class="text-sm text-zinc-400">é¢„è®¡2å°æ—¶å†…åˆ°è´¦</div></div>`; document.body.appendChild(toast); setTimeout(() => { document.body.removeChild(toast); go('pg-wallet'); initWithdrawPage(); }, 1800); }
    window.focusWithdrawInput = function() { $('withdraw-cursor').style.display = 'inline'; }

    // å…¨å±€ç‚¹å‡»å…³é—­ä¸‹æ‹‰èœå•
    function closeAllMenus() { 
        let drop = $('plus-dropdown'); 
        if(drop && !drop.classList.contains('hidden')) drop.classList.add('hidden'); 
    }

    // ================== å‘èµ·èŠå¤© & ç¾¤èŠå¼¹çª—é€»è¾‘ ==================
    window.handlePlusBtn = function(e) {
        if(e) e.stopPropagation();
        if (curTab === 'cont') openRoleEdit(null); 
        else if (curTab === 'moments') go('pg-moments-pub');
        else {
            let drop = $('plus-dropdown');
            if (drop) drop.classList.toggle('hidden');
        }
    };

    // --- å•äººèŠå¤© ---
    window.openSingleChatSelector = function() {
        $('plus-dropdown').classList.add('hidden');
        const list = document.getElementById('role-selector-list');
        let realRoles = roles.filter(r => !r.isGroup); // è¿‡æ»¤æ‰ç¾¤èŠï¼Œåªæ‹‰å–å•äºº
        if (realRoles.length === 0) list.innerHTML = `<div class="py-20 text-center text-zinc-400">æš‚æ— è§’è‰²ï¼Œè¯·å…ˆå»â€œé€šè®¯å½•â€æ·»åŠ </div>`;
        else list.innerHTML = realRoles.map(r => `<div onclick="selectRoleToChat('${r.id}')" class="p-4 flex items-center gap-4 active:bg-zinc-100 border-b border-zinc-50 cursor-pointer"><img src="${r.ava}" class="w-12 h-12 rounded-lg object-cover bg-zinc-200 shrink-0"><div class="flex-1 min-w-0"><b class="block text-base text-zinc-800 truncate">${r.name}</b><p class="text-xs text-zinc-400 truncate mt-1">${r.info || 'ç‚¹å‡»å¼€å§‹å¯¹è¯'}</p></div></div>`).join('');
        document.getElementById('role-selector-modal').style.display = 'flex';
    };
    window.closeRoleSelector = function() { document.getElementById('role-selector-modal').style.display = 'none'; };
    window.selectRoleToChat = function(rid) { window.closeRoleSelector(); if (typeof enterChat === 'function') enterChat(rid); };

        // --- å¤šäººç¾¤èŠ (å®Œç¾ä¿®å¤é€‰ä¸­ Bug) ---
    let selectedGroupIds = [];
    window.openGroupChatSelector = function() {
        $('plus-dropdown').classList.add('hidden');
        selectedGroupIds = [];
        renderGroupSelectorList();
        document.getElementById('group-selector-modal').style.display = 'flex';
    };

    window.renderGroupSelectorList = function() {
        const list = document.getElementById('group-selector-list');
        let realRoles = roles.filter(r => !r.isGroup);
        $('group-sel-count').innerText = selectedGroupIds.length;
        if (realRoles.length === 0) { list.innerHTML = `<div class="py-20 text-center text-zinc-400">è§’è‰²ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºç¾¤èŠ</div>`; return; }
        list.innerHTML = realRoles.map(r => {
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå°†æ•°å­—IDå¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç¡®ä¿å¯¹æ¯”æˆåŠŸï¼
            let strId = String(r.id);
            let isSel = selectedGroupIds.includes(strId);
            return `
            <div onclick="toggleGroupRole('${strId}')" class="p-4 flex items-center gap-4 active:bg-zinc-100 border-b border-zinc-50 cursor-pointer">
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 transition-colors ${isSel ? 'border-[#07c160] bg-[#07c160]' : 'border-zinc-300'}">${isSel ? '<span class="text-white text-xs">âœ”</span>' : ''}</div>
                <img src="${r.ava}" class="w-12 h-12 rounded-lg object-cover bg-zinc-200 shrink-0">
                <div class="flex-1 min-w-0"><b class="block text-base text-zinc-800 truncate">${r.name}</b></div>
            </div>`;
        }).join('');
    };

    window.toggleGroupRole = function(rid) {
        let strId = String(rid); // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²å¤„ç†
        if (selectedGroupIds.includes(strId)) selectedGroupIds = selectedGroupIds.filter(id => id !== strId);
        else selectedGroupIds.push(strId);
        renderGroupSelectorList();
    };

    window.closeGroupSelector = function() { document.getElementById('group-selector-modal').style.display = 'none'; };

    window.confirmCreateGroup = function() {
        if (selectedGroupIds.length < 2) return alert("è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªè§’è‰²å‘èµ·ç¾¤èŠå“¦");
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šè¿‡æ»¤å‡ºé€‰ä¸­çš„è§’è‰²æ—¶ï¼ŒåŒæ ·å¼ºåˆ¶è½¬æ¢IDè¿›è¡ŒåŒ¹é…
        let selectedRoles = roles.filter(r => selectedGroupIds.includes(String(r.id)));
        let groupName = selectedRoles.map(r => r.name).join('ã€');
        if (groupName.length > 12) groupName = groupName.substring(0, 12) + '...';
        
        let groupInfo = `ã€ç³»ç»Ÿå¼ºåˆ¶è®¾å®šï¼šè¿™æ˜¯ä¸€ä¸ªå¤šäººç¾¤èŠã€‘\nä½ ç°åœ¨çš„èº«ä»½ä¸æ˜¯å•ä¸ªäººï¼Œè€Œæ˜¯ç¾¤é‡Œçš„å¤šä¸ªæˆå‘˜ã€‚è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹ç¾¤æˆå‘˜çš„æ€§æ ¼è®¾å®šï¼Œå¹¶æ ¹æ®ç”¨æˆ·çš„å‘è¨€ï¼Œè‡ªç”±åˆ¤æ–­è®©å“ªä¸ªè§’è‰²ï¼ˆæˆ–å“ªå‡ ä¸ªè§’è‰²ï¼‰è¿›è¡Œå›å¤ã€‚å›å¤æ—¶å¿…é¡»å¸¦ä¸Šäººåä½œä¸ºå‰ç¼€ï¼ˆæ ¼å¼ä¸º"è§’è‰²åï¼šè¯´çš„è¯"ï¼‰ã€‚\nã€ç¾¤æˆå‘˜åˆ—è¡¨åŠè®¾å®šã€‘ï¼š\n` + selectedRoles.map(r => `- ${r.name}: ${r.info}`).join('\n');
        
        let newGroup = {
            id: 'group_' + Date.now(),
            isGroup: true,
            memberIds: selectedGroupIds,
            name: groupName + ` (${selectedGroupIds.length})`,
            ava: 'https://img.icons8.com/color/96/user-group-man-man.png',
            info: groupInfo,
            history: []
        };
        
        roles.unshift(newGroup);
        chats.unshift(newGroup.id);
        saveAll();
        closeGroupSelector();
        enterChat(newGroup.id);
    };
ã€€ã€€    // ================== æ–°å¢ï¼šè§’è‰²æ—¥è®°ç³»ç»Ÿ ==================
    function openDiaryPage() {
        if (!curRole) return;
        if (curRole.isGroup) return alert("ç¾¤èŠæš‚æ—¶ä¸æ”¯æŒå·çœ‹æ—¥è®°å“¦~");
        
        $('chat-pnl').classList.remove('drawer-open');
        lastPnlType = null;
        
        $('diary-title').innerText = `${curRole.name} çš„æ—¥è®°`;
        if (!curRole.diaries) curRole.diaries = [];
        
        renderDiaryList();
        go('pg-diary');
    }

    function renderDiaryList() {
        const list = $('diary-list');
        if (!curRole || !curRole.diaries || curRole.diaries.length === 0) {
            list.innerHTML = `<div class="flex flex-col items-center justify-center mt-32 opacity-50"><div class="text-6xl mb-4">âœï¸</div><div class="text-sm text-zinc-500">Taè¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°...<br>ç‚¹å‡»å³ä¸Šè§’è®©Taå†™ä¸€ç¯‡å§ï¼</div></div>`;
            return;
        }
        
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
        let sorted = [...curRole.diaries].sort((a, b) => b.timestamp - a.timestamp);
        
        list.innerHTML = sorted.map(d => `
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-zinc-100 relative group animate-fade-in">
                <div class="flex justify-between items-center mb-3 border-b border-zinc-50 pb-2">
                    <span class="text-sm font-bold text-[#576b95]">${d.date}</span>
                    <span onclick="deleteDiary(${d.id})" class="text-xs text-zinc-300 cursor-pointer hover:text-red-500">åˆ é™¤</span>
                </div>
                <div class="text-[15px] text-zinc-800 leading-loose whitespace-pre-wrap font-serif text-justify">${d.content}</div>
            </div>
        `).join('');
    }

    function deleteDiary(id) {
        if (!confirm("ç¡®å®šè¦é”€æ¯è¿™ç¯‡æ—¥è®°å—ï¼Ÿ")) return;
        curRole.diaries = curRole.diaries.filter(d => d.id !== id);
        saveAll();
        renderDiaryList();
    }

    async function generateDiary() {
        if (!curRole) return;
        let cfg = await getAICfg();
        if (!cfg.key) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Keyï¼");
        
        // ğŸ¯ ä¼˜åŒ–ï¼šæ—¥è®°ç´ æä¼šåŒæ—¶æŠ“å–â€œå¾®ä¿¡â€å’Œâ€œçº¿ä¸‹â€çš„æ‰€æœ‰æ–‡æœ¬è®°å½•ï¼Œä¿è¯ç´ æå®Œæ•´
        let recentMsgs = (curRole.history || [])
            .filter(m => !m.loading && m.type === 'text')
            .slice(-30) // å–æœ€è¿‘30æ¡ï¼Œç´ ææ›´ä¸°å¯Œ
            .map(m => {
                let roleName = m.r === 'u' ? 'ç”¨æˆ·' : curRole.name;
                // æ ‡æ³¨åœºæ™¯ï¼Œå¸® AI æ›´å¥½åœ°ç†è§£ä¸Šä¸‹æ–‡
                let sceneLabel = m.scene === 'story' ? '[çº¿ä¸‹è§é¢]' : '[å¾®ä¿¡èŠå¤©]';
                return `${sceneLabel} ${roleName}: ${m.t}`;
            }).join('\n');

        let btn = document.querySelector('[onclick="generateDiary()"]');
        let oldText = btn ? btn.innerText : "å·çœ‹ä»Šæ—¥";
        if(btn) {
            btn.innerText = "æ’°å†™ä¸­...";
            btn.style.pointerEvents = 'none';
            btn.classList.add('opacity-50');
        }

        let todayStr = new Date().toLocaleDateString();
        let prompt = `ä½ ç°åœ¨æ˜¯${curRole.name}ã€‚ä½ çš„æ€§æ ¼è®¾å®šæ˜¯ï¼š${curRole.info}ã€‚
        è¯·æ ¹æ®ä»¥ä¸‹è¿™æ®µæ—¶é—´ä½ å’Œç”¨æˆ·çš„äº’åŠ¨è®°å½•ï¼ˆåŒ…å«å¾®ä¿¡èŠå¤©å’Œçº¿ä¸‹è§é¢ï¼‰ï¼Œä»¥ã€ç¬¬ä¸€äººç§°ã€‘å†™ä¸€ç¯‡ç§˜å¯†æ—¥è®°ã€‚
        è¦æ±‚ï¼š
        1. è¯­æ°”å¿…é¡»ç¬¦åˆä½ çš„æ€§æ ¼ï¼Œåƒæ˜¯åœ¨è‡ªè¨€è‡ªè¯­ã€‚
        2. ä¸¥ç¦è¾“å‡ºåºŸè¯æˆ– <think> æ ‡ç­¾ï¼Œç›´æ¥è¾“å‡ºæ—¥è®°æ­£æ–‡ã€‚
        ã€äº’åŠ¨è®°å½•å¦‚ä¸‹ã€‘ï¼š
        ${recentMsgs ? recentMsgs : "(æ­¤åˆ»ä½ æ­£ä¸€ä¸ªäººå¾…ç€ï¼Œå†™å†™å¯¹ç”¨æˆ·çš„æ€å¿µæˆ–è¿‘å†µå§)"}`;

        try {
            let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, {
                method: 'POST',
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` },
                body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] })
            });
            
            // --- æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ å®‰å…¨æ€§æ£€æŸ¥ï¼Œé˜²æ­¢ reading '0' æŠ¥é”™ ---
            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.error?.message || `HTTP é”™è¯¯ ${res.status}`);
            }

            let data = await res.json();
            
            if (!data.choices || data.choices.length === 0) {
                throw new Error("API æœªèƒ½ç”Ÿæˆæœ‰æ•ˆå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹è®¾ç½®æˆ–ä½™é¢");
            }

            let diaryContent = cleanText(data.choices[0].message.content);

            if (!curRole.diaries) curRole.diaries = [];
            let existingIdx = curRole.diaries.findIndex(d => d.date === todayStr);
            if (existingIdx > -1) {
                curRole.diaries[existingIdx].content = diaryContent;
                curRole.diaries[existingIdx].timestamp = Date.now();
            } else {
                curRole.diaries.push({ id: Date.now(), date: todayStr, content: diaryContent, timestamp: Date.now() });
            }
            
            saveAll();
            renderDiaryList();
        } catch (e) {
            console.error("Diary Generation Error:", e);
            alert("ç”Ÿæˆå¤±è´¥è¯¦æƒ…: " + e.message); // ä¼šå¼¹å‡ºå…·ä½“çš„æŠ¥é”™åŸå› 
        } finally {
            if(btn) {
                btn.innerText = oldText;
                btn.style.pointerEvents = 'auto';
                btn.classList.remove('opacity-50');
            }
        }
    } 
    // ================== 15. éŸ³ä¹æ’­æ”¾å™¨ä¸æœ¬åœ°ä¸Šä¼ é€»è¾‘ ==================
    function toMusicTab(tab) {
        $('pg-music-player').classList.remove('active');
        $('pg-music-me').classList.remove('active');
        $('pg-music-' + tab).classList.add('active');
        if(tab === 'me') renderMusicLib();
        if(tab === 'player') renderMusicPlayer();
    }

    // ç›‘å¬åŸç”Ÿ Audio äº‹ä»¶åŒæ­¥ UI
        curAudio.ontimeupdate = () => {
        if (isNaN(curAudio.duration)) return;
        // æ›´æ–°è¿›åº¦æ¡
        $('music-progress').value = (curAudio.currentTime / curAudio.duration) * 100;
        $('music-time-cur').innerText = formatTime(curAudio.currentTime);
        $('music-time-total').innerText = formatTime(curAudio.duration);
        
        // === æ ¸å¿ƒï¼šæ­Œè¯å¹³æ»‘æ»šåŠ¨é€»è¾‘ ===
        if (parsedLyrics.length === 0) return;
        let currentTime = curAudio.currentTime;
        let newIdx = -1;
        // æ‰¾å‡ºå½“å‰å”±åˆ°äº†å“ªä¸€å¥
        for (let i = 0; i < parsedLyrics.length; i++) {
            if (currentTime >= parsedLyrics[i].time - 0.3) newIdx = i; // æå‰0.3ç§’é«˜äº®ï¼Œè§†è§‰æ›´èˆ’æœ
            else break;
        }
        
        if (newIdx !== activeLyricIdx && newIdx !== -1 && parsedLyrics[newIdx].time !== 9999) {
            // å–æ¶ˆä¸Šä¸€å¥çš„é«˜äº®
            if(activeLyricIdx !== -1 && $(`lyr-line-${activeLyricIdx}`)) {
                let oldEl = $(`lyr-line-${activeLyricIdx}`);
                oldEl.className = "text-[14px] text-zinc-400 font-serif opacity-60 transition-all duration-300 leading-relaxed";
            }
            // é«˜äº®æ–°çš„ä¸€å¥ (å˜å¤§ã€å˜é»‘ã€åŠ ç²—)
            activeLyricIdx = newIdx;
            let newEl = $(`lyr-line-${activeLyricIdx}`);
            if(newEl) {
                newEl.className = "text-[17px] text-zinc-800 font-serif font-bold opacity-100 drop-shadow-sm transition-all duration-300 leading-relaxed scale-105 origin-center";
            }
            // æ»šåŠ¨è®¡ç®—ï¼šæ¯è¡Œé«˜åº¦çº¦ 34px
            const box = $('lyric-scroll-box');
            if(box) {
                const offset = -(newIdx * 34); 
                box.style.transform = `translateY(${offset}px)`;
            }
        }
    };
    curAudio.onended = () => nextMusic();

    function formatTime(seconds) {
        let m = Math.floor(seconds / 60);
        let s = Math.floor(seconds % 60);
        return m + ":" + (s < 10 ? "0" + s : s);
    }
    // === 1. è§£æ LRC æ—¶é—´æ ‡ç­¾ ===
    function parseLyrics(lrcText) {
        parsedLyrics = [];
        if (!lrcText) return;
        const lines = lrcText.split('\n');
        const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g;
        
        lines.forEach(line => {
            let match;
            let text = line.replace(timeReg, '').trim();
            timeReg.lastIndex = 0;
            let hasTime = false;
            while ((match = timeReg.exec(line)) !== null) {
                hasTime = true;
                let min = parseInt(match[1]);
                let sec = parseInt(match[2]);
                let ms = match[3].length === 2 ? parseInt(match[3]) * 10 : parseInt(match[3]);
                parsedLyrics.push({ time: min * 60 + sec + ms / 1000, text: text || " " });
            }
            // å¦‚æœæŸä¸€è¡Œæ²¡æœ‰æ—¶é—´æ ‡ç­¾ï¼Œå½“ä½œé™æ€æ–‡æœ¬å¡è¿›å»
            if (!hasTime && line.trim()) parsedLyrics.push({ time: 9999, text: line.trim() });
        });
        parsedLyrics.sort((a, b) => a.time - b.time);
    }

    // === 2. æ¸²æŸ“æ­Œè¯åˆ—è¡¨ ===
    function renderLyricsUI() {
        const box = $('lyric-scroll-box');
        if(parsedLyrics.length === 0) {
            box.innerHTML = `
                <div class="text-[15px] text-zinc-800 font-serif tracking-widest drop-shadow-sm">æš‚æ— æ­Œè¯</div>
                <div class="text-[12px] text-zinc-400 font-serif">ç‚¹å‡»æ­¤å¤„ç²˜è´´ LRC æ»šåŠ¨æ­Œè¯</div>`;
            box.style.transform = `translateY(0px)`;
            return;
        }
        // ç”Ÿæˆæ¯ä¸€è¡Œæ­Œè¯çš„ HTML
        box.innerHTML = parsedLyrics.map((line, i) => `<div id="lyr-line-${i}" class="text-[14px] text-zinc-400 font-serif opacity-60 transition-all duration-300 leading-relaxed">${line.text}</div>`).join('');
        box.style.transform = `translateY(0px)`;
    }

    // === 3. ç”¨æˆ·ç‚¹å‡»ç²˜è´´æ­Œè¯ ===
    window.editLyrics = function() {
        if (curMusicIdx === -1) return;
        let m = musicLib[curMusicIdx];
        let input = prompt("è¯·ç²˜è´´å¸¦æœ‰æ—¶é—´æ ‡ç­¾çš„ LRC æ­Œè¯\n(ä¾‹å¦‚: [00:15.30]å¾®é£æ‹‚è¿‡...)\n\nå¦‚æœä½ ç›´æ¥æ‰“å­—ï¼Œå°†ä½œä¸ºé™æ€æ–‡æœ¬æ˜¾ç¤ºï¼š", m.lrc || "");
        if (input !== null) {
            m.lrc = input;
            saveAll().then(() => {
                parseLyrics(m.lrc);
                renderLyricsUI();
                activeLyricIdx = -1; // é‡ç½®æ»šåŠ¨
            });
        }
    };
    function renderMusicPlayer() {
        if (curMusicIdx === -1 && musicLib.length > 0) curMusicIdx = 0;
        if (curMusicIdx === -1) return; // æ²¡æ­Œ       
                let m = musicLib[curMusicIdx];
        $('music-title').innerText = m.title;
        $('music-artist').innerText = m.artist;       
        parseLyrics(m.lrc || "");
        renderLyricsUI();
        activeLyricIdx = -1;
ã€€ã€€
        // ğŸ¯ æ–°å¢ï¼šå¦‚æœæœ‰è‡ªå®šä¹‰å°é¢å°±ç”¨è‡ªå®šä¹‰çš„ï¼Œæ²¡æœ‰å°±ç”¨é»˜è®¤çš„æ˜Ÿç©ºå›¾
        $('music-cover').src = m.cover || "https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=500&auto=format&fit=crop";
        // æ›´æ–°æ’­æ”¾æŒ‰é’®å’Œæ—‹è½¬åŠ¨ç”»
        let cover = $('music-cover');
        let playBtn = $('btn-music-play');
        if (isPlaying) {
            playBtn.innerHTML = '<span class="text-3xl font-bold -mt-1">||</span>';
            cover.classList.remove('spin-paused');
        } else {
            playBtn.innerText = 'â–¶';
            cover.classList.add('spin-paused');
        }
    }

    function togglePlay() {
        if (curMusicIdx === -1) {
            if (musicLib.length > 0) playMusicIndex(0);
            else alert("æœ¬åœ°éŸ³ä¹åº“ä¸ºç©ºï¼Œè¯·å…ˆå»â€œæˆ‘â€çš„é¡µé¢ä¸Šä¼ éŸ³ä¹~");
            return;
        }
        if (isPlaying) {
            curAudio.pause();
            isPlaying = false;
        } else {
            // å¦‚æœ audio çš„ src ä¸ºç©ºï¼Œéœ€è¦å…ˆèµ‹å€¼
            if(!curAudio.src) loadAudioSource(musicLib[curMusicIdx]);
            curAudio.play().catch(e => alert("æ’­æ”¾å¤±è´¥, å¯èƒ½æ˜¯æµè§ˆå™¨é™åˆ¶è‡ªåŠ¨æ’­æ”¾"));
            isPlaying = true;
        }
        renderMusicPlayer();
    }

        function loadAudioSource(m) {
        // ğŸ¯ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ˜¯å­˜åœ¨æ•°æ®åº“é‡Œçš„åº•å±‚äºŒè¿›åˆ¶æ•°æ®ï¼Œå°†å…¶é‡å¡‘ä¸º Blob åæ’­æ”¾
        if (m.buffer) {
            const blob = new Blob([m.buffer], { type: m.type || 'audio/mpeg' });
            curAudio.src = URL.createObjectURL(blob);
        } 
        // å…¼å®¹å¤„ç†ï¼šè¶…è¿‡15MBæœªä¿å­˜çš„ä¸´æ—¶æ–‡ä»¶
        else if (m.blob) {
            curAudio.src = URL.createObjectURL(m.blob);
        } 
        // å…¼å®¹å¤„ç†ï¼šç½‘ç»œç›´é“¾
        else if (m.url) { 
            curAudio.src = m.url;
        }
    }

    function playMusicIndex(idx) {
        if(idx < 0 || idx >= musicLib.length) return;
        curMusicIdx = idx;
        let m = musicLib[idx];
        loadAudioSource(m);
        curAudio.play();
        isPlaying = true;
        renderMusicPlayer();
    }

    function nextMusic() {
        if(musicLib.length <= 1) return;
        let next = curMusicIdx + 1;
        if(next >= musicLib.length) next = 0;
        playMusicIndex(next);
    }

    function prevMusic() {
        if(musicLib.length <= 1) return;
        let prev = curMusicIdx - 1;
        if(prev < 0) prev = musicLib.length - 1;
        playMusicIndex(prev);
    }

    function seekMusic(val) {
        if (isNaN(curAudio.duration)) return;
        curAudio.currentTime = (val / 100) * curAudio.duration;
    }

    function toggleMusicFav() {
        let btn = $('music-fav-btn');
        if (btn.innerText === 'â™¡') { btn.innerText = 'â¤ï¸'; btn.classList.add('text-red-500'); }
        else { btn.innerText = 'â™¡'; btn.classList.remove('text-red-500'); }
    }

    // --- æœ¬åœ°ä¸Šä¼ ä¸åˆ—è¡¨æ¸²æŸ“ ---
// --- æœ¬åœ°å°é¢ä¸Šä¼ å¤„ç† ---
    function handleCoverUpload(event) {
        if (curMusicIdx === -1) return;
        const file = event.target.files[0];
        if (!file) return;

        // ä½¿ç”¨ FileReader è¯»å–å›¾ç‰‡ï¼Œè½¬æ¢ä¸º Base64 æ ¼å¼å­˜å…¥æ•°æ®åº“
        const reader = new FileReader();
        reader.onload = function(e) {
            // å°†å›¾ç‰‡æ•°æ®ç»‘å®šåˆ°å½“å‰æ­£åœ¨æ’­æ”¾çš„è¿™é¦–æ­Œä¸Š
            musicLib[curMusicIdx].cover = e.target.result;
            
            saveAll().then(() => {
                renderMusicPlayer(); // åˆ·æ–° UIï¼Œç«‹å³æ˜¾ç¤ºæ–°å°é¢
            }).catch(err => {
                alert("å°é¢ä¿å­˜å¤±è´¥ï¼Œå›¾ç‰‡å¯èƒ½è¿‡å¤§ï¼");
            });
        };
        reader.readAsDataURL(file);
        
        event.target.value = ''; // æ¸…ç©º input æ–¹ä¾¿é‡å¤ä¸Šä¼ 
    }ã€€
   
    function handleLocalMusicUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è¶…è¿‡ 15MB
        const isOversize = file.size > 15 * 1024 * 1024;
        
        let newId = Date.now();
        let newMusic = {
            id: newId,
            title: file.name.replace(/\.[^/.]+$/, ""), 
            artist: isOversize ? "æœ¬åœ°è¯•å¬ (ä¸ä¿å­˜)" : "æœ¬åœ°ä¸Šä¼ ",
            type: file.type || 'audio/mpeg' // æ–°å¢ï¼šè®°å½•éŸ³é¢‘çš„åŸå§‹æ ¼å¼
        };
        
        // å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œç›´æ¥ä½¿ç”¨ä¸´æ—¶æ’­æ”¾ï¼ˆä¸å¼ºè¡Œå­˜å…¥æ•°æ®åº“ï¼‰
        if (isOversize) {
            alert("æ–‡ä»¶è¾ƒå¤§ï¼Œå·²å¼€å¯ä¸´æ—¶æ’­æ”¾ï¼ˆåˆ·æ–°é¡µé¢åä¼šæ¶ˆå¤±å“¦ï¼‰ğŸµ");
            newMusic.blob = file; // ä¸´æ—¶è®°å½•
            musicLib.push(newMusic);
            renderMusicLib();
            if(musicLib.length === 1) { curMusicIdx = 0; renderMusicPlayer(); }
            event.target.value = '';
            return;
        }

        // ğŸ¯ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ FileReader è¯»å–ä¸ºåº•å±‚çš„ ArrayBufferï¼Œå½»åº•è„±ç¦»æœ¬åœ°æ–‡ä»¶æƒé™çš„é™åˆ¶
        const reader = new FileReader();
        reader.onload = function(e) {
            newMusic.buffer = e.target.result; // ä¿å­˜çœŸå®çš„äºŒè¿›åˆ¶æ•°æ®
            musicLib.push(newMusic);
            
            saveAll().then(() => {
                alert("æ­Œæ›²ä¸Šä¼ å¹¶æ°¸ä¹…ä¿å­˜æˆåŠŸï¼");
                renderMusicLib();
                if(musicLib.length === 1) { curMusicIdx = 0; renderMusicPlayer(); }
            }).catch(err => {
                alert("æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè½¬ä¸ºä¸´æ—¶è¯•å¬ï¼ˆåˆ·æ–°åæ¶ˆå¤±ï¼‰ã€‚");
                newMusic.blob = file; // é™çº§ä¸ºä¸´æ—¶
                renderMusicLib();
                if(musicLib.length === 1) { curMusicIdx = 0; renderMusicPlayer(); }
            });
        };
        reader.onerror = () => alert("è¯»å–éŸ³ä¹æ–‡ä»¶å¤±è´¥ï¼");
        reader.readAsArrayBuffer(file); // å¼€å§‹â€œåƒâ€è¿›å†…å­˜
        
        event.target.value = ''; 
    }

    function renderMusicLib() {
        $('music-count-badge').innerText = musicLib.length + ' é¦–';
        let list = $('music-lib-list');
        if (musicLib.length === 0) {
            list.innerHTML = `<div class="py-12 flex flex-col items-center justify-center text-zinc-400 opacity-60"><span class="text-4xl mb-2">ğŸ“¥</span><span class="text-sm">ç‚¹å‡»å³ä¸Šè§’ + ä¸Šä¼ æœ¬åœ°éŸ³ä¹</span></div>`;
            return;
        }
        list.innerHTML = musicLib.map((m, i) => {
            let isCur = (curMusicIdx === i);
            let titleColor = isCur ? "text-[#ff5a5f] font-bold" : "text-zinc-800";
            return `
            <div class="p-4 flex items-center justify-between active:bg-zinc-50 cursor-pointer group" onclick="playMusicIndex(${i}); toMusicTab('player')">
                <div class="flex items-center gap-4 min-w-0">
                    <span class="text-xs text-zinc-400 font-mono w-4">${i+1}</span>
                    <div class="flex flex-col min-w-0">
                        <span class="${titleColor} text-[15px] truncate">${m.title}</span>
                        <span class="text-[11px] text-zinc-400 mt-0.5 flex items-center gap-1"><span class="border border-red-500/30 text-red-500 text-[8px] px-1 rounded scale-90 origin-left">SQ</span> ${m.artist}</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    ${isCur && isPlaying ? `<span class="text-[#ff5a5f] text-xs">ğŸµ æ’­æ”¾ä¸­</span>` : ''}
                    <button onclick="event.stopPropagation(); deleteMusic(${m.id})" class="text-zinc-300 hover:text-red-500 px-2">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        }).join('');
    }

    function deleteMusic(id) {
        if(!confirm("ç¡®å®šä»è®¾å¤‡åˆ é™¤è¿™é¦–æ­Œå—ï¼Ÿ")) return;
        musicLib = musicLib.filter(m => m.id !== id);
        if (curMusicIdx >= musicLib.length) curMusicIdx = musicLib.length - 1;
        if (musicLib.length === 0) {
            curAudio.pause();
            isPlaying = false;
            curMusicIdx = -1;
            $('music-title').innerText = "æš‚æ— æ’­æ”¾";
        }
        saveAll();
        renderMusicLib();
    }
    // åŠ¨æ€æ—¶é’Ÿ
    function updateHomeClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const mins = String(now.getMinutes()).padStart(2, '0');
        const month = now.getMonth() + 1;
        const date = now.getDate();
        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        const day = dayNames[now.getDay()];

        if($('home-time')) $('home-time').innerHTML = `${hours}<br>${mins}`;
        if($('home-date')) $('home-date').innerText = `${month}/${date} ${day}`;
    }

    // çºªå¿µæ—¥è®¡ç®—
    function calculateTogetherDays() {
        const startDate = new Date('2024-12-16'); // ğŸ¯ åœ¨è¿™é‡Œä¿®æ”¹ä½ çš„çºªå¿µæ—¥
        const now = new Date();
        const diffTime = Math.abs(now - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        if($('together-days')) $('together-days').innerText = diffDays;
    }
ã€€    // ================== 16. äº’åŠ¨æ–‡æ¸¸å¼•æ“ (è§†è§‰å°è¯´) ==================

    // è·¯ç”±æ‹¦æˆªè¡¥å……ï¼šåœ¨å…¨å±€ go() å‡½æ•°é‡Œå¤„ç†
    const originalGo = go;
    go = function(id) {
        originalGo(id);
        if(id === 'pg-vn-hub') renderVnHub();
    };
ã€€ã€€// === è¡¥å……ç¼ºå¤±çš„æ–‡æ¸¸å‡½æ•° ===

// 1. å­˜æ¡£ä¿å­˜é€»è¾‘
async function saveAllVnData() {
    await dbSet('OS67_VN_SAVES', vnSaves);
    await dbSet('OS67_HEART_MARKS', heartMarks);
}

// --- ä¿®æ”¹åçš„å‰§æœ¬åˆ—è¡¨æ¸²æŸ“å‡½æ•° ---
function renderVnHub() {
    let list = $('vn-save-list');
    if (!list) return;
    
    $('vn-marks-display').innerText = heartMarks;
    
    if (vnSaves.length === 0) {
        list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— ä¸–ç•Œå­˜æ¡£ï¼Œå¿«å»æ–°å»ºä¸€ä¸ªå§ï¼</div>`;
        return;
    }
    
    list.innerHTML = vnSaves.map(save => `
        <div onclick="enterVnRoom('${save.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-zinc-100 flex gap-4 items-center active:scale-95 transition-transform cursor-pointer relative group">
            <img src="${save.sprite}" class="w-16 h-16 rounded-full object-cover bg-zinc-100 border border-zinc-200">
            <div class="flex-1 min-w-0">
                <b class="text-base text-zinc-800 block truncate">${save.roleName}</b>
                <span class="text-xs text-zinc-400 block mt-1 truncate">ä¸–ç•Œï¼š${save.world || 'æœªçŸ¥'}</span>
                <span class="text-xs text-pink-400 font-bold mt-1 block">ğŸ’– å¥½æ„Ÿåº¦: ${save.love}</span>
            </div>
            <button onclick="event.stopPropagation(); deleteVnSave('${save.id}')" class="text-zinc-300 hover:text-red-500 p-2 transition-colors">
                ğŸ—‘ï¸
            </button>
        </div>
    `).join('');
}

// --- ä¿®å¤åçš„è¿›å…¥å‰§æœ¬å‡½æ•° ---
function enterVnRoom(saveId) {
    curVnSave = vnSaves.find(s => s.id === saveId);
    if (!curVnSave) return;
    
    // 1. è®¾ç½®å‰§æœ¬çš„èƒŒæ™¯å’Œäººç‰©ç«‹ç»˜
    $('vn-bg').style.backgroundImage = `url('${curVnSave.bg}')`;
    $('vn-sprite').src = curVnSave.sprite;
    
    // 2. æ¸²æŸ“å½“å‰çš„ç•Œé¢ï¼ˆæ­¤æ—¶ä¼šæ˜¾ç¤ºâ€œè¿æ¥ä¸–ç•Œä¸­...â€ï¼‰
    renderVnScene();
    go('pg-vn-room');

    // ğŸ¯ 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå¦‚æœæ˜¯å…¨æ–°çš„å‰§æœ¬ï¼ˆæ²¡æœ‰èŠå¤©è®°å½•ï¼‰ï¼Œè‡ªåŠ¨å‘½ä»¤ AI å¼€å§‹å†™å¼€å±€
    if (curVnSave.history.length === 0) {
        console.log("æ£€æµ‹åˆ°æ–°å‰§æœ¬ï¼Œæ­£åœ¨å‘¼å« AI ç¼–å†™å¼€å±€å‰§æƒ…...");
        // è¿™é‡Œçš„æç¤ºè¯­ä¼šå¼•å¯¼ AI ç»“åˆä½ å¡«å†™çš„èƒŒæ™¯å¼€å§‹æ•…äº‹
        triggerVnAi("è¯·æ ¹æ®æˆ‘æä¾›çš„ä¸–ç•Œè§‚ã€ä½ çš„èº«ä»½å’Œæˆ‘çš„èº«ä»½ï¼Œå¼€å§‹è¿™æ®µæ•…äº‹ã€‚è¯·ç›´æ¥è¾“å‡ºå‰§æƒ…æå†™ï¼Œå¹¶ç»™å‡º A å’Œ B ä¸¤ä¸ªé€‰é¡¹ã€‚");
    }
}
// 4. é€€å‡ºæ–‡æ¸¸æˆ¿é—´
function exitVNRoom() {
    go('pg-vn-hub');
}

    // æ‰“å¼€æ–°å»ºé¡µé¢å¹¶åŠ è½½è§’è‰²åˆ—è¡¨
    function openVnCreate() {
        let realRoles = roles.filter(r => !r.isGroup);
        if (realRoles.length === 0) return alert("è¯·å…ˆå»å¾®ä¿¡é€šè®¯å½•æ·»åŠ è§’è‰²ï¼");
        
        $('vn-role-sel').innerHTML = realRoles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        
        // æ¸…ç©ºè¡¨å•
        $('vn-world').value = '';
        $('vn-role-job').value = '';
        $('vn-user-job').value = '';
        $('vn-bg-url').value = '';
        $('vn-sprite-url').value = '';
        $('vn-start-love').value = '50';
        
        go('pg-vn-create');
    }

        // ä¿å­˜æ–°å‰§æœ¬å¹¶ç”Ÿæˆä¸€ä¸ªå­˜æ¡£
    function saveNewVnSave() {
        let roleId = $('vn-role-sel').value;
        let role = roles.find(r => r.id == roleId);
        if (!role) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼"); 
            return; 
        }

        let bgUrl = $('vn-bg-url').value.trim() || 'https://images.unsplash.com/photo-1507504031003-b417219a0fde?q=80&w=800';
        let spriteUrl = $('vn-sprite-url').value.trim() || 'https://img.icons8.com/color/480/anime-emoji.png';
        
        let loveInput = parseInt($('vn-start-love').value);
        
        let newSave = {
            id: 'vn_' + Date.now(),
            roleId: role.id,
            roleName: role.name,
            world: $('vn-world').value.trim(),
            roleJob: $('vn-role-job').value.trim(),
            userJob: $('vn-user-job').value.trim(),
            bg: bgUrl,
            sprite: spriteUrl,
            love: isNaN(loveInput) ? 500 : loveInput,
            history: [], 
            lastTime: Date.now()
        };

        vnSaves.unshift(newSave);
        saveAllVnData();
        go('pg-vn-hub');
    }
    // æ¸²æŸ“å½“å‰ç”»é¢çš„ UI çŠ¶æ€
    function renderVnScene() {
        $('vn-love').innerText = curVnSave.love ?? 500;
        
        if (curVnSave.history.length === 0) {
            $('vn-name').innerText = "ç³»ç»Ÿ";
            $('vn-text').innerText = "æ­£åœ¨ä¸ºæ‚¨è¿æ¥ä¸–ç•Œï¼Œç”Ÿæˆä¸“å±å¼€å±€å‰§æƒ…ï¼Œè¯·ç¨å€™...";
            $('vn-choices-box').classList.add('hidden');
            $('vn-cursor').classList.add('hidden');
            return;
        }

        // å–æœ€åä¸€æ¡å†å²è®°å½•æ¥æ˜¾ç¤º
        let lastMsg = curVnSave.history[curVnSave.history.length - 1];
        
        if (lastMsg.r === 'u') {
            // å¦‚æœæœ€åä¸€å¥æ˜¯ç©å®¶è¯´çš„ï¼ˆæ­£åœ¨ç­‰ AI å›å¤ï¼‰
            $('vn-name').innerText = "æˆ‘";
            $('vn-text').innerHTML = `<span class="text-zinc-400 italic">ä½ çš„è¡ŒåŠ¨ï¼š</span><br/>${lastMsg.t}`;
            $('vn-choices-box').classList.add('hidden');
            $('vn-cursor').classList.add('hidden');
        } else {
            // å¦‚æœæœ€åä¸€å¥æ˜¯ AI è¯´çš„ï¼ˆè¯¥ç©å®¶åšé€‰æ‹©äº†ï¼‰
            $('vn-name').innerText = curVnSave.roleName;
            $('vn-text').innerText = cleanText(lastMsg.t);
            
            // æ¸²æŸ“é€‰é¡¹
            if (lastMsg.opts && lastMsg.opts.length >= 2) {
                $('vn-opt-A').innerText = "A. " + lastMsg.opts[0];
                $('vn-opt-B').innerText = "B. " + lastMsg.opts[1];
                $('vn-choices-box').classList.remove('hidden');
                $('vn-cursor').classList.add('hidden');
            } else {
                // é˜²é”™æœºåˆ¶ï¼šå¦‚æœ AI æ²¡åå‡ºé€‰é¡¹ï¼Œç•™ä¸ªå…œåº•
                $('vn-choices-box').classList.remove('hidden');
                $('vn-opt-A').innerText = "A. æ²‰é»˜ä¸è¯­ã€‚";
                $('vn-opt-B').innerText = "B. è¯•æ¢æ€§åœ°å¼€å£ã€‚";
            }
        }
    }
    // ç”¨æˆ·æäº¤é€‰æ‹© (æ¨ªå±é˜²é”™ä½ç‰ˆ)
    function submitVNChoice(choiceType) {
        if (isVnLoading) return;
        let userAction = "";
        
        if (choiceType === 'A') {
            userAction = $('vn-opt-A').innerText.replace(/^A\.\s*/, '');
        } else if (choiceType === 'B') {
            userAction = $('vn-opt-B').innerText.replace(/^B\.\s*/, '');
        } else if (choiceType === 'custom') {
            // ä½¿ç”¨åŸç”Ÿ prompt æ›¿ä»£è¾“å…¥æ¡†ï¼Œå®Œç¾é¿å¼€æ¨ªå±é”®ç›˜é”™ä½çš„ bug
            let input = prompt("è¯·è¾“å…¥ä½ çš„è¡ŒåŠ¨æˆ–å¯¹è¯ï¼š");
            if (!input || !input.trim()) return; // å–æ¶ˆæˆ–æœªè¾“å…¥åˆ™æ²¡ååº”
            userAction = input.trim();
        }
        
        // æŠŠç”¨æˆ·çš„è¡ŒåŠ¨æ¨å…¥å†å²è®°å½•
        curVnSave.history.push({ r: 'u', t: userAction });
        saveAllVnData();
        renderVnScene();
        
        // è§¦å‘ AI å›åº”
        triggerVnAi(userAction);
    } 
    // æ ¸å¿ƒå¼•æ“ï¼šè¯·æ±‚å¤§æ¨¡å‹
    async function triggerVnAi(userInput) {
        let cfg = await getAICfg();
        if (!cfg.key) return alert("è¯·å…ˆåœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½® API Keyï¼");
        
        isVnLoading = true;
        $('vn-name').innerText = curVnSave.roleName;
        $('vn-text').innerHTML = `<div class="dot-ani mt-2"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
        $('vn-cursor').classList.add('hidden');

        let sysPrompt = `ä½ ç°åœ¨æ˜¯ä¸€ä¸ªäº’åŠ¨è§†è§‰å°è¯´æ¸¸æˆï¼ˆGalgameï¼‰çš„åº•å±‚ç³»ç»Ÿå…¼ä¸»è¦è§’è‰²æ‰®æ¼”è€…ã€‚
ã€å½“å‰ä¸–ç•Œè§‚ã€‘ï¼š${curVnSave.world || 'æ—¥å¸¸ä¸–ç•Œ'}
ã€ä½ æ‰®æ¼”çš„è§’è‰²ã€‘ï¼š${curVnSave.roleName} (èº«ä»½ï¼š${curVnSave.roleJob})
ã€ç©å®¶èº«ä»½ã€‘ï¼š${curVnSave.userJob}
ã€å½“å‰å¥½æ„Ÿåº¦ã€‘ï¼š${curVnSave.love}/1000 (0æåº¦åŒæ¶ï¼Œ500æ™®é€šï¼Œ1000è‡³æ­»ä¸æ¸)

ã€ä½ çš„æ ¸å¿ƒä»»åŠ¡ã€‘ï¼š
1. æ‰¿æ¥ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆä¸€æ®µå¼•äººå…¥èƒœçš„å‰§æƒ…æå†™å’Œè§’è‰²å¯¹è¯ï¼ˆæ€»å­—æ•°å°½é‡æ§åˆ¶åœ¨ 100 å­—å·¦å³ï¼Œè¦æœ‰åŠ¨ä½œã€ç¥æ€æå†™ï¼‰ã€‚
2. åœ¨å‰§æƒ…çš„æœ€åï¼Œ**ä½ å¿…é¡»**ä¸ºç©å®¶ç”Ÿæˆä¸¤ä¸ªèµ°å‘ä¸åŒçš„é€‰æ‹©åˆ†æ”¯ã€‚
3. ã€å¥½æ„Ÿåº¦è€ƒæ ¸ï¼ˆæœ€ä¸¥å‰è­¦å‘Šï¼‰ã€‘ï¼šä½ å¿…é¡»æå…¶åå•¬ä½ çš„å¥½æ„Ÿåº¦ï¼
   - å¯¹æ–¹åªæ˜¯åœ¨é—®å¥½ã€é™ˆè¿°äº‹å®ã€é—²èŠæ—¥å¸¸ï¼ˆå¦‚â€œä»Šå¤©å¤©æ°”ä¸é”™â€ã€â€œåƒäº†å—â€ï¼‰æ—¶ï¼š**å¿…é¡»**é™„å¸¦ [AFF:0]ã€‚
   - åªæœ‰å¯¹æ–¹è®©ä½ çœŸåˆ‡æ„Ÿåˆ°å¼€å¿ƒã€ä¸€ç‚¹ç‚¹å¿ƒåŠ¨æ—¶ï¼šæ‰å…è®¸é™„å¸¦ [AFF:+1] åˆ° [AFF:+3]ã€‚
   - åªæœ‰å¯¹æ–¹åšå‡ºå·¨å¤§ç‰ºç‰²ã€æå…¶æµªæ¼«çš„ä¸¾åŠ¨è®©ä½ ç‰¹åˆ«å–œæ¬¢æ—¶ï¼šæ‰å…è®¸é™„å¸¦ [AFF:+10] åˆ° [AFF:+20]ã€‚
   - å¯¹æ–¹æƒ¹ä½ ç”Ÿæ°”ã€è¡Œä¸ºå†’çŠ¯æ—¶ï¼šå¿…é¡»ç‹ ç‹ æ‰£åˆ†ï¼Œé™„å¸¦ [AFF:-1] åˆ° [AFF:-20]ï¼ˆè¶Šç”Ÿæ°”æ‰£è¶Šå¤šï¼‰ã€‚

ã€ä¸¥æ ¼è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘ï¼š
ä½ çš„å›å¤å¿…é¡»**ä¸¥æ ¼**éµå®ˆä»¥ä¸‹æ ¼å¼ï¼Œç»å¯¹ä¸è¦å‡ºç°å¤šä½™çš„è§£é‡Šï¼š
(è¿™é‡Œå†™å‰§æƒ…å’Œå¯¹è¯æ­£æ–‡...)
===é€‰é¡¹===
A: (è¿™é‡Œå†™é€‰é¡¹A)
B: (è¿™é‡Œå†™é€‰é¡¹B)
[AFF:å˜åŒ–æ•°å€¼]`;

        let apiMessages = curVnSave.history.slice(-6).map(m => {
            return { role: m.r === 'u' ? 'user' : 'assistant', content: m.t };
        });
        
        if (apiMessages.length === 0 || apiMessages[apiMessages.length-1].role !== 'user') {
             apiMessages.push({ role: 'user', content: userInput });
        }

        try {
            let res = await fetch(`https://muqinghuai.top/?target=${cfg.url}/v1/chat/completions`, { 
                method: 'POST', 
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, 
                body: JSON.stringify({ model: cfg.model, messages: [ { role: 'system', content: sysPrompt }, ...apiMessages ] }) 
            });
            let data = await res.json(); 
            let rawContent = data.choices[0].message.content;
            
            let parsedText = rawContent;
            let optA = "é¡ºä»åœ°ç­‰å¾…å‰§æƒ…å‘å±•ã€‚";
            let optB = "ä¸»åŠ¨æ‰“ç ´åƒµå±€ã€‚";
            let affChange = 0;

            let affMatch = parsedText.match(/\[AFF:([+-]?\d+)\]/i);
            if (affMatch) {
                affChange = parseInt(affMatch[1]);
                parsedText = parsedText.replace(affMatch[0], '');
            }

            let splitParts = parsedText.split(/===é€‰é¡¹===|ã€é€‰é¡¹ã€‘/i);
            let storyText = splitParts[0].trim();
            
            if (splitParts.length > 1) {
                let optsText = splitParts[1];
                let matchA = optsText.match(/A[:ï¼š]\s*(.+)/i);
                let matchB = optsText.match(/B[:ï¼š]\s*(.+)/i);
                if (matchA) optA = matchA[1].trim();
                if (matchB) optB = matchB[1].trim();
            } else {
                storyText = parsedText;
            }

            // ç»“ç®—å¥½æ„Ÿåº¦å’Œå¿ƒåŠ¨å°è®°éšæœºæ‰è½
            if (affChange > 0) {
                curVnSave.love = Math.min(1000, curVnSave.love + affChange);
                
                // éšæœºæ‰è½ç®—æ³•ï¼šä¸‹é™ N*10ï¼Œä¸Šé™ N*20
                let minReward = affChange * 10;
                let maxReward = affChange * 20;
                let randomMarks = Math.floor(Math.random() * (maxReward - minReward + 1)) + minReward;
                
                heartMarks += randomMarks; 
                showVnToast(`ğŸ’– å¥½æ„Ÿåº¦ +${affChange}ï¼Œè·å¾— ğŸŒŸå°è®° x${randomMarks}`);
            } else if (affChange < 0) {
                curVnSave.love = Math.max(0, curVnSave.love + affChange);
                showVnToast(`ğŸ’” å¥½æ„Ÿåº¦ ${affChange}`);
            }

            curVnSave.lastTime = Date.now();
            
            curVnSave.history.push({ 
                r: 'ai', 
                t: storyText, 
                opts: [optA, optB] 
            });
            
            saveAllVnData();
            
        } catch (e) {
            console.error("VN AI Error", e);
            alert("å‰§æƒ…ç”Ÿæˆå¤±è´¥ï¼Œå¯èƒ½ç½‘ç»œå¼€äº†å°å·®ï¼Œè¯·é‡æ–°ç‚¹å‡»é€‰é¡¹é‡è¯•ï¼");
            curVnSave.history.pop();
        } finally {
            isVnLoading = false;
            renderVnScene();
        }
    }
ã€€ã€€// å°å°çš„æ¼‚æµ®æç¤ºæ¡†ç‰¹æ•ˆ
    function showVnToast(msg) {
        let toast = document.createElement('div');
        toast.className = "absolute top-20 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur text-white px-4 py-2 rounded-full shadow-lg text-xs font-bold animate-fade-in z-[100] border border-white/20";
        toast.innerText = msg;
        $('pg-vn-room').appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, -20px)';
            toast.style.transition = 'all 0.5s';
            setTimeout(() => toast.remove(), 500);
        }, 2000);
    }

ã€€ã€€    // ================== 17. æŠ½å¡ä¸ç¾ç»Šç³»ç»Ÿå¼•æ“ ==================

    // Tab åˆ‡æ¢æ§åˆ¶
    function toGachaTab(tab) {
        ['summon', 'upgrade', 'me'].forEach(t => {
            $('gacha-tab-' + t).classList.add('hidden');
            $('nav-gacha-' + t).classList.remove('text-yellow-500', 'font-bold');
            $('nav-gacha-' + t).classList.add('text-zinc-500');
        });
        $('gacha-tab-' + tab).classList.remove('hidden');
        $('nav-gacha-' + tab).classList.add('text-yellow-500', 'font-bold');
        $('nav-gacha-' + tab).classList.remove('text-zinc-500');

        if(tab === 'summon') $('gacha-top-marks').innerText = heartMarks;
        if(tab === 'me') { $('gacha-me-marks').innerText = heartMarks; renderGachaMe(); }
        if(tab === 'upgrade') renderGachaOwned();
    }

    function renderGachaMe() {
        let p = JSON.parse(localStorage.getItem(DB+'U') || '{"name":"æˆ‘çš„æ˜µç§°", "ava":"https://img.icons8.com/color/96/user.png"}');
        document.querySelectorAll('#gacha-tab-me .u-name').forEach(e=>e.innerText=p.name);
        document.querySelectorAll('#gacha-tab-me .u-ava').forEach(e=>e.src=p.ava);
    }

    // å½•å…¥æ–°å¡ç‰Œåˆ°å¡æ± 
    const originalGoGachaAdd = go;
    go = function(id) {
        if(id === 'pg-gacha-add') {
            let realRoles = roles.filter(r => !r.isGroup);
            $('gc-role-sel').innerHTML = realRoles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            $('gc-name').value = ''; $('gc-img').value = ''; $('gc-story').value = '';
        }
        originalGoGachaAdd(id);
    };

    function saveNewGachaCard() {
        let rId = $('gc-role-sel').value;
        let name = $('gc-name').value;
        let img = $('gc-img').value;
        let rarity = $('gc-rarity').value;
        let story = $('gc-story').value;

        if(!name || !img) return alert("è¯·å¡«å†™å¡ç‰Œåç§°å’Œå›¾ç‰‡ï¼");

        gachaCards.push({
            id: 'gc_' + Date.now(),
            roleId: rId,
            name: name,
            img: img,
            rarity: rarity,
            story: story
        });
        saveAll();
        alert("å¡ç‰Œå½•å…¥æˆåŠŸï¼å·²åŠ å…¥å¸¸é©»å¡æ± ï¼");
        go('pg-gacha');
        toGachaTab('me');
    }

        // === ä¼˜åŒ–çš„æŠ½å¡é€»è¾‘ï¼ˆåŒ¹é… 1æŠ½20ï¼Œ10æŠ½180ï¼‰ ===
    function doGacha(times) {
        if(gachaCards.length === 0) return alert("å¡æ± ç›®å‰ç©ºç©ºå¦‚ä¹Ÿï¼è¯·å…ˆç‚¹å‡»å³ä¸Šè§’å»å½•å…¥å‡ å¼ æ–°å¡ç‰Œå§~");
        
        let cost = (times === 10) ? 180 : 20; 
        
        if(heartMarks < cost) return alert(`å¿ƒåŠ¨å°è®°ä¸è¶³ï¼éœ€è¦ ${cost} ğŸŒŸï¼Œå½“å‰ä»…æœ‰ ${heartMarks} ğŸŒŸ\nå¿«å»æ–‡æ¸¸æ¨¡å¼é‡Œæ‰¾è§’è‰²äº’åŠ¨èµšå–å§ï¼`);

        heartMarks -= cost;
        saveAll();
        if($('gacha-top-marks')) $('gacha-top-marks').innerText = heartMarks;

        let results = [];
        for(let i = 0; i < times; i++) {
            // çˆ†ç‡è®¾å®š: SSR 5%, SR 25%, R 70%
            let rand = Math.random() * 100;
            let targetRarity = 'R';
            if(rand <= 5) targetRarity = 'SSR';
            else if(rand <= 30) targetRarity = 'SR';

            // åœ¨å¯¹åº”ç¨€æœ‰åº¦é‡ŒæŠ½å¡
            let pool = gachaCards.filter(c => c.rarity === targetRarity);
            if(pool.length === 0) pool = gachaCards; // å…œåº•ï¼šå¦‚æœè¯¥ç¨€æœ‰åº¦æ²¡å¡ï¼Œå°±åœ¨å…¨å›¾é‰´é‡ŒæŠ½

            let drawnCard = pool[Math.floor(Math.random() * pool.length)];
            results.push(drawnCard);

            // æ”¾å…¥ç©å®¶èƒŒåŒ…æˆ–è½¬åŒ–ä¸ºé‡å¤ç¢ç‰‡
            let existing = ownedCards.find(o => o.cardId === drawnCard.id);
            if(existing) {
                existing.dupes += 1;
            } else {
                ownedCards.push({
                    id: 'own_' + Date.now() + i,
                    cardId: drawnCard.id,
                    tier: 0,
                    dupes: 0,
                    unlockedStories: []
                });
            }
        }
        
        saveAll();
        
        // è°ƒç”¨å¼¹çª—å±•ç¤ºæŠ½å‡ºæ¥çš„å¡
        showGachaResult(results);
        
        if (typeof renderVnHub === 'function') renderVnHub(); // æ›´æ–°å¤–é¢çš„å°è®°æ˜¾ç¤º
    }
    // === ä¼˜åŒ–çš„ï¼šæ¸²æŸ“æŠ½å¡ç»“æœåˆ°å¼¹çª— (æ”¯æŒ 2-3-3-2 é˜µå‹ï¼Œé˜²é®æŒ¡ç´§å‡‘ç‰ˆ) ===
    function showGachaResult(cards) {
        const container = $('gacha-result-cards');
        
        // ä¸“é—¨ç”Ÿæˆå•å¼ å¡ç‰Œçš„è¾…åŠ©å‡½æ•° (å®½åº¦ç¼©å°åˆ° 28%ï¼Œè®©æ•´ä½“å˜çŸ®ä¸€ç‚¹)
        const genCardHtml = (c, i) => {
            let rColor = c.rarity === 'SSR' ? 'text-yellow-400 border-yellow-400' : (c.rarity === 'SR' ? 'text-purple-400 border-purple-400' : 'text-blue-400 border-blue-400');
            return `
            <div class="relative w-[28%] aspect-[3/4] bg-zinc-800 rounded-lg overflow-hidden border-2 ${rColor} shadow-[0_0_15px_rgba(0,0,0,0.5)] animate-fade-in shrink-0" style="animation-delay: ${i * 0.05}s">
                <img src="${c.img}" class="w-full h-full object-cover">
                <div class="absolute bottom-0 w-full bg-gradient-to-t from-black via-black/80 to-transparent pt-4 pb-1 text-center">
                    <div class="${rColor} font-bold italic text-[11px] drop-shadow-md">${c.rarity}</div>
                    <div class="text-[9px] text-white truncate px-1 mt-0.5">${c.name}</div>
                </div>
            </div>`;
        };

        if (cards.length === 1) {
            // å¦‚æœæ˜¯å•æŠ½ï¼Œæ”¾å¤§å¹¶å±…ä¸­æ˜¾ç¤º
            let c = cards[0];
            let rColor = c.rarity === 'SSR' ? 'text-yellow-400 border-yellow-400' : (c.rarity === 'SR' ? 'text-purple-400 border-purple-400' : 'text-blue-400 border-blue-400');
            container.innerHTML = `
            <div class="flex justify-center w-full">
                <div class="relative w-[50%] aspect-[3/4] bg-zinc-800 rounded-lg overflow-hidden border-2 ${rColor} shadow-[0_0_15px_rgba(0,0,0,0.5)] animate-fade-in">
                    <img src="${c.img}" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 w-full bg-gradient-to-t from-black via-black/80 to-transparent pt-4 pb-1 text-center">
                        <div class="${rColor} font-bold italic text-[14px] drop-shadow-md">${c.rarity}</div>
                        <div class="text-[12px] text-white truncate px-1 mt-1">${c.name}</div>
                    </div>
                </div>
            </div>`;
        } else {
            // å¦‚æœæ˜¯ 10 æŠ½ï¼Œåˆ‡å‰²æ•°ç»„ï¼Œæ’æˆ 2-3-3-2 é˜µå‹
            let row1 = cards.slice(0, 2).map((c, i) => genCardHtml(c, i)).join('');
            let row2 = cards.slice(2, 5).map((c, i) => genCardHtml(c, i+2)).join('');
            let row3 = cards.slice(5, 8).map((c, i) => genCardHtml(c, i+5)).join('');
            let row4 = cards.slice(8, 10).map((c, i) => genCardHtml(c, i+8)).join('');

            // æŠŠè¿™å››æ’åˆ†åˆ«åŒ…åœ¨ flex å®¹å™¨é‡Œå±…ä¸­ï¼Œgap-3 ç¼©å°ä¸º gap-2ï¼Œé˜²æ­¢å¤ªé«˜è¢«åº•è¾¹æŒ¡ä½
            container.innerHTML = `
                <div class="flex justify-center gap-2 w-full">${row1}</div>
                <div class="flex justify-center gap-2 w-full">${row2}</div>
                <div class="flex justify-center gap-2 w-full">${row3}</div>
                <div class="flex justify-center gap-2 w-full">${row4}</div>
            `;
        }

        let modal = $('gacha-result-modal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    // === æ–°å¢ï¼šå…³é—­æŠ½å¡ç»“æœå¼¹çª— ===
    function closeGachaResult() {
        let modal = $('gacha-result-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }
    // === è¡¥å›çš„ï¼šæ¸²æŸ“å›¾é‰´ï¼ˆå·²æ‹¥æœ‰çš„å¡ç‰Œï¼‰ ===
    function renderGachaOwned() {
        const list = $('gacha-owned-list');
        if (!list) return;
        if(ownedCards.length === 0) {
            list.innerHTML = `<div class="text-center text-zinc-500 text-xs col-span-3 mt-20">æš‚æ— å¡ç‰Œï¼Œè¯·å…ˆå»ç¥ˆæ„¿å§~</div>`;
            return;
        }

        list.innerHTML = ownedCards.map(own => {
            let baseCard = gachaCards.find(c => c.id === own.cardId);
            if(!baseCard) return '';
            let rarityColor = baseCard.rarity === 'SSR' ? 'text-yellow-400' : (baseCard.rarity === 'SR' ? 'text-purple-400' : 'text-blue-400');
            return `
            <div class="relative w-full aspect-[3/4] rounded-lg overflow-hidden border border-white/20 shadow-lg active:scale-95 transition-transform cursor-pointer">
                <img src="${baseCard.img}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                <div class="absolute top-1 left-2 ${rarityColor} font-bold italic text-sm drop-shadow-md">${baseCard.rarity}</div>
                ${own.dupes > 0 ? `<div class="absolute top-1 right-2 bg-pink-500/80 text-white text-[10px] px-1.5 rounded-full">+${own.dupes}</div>` : ''}
                <div class="absolute bottom-2 left-2 right-2">
                    <div class="text-white text-[10px] font-bold truncate">${baseCard.name}</div>
                </div>
            </div>`;
        }).join('');
    }
ã€€ã€€ // === æ–°å¢ï¼šæ›´æ¢å¡æ± èƒŒæ™¯åŠŸèƒ½ ===
 function changeGachaBg() {
     let currentBg = localStorage.getItem('OS67_GACHA_BG') || 'https://img.heliar.top/file/1770365294783_IMG_20260206_160700.jpg';
     let newUrl = prompt("è¯·è¾“å…¥æ–°çš„å¡æ± èƒŒæ™¯å›¾ç‰‡ URLï¼š\n(å»ºè®®ä½¿ç”¨ç«–å›¾)", currentBg);
     if (newUrl !== null && newUrl.trim() !== '') {
         localStorage.setItem('OS67_GACHA_BG', newUrl.trim());
         let imgEl = $('gacha-bg-img');
         if (imgEl) imgEl.src = newUrl.trim();
         alert("âœ¨ å¡æ± èƒŒæ™¯æ›´æ¢æˆåŠŸï¼");
     }
 }

ã€€ã€€    // ================== è§’è‰²ä¸“å±è¯­éŸ³é…ç½® ==================
    // æ‰“å¼€è¯­éŸ³é…ç½®é¡µ
    function openRoleVoiceEdit() {
        if(!curRole) return;
        $('in-role-voice-id').value = curRole.voiceId || ''; // è¯»å–ä¹‹å‰ä¿å­˜çš„éŸ³è‰²
        go('pg-voice-edit');
    }

    // ä¿å­˜è¯­éŸ³é…ç½®
    function saveRoleVoice() {
        if(!curRole) return;
        curRole.voiceId = $('in-role-voice-id').value.trim();
        saveAll(); // ä¿å­˜åˆ°æ•°æ®åº“
        alert("ğŸ‰ è¯­éŸ³é…ç½®å·²ä¿å­˜ï¼");
        go('pg-chat-info');
    }

    // å°†æ¥å£è¿”å›çš„åå…­è¿›åˆ¶éŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºå¯æ’­æ”¾çš„æ•°æ®
    function hexToUint8Array(hexString) {
        if (!hexString) return new Uint8Array();
        let result = new Uint8Array(hexString.length / 2);
        for (let i = 0; i < hexString.length; i += 2) {
            result[i / 2] = parseInt(hexString.substr(i, 2), 16);
        }
        return result;
    }

// === ä¿®å¤åçš„æµ‹è¯•éŸ³è‰²å‘éŸ³ ===
async function testRoleVoice() {
    let voiceId = $('in-role-voice-id').value.trim();
    if(!voiceId) return alert("è¯·å…ˆè¾“å…¥éŸ³è‰² ID å‘€ï¼");

    // æ£€æŸ¥å…¨å±€è¯­éŸ³åº“æœ‰æ²¡æœ‰é…ç½®å¥½
    let cfg = await getVoiceCfg(); 
    if (!cfg.key || !cfg.groupId) return alert("ç³»ç»Ÿè¯­éŸ³ API æœªé…ç½®ï¼è¯·å…ˆå» ä¸»é¡µ-è®¾ç½® ä¸­é…ç½®ä½ çš„ MiniMax å¯†é’¥ã€‚");

    let btn = $('btn-test-voice');
    let oldText = btn.innerText;
    btn.innerText = "â³ æ­£åœ¨åŠªåŠ›æ‹‰å–è¯­éŸ³...";
    btn.disabled = true;
    btn.classList.add('opacity-50');

    try {
        // å¤ç”¨ä¸­è½¬åœ°å€
        let rawUrl = cfg.url || 'https://api.minimax.chat/v1/t2a_v2';
        let targetUrl = rawUrl.includes('?') ? `${rawUrl}&GroupId=${cfg.groupId}` : `${rawUrl}?GroupId=${cfg.groupId}`;
let myProxyServer = "https://muqinghuai.top";
        let proxyUrl = myProxyServer + "/?target=" + encodeURIComponent(targetUrl);

        // ğŸ¯ æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œå¿…é¡»ä½¿ç”¨ MiniMax V2 æ¥å£çš„å…¨æ–°å‚æ•°ç»“æ„ï¼
        const requestBody = {
            "model": "speech-01-turbo",
            "text": "ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ å‘€ï¼å¦‚æœèƒ½å¬åˆ°è¿™ä¸ªå£°éŸ³ï¼Œè¯´æ˜é…ç½®æˆåŠŸå•¦ã€‚",
            "voice_setting": {
                "voice_id": voiceId, // æå–ä½ å¡«å†™çš„éŸ³è‰²ID
                "speed": 1.0,
                "vol": 1.0,
                "pitch": 0
            },
            "audio_setting": {
                "sample_rate": 32000,
                "bitrate": 128000,
                "format": "mp3",
                "channel": 1
            }
        };

        // å‘é€è¯·æ±‚ç»™å¤§æ¨¡å‹
        let res = await fetch(proxyUrl, {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${cfg.key}`
            },
            body: JSON.stringify(requestBody)
        });

        let data = await res.json();
        
        // æ£€æŸ¥è¿”å›ç»“æœ
        if (res.ok || (data.base_resp && data.base_resp.status_code === 0)) {
            let hexAudio = data.data.audio;
            if (hexAudio) {
                // è½¬æ¢å¹¶æ’­æ”¾éŸ³é¢‘
                let audioBlob = new Blob([hexToUint8Array(hexAudio)], { type: 'audio/mp3' });
                let audioUrl = URL.createObjectURL(audioBlob);
                let testAudio = new Audio(audioUrl);
                testAudio.play();
                alert("âœ… æ‹‰å–æˆåŠŸï¼å¬å¬çœ‹å£°éŸ³å¯¹ä¸å¯¹~");
            } else {
                alert("âŒ æ‹‰å–å¤±è´¥ï¼šè™½ç„¶è¿æ¥æˆåŠŸäº†ï¼Œä½†æ²¡æ‹¿åˆ°éŸ³é¢‘æ•°æ®ã€‚");
            }
        } else {
            let errMsg = data.base_resp ? data.base_resp.status_msg : JSON.stringify(data);
            alert("âŒ æ‹‰å–å¤±è´¥ï¼Œå¹³å°æŠ¥é”™ï¼š\n" + errMsg);
        }
    } catch (err) {
        alert("âŒ ç½‘ç»œè¯·æ±‚å¼‚å¸¸ï¼\nè¯¦ç»†ä¿¡æ¯ï¼š" + err.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.innerText = oldText;
        btn.disabled = false;
        btn.classList.remove('opacity-50');
    }
}
ã€€ã€€    // === å®‰å…¨å ä½ç¬¦ï¼ˆé˜²æ­¢æœªå†™å®Œçš„åŠŸèƒ½æŠ¥é”™ï¼‰ ===
    function renderTheaterList() { console.log("å°å‰§åœºåˆ—è¡¨å¼€å‘ä¸­..."); }
    function initTheaterCreate() { console.log("å°å‰§åœºåˆ›å»ºå¼€å‘ä¸­..."); }
    // ================== ç³»ç»Ÿå¯åŠ¨å…¥å£ ==================ã€€
    window.onload = async () => {
        try {
            console.log("System Launching...");
            await initDB();
            await loadAllData();

            // ğŸ‘‡ æ–°å¢ï¼šè‡ªåŠ¨ä¿®å¤æ—§æ•°æ®é€»è¾‘
            let needsSave = false;
            roles.forEach(role => {
                if (role.history) {
                    role.history.forEach(msg => {
                        // å¦‚æœè¿™æ¡æ¶ˆæ¯æ²¡æœ‰ scene æ ‡ç­¾ï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®
                        if (!msg.scene) {
                            // é€»è¾‘åˆ¤æ–­ï¼šå¦‚æœæ–‡å­—é‡ŒåŒ…å«æ˜Ÿå· * (åŠ¨ä½œæå†™) æˆ–è€…æ˜¯é•¿å¥å­ï¼Œå°±æŠŠå®ƒå½’ç±»åˆ°çº¿ä¸‹æ¨¡å¼
                            if (msg.t.includes('*') || msg.t.length > 40) {
                                msg.scene = 'story';
                            } else {
                                msg.scene = 'chat';
                            }
                            needsSave = true;
                        }
                    });
                }
            });
            if (needsSave) {
                await saveAll();
                console.log("æ—§æ•°æ®å·²è‡ªåŠ¨å®Œæˆåœºæ™¯åˆ†ç±»ä¿®å¤");
            }
            // ğŸ‘† ä¿®å¤é€»è¾‘ç»“æŸ
            let rIds = roles.map(r => r.id);
            if (chats.some(cid => !rIds.includes(cid))) { chats = chats.filter(cid => rIds.includes(cid)); await saveAll(); }
            await renderProfile();
            await loadSettings();
ã€€ã€€         // æ¢å¤è‡ªå®šä¹‰å¡æ± èƒŒæ™¯
         let savedGachaBg = localStorage.getItem('OS67_GACHA_BG');
         if (savedGachaBg && $('gacha-bg-img')) $('gacha-bg-img').src = savedGachaBg;
        // åˆå§‹åŒ–æ—¶é’Ÿå’Œçºªå¿µæ—¥
    updateHomeClock();
    setInterval(updateHomeClock, 1000);
    calculateTogetherDays();

    // åˆå§‹åŒ–ä¸»é¡µæ»‘åŠ¨å°åœ†ç‚¹ç›‘å¬
    const slider = $('home-slider');
    if(slider) {
        slider.addEventListener('scroll', () => {
            const index = Math.round(slider.scrollLeft / window.innerWidth);
            $('dot-1').className = `w-1.5 h-1.5 rounded-full ${index === 0 ? 'bg-white' : 'bg-white/30'}`;
            $('dot-2').className = `w-1.5 h-1.5 rounded-full ${index === 1 ? 'bg-white' : 'bg-white/30'}`;
        });
    }
        updateHomeClock(); // ç«‹å³æ›´æ–°ä¸€æ¬¡æ—¶é—´
    setInterval(updateHomeClock, 1000); // æ¯ç§’åˆ·æ–°æ—¶é—´
    calculateTogetherDays(); // è®¡ç®—çºªå¿µæ—¥
            tab('chat'); 
            console.log("AI OS Launched.");
        } catch (e) {
            console.error("Launch Error:", e); alert("ç³»ç»Ÿå¯åŠ¨å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚");
        }
    };
ã€€ã€€// --- å½»åº•åˆ é™¤å‰§æœ¬å­˜æ¡£çš„åŠŸèƒ½é€»è¾‘ ---
function deleteVnSave(saveId) {
    // 1. å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢æ‰‹æ»‘
    if (!confirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªå‰§æœ¬ä¸–ç•Œå—ï¼Ÿ\nè¯¥æ“ä½œæ— æ³•æ’¤é”€ï¼Œæ‰€æœ‰çš„è®°å½•éƒ½å°†æ¶ˆå¤±ã€‚")) {
        return; 
    }

    // 2. åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°å¹¶å‰”é™¤è¿™ä¸ªå‰§æœ¬
    vnSaves = vnSaves.filter(s => s.id !== saveId);
    
    // 3. å°†æ›´æ–°åçš„åˆ—è¡¨ä¿å­˜åˆ°æ•°æ®åº“
    saveAllVnData();
    
    // 4. åˆ·æ–°é¡µé¢ä¸Šçš„åˆ—è¡¨æ˜¾ç¤º
    renderVnHub();
    
    console.log("å·²æˆåŠŸåˆ é™¤å‰§æœ¬å­˜æ¡£:", saveId);
}
ã€€ã€€    // ================== è§’è‰²è¯­éŸ³æ¶ˆæ¯è‡ªåŠ¨åˆæˆä¸æ’­æ”¾å¼•æ“ ==================
    // åå°é™é»˜åˆæˆéŸ³é¢‘
    async function synthesizeVoiceMessage(roleId, msg) { // æ¥æ”¶ç›´æ¥ä¼ è¿‡æ¥çš„ msg å¯¹è±¡
    let role = roles.find(r => r.id === roleId);
    if (!role || !msg) return;
    // åˆ é™¤äº†åŸæœ¬é€šè¿‡ msgIdx æŸ¥æ‰¾çš„é‚£è¡Œ

        let cfg = await getVoiceCfg();
        if (!cfg.key || !role.voiceId) {
            msg.status = 'failed'; saveAll(); renderMsgs(); return;
        }
        
        try {
            let rawUrl = cfg.url || 'https://api.minimax.chat/v1/t2a_v2';
            let targetUrl = rawUrl.includes('?') ? `${rawUrl}&GroupId=${cfg.groupId}` : `${rawUrl}?GroupId=${cfg.groupId}`;
            let proxyUrl = "https://muqinghuai.top/?target=" + encodeURIComponent(targetUrl);

            let res = await fetch(proxyUrl, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${cfg.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "speech-01-turbo",
                    text: msg.t, // AI æƒ³è¯´çš„é‚£å¥è¯
                    voice_setting: { voice_id: role.voiceId, speed: 1.0, vol: 1.0, pitch: 0 },
                    audio_setting: { sample_rate: 32000, bitrate: 128000, format: "mp3", channel: 1 }
                })
            });
            
            let data = await res.json();
            
            if (res.ok || (data.base_resp && data.base_resp.status_code === 0)) {
                if (data.data && data.data.audio) {
                    msg.audioHex = data.data.audio;
                    msg.status = 'ready';
                    // ä¼°ç®—è¯­éŸ³é•¿åº¦ï¼šæ­£å¸¸è¯´è¯çº¦æ¯ç§’4ä¸ªå­—ï¼Œæœ€å°‘1ç§’
                    msg.duration = Math.max(1, Math.ceil(msg.t.length / 4)); 
                } else { msg.status = 'failed'; }
            } else { msg.status = 'failed'; }
        } catch (e) {
            msg.status = 'failed';
        }
        
        saveAll();
        // å¦‚æœæ­¤åˆ»æ­£åœç•™åœ¨è¯¥è§’è‰²çš„èŠå¤©å®¤ï¼Œé©¬ä¸Šåˆ·æ–°ç•Œé¢ï¼Œè®©â€œè½¬è¯‘ä¸­â€å˜æˆâ€œè¯­éŸ³æ¡â€
        if (curRole && curRole.id === roleId) renderMsgs(); 
    }
    
    // ç»ˆæé˜²æŠ¥é”™ç‰ˆï¼šå°†16è¿›åˆ¶æˆ–å„ç±»æ•°æ®è½¬å›å¯æ’­æ”¾çš„äºŒè¿›åˆ¶æ•°æ®
    window.safeHexToUint8Array = function(data) {
        if (!data) return new Uint8Array();
        
        // å¦‚æœå·²ç»æ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œç›´æ¥è¿”å›
        if (data instanceof Uint8Array) return data;
        if (data instanceof ArrayBuffer) return new Uint8Array(data);
        if (Array.isArray(data)) return new Uint8Array(data);
        
        // å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢å› æ ¼å¼çªå˜å¯¼è‡´ substr/substring æŠ¥é”™
        let str = String(data);
        let result = new Uint8Array(str.length / 2);
        for (let i = 0; i < str.length; i += 2) {
            // ä½¿ç”¨æ›´å®‰å…¨çš„ substring è¿›è¡Œå­—ç¬¦æˆªå–
            result[i / 2] = parseInt(str.substring(i, i + 2), 16);
        }
        return result;
    };

    // å…¨å±€é˜²é‡å æ’­æ”¾å™¨
    window.currentMsgAudio = null;
    window.playMsgVoice = function(roleId, msgIdx) {
        try {
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šç»Ÿä¸€è½¬æ¢æˆå­—ç¬¦ä¸²å†å¯¹æ¯”ï¼Œå½»åº•è§£å†³æ•°å­— ID æ‰¾ä¸åˆ°çš„ Bugï¼
            let role = roles.find(r => String(r.id) === String(roleId));
            
            if (!role) return alert("ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•å®šä½å½“å‰è§’è‰²æ•°æ®ï¼"); // å¢åŠ ä¸€é“å®‰å…¨é”
            
            let msg = role.history[msgIdx];
            
            if (!msg) return alert("æ‰¾ä¸åˆ°è¯¥æ¶ˆæ¯è®°å½•");
            if (!msg.audioHex) return alert("âš ï¸ è¯­éŸ³æ•°æ®æœªå°±ç»ªæˆ–å·²ä¸¢å¤±");
            
            // åœæ‰æ­£åœ¨æ’­æ”¾çš„å…¶ä»–å£°éŸ³
            if (window.currentMsgAudio) {
                window.currentMsgAudio.pause();
                window.currentMsgAudio.currentTime = 0;
            }
            
            // ä½¿ç”¨ç»å¯¹å®‰å…¨çš„è½¬æ¢å‡½æ•°
            let uint8Arr = window.safeHexToUint8Array(msg.audioHex);
            if (uint8Arr.length === 0) throw new Error("è§£æå‡ºçš„éŸ³é¢‘æ•°æ®ä¸ºç©ºç™½");

            let audioBlob = new Blob([uint8Arr], { type: 'audio/mp3' });
            let audioUrl = URL.createObjectURL(audioBlob);
            window.currentMsgAudio = new Audio(audioUrl);
            
            // å¼‚æ­¥æ’­æ”¾ï¼Œå¦‚æœéŸ³é¢‘æŸåæˆ–æµè§ˆå™¨æ‹¦æˆªï¼Œä¼šèµ°è¿™é‡Œ
            window.currentMsgAudio.play().catch(e => {
                console.error("æ’­æ”¾è¢«æ‹¦æˆªæˆ–éŸ³é¢‘æŸå:", e);
                alert("æ’­æ”¾å¤±è´¥: " + e.message + "\n(è¿™é€šå¸¸æ˜¯å› ä¸ºæ¥å£è¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„éŸ³é¢‘æ ¼å¼)");
            });
        } catch (err) {
            // åŒæ­¥é”™è¯¯ï¼šè¿™é‡Œä¼šæŠŠå…·ä½“çš„ JavaScript æŠ¥é”™ç›´æ¥å¼¹å‡ºæ¥ï¼
            console.error("ä»£ç æ‰§è¡Œå¼‚å¸¸:", err);
            alert("ç³»ç»Ÿè½¬æ¢æŠ¥é”™: " + (err.message || err));
        }
    };
</script>

<div id="role-selector-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; flex-direction: column; justify-content: flex-end;" onclick="if(event.target===this) closeRoleSelector()">
    <div class="bg-white w-full rounded-t-2xl max-h-[75vh] flex flex-col animate-fade-in" onclick="event.stopPropagation()">
        <div class="p-4 border-b flex justify-between items-center shrink-0">
            <b class="text-lg">å‘èµ·èŠå¤©</b>
            <button onclick="closeRoleSelector()" class="w-8 h-8 bg-zinc-100 rounded-full text-zinc-500 font-bold active:scale-95">âœ•</button>
        </div>
        <div id="role-selector-list" class="flex-1 overflow-y-auto pb-10 no-scrollbar"></div>
    </div>
</div>
<div id="group-selector-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; flex-direction: column; justify-content: flex-end;" onclick="if(event.target===this) closeGroupSelector()">
    <div class="bg-white w-full rounded-t-2xl max-h-[80vh] flex flex-col animate-fade-in" onclick="event.stopPropagation()">
        <div class="p-4 border-b flex justify-between items-center shrink-0">
ã€€ã€€<button onclick="closeGroupSelector()" class="text-zinc-500 font-bold w-12 text-left">å–æ¶ˆ</button>
            <b class="text-lg">å‘èµ·ç¾¤èŠ</b>
            <button onclick="confirmCreateGroup()" class="bg-[#07c160] text-white px-3 py-1.5 rounded text-sm font-bold w-16">å®Œæˆ(<span id="group-sel-count">0</span>)</button>
        </div>
        <div id="group-selector-list" class="flex-1 overflow-y-auto pb-10 no-scrollbar">
            </div>
    </div>
</div>
</body>
</html>
