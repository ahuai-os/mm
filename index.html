ã€€ã€€<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI OS 9.0 Pro (IndexedDB ç»ˆæç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* === åŸºç¡€ç³»ç»Ÿæ ·å¼ === */
        body { background: #f7f7f7; margin: 0; padding: 0; width: 100vw; height: 100vh; height: 100dvh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .phone { width: 100%; height: 100%; background: #f7f7f7; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; }
        .page { position: absolute; inset: 0; background: #f7f7f7; display: none; flex-direction: column; z-index: 10; }
        .active { display: flex !important; }
        #pg-home { background: url('https://img.heliar.top/file/1770365294783_IMG_20260206_160700.jpg') center top / cover no-repeat; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); padding-bottom: max(env(safe-area-inset-bottom), 15px); height: auto; min-height: 60px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); padding-bottom: max(env(safe-area-inset-bottom), 20px); }

        /* === èŠå¤©æ°”æ³¡æ ·å¼ === */
        .bubble { width: fit-content; max-width: 100%; word-wrap: break-word; white-space: pre-wrap; }
        .bubble-user { background: #95ec69; color: #000; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.6; position: relative; margin-right: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: left; }
        .bubble-user::after { content: ''; position: absolute; right: -5px; top: 12px; border-left: 5px solid #95ec69; border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
        .bubble-ai { background: #fff; color: #000; border: 1px solid #ededed; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.6; position: relative; margin-left: 6px; text-align: left; }
        .bubble-ai::after { content: ''; position: absolute; left: -5px; top: 12px; border-right: 5px solid #fff; border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
        
        /* === å°å‰§åœºä¸åŠ¨ç”» === */
        .story-text-container { background: rgba(255, 255, 255, 0.95); color: #1f1f1f; padding: 18px 22px; border-radius: 6px; font-family: "Songti SC", "SimSun", serif; font-size: 17px; line-height: 1.8; text-align: justify; width: 100%; }
        .story-p { text-indent: 2em; margin-bottom: 0.8em; display: block; }
        .moment-cover { height: 320px; background-position: center; background-size: cover; position: relative; margin-bottom: 30px; }
        .drawer { transition: height 0.3s ease; height: 0; background: #f7f7f7; overflow: hidden; border-top: 1px solid #e5e5e5; }
        .drawer-open { height: 280px; } 
        .role-chip { transition: all 0.2s; border: 1px solid #ddd; background: white; color: #666; }
        .role-chip.selected { background: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 2px 4px rgba(59,130,246,0.3); }
        .dot-ani { display: flex; gap: 4px; padding: 4px 0; }
        .dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: dot-pulse 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .indent-8 { text-indent: 2em; }
        img { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }

        /* === å°å‰§åœºç›®å½• === */
        .catalog-drawer { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; opacity: 0; transition: opacity 0.3s; }
        .catalog-drawer.active { display: flex; opacity: 1; }
        .catalog-content { background: #fff; width: 80%; max-width: 300px; height: 100%; margin-left: auto; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .catalog-drawer.active .catalog-content { transform: translateX(0); }
        .chapter-item { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .chapter-item.active { background: #f0fdf4; color: #166534; font-weight: bold; }

        /* === å¤–å–ä¸å•†åŸæ ·å¼ === */
        .food-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.03); transition: transform 0.1s; }
        .food-card:active { transform: scale(0.98); }
        .food-img-box { width: 100%; aspect-ratio: 1/1; background: #f0f0f0; position: relative; flex-shrink: 0; }
        .food-img-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .cart-badge-ani { animation: pop-scale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-scale { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.3); } 100% { transform: scale(1); opacity: 1; } }
        .food-modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: flex; align-items: flex-end; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .food-modal-mask.active { opacity: 1; pointer-events: auto; }
        .food-modal-body { background: white; width: 100%; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); overflow: hidden; max-height: 85vh; display: flex; flex-direction: column; }
        .food-modal-mask.active .food-modal-body { transform: translateY(0); }

        /* === èŠå¤©å¡ç‰‡æ ·å¼ === */
        .msg-card { background: white; border-radius: 12px; padding: 12px; width: 240px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; overflow: hidden; border: 1px solid #eee; }
        .card-header-pay { background: #FFD101; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-header-pay-shop { background: #ff6700; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-header-share { background: #ff6b6b; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #333; display: flex; align-items: center; gap: 6px; }
        .card-content { display: flex; gap: 8px; align-items: center; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 10px; }
        .card-img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; background: #eee; }
        .card-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .card-price { font-size: 16px; font-weight: bold; color: #e64340; }
        .card-desc { font-size: 12px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
        .status-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: auto; }
        .st-pending { color: #f6a623; background: #fff7e6; }
        .st-paid { color: #52c41a; background: #f6ffed; }
        .st-rejected { color: #ff4d4f; background: #fff1f0; }
        .card-btn { width: 100%; text-align: center; font-size: 13px; padding: 6px 0; border-top: 1px solid #eee; color: #576b95; font-weight: 500; cursor: pointer; }
        .card-btn:active { background: #f5f5f5; }
    </style>
</head>
<body>
<div class="phone">
    <div id="pg-home" class="page active">
        <div class="absolute right-8 top-16 text-right text-white font-extralight text-7xl select-none z-10" style="text-shadow: 0 2px 10px rgba(0,0,0,0.3);">09<br>41</div>
        <div class="absolute bottom-32 w-full flex flex-wrap justify-center gap-5 z-10 px-4">
            <div onclick="go('pg-wechat')" class="w-16 h-16 bg-[#07c160] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ’¬</div>
            <div onclick="toTakeoutTab('home'); go('pg-takeout-home')" class="w-16 h-16 bg-[#FFD101] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ¥¡</div>
            <div onclick="toShopTab('home'); go('pg-shop-home')" class="w-16 h-16 bg-[#ff6700] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ›ï¸</div>
            <div onclick="go('pg-wb')" class="w-16 h-16 bg-blue-500 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ“–</div>
            <div onclick="go('pg-memory')" class="w-16 h-16 bg-yellow-500 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ§ </div>
            <div onclick="go('pg-theater')" class="w-16 h-16 bg-purple-600 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ­</div>
            <div onclick="go('pg-set')" class="w-16 h-16 bg-zinc-700 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">âš™ï¸</div>
        </div>
    </div>

    <div id="pg-wechat" class="page">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0 z-20">
            <span onclick="go('pg-home')" class="text-zinc-600 text-sm pb-1">é€€å‡º</span>
            <b id="we-title" class="pb-1 text-lg">å¾®ä¿¡</b>
            <span onclick="handlePlusBtn()" class="text-2xl pb-1 cursor-pointer">ï¼‹</span>
        </header>
        <div class="flex-1 overflow-y-auto no-scrollbar relative" onclick="closeAllMenus()">
            <div id="sub-chat" class="bg-white divide-y"></div>
            <div id="sub-cont" class="hidden bg-white divide-y"></div>
            <div id="sub-moments" class="hidden bg-white h-full overflow-y-auto no-scrollbar">
                <div id="moment-bg" class="moment-cover" onclick="triggerRolePost(true)">
                    <div class="absolute -bottom-4 right-4 flex items-end gap-3">
                        <b class="text-white text-lg u-name shadow-sm font-bold mb-3 drop-shadow-md" style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></b>
                        <img class="w-20 h-20 rounded-xl u-ava border-2 border-white bg-zinc-100 shadow-md">
                    </div>
                </div>
                <div id="mnts-list" class="mt-16 p-0 pb-32"></div>
            </div>
            <div id="sub-me" class="hidden bg-zinc-100 h-full">
                <div onclick="go('pg-prof')" class="bg-white p-6 mt-4 flex items-center gap-4 active:bg-zinc-50 cursor-pointer">
                    <img class="w-16 h-16 rounded-lg u-ava bg-zinc-200">
                    <div class="flex flex-col"><b class="text-xl u-name"></b><span class="text-sm text-zinc-400">å¾®ä¿¡å·: AI_OS_User</span></div>
                </div>
                <div class="mt-4 bg-white divide-y">
                    <div onclick="go('pg-wallet')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><div class="flex items-center gap-3"><span class="text-green-600 text-xl font-bold">ğŸ’°</span><span>æ”¯ä»˜/é’±åŒ…</span></div><span class="text-zinc-300">ã€‰</span></div>
                </div>
                <div class="mt-4 bg-white divide-y">
                    <div onclick="go('pg-emj')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span>è¡¨æƒ…åŒ…ç®¡ç†</span><span class="text-zinc-300">ã€‰</span></div>
                </div>
                <div class="mt-8 p-4">
                    <button onclick="cleanBadData()" class="w-full py-3 bg-yellow-50 text-yellow-600 rounded-lg text-sm border border-yellow-200 font-bold mb-3">ğŸ› ï¸ æ·±åº¦æ¸…ç†åæ•°æ® (ä¿ç•™èŠå¤©)</button>
                    <button onclick="hardReset()" class="w-full py-3 bg-red-50 text-red-500 rounded-lg text-sm border border-red-100">âš ï¸ æ ¼å¼åŒ–é‡ç½® (åˆ é™¤æ‰€æœ‰)</button>
                </div>
            </div>
        </div>
        <footer class="bg-[#f7f7f7] border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 shadow-lg">
            <div onclick="tab('chat')" id="t-chat" class="text-center flex-1 py-1">ğŸ’¬<br>å¾®ä¿¡</div>
            <div onclick="tab('cont')" id="t-cont" class="text-center flex-1 py-1">ğŸ‘¥<br>é€šè®¯å½•</div>
            <div onclick="tab('moments')" id="t-moments" class="text-center flex-1 py-1">ğŸ§­<br>æœ‹å‹åœˆ</div>
            <div onclick="tab('me')" id="t-me" class="text-center flex-1 py-1">ğŸ‘¤<br>æˆ‘</div>
        </footer>
    </div>
    
    <div id="pg-takeout-home" class="page bg-[#f5f5f5] z-[40]">
        <header class="bg-[#FFD101] p-3 pb-2 pt-12 rounded-b-xl shadow-sm sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div onclick="go('pg-home')" class="bg-white/20 p-1 rounded-full text-zinc-800 font-bold px-2 text-xs">âœ• é€€å‡º</div>
                <div class="flex-1 bg-white h-9 rounded-full flex items-center px-3 gap-2 relative">
                    <span class="text-zinc-400">ğŸ”</span>
                    <input id="takeout-search" oninput="handleSearchInput()" class="bg-transparent outline-none text-sm w-full" placeholder="æœç´¢ç‚¸é¸¡ã€å¥¶èŒ¶...">
                    <div id="btn-clear-search" onclick="clearSearch()" class="hidden w-5 h-5 bg-zinc-200 rounded-full flex items-center justify-center text-zinc-500 text-[10px] cursor-pointer">âœ•</div>
                </div>
            </div>
        </header>
        <div id="takeout-list" class="p-3 pb-24 grid grid-cols-2 gap-2 overflow-y-auto h-full"></div>
        <div id="food-detail-modal" class="food-modal-mask" onclick="if(event.target===this) closeFoodDetail()"><div class="food-modal-body"></div></div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div>
            <div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5 relative">ğŸ›’<span id="cart-badge" class="absolute -top-1 right-8 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span></div>è´­ç‰©è½¦</div>
            <div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-takeout-cart" class="page bg-[#f5f5f5] z-[40]">
        <header class="bg-white p-4 pt-12 border-b flex justify-between items-center sticky top-0 z-20"><b class="text-lg">è´­ç‰©è½¦</b><span onclick="clearCart()" class="text-sm text-zinc-500">æ¸…ç©º</span></header>
        <div class="bg-red-50 text-red-500 text-xs px-4 py-2 flex justify-between items-center"><span>ğŸ”¥ æ»¡20å‡3ï¼Œæ»¡50å‡8</span><span class="text-red-400">å»å‡‘å• ></span></div>
        <div id="cart-list" class="p-4 pb-32 space-y-3 overflow-y-auto h-full"></div>
        <div class="absolute bottom-14 w-full bg-white border-t p-3 flex justify-between items-center z-30 pb-safe">
            <div class="flex items-baseline gap-1"><span class="text-xs text-zinc-500">åˆè®¡:</span><span class="text-red-500 font-bold text-lg">Â¥<span id="cart-total">0.00</span></span></div>
            <button onclick="doCheckout()" class="bg-[#FFD101] text-black px-8 py-2.5 rounded-full font-bold shadow-md active:scale-95 transition-transform">å»ç»“ç®—</button>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div><div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-takeout-me" class="page bg-[#f5f5f5] z-[40]">
        <div class="bg-[#FFD101] pt-14 pb-10 px-6 flex items-center gap-4 rounded-b-[30px]"><img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white"><div><b class="u-name text-xl block text-[#1f1f1f]"></b><span class="text-xs bg-black/10 px-2 py-0.5 rounded text-[#1f1f1f]">é»„é‡‘ä¼šå‘˜ ğŸ’</span></div></div>
        <div class="mx-4 -mt-6 bg-white rounded-xl shadow-sm p-4 grid grid-cols-3 gap-4 text-center relative z-10">
            <div onclick="go('pg-takeout-orders')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-xl">ğŸ“„</div><span class="text-xs font-bold text-zinc-700">å…¨éƒ¨è®¢å•</span></div>
            <div onclick="go('pg-takeout-pending')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center text-xl">ğŸ›µ</div><span class="text-xs font-bold text-zinc-700">å¾…æ”¶è´§</span><div id="badge-pending" class="absolute top-3 left-[45%] bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</div></div>
            <div onclick="go('pg-takeout-add')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-xl">â•</div><span class="text-xs font-bold text-zinc-700">æ·»åŠ å•†å“</span></div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div><div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-takeout-orders" class="page bg-[#f5f5f5] z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">æˆ‘çš„è®¢å•</b></header><div id="order-history-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div></div>
    <div id="pg-takeout-pending" class="page bg-[#f5f5f5] z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">å¾…æ”¶è´§</b></header><div id="order-pending-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div></div>
    <div id="pg-takeout-add" class="page bg-white z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">ä¸Šæ¶æ–°å¤–å–</b><button onclick="saveNewFood()" class="ml-auto text-[#FFD101] font-bold text-sm bg-black px-3 py-1 rounded-full">ä¸Šæ¶</button></header><div class="p-6 space-y-5"><div><label class="block text-xs font-bold text-zinc-500 mb-1">åº—é“ºåç§°</label><input id="tf-store" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: éº¦å½“åŠ³"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">å•†å“åç§°</label><input id="tf-name" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: åŒå±‚å‰å£«æ±‰å ¡"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">ä»·æ ¼ (Â¥)</label><input id="tf-price" type="number" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="25.5"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">å›¾ç‰‡é“¾æ¥</label><input id="tf-img" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="http://..."></div></div></div>

    <div id="pg-shop-home" class="page bg-[#f2f2f2] z-[40]">
        <header class="bg-[#ff6700] p-3 pb-2 pt-12 rounded-b-xl shadow-sm sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div onclick="go('pg-home')" class="bg-white/20 p-1 rounded-full text-white font-bold px-2 text-xs">âœ• é€€å‡º</div>
                <div class="flex-1 bg-white h-9 rounded-full flex items-center px-3 gap-2 relative">
                    <span class="text-zinc-400">ğŸ”</span>
                    <input id="shop-search" oninput="handleShopSearch()" class="bg-transparent outline-none text-sm w-full" placeholder="æœå¥½ç‰©...">
                    <div id="btn-shop-clear" onclick="clearShopSearch()" class="hidden w-5 h-5 bg-zinc-200 rounded-full flex items-center justify-center text-zinc-500 text-[10px] cursor-pointer">âœ•</div>
                </div>
            </div>
        </header>
        <div id="shop-list" class="p-3 pb-24 grid grid-cols-2 gap-2 overflow-y-auto h-full"></div>
        <div id="shop-detail-modal" class="food-modal-mask" onclick="if(event.target===this) closeShopDetail()"><div class="food-modal-body"></div></div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div>
            <div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5 relative">ğŸ›’<span id="shop-cart-badge" class="absolute -top-1 right-8 bg-[#ff6700] text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span></div>è´­ç‰©è½¦</div>
            <div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-shop-cart" class="page bg-[#f2f2f2] z-[40]">
        <header class="bg-white p-4 pt-12 border-b flex justify-between items-center sticky top-0 z-20"><b class="text-lg">è´­ç‰©è½¦</b><span onclick="clearShopCart()" class="text-sm text-zinc-500">æ¸…ç©º</span></header>
        <div id="shop-cart-list" class="p-4 pb-32 space-y-3 overflow-y-auto h-full"></div>
        <div class="absolute bottom-14 w-full bg-white border-t p-3 flex justify-between items-center z-30 pb-safe">
            <div class="flex items-baseline gap-1"><span class="text-xs text-zinc-500">åˆè®¡:</span><span class="text-[#ff6700] font-bold text-lg">Â¥<span id="shop-cart-total">0.00</span></span></div>
            <button onclick="doShopCheckout()" class="bg-gradient-to-r from-[#ff9000] to-[#ff5000] text-white px-8 py-2.5 rounded-full font-bold shadow-md active:scale-95 transition-transform">ç«‹å³è´­ä¹°</button>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div><div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-shop-me" class="page bg-[#f2f2f2] z-[40]">
        <div class="bg-gradient-to-r from-[#ff9000] to-[#ff5000] pt-14 pb-10 px-6 flex items-center gap-4 rounded-b-[30px]"><img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white"><div><b class="u-name text-xl block text-white"></b><span class="text-xs bg-white/20 px-2 py-0.5 rounded text-white">æ·˜æ°”å€¼ 1000</span></div></div>
        <div class="mx-4 -mt-6 bg-white rounded-xl shadow-sm p-4 grid grid-cols-4 gap-2 text-center relative z-10">
            <div onclick="go('pg-shop-favs')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">â­</div><span class="text-xs font-bold text-zinc-700">æ”¶è—å¤¹</span></div>
            <div onclick="openShopOrders('pending')" class="flex flex-col items-center gap-2 active:opacity-50 relative"><div class="text-xl">ğŸ“¦</div><span class="text-xs font-bold text-zinc-700">å¾…æ”¶è´§</span><div id="badge-shop-pending" class="absolute top-0 right-4 bg-[#ff6700] text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</div></div>
            <div onclick="openShopOrders('history')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">ğŸ“œ</div><span class="text-xs font-bold text-zinc-700">å·²ä¹°åˆ°</span></div>
            <div onclick="go('pg-shop-add')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">â•</div><span class="text-xs font-bold text-zinc-700">æ·»åŠ </span></div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div><div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-shop-orders" class="page bg-[#f2f2f2] z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base" id="shop-order-title">æˆ‘çš„è®¢å•</b></header>
        <div id="shop-order-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div>
    </div>
    <div id="pg-shop-favs" class="page bg-[#f2f2f2] z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">æˆ‘çš„æ”¶è—</b></header>
        <div id="shop-fav-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div>
    </div>
    <div id="pg-shop-add" class="page bg-white z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">å‘å¸ƒæ–°å•†å“</b><button onclick="saveNewGoods()" class="ml-auto text-white font-bold text-sm bg-[#ff6700] px-3 py-1 rounded-full">å‘å¸ƒ</button></header>
        <div class="p-6 space-y-5">
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">åº—é“ºåç§°</label><input id="sf-store" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: ä¼˜è¡£åº“æ——èˆ°åº—"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å•†å“åç§°</label><input id="sf-name" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: çº¯æ£‰Tæ¤"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">ä»·æ ¼ (Â¥)</label><input id="sf-price" type="number" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="99.00"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å›¾ç‰‡é“¾æ¥</label><input id="sf-img" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="http://..."></div>
        </div>
    </div>

    <div id="pg-wallet" class="page bg-gray-50 z-[60]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0"><span onclick="go('pg-wechat')" class="text-zinc-700 text-lg cursor-pointer">ã€ˆ</span><span class="text-zinc-700 text-sm mb-1 cursor-pointer">é›¶é’±æ˜ç»†</span></header>
        <div class="flex flex-col items-center pt-16 px-6">
            <div class="w-20 h-20 bg-[#fbbd08] rounded-full flex items-center justify-center mb-8"><span class="text-white text-5xl font-bold">Â¥</span></div>
            <div class="text-zinc-800 text-lg mb-2">æˆ‘çš„é›¶é’±</div>
            <div class="text-4xl font-bold mb-16 flex items-baseline"><span class="text-2xl mr-1">Â¥</span><span id="wallet-num">0.00</span></div>
            <button onclick="walletOp('add')" class="w-full bg-[#07c160] text-white py-3 rounded-lg font-bold text-lg mb-4 active:bg-[#06ad56]">å……å€¼</button>
            <button onclick="walletOp('sub')" class="w-full bg-white text-zinc-800 py-3 rounded-lg font-bold text-lg border border-zinc-300 active:bg-gray-50">æç°</button>
        </div>
    </div>
    <div id="pg-transfer-detail" class="page z-[80] bg-[#191919] text-white flex flex-col items-center">
        <header class="w-full h-16 flex items-end justify-between p-4 shrink-0"><span onclick="go('pg-chat-room')" class="text-white text-lg cursor-pointer">ã€ˆ</span><span class="mb-1 text-sm font-light opacity-80">äº¤æ˜“è¯¦æƒ…</span><div class="w-4"></div></header>
        <div class="mt-10 flex flex-col items-center w-full px-8 animate-fade-in">
            <div class="mb-4 text-[#f79c4a] text-6xl"><div class="w-24 h-24 rounded-full border-4 border-[#f79c4a] flex items-center justify-center mx-auto mb-4"><span id="tx-icon">â³</span></div></div>
            <div id="tx-status" class="text-xl mb-2 text-[#f79c4a]">å¾…æ”¶æ¬¾</div>
            <div class="text-5xl font-bold mb-10 flex items-baseline"><span class="text-3xl mr-2">Â¥</span><span id="tx-amount">0.00</span></div>
            <button id="btn-tx-receive" onclick="doReceiveTransfer()" class="w-2/3 bg-[#07c160] text-white py-4 rounded-lg font-bold text-lg mb-6 active:scale-95 transition-transform shadow-lg hidden">ç¡®è®¤æ”¶æ¬¾</button>
            <div id="link-tx-return" class="text-sm text-zinc-500 mt-auto mb-8 hidden">1å¤©å†…æœªç¡®è®¤ï¼Œå°†é€€è¿˜ç»™å¯¹æ–¹ã€‚<span onclick="doReturnTransfer()" class="text-[#576b95] cursor-pointer ml-1">ç«‹å³é€€è¿˜</span></div>
            <div id="tx-info-box" class="hidden text-zinc-500 text-sm mt-4 text-center space-y-2"><p>è½¬è´¦æ—¶é—´: <span id="tx-time"></span></p><p>æ”¶é’±æ—¶é—´: <span id="tx-time-rcv">--</span></p></div>
        </div>
    </div>

    <div id="pg-theater" class="page bg-zinc-50 z-[50]">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0 sticky top-0 z-20"><button onclick="go('pg-home')" class="text-zinc-600 pb-1 w-10 text-left">ğŸ </button><b class="pb-1 text-lg">æˆ‘çš„å‰§åœº</b><button onclick="go('pg-theater-create')" class="text-blue-600 font-bold pb-1 text-sm w-10 text-right">æ–°å»º</button></header>
        <div id="theater-list" class="p-4 space-y-3 overflow-y-auto pb-20 no-scrollbar"></div>
    </div>
    <div id="pg-theater-create" class="page bg-white z-[60]">
        <header class="h-14 flex items-end justify-between p-3 border-b shrink-0"><button onclick="go('pg-theater')" class="text-zinc-600 pb-1">å–æ¶ˆ</button><b class="pb-1 text-lg">æ–°å»ºå‰§æœ¬</b><button onclick="startTheaterGen()" id="btn-create-th" class="bg-[#07c160] text-white px-3 py-1 rounded text-sm font-bold mb-0.5 shadow-sm">å¼€å§‹ç”Ÿæˆ</button></header>
        <div class="p-5 space-y-5 overflow-y-auto h-full pb-20">
            <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-600 leading-5">ğŸ’¡ æç¤ºï¼šé€‰æ‹©ä¸€ä¸ªå·²æœ‰äººç‰©ï¼Œè®¾å®šèº«ä»½ï¼ŒAIå°†ä¸ºä½ ç”Ÿæˆä¸“å±äº’åŠ¨å°è¯´ã€‚</div>
            <div><label class="block text-sm font-bold text-zinc-800 mb-2">1. é€‰æ‹©è§’è‰²</label><select id="th-role-sel" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none"></select></div>
            <div class="flex gap-3"><div class="flex-1"><label class="block text-sm font-bold text-zinc-800 mb-2">2. ä»–çš„èº«ä»½</label><input id="th-role-job" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none" placeholder="ä¾‹: å‚²å¨‡åŒ»ç”Ÿ"></div><div class="flex-1"><label class="block text-sm font-bold text-zinc-800 mb-2">3. æˆ‘çš„èº«ä»½</label><input id="th-user-job" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none" placeholder="ä¾‹: ç¬¨è›‹æ‚£è€…"></div></div>
            <div><label class="block text-sm font-bold text-zinc-800 mb-2">4. å‰§æƒ…æ¢—æ¦‚</label><textarea id="th-prompt" class="w-full h-32 p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none resize-none text-sm leading-relaxed" placeholder="è¯·è¾“å…¥æ•…äº‹èƒŒæ™¯ã€‚ä¾‹å¦‚ï¼šæˆ‘åœ¨åŒ»é™¢æŒ‚é”™å·é‡åˆ°äº†ä»–..."></textarea></div>
            <div><label class="block text-sm font-bold text-zinc-800 mb-2">5. ç›®æ ‡å­—æ•°</label><input id="th-len" type="number" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none" placeholder="20000" value="20000"><p class="text-xs text-zinc-400 mt-2">* AIå°†åˆ†ç« èŠ‚é€æ­¥ç»­å†™ã€‚</p></div>
        </div>
    </div>
    <div id="pg-theater-read" class="page bg-[#f8f1e5] z-[70]">
        <header class="h-14 bg-[#f8f1e5] flex items-end justify-between p-3 border-b border-[#eaddcf] shrink-0 sticky top-0 z-20 shadow-sm"><button onclick="go('pg-theater')" class="text-[#8c7b6c] pb-1 font-medium">ã€ˆ ä¹¦æ¶</button><b id="th-read-title" class="pb-1 text-[#5c4b3c] text-lg overflow-hidden whitespace-nowrap text-ellipsis max-w-[50%]"></b><button onclick="deleteTheater()" class="text-red-400 text-xs pb-1 px-2">åˆ é™¤</button></header>
        <div id="th-read-content" class="p-6 overflow-y-auto h-full pb-32 text-[#4a3b2c] font-serif text-lg leading-loose text-justify whitespace-pre-wrap scroll-smooth"></div>
        <div class="absolute bottom-0 w-full bg-[#f8f1e5]/95 backdrop-blur border-t border-[#eaddcf] p-4 flex gap-3 z-30 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <button id="btn-th-continue" onclick="continueTheater()" class="flex-1 bg-[#5c4b3c] text-[#f8f1e5] py-3 rounded-lg font-bold shadow-md active:scale-95 transition-transform flex justify-center items-center gap-2"><span>âœï¸ ç»­å†™ä¸‹ä¸€ç« </span></button>
            <button onclick="toggleCatalog()" class="w-14 flex items-center justify-center bg-[#eaddcf] rounded-lg text-lg active:bg-[#d6c4b0] transition-colors relative">ğŸ“‹<span id="chapter-count-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full shadow-sm hidden">0</span></button>
        </div>
        <div id="catalog-drawer" class="catalog-drawer" onclick="if(event.target===this) toggleCatalog()"><div class="catalog-content"><div class="h-14 border-b flex items-end p-4 bg-gray-50"><b class="text-lg text-zinc-700">ğŸ“œ ç« èŠ‚ç›®å½•</b></div><div id="catalog-list" class="flex-1 overflow-y-auto"></div><div class="p-4 border-t bg-gray-50"><button onclick="copyTheater()" class="w-full py-2 border border-zinc-300 rounded text-zinc-600 text-sm">å¤åˆ¶å…¨æ–‡</button></div></div></div>
    </div>

    <div id="pg-chat-room" class="page z-[50]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0">
            <span onclick="go('pg-wechat')" class="text-zinc-600 pb-1 cursor-pointer">ã€ˆ è¿”å›</span>
            <div class="flex flex-col items-center pb-1"><b id="chat-user-name"></b><span id="chat-mode-tag" class="text-[10px] text-zinc-400">çŸ­å¥æ¨¡å¼</span></div>
            <div class="flex items-center gap-3 pb-1"><button onclick="toggleChatMode()" class="text-xl transition-transform active:scale-90" id="btn-mode-switch">ğŸ’¬</button><button onclick="go('pg-chat-info')" class="text-zinc-800 text-xl font-bold px-2 tracking-widest">â€¢â€¢â€¢</button></div>
        </header>
        <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar bg-[#f2f2f2] bg-cover bg-center"></div>
        <footer class="bg-[#f7f7f7] border-t z-[60] relative shrink-0 safe-area-pb">
            <div class="p-3 flex items-center gap-2">
                <button onclick="togglePnl('emoji')" class="text-3xl text-zinc-600 font-light active:opacity-50 px-1">â˜º</button>
                <input id="chat-in" class="flex-1 border-none rounded bg-white h-10 px-3 outline-none text-base" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button onclick="togglePnl('tools')" class="text-3xl text-zinc-600 font-light active:opacity-50 px-1">âŠ•</button>
                <button onclick="handleSendMsg()" class="bg-[#07c160] text-white px-3 py-1.5 rounded text-sm font-medium whitespace-nowrap">å‘é€</button>
            </div>
            <div id="chat-pnl" class="drawer bg-[#f7f7f7]"></div>
        </footer>
    </div>

    <div id="pg-chat-info" class="page z-[60] bg-zinc-100">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0"><span onclick="go('pg-chat-room')" class="text-zinc-600 pb-1 cursor-pointer">ã€ˆ</span><b class="pb-1">èŠå¤©ä¿¡æ¯</b><div class="w-6"></div></header>
        <div class="overflow-y-auto">
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="go('pg-mask-edit')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span class="text-base text-zinc-800">ğŸ­ ç”¨æˆ·é¢å…· (äººè®¾)</span><div class="flex items-center gap-2"><span id="info-mask-status" class="text-xs text-zinc-400">é»˜è®¤</span><span class="text-zinc-300">ã€‰</span></div></div></div>
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="setChatBg()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span class="text-base text-zinc-800">ğŸ–¼ï¸ è®¾ç½®å½“å‰èŠå¤©èƒŒæ™¯</span><span class="text-zinc-300">ã€‰</span></div></div>
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="clearHistory()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer text-red-600 text-center justify-center font-medium">æ¸…ç©ºèŠå¤©è®°å½•</div></div>
        </div>
    </div>
    <div id="pg-mask-edit" class="page z-[70] bg-white"><header class="h-16 flex items-end justify-between border-b pb-4 px-4 shrink-0"><button onclick="go('pg-chat-info')" class="text-zinc-600">å–æ¶ˆ</button><b>ç¼–è¾‘é¢å…·</b><button onclick="saveMask()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-6 space-y-6"><div class="text-xs text-zinc-400 text-center">åœ¨æ­¤å¤„è®¾ç½®çš„å½¢è±¡å’Œäººè®¾ï¼Œä»…åœ¨ä¸å½“å‰è§’è‰²èŠå¤©æ—¶ç”Ÿæ•ˆã€‚</div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·æ˜µç§°</label><input id="in-mask-n" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: ä½ çš„å­¦ç”Ÿå°æ˜"></div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·å¤´åƒ URL</label><input id="in-mask-a" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="http://..."></div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·äººè®¾è¯¦æƒ…</label><textarea id="in-mask-i" class="w-full h-40 p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ååŒ»å­¦é™¢çš„å­¦ç”Ÿ..."></textarea></div></div></div>
    <div id="pg-prof" class="page bg-white p-4"><header class="h-16 flex items-end justify-between border-b pb-4 shrink-0"><button onclick="go('pg-wechat')">è¿”å›</button><b>ä¸ªäººä¿¡æ¯</b><div class="w-8"></div></header><div class="mt-4 divide-y"><div onclick="updProf('name','æ˜µç§°')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>æ˜µç§°</span><span class="u-name text-zinc-400"></span></div><div onclick="updProf('ava','å¤´åƒURL')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>å¤´åƒ</span><img class="w-12 h-12 u-ava rounded-lg bg-zinc-100"></div><div onclick="updProf('bg','æœ‹å‹åœˆèƒŒæ™¯URL')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>æœ‹å‹åœˆèƒŒæ™¯</span><span class="text-zinc-400 text-sm">ç‚¹å‡»æ›´æ¢ ã€‰</span></div><div onclick="updProf('info','äººè®¾ç­¾å')" class="py-5 flex flex-col gap-2 active:bg-zinc-50"><span>èº«ä»½äººè®¾/ç­¾å</span><div id="u-info-box" class="text-sm text-zinc-400 bg-zinc-50 p-4 rounded-lg"></div></div></div></div>
    <div id="pg-moments-pub" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')" class="text-zinc-700">å–æ¶ˆ</button><b class="pb-1">å‘è¡¨æœ‹å‹åœˆ</b><button onclick="submitMoment()" class="bg-[#07c160] text-white px-4 py-1 rounded text-sm font-medium">å‘è¡¨</button></header><div class="flex-1 overflow-y-auto"><textarea id="in-m-t" class="w-full h-40 p-4 outline-none resize-none text-lg" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea><div class="p-4 border-t"><p class="text-xs text-zinc-400 mb-2">é…å›¾é“¾æ¥ (å¯é€‰)</p><input id="in-m-img" class="w-full p-3 bg-zinc-50 rounded-lg text-sm border-none outline-none" placeholder="ç²˜è´´å›¾ç‰‡ç›´é“¾ http://..."></div></div></div>
    <div id="pg-wb" class="page bg-zinc-100"><header class="h-16 bg-white flex items-end justify-between p-4 border-b shrink-0"><button onclick="go('pg-home')" class="text-zinc-600">ğŸ </button><b>ä¸–ç•Œä¹¦</b><button onclick="openWBEdit(null)" class="text-blue-600 font-bold">ï¼‹</button></header><div id="wb-list-box" class="p-4 space-y-3"></div></div>
    <div id="pg-wb-edit" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wb')">å–æ¶ˆ</button><b>ç¼–è¾‘è®¾å®š</b><button onclick="saveWB()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-4 space-y-4 overflow-y-auto no-scrollbar"><input id="in-wb-n" class="w-full p-3 border rounded-lg" placeholder="è®¾å®šæ ‡é¢˜"><textarea id="in-wb-c" class="w-full h-40 p-3 border rounded-lg" placeholder="å†…å®¹..."></textarea><div id="wb-roles-sel" class="flex flex-wrap gap-2 pb-10"></div></div></div>
    <div id="pg-memory" class="page bg-zinc-100"><header class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-home')" class="text-zinc-600">ğŸ </button><b>è®°å¿†æ®¿å ‚</b><div class="w-8"></div></header><div id="memory-list" class="p-4 space-y-4 overflow-y-auto no-scrollbar"></div></div>
    <div id="pg-set" class="page bg-zinc-100"><header class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-home')">ğŸ </button><b>API è®¾ç½®</b><div></div></header><div class="p-6 space-y-4"><input id="in-s-u" class="w-full p-3 border rounded-lg" placeholder="API åœ°å€"><input id="in-s-k" type="password" class="w-full p-3 border rounded-lg" placeholder="API Key"><div class="flex gap-2"><input id="in-s-m" class="flex-1 p-3 border rounded-lg" placeholder="æ¨¡å‹åç§°"><button onclick="fetchModels()" class="bg-blue-600 text-white px-3 rounded-lg text-xs whitespace-nowrap">æ‹‰å–åˆ—è¡¨</button></div><select id="model-select" class="w-full p-3 border rounded-lg hidden" onchange="$('in-s-m').value=this.value"></select><button onclick="saveSettings()" class="w-full bg-zinc-800 text-white py-4 rounded-xl font-bold shadow-lg mt-4">ä¿å­˜è®¾ç½®å¹¶è¿”å›</button></div></div>
    <div id="pg-role-edit" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')">å–æ¶ˆ</button><b id="role-edit-title">è§’è‰²</b><button onclick="saveRole()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-4 space-y-4 overflow-y-auto no-scrollbar"><input id="in-r-n" class="w-full p-3 border rounded-lg" placeholder="æ˜µç§°"><input id="in-r-a" class="w-full p-3 border rounded-lg" placeholder="å¤´åƒURL"><textarea id="in-r-i" class="w-full h-80 p-3 border rounded-lg" placeholder="è¯¦ç»†äººè®¾..."></textarea><button id="del-role-btn" onclick="deleteRole()" class="w-full py-3 text-red-500 hidden">åˆ é™¤æ­¤è§’è‰²</button></div></div>
    <div id="pg-emj" class="page bg-white"><header class="h-16 border-b p-4 flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')">è¿”å›</button><b>è¡¨æƒ…åŒ…åˆ—è¡¨</b><button onclick="addEmj()" class="text-green-600">æ·»åŠ </button></header><div id="emj-box" class="p-4 grid grid-cols-4 gap-4 overflow-y-auto"></div></div>
</div>
<script>
    const $ = id => document.getElementById(id);
    const DB_NAME = 'AI_OS_DB';
    const STORE_NAME = 'system_data';
    const DB = 'OS67_'; 
    const DB_VERSION = 1;
    let db;

    // ================== 1. IndexedDB æ ¸å¿ƒå¼•æ“ ==================
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (e) => { console.error("DB Error", e); reject("æ•°æ®åº“æ‰“å¼€å¤±è´¥"); };
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                console.log("IndexedDB è¿æ¥æˆåŠŸ");
                resolve(db);
            };
        });
    }

    function dbGet(key, defaultVal) {
        return new Promise((resolve) => {
            if(!db) return resolve(defaultVal);
            const tx = db.transaction([STORE_NAME], 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result !== undefined ? req.result : defaultVal);
            req.onerror = () => { console.warn(`Read error: ${key}`); resolve(defaultVal); };
        });
    }

    function dbSet(key, val) {
        return new Promise((resolve, reject) => {
            if(!db) return reject("DBæœªåˆå§‹åŒ–");
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const req = store.put(val, key);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }

    // ================== 2. å…¨å±€å˜é‡ä¸è¾…åŠ© ==================
    let roles, chats, wbs, emjs, mnts, balance, theaters;
    let foods, cart, orders;          
    let shopGoods, shopCart, shopOrders, shopFavs; 

    let curRole = null, curWB = null, selRids = [], curTab = 'chat';
    let curMsgIdx = -1, lastPnlType = null, curTheater = null;
    let takeoutCtx = { fromChat: false, targetRoleId: null };

    function cleanText(text) { 
        if (typeof text !== 'string') return '';
        let res = text.replace(/<think>[\s\S]*?<\/think>/gi, "");
        res = res.replace(/^\(Hello, I am.*?\.\)\s*/i, "").replace(/^Hello, I am.*?\.\s*/i, "");
        res = res.replace(/æˆ‘æ˜¯.*?æ¨¡å‹/g, "").replace(/```.*?/g, "").replace(/```/g, "");
        return res.trim(); 
    }
    
    function safeParse(key, def) { return def; } 

    async function cleanBadData() {
        if(!confirm("ç¡®å®šè¦æ·±åº¦æ¸…ç†å—ï¼Ÿ")) return;
        let r = await dbGet('OS67_R', []);
        r.forEach(role => {
            if (role.history && Array.isArray(role.history)) {
                role.history = role.history.filter(m => m && typeof m.t === 'string');
            } else { role.history = []; }
            if(!role.mode) role.mode = 'chat';
        });
        await dbSet('OS67_R', r);
        alert(`æ¸…ç†å®Œæˆï¼Œå³å°†åˆ·æ–°`);
        location.reload();
    }

    // ================== 3. æ•°æ®åŠ è½½ä¸ä¿å­˜ ==================
    async function loadAllData() {
        const K = 'OS67_';
        roles = await dbGet(K+'R', []);
        chats = await dbGet(K+'C', []);
        wbs = await dbGet(K+'W', []);
        emjs = await dbGet(K+'E', []);
        mnts = await dbGet(K+'M', []);
        balance = parseFloat(await dbGet(K+'BAL', '0.00'));
        theaters = await dbGet(K+'THEATERS', []);

        foods = await dbGet(K+'FOODS', [
            { id: 1, store: "å¡”æ–¯æ±€ä¸­å›½æ±‰å ¡", name: "é¦™è¾£é¸¡è…¿å ¡å¥—é¤", price: 19.9, sales: 500, img: "https://img.meituan.net/msi/0b17156b82547565d833896409a80374116496.jpg" },
            { id: 2, store: "èœœé›ªå†°åŸ", name: "å†°é²œæŸ æª¬æ°´", price: 4.0, sales: 9999, img: "https://img.meituan.net/msi/86d38e24483584852880092305822365287313.png" },
            { id: 3, store: "éŸ©å¼ç‚¸é¸¡", name: "ç”œè¾£æ— éª¨ç‚¸é¸¡", price: 25.8, sales: 230, img: "https://p0.meituan.net/deal/832c6968037628833959952044565773108620.jpg" },
            { id: 4, store: "å–œèŒ¶ HEYTEA", name: "å¤šè‚‰è‘¡è„(é¦–åˆ›)", price: 28.0, sales: 600, img: "https://img.meituan.net/msi/e4d09320297063f2722b512c1421f18e1467402.jpg" }
        ]);
        cart = await dbGet(K+'CART', []);
        orders = await dbGet(K+'ORDERS', []);

        shopGoods = await dbGet(K+'SHOP_GOODS', [
            { id: 101, store: "å®˜æ–¹æ——èˆ°åº—", name: "æ–°æ¬¾æ™ºèƒ½æ‰‹æœº Pro Max", price: 5999.0, sales: 2000, img: "https://img.icons8.com/color/480/smartphone.png" },
            { id: 102, store: "æ½®ç‰Œé›†åˆ", name: "å®½æ¾çº¯æ£‰æƒ…ä¾£å«è¡£", price: 129.0, sales: 800, img: "https://img.icons8.com/color/480/hoodie-with-pocket.png" },
            { id: 103, store: "ç¾å¦†è‡ªè¥", name: "å¤§ç‰Œå£çº¢ çƒ‚ç•ªèŒ„è‰²", price: 299.0, sales: 5000, img: "https://img.icons8.com/color/480/lipstick.png" },
            { id: 104, store: "ç”Ÿæ´»å®¶å±…", name: "è¶…è½¯æ¯›ç»’å…¬ä»” (å¤§å·)", price: 88.0, sales: 300, img: "https://img.icons8.com/color/480/teddy-bear.png" }
        ]);
        shopCart = await dbGet(K+'SHOP_CART', []);
        shopOrders = await dbGet(K+'SHOP_ORDERS', []);
        shopFavs = await dbGet(K+'SHOP_FAVS', []);

        roles.forEach(r => { if(!r.ava) r.ava = "https://img.icons8.com/color/96/user.png"; });
    }

    async function saveAll() {
        const K = 'OS67_';
        try {
            await Promise.all([
                dbSet(K+'R', roles), dbSet(K+'C', chats), dbSet(K+'W', wbs),
                dbSet(K+'E', emjs), dbSet(K+'M', mnts), dbSet(K+'BAL', balance.toFixed(2)),
                dbSet(K+'THEATERS', theaters),
                dbSet(K+'FOODS', foods), dbSet(K+'CART', cart), dbSet(K+'ORDERS', orders),
                dbSet(K+'SHOP_GOODS', shopGoods), dbSet(K+'SHOP_CART', shopCart),
                dbSet(K+'SHOP_ORDERS', shopOrders), dbSet(K+'SHOP_FAVS', shopFavs)
            ]);
        } catch (e) { console.error("Save Failed:", e); alert("ä¿å­˜å¤±è´¥ï¼æ£€æŸ¥å­˜å‚¨ç©ºé—´"); }
    }
    function saveTakeoutData() { saveAll(); } 

    function hardReset() {
        if(confirm("ã€é«˜èƒ½è­¦å‘Šã€‘\nè¿™å°†å®Œå…¨æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼\nç¡®å®šç»§ç»­å—ï¼Ÿ")) {
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const req = tx.objectStore(STORE_NAME).clear();
            req.onsuccess = () => { alert("ç³»ç»Ÿå·²é‡ç½®"); location.reload(); };
        }
    }

    // ================== 4. è·¯ç”±é€»è¾‘ ==================
    function go(id) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        let target = $(id); if(target) target.classList.add('active');
        if(id==='pg-wb') renderWBList();
        if(id==='pg-emj') renderEmj();
        if(id==='pg-set') loadSettings();
        if(id==='pg-memory') renderMemPage();
        if(id==='pg-wallet') renderWallet();
        if(id==='pg-chat-info') renderChatInfo();
        if(id==='pg-mask-edit') loadMaskEdit();
        if(id==='pg-theater') renderTheaterList();
        if(id==='pg-theater-create') initTheaterCreate();
        if(id==='pg-takeout-home') renderFoodList();
        if(id==='pg-takeout-cart') renderCart();
        if(id==='pg-takeout-me') updatePendingBadge();
        if(id==='pg-takeout-orders') renderAllOrders();
        if(id==='pg-takeout-pending') renderPendingOrders();
        if(id==='pg-shop-favs') renderFavs(); 
        if(id==='pg-shop-home') renderShopList(); 
        if(id==='pg-shop-cart') renderShopCart(); 
        if(id==='pg-shop-me') updateShopPendingBadge(); 
    }

    function tab(t) {
        curTab = t;
        ['chat','cont','moments','me'].forEach(k=>$(`sub-${k}`).classList.add('hidden'));
        $(`sub-${t}`).classList.remove('hidden');
        document.querySelectorAll('footer div').forEach(d=>d.style.color='#999');
        let tIcon = $(`t-${t}`); if(tIcon) tIcon.style.color='#07c160';
        if(t==='chat') renderChatList();
        if(t==='cont') renderCont();
        if(t==='moments') renderMnts();
        if(t==='me') renderProfile();
    }

    // ================== 5. å°å‰§åœºç³»ç»Ÿ ==================
    function initTheaterCreate() {
        const sel = $('th-role-sel');
        sel.innerHTML = roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        if(roles.length === 0) sel.innerHTML = '<option disabled>è¯·å…ˆå»é€šè®¯å½•æ·»åŠ è§’è‰²</option>';
    }
    function renderTheaterList() {
        const list = $('theater-list');
        if (theaters.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-32 opacity-50"><div class="text-6xl mb-4">ğŸ“š</div><div class="text-sm text-zinc-500">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</div><div class="text-xs text-zinc-400 mt-2">ç‚¹å‡»å³ä¸Šè§’æ–°å»º</div></div>`; return; }
        let sorted = theaters.sort((a,b) => b.createTime - a.createTime);
        list.innerHTML = sorted.map(t => {
            let r = roles.find(x => x.id == roleIdCompat(t));
            let roleName = r ? r.name : (t.roleName || 'æœªçŸ¥');
            let roleJob = t.roleJob || 'ä¸»è§’';
            let ava = r ? r.ava : 'https://img.icons8.com/color/96/user.png';
            let fullText = getFullText(t);
            let excerpt = fullText.slice(0, 45).replace(/\n/g, ' ') + '...';
            let wordCount = fullText.length;
            let dateStr = new Date(t.createTime).toLocaleDateString();
            return `<div onclick="openTheater(${t.id})" class="bg-white p-4 rounded-xl border border-zinc-100 shadow-sm flex gap-4 cursor-pointer active:scale-[0.98] transition-all hover:shadow-md group"><div class="relative w-16 h-24 shrink-0 bg-zinc-200 rounded overflow-hidden shadow-inner"><img src="${ava}" class="w-full h-full object-cover opacity-90 group-hover:scale-110 transition-transform duration-500"><div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div><div class="absolute bottom-1 left-1 text-[10px] text-white font-light">å‰§æœ¬</div></div><div class="flex-1 min-w-0 flex flex-col py-0.5"><div class="flex justify-between items-start"><h3 class="font-bold text-[16px] text-zinc-800 truncate pr-2">${t.title || 'æ— é¢˜å‰§æœ¬'}</h3><span class="text-[10px] text-zinc-400 bg-zinc-50 px-1.5 py-0.5 rounded border border-zinc-100">${dateStr}</span></div><p class="text-xs text-[#576b95] mt-1 font-medium">${roleName} <span class="text-zinc-400">é¥°</span> ${roleJob}</p><p class="text-sm text-zinc-400 mt-2 leading-tight line-clamp-2">${excerpt}</p><div class="mt-auto text-[10px] text-zinc-300 text-right">å…± ${wordCount} å­—</div></div></div>`;
        }).join('');
    }
    function getFullText(theater) { if (!theater) return ""; if (Array.isArray(theater.chapters)) { return theater.chapters.map(c => c.text).join('\n\n'); } return theater.content || ""; }
    function roleIdCompat(t) { return t.roleId; }
    
    async function startTheaterGen() {
        const roleId = $('th-role-sel').value; const roleJob = $('th-role-job').value || "æœªçŸ¥èº«ä»½"; const userJob = $('th-user-job').value || "æ™®é€šäºº"; const promptText = $('th-prompt').value;
        if (!roleId || !promptText) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        let role = roles.find(r => r.id == roleId); let cfg = await getAICfg(); if (!cfg.key) return alert("è¯·å…ˆè®¾ç½® API Key");
        let btn = $('btn-create-th'); btn.innerText = "æ­£åœ¨æ„å»ºå¹³è¡Œä¸–ç•Œ..."; btn.disabled = true; btn.classList.add('opacity-50');
        let newTheater = { id: Date.now(), roleId: role.id, roleName: role.name, roleJob: roleJob, title: promptText.slice(0, 8) + "...", context: `ã€è§’è‰²æ€§æ ¼åŸå‹ã€‘ï¼š${role.name}ï¼ˆæ€§æ ¼å‚è€ƒï¼š${role.info}ï¼‰ã€‚\nã€å½“å‰å‰§æœ¬æ–°è®¾å®šã€‘ï¼šè¿™æ˜¯ä¸€ä¸ªå¹³è¡Œå®‡å®™(AU)æ•…äº‹ã€‚æ—¶é—´/åœ°ç‚¹/èƒŒæ™¯å®Œå…¨ä»¥â€œ${promptText}â€ä¸ºå‡†ã€‚è‹¥åŸè®¾èƒŒæ™¯ä¸æ–°è®¾å®šå†²çªï¼Œ**å¼ºåˆ¶è¦†ç›–**åŸè®¾ã€‚${role.name}ç°åœ¨çš„èº«ä»½æ˜¯${roleJob}ï¼Œæˆ‘æ˜¯${userJob}ã€‚`, prompt: promptText, chapters: [], createTime: Date.now() };
        const sysPrompt = `ä½ æ˜¯ä¸€ä½ç•…é”€å°è¯´å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ã€å¹³è¡Œå®‡å®™è®¾å®šã€‘å†™ä¸€ç¯‡å°è¯´çš„ç¬¬ä¸€ç« ã€‚\nã€æ ¸å¿ƒæŒ‡ä»¤ã€‘\n1. **èƒŒæ™¯è¦†ç›–åŸåˆ™**ï¼šè¿™æ˜¯ä¸€éƒ¨AUï¼ˆå¹³è¡Œä¸–ç•Œï¼‰åŒäººå°è¯´ã€‚è™½ç„¶ä¸»è§’æ€§æ ¼å‚è€ƒåŸè®¾ï¼Œä½†**å¿…é¡»ä¸¥æ ¼æ‰§è¡Œç”¨æˆ·æä¾›çš„æ–°èƒŒæ™¯/æ–°èŒä¸š**ã€‚å¦‚æœåŸè®¾æ˜¯å¤ä»£/æ°‘å›½ï¼Œè€Œç”¨æˆ·è®¾å®šæ˜¯ç°ä»£ï¼Œ**å¿…é¡»**å†™ç°ä»£ã€‚\n2. **æ ¼å¼æ¸…æ´—**ï¼šç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚**ä¸¥ç¦**è¾“å‡ºâ€œ(Hello...)â€ã€â€œå¥½çš„æˆ‘æ¥å†™â€ç­‰åºŸè¯ã€‚**ä¸¥ç¦**è¾“å‡º <think> æ ‡ç­¾ã€‚\n3. **å†™ä½œè¦æ±‚**ï¼šé¢˜ç›®è‡ªæ‹Ÿï¼ˆç¬¬ä¸€è¡Œè¾“å‡ºé¢˜ç›®ï¼‰ã€‚æ­£æ–‡çº¦800å­—ã€‚`;
        try {
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `ã€æ–°å‰§æœ¬å¤§çº²ã€‘ï¼š${newTheater.prompt}\nã€è§’è‰²è®¾å®šã€‘ï¼š${newTheater.context}` }] }) });
            let data = await res.json(); 
            let content = cleanText(data.choices[0].message.content);
            let lines = content.split('\n'); let firstLine = lines[0].replace(/[#ã€Šã€‹]/g, '').trim();
            if(firstLine.length < 20) newTheater.title = firstLine;
            newTheater.chapters.push({ id: Date.now(), text: content }); theaters.unshift(newTheater); saveAll(); openTheater(newTheater.id);
        } catch (e) { alert("ç”Ÿæˆå¤±è´¥: " + e.message); } finally { btn.innerText = "å¼€å§‹ç”Ÿæˆ"; btn.disabled = false; btn.classList.remove('opacity-50'); }
    }

    function openTheater(tid) { curTheater = theaters.find(t => t.id == tid); if(!curTheater) return; $('th-read-title').innerText = curTheater.title; if (!curTheater.chapters) { curTheater.chapters = [{ id: Date.now(), text: curTheater.content || "" }]; delete curTheater.content; saveAll(); } renderReaderContent(); updateCatalogList(); go('pg-theater-read'); }
    function renderReaderContent() {
        const contentDiv = $('th-read-content'); contentDiv.innerHTML = "";
        curTheater.chapters.forEach((chap, idx) => {
            let chapDiv = document.createElement('div'); chapDiv.id = `chap-${idx}`; chapDiv.className = "mb-10 pb-6 border-b border-[#eaddcf]/50";
            let chapHeader = document.createElement('div'); chapHeader.className = "text-xs text-[#8c7b6c] mb-4 font-bold flex justify-between items-center select-none"; chapHeader.innerHTML = `<span>â€”â€” ç¬¬ ${idx+1} ç«  â€”â€”</span>`;
            let retryBtn = document.createElement('span'); retryBtn.className = "cursor-pointer text-blue-400 hover:text-blue-600 px-2"; retryBtn.innerText = "ğŸ”„ é‡å†™æ­¤æ®µ"; retryBtn.onclick = () => retryChapter(idx); chapHeader.appendChild(retryBtn);
            let textDiv = document.createElement('div'); let htmlText = chap.text.split('\n').map(line => { line = line.trim(); if(!line) return '<br>'; return `<p class="mb-4 indent-8">${line}</p>`; }).join(''); textDiv.innerHTML = htmlText;
            chapDiv.appendChild(chapHeader); chapDiv.appendChild(textDiv); contentDiv.appendChild(chapDiv);
        });
        const badge = $('chapter-count-badge'); badge.innerText = curTheater.chapters.length; badge.classList.remove('hidden');
    }
    function toggleCatalog() { const drawer = $('catalog-drawer'); if(drawer.classList.contains('active')) drawer.classList.remove('active'); else { updateCatalogList(); drawer.classList.add('active'); } }
    function updateCatalogList() { if(!curTheater || !curTheater.chapters) return; $('catalog-list').innerHTML = curTheater.chapters.map((c, idx) => { let preview = c.text.slice(0, 15).replace(/\n/g, '') + "..."; return `<div onclick="jumpToChapter(${idx})" class="chapter-item"><div class="flex flex-col"><span class="text-sm font-bold text-zinc-700">ç¬¬ ${idx+1} ç« </span><span class="text-xs text-zinc-400 mt-1">${preview}</span></div><div class="text-xs text-zinc-300">GO</div></div>`; }).join(''); }
    function jumpToChapter(idx) { toggleCatalog(); const target = $(`chap-${idx}`); if(target) { target.scrollIntoView({ behavior: 'smooth', block: 'start' }); target.classList.add('bg-yellow-50/50'); setTimeout(() => target.classList.remove('bg-yellow-50/50'), 1000); } }
    
    async function retryChapter(idx) {
        if(!confirm(`ç¡®å®šè¦é‡å†™ç¬¬ ${idx+1} ç« å—ï¼Ÿ`)) return; let cfg = await getAICfg(); if (!cfg.key) return alert("API Key æœªè®¾ç½®");
        let prevText = ""; for(let i=0; i<idx; i++) { prevText += curTheater.chapters[i].text + "\n"; } let contextText = prevText.slice(-3000);
        const chapDiv = $(`chap-${idx}`); const originalContent = chapDiv.innerHTML; chapDiv.innerHTML = `<div class="p-10 flex flex-col items-center justify-center text-[#8c7b6c] animate-pulse"><div class="text-2xl mb-2">âœï¸</div><div>AI æ­£åœ¨é‡æ„æ€è·¯...</div></div>`;
        const sysPrompt = `ä½ æ˜¯ä¸€ä½å°è¯´å®¶ã€‚è¯·é‡å†™è¿™ä¸€ç« èŠ‚ã€‚\nã€è®¾å®šã€‘ï¼š${curTheater.context}\nã€è¦æ±‚ã€‘ï¼š1. æ‰¿æ¥ä¸Šæ–‡ï¼Œé€»è¾‘è¿è´¯ã€‚2. ä¸¥ç¦åºŸè¯å’Œæ€è€ƒæ ‡ç­¾ï¼Œåªè¾“å‡ºæ­£æ–‡ã€‚3. ä¿æŒAUè®¾å®šï¼Œä¸è¦æ··æ·†æ—¶ä»£èƒŒæ™¯ã€‚`;
        try {
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `ã€å‰æƒ…å›é¡¾ã€‘ï¼š${contextText || "ï¼ˆè¿™æ˜¯ç¬¬ä¸€ç« ï¼Œæ— å‰æ–‡ï¼‰"}\n\nè¯·é‡å†™æœ¬ç« ï¼š` }] }) });
            let data = await res.json(); let newText = cleanText(data.choices[0].message.content); curTheater.chapters[idx].text = newText; saveAll(); renderReaderContent(); setTimeout(() => jumpToChapter(idx), 100);
        } catch (e) { alert("é‡å†™å¤±è´¥: " + e.message); chapDiv.innerHTML = originalContent; }
    }
    async function continueTheater() {
        if(!curTheater) return; let cfg = await getAICfg(); let btn = $('btn-th-continue'); btn.innerHTML = `<span class="dot-ani"><span class="dot bg-white"></span><span class="dot bg-white"></span><span class="dot bg-white"></span></span> æ­£åœ¨æ„æ€...`; btn.disabled = true;
        let fullText = getFullText(curTheater); let contextText = fullText.slice(-4000);
        const sysPrompt = `ä½ æ˜¯ä¸€ä½å°è¯´å®¶ã€‚è¯·ç»§ç»­ç»­å†™ä¹‹å‰çš„æ•…äº‹ã€‚\nã€é‡è¦è®¾å®šæé†’ã€‘\n${curTheater.context}\n(è¯·æ—¶åˆ»è®°ä½ä¸Šè¿°å¹³è¡Œå®‡å®™è®¾å®šï¼Œä¸è¦è®©è§’è‰²ç©¿è¶Šå›åŸå§‹èƒŒæ™¯)\nã€ç»­å†™è¦æ±‚ã€‘\n1. ç´§æ¥ä¸Šæ–‡ï¼Œæ¨åŠ¨æƒ…èŠ‚ã€‚\n2. **ä¸¥ç¦**è¾“å‡ºä»»ä½•ç³»ç»ŸåºŸè¯ï¼ˆå¦‚ "Hello", "Here is the story"ï¼‰æˆ–æ€è€ƒæ ‡ç­¾ã€‚ç›´æ¥è¾“å‡ºå°è¯´æ­£æ–‡ã€‚\n3. è¾“å‡ºçº¦800-1000å­—æ–°å†…å®¹ã€‚`;
        try {
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `ã€å‰æƒ…å›é¡¾ã€‘ï¼š...${contextText}\n\nè¯·ç»§ç»­å†™ï¼š` }] }) });
            let data = await res.json(); let newText = cleanText(data.choices[0].message.content); curTheater.chapters.push({ id: Date.now(), text: newText }); saveAll(); renderReaderContent(); $('th-read-content').scrollTop = $('th-read-content').scrollHeight;
        } catch (e) { alert("ç»­å†™å¤±è´¥: " + e.message); } finally { btn.innerHTML = `âœï¸ ç»­å†™ä¸‹ä¸€ç« `; btn.disabled = false; }
    }
    function deleteTheater() { if(confirm("ç¡®å®šè¦æŠŠè¿™æœ¬å°è¯´ä»ä¹¦æ¶ç§»é™¤å—ï¼Ÿ")) { theaters = theaters.filter(t => t.id !== curTheater.id); saveAll(); go('pg-theater'); } }
    function copyTheater() { let text = getFullText(curTheater); if(text) navigator.clipboard.writeText(text).then(()=>alert("å·²å¤åˆ¶å…¨æ–‡")); }

    // ================== 6. èŠå¤©ç³»ç»Ÿ (å®Œæ•´) ==================
    function applyChatBg() { if(curRole && curRole.chatBg) { $('chat-msgs').style.backgroundImage = `url('${curRole.chatBg}')`; } else { $('chat-msgs').style.backgroundImage = 'none'; } }
    function setChatBg() { let url = prompt("è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL:", (curRole && curRole.chatBg) ? curRole.chatBg : ""); if(url !== null) { if(curRole) { curRole.chatBg = url; saveAll(); applyChatBg(); } } }
    function enterChat(id) { 
        try {
            curRole = roles.find(x => x.id == id); if (!curRole) { alert("æ•°æ®å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨ä¿®å¤"); chats = chats.filter(c => c != id); saveAll(); renderChatList(); return; }
            if(!chats.includes(curRole.id)) { chats.unshift(curRole.id); saveAll(); } 
            $('chat-user-name').innerText = curRole.name; if (!curRole.mode) curRole.mode = 'chat'; 
            updateChatModeUI(); applyChatBg(); go('pg-chat-room'); renderMsgs(); 
        } catch (e) { alert("è¿›å…¥èŠå¤©å¤±è´¥: " + e.message); }
    }
    function toggleChatMode() { if (!curRole) return; curRole.mode = (curRole.mode === 'story') ? 'chat' : 'story'; saveAll(); updateChatModeUI(); renderMsgs(); }
    function updateChatModeUI() { if (!curRole) return; let isStory = curRole.mode === 'story'; $('btn-mode-switch').innerText = isStory ? 'ğŸ“–' : 'ğŸ’¬'; $('chat-mode-tag').innerText = isStory ? 'æ²‰æµ¸å‰§æƒ…ä¸­' : 'çŸ­å¥æ¨¡å¼'; $('chat-mode-tag').className = isStory ? "text-[10px] text-purple-600 font-bold" : "text-[10px] text-zinc-400"; $('chat-in').placeholder = isStory ? "è¾“å…¥åŠ¨ä½œã€è¯­è¨€æˆ–å¿ƒç†æ´»åŠ¨..." : "è¾“å…¥æ¶ˆæ¯..."; }
    
    function togglePnl(type) { const pnl = $('chat-pnl'); const isOpen = pnl.classList.contains('drawer-open'); if (isOpen && lastPnlType === type) { pnl.classList.remove('drawer-open'); lastPnlType = null; } else { pnl.classList.add('drawer-open'); lastPnlType = type; if (type === 'emoji') renderEmjPnl(); else renderToolsPnl(); } }
    function renderEmjPnl() { if (emjs.length === 0) { $('chat-pnl').innerHTML = `<div class="text-center text-zinc-300 text-xs py-10">æš‚æ— è¡¨æƒ…åŒ…<br>å»â€œæˆ‘-è¡¨æƒ…åŒ…ç®¡ç†â€æ·»åŠ ä¸€äº›å§~</div>`; return; } $('chat-pnl').innerHTML = `<div class="grid grid-cols-5 gap-4 p-4">${emjs.map(e => `<img src="${e.url}" onclick="handleSendMsg('${e.url}','image'); $('chat-pnl').classList.remove('drawer-open');" class="w-full h-14 object-contain bg-white rounded-lg border border-zinc-100 p-1 active:scale-95 transition-transform shadow-sm cursor-pointer">`).join('')}</div>`; }
    function renderToolsPnl() {
        $('chat-pnl').innerHTML = `
            <div class="grid grid-cols-4 gap-6 p-6">
                <div onclick="startTransfer()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center border border-zinc-200 shadow-sm"><span class="text-2xl">ğŸ§§</span></div><span class="text-xs text-zinc-500">è½¬è´¦</span></div>
                <div onclick="openTakeoutFromChat()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-[#FFD101] rounded-xl flex items-center justify-center border border-yellow-300 shadow-sm"><span class="text-2xl">ğŸ¥¡</span></div><span class="text-xs text-zinc-500">ç‚¹å¤–å–</span></div>
                <div onclick="openShopFromChat()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-[#ff6700] rounded-xl flex items-center justify-center border border-orange-300 shadow-sm"><span class="text-2xl">ğŸ›ï¸</span></div><span class="text-xs text-zinc-500">é€›å•†åœº</span></div>
                <div onclick="$('chat-in').focus(); alert('è¯·ç›´æ¥ç²˜è´´å›¾ç‰‡é“¾æ¥')" class="flex flex-col items-center gap-2 opacity-50 grayscale cursor-pointer"><div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center border border-zinc-200"><span class="text-2xl">ğŸ–¼ï¸</span></div><span class="text-xs text-zinc-500">ç›¸å†Œ</span></div>
            </div>`;
    }
    function openShopFromChat() { if (!curRole) return; takeoutCtx = { fromChat: true, targetRoleId: curRole.id }; $('chat-pnl').classList.remove('drawer-open'); toShopTab('home'); go('pg-shop-home'); }
    function openTakeoutFromChat() { if (!curRole) return; takeoutCtx = { fromChat: true, targetRoleId: curRole.id }; $('chat-pnl').classList.remove('drawer-open'); toTakeoutTab('home'); go('pg-takeout-home'); }

    function startTransfer() { $('chat-pnl').classList.remove('drawer-open'); lastPnlType = null; let val = prompt("è¯·è¾“å…¥è½¬è´¦é‡‘é¢:"); if (val === null) return; let amt = parseFloat(val); if (isNaN(amt) || amt <= 0.01) return alert("é‡‘é¢æ ¼å¼ä¸æ­£ç¡®"); if (amt > balance) return alert(`ä½™é¢ä¸è¶³ï¼å½“å‰åªæœ‰ Â¥${balance.toFixed(2)}`); balance -= amt; saveAll(); handleSendMsg(amt.toFixed(2), 'transfer'); }
    function openTransferDetail(idx) { curMsgIdx = idx; let msg = curRole.history[idx]; $('tx-amount').innerText = parseFloat(msg.t).toFixed(2); let statusEl = $('tx-status'), iconEl = $('tx-icon'), btnReceive = $('btn-tx-receive'), linkReturn = $('link-tx-return'), infoBox = $('tx-info-box'); btnReceive.classList.add('hidden'); linkReturn.classList.add('hidden'); infoBox.classList.add('hidden'); statusEl.className = "text-xl mb-2 text-[#f79c4a]"; if (msg.status === 'received') { statusEl.innerText = "å·²æ”¶æ¬¾"; statusEl.className = "text-xl mb-2 text-zinc-500"; iconEl.innerText = "âœ”"; infoBox.classList.remove('hidden'); $('tx-time-rcv').innerText = msg.rcvTime || 'æœªçŸ¥'; } else if (msg.status === 'returned') { statusEl.innerText = "å·²é€€è¿˜"; statusEl.className = "text-xl mb-2 text-red-500"; iconEl.innerText = "â†©"; infoBox.classList.remove('hidden'); $('tx-time-rcv').innerText = "å·²åŸè·¯é€€å›"; } else { if (msg.r === 'ai') { statusEl.innerText = "å¾…ä½ æ”¶æ¬¾"; iconEl.innerText = "ğŸ’°"; btnReceive.classList.remove('hidden'); linkReturn.classList.remove('hidden'); } else { statusEl.innerText = `ç­‰å¾… ${curRole.name} ç¡®è®¤æ”¶æ¬¾`; iconEl.innerText = "â³"; } } go('pg-transfer-detail'); }
    function doReceiveTransfer() { if (curMsgIdx === -1) return; let msg = curRole.history[curMsgIdx]; if (msg.status !== 'pending') return; balance += parseFloat(msg.t); msg.status = 'received'; msg.rcvTime = new Date().toLocaleString(); saveAll(); renderWallet(); openTransferDetail(curMsgIdx); }
    function doReturnTransfer() { if (curMsgIdx === -1) return; let msg = curRole.history[curMsgIdx]; if (msg.status !== 'pending') return; msg.status = 'returned'; msg.rcvTime = new Date().toLocaleString(); curRole.history.push({ r: 'u', t: `[ç³»ç»Ÿ: å·²é€€è¿˜è½¬è´¦ Â¥${msg.t}]`, type: 'text' }); saveAll(); openTransferDetail(curMsgIdx); }

    async function handleSendMsg(customVal, type='text', isRetry=false) {
        let txt = customVal || $('chat-in').value; if(!txt && type === 'text') return;
        let newMsg = { r: 'u', t: txt, type: type, status: 'pending', time: new Date().toLocaleString() };
        if(!isRetry) curRole.history.push(newMsg); if(!customVal) $('chat-in').value = ''; renderMsgs();
        if (curRole.history.length > 400) { await summarizeMemory(); renderMsgs(); }
        
        let cfg = await getAICfg(); 
        let globalUser = await dbGet('OS67_U', {}); 
        let worldCtx = wbs.filter(b => b.rids?.includes(curRole.id)).map(b => b.content).join('\n'); 
        let mask = curRole.userMask || {}; 
        let effectiveUser = { name: mask.name || globalUser.name || "ç”¨æˆ·", info: mask.info || "æ™®é€šç”¨æˆ·" }; 
        let longTermMem = curRole.memories ? `è®°å¿†:${curRole.memories.slice(-3).join('; ')}` : '';
        let contentForAI = txt;
        
        if (type === 'transfer') contentForAI = `[ç³»ç»Ÿäº‹ä»¶ï¼šç”¨æˆ·è½¬è´¦ Â¥${txt}ã€‚æ”¶ä¸‹å›[CMD:RECEIVE]ï¼Œæ‹’æ”¶å›[CMD:RETURN]ã€‚]`; 
        else if (type === 'image') contentForAI = `[ç”¨æˆ·å‘å›¾: ${txt}]`;
        
        let modeSysPrompt = ""; let modeReinforce = "";
        if (curRole.mode === 'story') { 
            modeSysPrompt = `ã€æ¨¡å¼:é•¿å‰§æƒ…å°è¯´ã€‘\n1. è¯·ä½¿ç”¨å‡ºç‰ˆçº§å°è¯´ç¬”æ³•ï¼Œç¯å¢ƒ/åŠ¨ä½œ/å¿ƒç†æå†™å¿…é¡»ä¸°å¯Œã€‚\n2. å¯¹è¯éœ€ç”¨åŒå¼•å·ã€‚\n3. å­—æ•°è¦æ±‚ï¼šæ¯æ¬¡è¾“å‡º200å­—ä»¥ä¸Šï¼Œæ¨åŠ¨æƒ…èŠ‚å‘å±•ã€‚`; 
            modeReinforce = `(System Note: Current mode is NOVEL. Please write a long, descriptive response.)`;
        } else { 
            modeSysPrompt = `ã€æ¨¡å¼:å¾®ä¿¡çŸ­èŠã€‘\n1. å¿…é¡»å®Œå…¨ç¦æ­¢ç¯å¢ƒ/åŠ¨ä½œæå†™ï¼\n2. å°±åƒåœ¨å¾®ä¿¡æ‰“å­—ä¸€æ ·ï¼Œç®€çŸ­ã€å£è¯­åŒ–ã€æ¥åœ°æ°”ã€‚\n3. ä¸è¦ç”¨ä¹¦é¢è¯­ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºï¼Œæ¯æ¬¡å›å¤ä¸è¶…è¿‡50å­—ã€‚`; 
            modeReinforce = `(ç³»ç»Ÿå¼ºåˆ¶æŒ‡ä»¤ï¼šç«‹åˆ»åœæ­¢å°è¯´å†™æ³•ï¼ç°åœ¨æ˜¯å¾®ä¿¡èŠå¤©æ¨¡å¼ã€‚ç¦æ­¢ä»»ä½•åŠ¨ä½œ/å¿ƒç†æå†™ã€‚åªå›å¤ç®€çŸ­çš„å£è¯­å¯¹è¯ã€‚ä¸è¦åŠ å¼•å·ã€‚)`;
        }
        
        let loadingMsg = { r: 'ai', t: '', loading: true }; curRole.history.push(loadingMsg); renderMsgs();
        try {
            let apiMessages = curRole.history.filter(m => !m.loading && m.t && m.type !== 'pay_request' && m.type !== 'order_share').map(m => {
                let content = m.t; if (m.type === 'transfer') content = m.r === 'u' ? `[ç”¨æˆ·è½¬è´¦ Â¥${m.t}]` : `[æˆ‘è½¬è´¦ Â¥${m.t}]`; if (m.r === 'ai') content = cleanText(m.t); return { role: m.r === 'u' ? 'user' : 'assistant', content: content };
            });
            apiMessages[apiMessages.length-1].content = contentForAI + `\n\n${modeReinforce}`;

            let sysPrompt = `ä½ æ˜¯${curRole.name}ã€‚${longTermMem}ã€‚èƒŒæ™¯:${curRole.info}ã€‚ä¸${effectiveUser.name}èŠå¤©ã€‚ä¸–ç•Œ:${worldCtx}ã€‚\n${modeSysPrompt}\nã€é€šç”¨è§„åˆ™ã€‘:\n1. é‡‘é’±ï¼šæƒ³è½¬è´¦å› [CMD:TRANSFER:é‡‘é¢]ã€‚æ”¶æ¬¾ç”¨ [CMD:RECEIVE]ï¼Œæ‹’æ”¶ç”¨ [CMD:RETURN]ã€‚\n2. æœ‹å‹åœˆï¼šæƒ³å‘åŠ¨æ€å› [CMD:POST:å†…å®¹]ã€‚`;
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [ { role: 'system', content: sysPrompt }, ...apiMessages ], stream: false }) });
            let data = await res.json(); 
            let rawContent = cleanText(data.choices[0].message.content);
            
            let postMatch = rawContent.match(/\[CMD:POST:(.*?)\]/); if (postMatch) { let postContent = postMatch[1]; rawContent = rawContent.replace(postMatch[0], '').trim(); mnts.unshift({ id: Date.now(), r: curRole.id, content: postContent, img: "", time: Date.now(), likes: [], comments: [] }); saveAll(); if(curTab === 'moments') renderMnts(); }
            if (rawContent.includes('[CMD:RECEIVE]')) { rawContent = rawContent.replace('[CMD:RECEIVE]', '').trim(); let pendingMsg = curRole.history.findLast(m => m.r === 'u' && m.type === 'transfer' && m.status === 'pending'); if (pendingMsg) { pendingMsg.status = 'received'; pendingMsg.rcvTime = new Date().toLocaleString(); } }
            if (rawContent.includes('[CMD:RETURN]')) { rawContent = rawContent.replace('[CMD:RETURN]', '').trim(); let pendingMsg = curRole.history.findLast(m => m.r === 'u' && m.type === 'transfer' && m.status === 'pending'); if (pendingMsg) { pendingMsg.status = 'returned'; pendingMsg.rcvTime = new Date().toLocaleString(); balance += parseFloat(pendingMsg.t); saveAll(); } }
            let transferMatch = rawContent.match(/\[CMD:TRANSFER:(\d+(\.\d+)?)\]/); let aiTransferAmt = 0; if (transferMatch) { aiTransferAmt = parseFloat(transferMatch[1]); rawContent = rawContent.replace(transferMatch[0], '').trim(); }
            loadingMsg.t = rawContent; delete loadingMsg.loading; if (aiTransferAmt > 0) { if (!rawContent) { loadingMsg.type = 'transfer'; loadingMsg.t = aiTransferAmt.toString(); loadingMsg.status = 'pending'; } else { curRole.history.push({ r: 'ai', t: aiTransferAmt.toString(), type: 'transfer', status: 'pending', time: new Date().toLocaleString() }); } }
            if(!loadingMsg.t && loadingMsg.type==='text') loadingMsg.t = "..."; saveAll(); renderMsgs();
        } catch (e) { console.error(e); curRole.history.pop(); renderMsgs(); alert("å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–API Key"); }
    }

    function renderMsgs() {
        if (!curRole || !curRole.history) return; 
        let myAva = document.querySelector('.u-ava')?.src || "https://img.icons8.com/color/96/user.png";
        let userAva = (curRole.userMask && curRole.userMask.ava) ? curRole.userMask.ava : myAva;
        let isStoryMode = curRole.mode === 'story';
        $('chat-msgs').innerHTML = curRole.history.map((m, idx) => {
            if (!m) return ''; 
            let avaSrc = m.r==='u' ? userAva : curRole.ava;
            let bubbleContent = '', bubbleClass = '', extraStyle = '', containerClass = '', wrapperClass = '', showAva = true;

            if (m.type === 'transfer') {
                wrapperClass = m.r === 'u' ? 'flex flex-row justify-end items-start' : 'flex flex-row justify-start items-start';
                containerClass = m.r === 'u' ? 'flex flex-col items-end max-w-[75%] mr-2' : 'flex flex-col items-start max-w-[75%] ml-2';
                bubbleClass = 'bg-[#f79c4a] text-white border-none cursor-pointer active:opacity-80 rounded-xl px-4 py-3 shadow-sm'; 
                let icon = m.status === 'received' ? 'âœ”' : (m.status === 'returned' ? 'â†©' : (m.r==='u' ? 'Â¥' : 'ğŸ’°')); 
                let title = m.r === 'u' ? `è½¬è´¦ç»™ ${curRole.name}` : 'æ”¶åˆ°è½¬è´¦'; 
                let statusText = m.status === 'received' ? (m.r==='u'?'å·²è¢«é¢†å–':'å·²æ”¶æ¬¾') : (m.status==='returned'?'å·²é€€è¿˜':(m.r==='u'?'ç­‰å¾…å¯¹æ–¹ç¡®è®¤':'å¾…ä½ æ”¶æ¬¾'));
                bubbleContent = `<div onclick="openTransferDetail(${idx})" class="flex items-center gap-3 min-w-[200px]"><div class="w-10 h-10 rounded-full border-2 border-white/30 flex items-center justify-center text-white text-xl">${icon}</div><div class="flex flex-col"><span class="text-base font-bold">Â¥${m.t}</span><span class="text-[10px] opacity-80">${title}</span></div></div><div class="mt-2 pt-1 border-t border-white/20 text-[10px] opacity-70">${statusText}</div>`;
            } else if (m.type === 'pay_request') {
                wrapperClass = 'flex flex-row justify-end items-start'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
                let statusText = m.status==='pending'?'ç­‰å¾…å¯¹æ–¹ä»˜æ¬¾':(m.status==='paid'?'å¯¹æ–¹å·²ä»˜æ¬¾':'å¯¹æ–¹å·²æ‹’ç»');
                let statusClass = m.status==='pending'?'st-pending':(m.status==='paid'?'st-paid':'st-rejected');
                let isShop = m.itemDisplay && m.itemDisplay.startsWith('[å•†åŸ]');
                let payTitle = isShop ? "è¯·ä½ å¸®æˆ‘ä»˜å•†åŸè®¢å•" : "è¯·ä½ å¸®æˆ‘ä»˜å¤–å–";
                let headerClass = isShop ? "card-header-pay-shop" : "card-header-pay";
                let source = isShop ? "AI å•†åŸ" : "ç¾å›¢å¤–å–";
                bubbleContent = `<div class="msg-card"><div class="${headerClass}"></div><div class="card-title"><span>${isShop?'ğŸ›ï¸':'ğŸ’³'}</span> ${payTitle}</div><div class="card-content"><img src="${m.img || ''}" class="card-img"><div class="card-info"><div class="card-desc">${m.itemDisplay || 'å•†å“'}</div><div class="card-price">Â¥${parseFloat(m.total).toFixed(2)}</div></div></div><div class="flex justify-between items-center text-xs"><span class="text-zinc-400">${source}</span><span class="status-tag ${statusClass}">${statusText}</span></div></div>`;
            } else if (m.type === 'order_share') {
                wrapperClass = 'flex flex-row justify-end items-start'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
                bubbleContent = `<div class="msg-card"><div class="card-header-share"></div><div class="card-title"><span>ğŸ˜‹</span> æˆ‘ç‚¹äº†è¿™å®¶ï¼Œè¶…å¥½åƒ</div><div class="card-content"><img src="${m.img || ''}" class="card-img"><div class="card-info"><div class="card-desc">${m.itemDisplay}</div><div class="text-xs text-zinc-400">å…± ${m.count} ä»¶</div></div></div><div onclick="go('pg-takeout-home')" class="card-btn">å»çœ‹çœ‹</div></div>`;
            } else if (m.type === 'image') {
                wrapperClass = m.r==='u'?'flex flex-row justify-end items-start':'flex flex-row justify-start items-start';
                containerClass = m.r==='u'?'flex flex-col items-end max-w-[75%] mr-2':'flex flex-col items-start max-w-[75%] ml-2';
                bubbleContent = `<img src="${m.t}" class="max-w-[150px] rounded-lg cursor-pointer" onclick="window.open('${m.t}')">`; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
            } else {
                if (m.loading) { bubbleContent = `<div class="dot-ani"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`; } 
                else {
                    let rawText = m.r === 'ai' ? cleanText(m.t) : m.t;
                    let formattedText = typeof rawText === 'string' ? rawText.replace(/\*([^*]+)\*/g, '<span class="text-zinc-400 italic text-[15px]">$1</span>') : '';
                    if (isStoryMode && m.r === 'ai') bubbleContent = formattedText.split('\n').filter(line => line.trim() !== '').map(line => `<span class="story-p">${line}</span>`).join('');
                    else bubbleContent = formattedText.replace(/\n/g, '<br>');
                }
                if (m.r === 'u') { wrapperClass = 'flex flex-row justify-end items-start'; bubbleClass = 'bubble-user shadow-sm'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; } 
                else { if (isStoryMode) { showAva = false; wrapperClass = 'flex justify-center'; containerClass = 'flex flex-col w-[90%]'; bubbleClass = 'story-text-container'; } else { wrapperClass = 'flex flex-row justify-start items-start'; bubbleClass = 'bubble-ai shadow-sm'; containerClass = 'flex flex-col items-start max-w-[75%] ml-2'; } }
            }
            let avatarHtml = showAva ? `<img src="${avaSrc}" class="w-10 h-10 rounded-lg shrink-0 bg-zinc-300 shadow-sm">` : ''; 
            let retryBtn = (m.r === 'ai' && !m.loading && m.type === 'text') ? ` <span class="text-zinc-300">|</span> <span onclick="retryMsg(${idx})" class="cursor-pointer text-blue-500 font-bold hover:bg-zinc-100 px-1 rounded">â†»é‡è¯´</span>` : '';
            let innerHtml = m.r === 'u' ? `<div class="${containerClass}"><div class="bubble ${bubbleClass}" style="${extraStyle}">${bubbleContent}</div><div class="text-[10px] text-zinc-400 mt-1 flex gap-3 px-1 mr-1"><span onclick="delMsg(${idx})" class="cursor-pointer">åˆ é™¤</span></div></div>${avatarHtml}` : `${m.r==='ai'?avatarHtml:''}<div class="${containerClass}"><div class="bubble ${bubbleClass}" style="${extraStyle}">${bubbleContent}</div><div class="text-[10px] text-zinc-400 mt-1 flex gap-2 px-1 ${isStoryMode?'ml-0 justify-end w-full pr-4':'ml-1 items-center'}"><span onclick="delMsg(${idx})" class="cursor-pointer text-zinc-400 hover:text-red-500">åˆ é™¤</span>${retryBtn}</div></div>`;
            return `<div class="${wrapperClass} gap-2 mb-4 w-full px-2">${innerHtml}</div>`;
        }).join('');
        $('chat-msgs').scrollTop = $('chat-msgs').scrollHeight;
    }

    function renderChatList() { $('sub-chat').innerHTML = chats.map(id => { let r = roles.find(x=>x.id==id); if(!r) return ''; let lastMsg = r.history.length > 0 ? r.history[r.history.length-1].t : 'æš‚æ— æ¶ˆæ¯'; return `<div onclick="enterChat('${r.id}')" class="p-4 flex gap-3 bg-white active:bg-zinc-50 border-b"><img src="${r.ava}" class="w-12 h-12 rounded-lg bg-zinc-100"><div class="flex-1 min-w-0"><b class="block truncate">${r.name}</b><p class="text-xs text-zinc-400 truncate">${cleanText(lastMsg)}</p></div></div>`; }).join(''); }
    function renderCont() { $('sub-cont').innerHTML = roles.map(r => `<div class="p-4 flex justify-between items-center bg-white active:bg-zinc-50 border-b"><div class="flex items-center gap-3"><img src="${r.ava}" class="w-10 h-10 rounded-lg bg-zinc-100"><b>${r.name}</b></div><button onclick="openRoleEdit('${r.id}')" class="text-blue-500 text-xs border border-blue-200 px-3 py-1 rounded-full">è®¾å®š</button></div>`).join(''); }
    function renderMemPage() { let html = roles.map(r => { if (!r.memories || r.memories.length === 0) return ''; let volumes = []; for (let i = 0; i < r.memories.length; i += 10) { let chunk = r.memories.slice(i, i + 10); let volNum = Math.floor(i / 10) + 1; let contentHtml = chunk.map((m, idx) => `<div class="mb-2 text-sm text-zinc-600 border-b border-dashed pb-2"><b class="text-yellow-600">${i + idx + 1}:</b> ${m}</div>`).join(''); volumes.push(`<details class="mb-2 ml-4"><summary class="text-sm font-bold text-zinc-500 cursor-pointer p-2 hover:bg-zinc-100 rounded select-none">ğŸ“œ ç¬¬ ${volNum} å· (è®°å½• ${i+1}-${i+chunk.length})</summary><div class="p-3 bg-zinc-50 rounded-lg mt-1 border border-zinc-200">${contentHtml}</div></details>`); } return `<details class="bg-white p-4 rounded-xl shadow-sm group mb-4"><summary class="flex items-center gap-3 cursor-pointer list-none select-none"><img src="${r.ava}" class="w-10 h-10 rounded-lg bg-zinc-100"><div class="flex-1 font-bold text-lg text-zinc-800">${r.name}</div><span class="text-xs text-zinc-400 bg-zinc-100 px-2 py-1 rounded-full">å…± ${r.memories.length} æ¡</span><span class="transition-transform group-open:rotate-90">â–¶</span></summary><div class="mt-4 border-t pt-2 space-y-1">${volumes.join('')}</div></details>`; }).join(''); $('memory-list').innerHTML = html || '<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— è®°å¿†æ¡£æ¡ˆ<br>å¤šèŠèŠå¤©ï¼Œå½“å¯¹è¯è¶…è¿‡20æ¡æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ...</div>'; }
    async function summarizeMemory() { let cfg = await getAICfg(); if (!cfg.key) return; let earlyMsgs = curRole.history.slice(0, 10); let chatText = earlyMsgs.map(m => (m.r === 'u' ? 'ç”¨æˆ·:' : 'ä½ :') + m.t).join('\n'); let prompt = `å‰§æƒ…æ‘˜è¦:\n${chatText}\n\næ¦‚æ‹¬ä¸ºç®€ç»ƒçš„å‰§æƒ…ï¼Œç¬¬ä¸‰äººç§°ï¼Œ100å­—å†…ã€‚`; try { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] }) }); let data = await res.json(); let newSummary = data.choices[0].message.content; if (!curRole.memories) curRole.memories = []; curRole.memories.push(newSummary); curRole.history.splice(0, 10); saveAll(); } catch (e) { console.error(e); } }
    
    function openWBEdit(id) { curWB = id ? wbs.find(x=>x.id===id) : null; $('in-wb-n').value = curWB ? curWB.name : ''; $('in-wb-c').value = curWB ? curWB.content : ''; selRids = curWB ? [...curWB.rids] : []; renderWBSelect(); go('pg-wb-edit'); }
    function renderWBSelect() { $('wb-roles-sel').innerHTML = roles.map(r => `<div onclick="toggleWBR('${r.id}', this)" class="role-chip px-4 py-1.5 rounded-full text-xs cursor-pointer ${selRids.includes(r.id)?'selected':''}">${r.name}</div>`).join(''); }
    function toggleWBR(id, el) { if(selRids.includes(id)) { selRids = selRids.filter(x=>x!==id); el.classList.remove('selected'); } else { selRids.push(id); el.classList.add('selected'); } }
    function saveWB() { let b = { id: curWB?curWB.id:Date.now(), name:$('in-wb-n').value, content:$('in-wb-c').value, rids:selRids }; if(curWB) wbs = wbs.map(x=>x.id===curWB.id?b:x); else wbs.push(b); saveAll(); go('pg-wb'); }
    function renderWBList() { $('wb-list-box').innerHTML = wbs.map(b => `<div class="p-4 bg-white rounded-xl shadow-sm flex justify-between items-center"><div><b>${b.name}</b><p class="text-[10px] text-zinc-400 mt-1">ç»‘å®š: ${b.rids.length}</p></div><button onclick="openWBEdit(${b.id})" class="text-blue-500">ç¼–è¾‘</button></div>`).join(''); }
    function openRoleEdit(id) { curRole = id ? roles.find(x=>x.id==id) : null; $('in-r-n').value = curRole ? curRole.name : ''; $('in-r-a').value = curRole ? curRole.ava : ''; $('in-r-i').value = curRole ? curRole.info : ''; $('del-role-btn').style.display = curRole ? 'block' : 'none'; go('pg-role-edit'); }
    function saveRole() { let r = { id: curRole?curRole.id:Date.now(), name:$('in-r-n').value, ava:$('in-r-a').value, info:$('in-r-i').value, history: curRole?curRole.history:[] }; if(curRole) roles = roles.map(x=>x.id===curRole.id?r:x); else roles.push(r); saveAll(); go('pg-wechat'); tab('cont'); }
    function deleteRole() { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")){ roles=roles.filter(x=>x.id!==curRole.id); chats=chats.filter(id=>id!==curRole.id); saveAll(); go('pg-wechat'); tab('cont'); } }
    function clearHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")){ curRole.history=[]; saveAll(); renderMsgs(); go('pg-chat-room'); } }
    function delMsg(idx) { curRole.history.splice(idx,1); saveAll(); renderMsgs(); }
    function retryMsg(idx) { let lastU = ""; for(let i=idx-1; i>=0; i--){ if(curRole.history[i].r==='u'){ lastU=curRole.history[i].t; break; } } curRole.history.splice(idx,1); saveAll(); renderMsgs(); if(lastU) handleSendMsg(lastU, 'text', true); else handleSendMsg(" ", 'text', true); }
    // ================== 7. é€šç”¨è®¾ç½®ä¸è¾…åŠ© ==================
    async function getAICfg() {
        let val = await dbGet(DB+'AI', null); 
        // å…¼å®¹ LocalStorage (æ–¹ä¾¿è€ç”¨æˆ·æˆ–é¦–æ¬¡é…ç½®)
        if (!val) {
            let local = localStorage.getItem(DB+'AI');
            val = local ? JSON.parse(local) : {};
        }
        return val || {};
    }

    async function loadSettings() { 
        let cfg = await getAICfg(); 
        if($('in-s-u')) $('in-s-u').value = cfg.url || ''; 
        if($('in-s-k')) $('in-s-k').value = cfg.key || ''; 
        if($('in-s-m')) $('in-s-m').value = cfg.model || ''; 
    }
    
    async function saveSettings() { 
        await dbSet(DB+'AI', { url:$('in-s-u').value, key:$('in-s-k').value, model:$('in-s-m').value }); 
        alert("å·²ä¿å­˜"); go('pg-home'); 
    }

    async function fetchModels() { 
        let u=$('in-s-u').value, k=$('in-s-k').value; 
        if(!u||!k) return alert("è¯·å…ˆå¡«å†™ URL å’Œ Key"); 
        try { 
            let res = await fetch(`${u}/v1/models`, { headers:{"Authorization":`Bearer ${k}`} }); 
            let d = await res.json(); 
            if(d.data && Array.isArray(d.data)) { 
                $('model-select').innerHTML = d.data.map(m=>`<option value="${m.id}">${m.id}</option>`).join(''); 
                $('model-select').classList.remove('hidden'); 
                alert("æ‹‰å–æˆåŠŸ"); 
            } else { alert("è·å–å¤±è´¥"); } 
        } catch(e) { alert("ç½‘ç»œè¿æ¥å¤±è´¥"); } 
    }

    // ================== 8. ä¸ªäººä¿¡æ¯ä¸æœ‹å‹åœˆ ==================
    async function renderProfile() { 
        let p = await dbGet(DB+'U', null);
        if (!p) {
            let local = localStorage.getItem(DB+'U'); // å…¼å®¹æ—§æ•°æ®
            p = local ? JSON.parse(local) : {name:"æˆ‘çš„æ˜µç§°", ava:"https://img.icons8.com/color/96/user.png", bg:"", info:"æ™®é€šç”¨æˆ·"};
        }
        document.querySelectorAll('.u-name').forEach(e=>e.innerText=p.name);
        document.querySelectorAll('.u-ava').forEach(e=>e.src=p.ava);
        if($('u-info-box')) $('u-info-box').innerText = p.info;
        if($('moment-bg')) $('moment-bg').style.backgroundImage = `url('${p.bg||''}')`;
    }
    
    async function updProf(k, l) { 
        let p = await dbGet(DB+'U', {name:"æˆ‘çš„æ˜µç§°", ava:"https://img.icons8.com/color/96/user.png", bg:"", info:"æ™®é€šç”¨æˆ·"});
        let n = prompt(`ä¿®æ”¹${l}`, p[k]); 
        if(n!==null) { p[k]=n; await dbSet(DB+'U', p); renderProfile(); } 
    }

    function renderMnts() {
        let p = {name:"æˆ‘", ava:"https://img.icons8.com/color/96/user.png"}; // ç®€åŒ–å±•ç¤ºï¼Œå®é™…æ•°æ®å·²åœ¨DB
        let sorted = mnts.sort((a,b) => b.time - a.time);
        $('mnts-list').innerHTML = sorted.map((m, i) => {
            let isMe = m.r === 'u';
            let role = isMe ? null : roles.find(r=>r.id==m.r);
            let name = isMe ? "æˆ‘" : (role?.name || 'æœªçŸ¥ç”¨æˆ·');
            let ava = isMe ? document.querySelector('.u-ava').src : (role?.ava || '');
            let content = m.content || '';
            let imgHtml = m.img ? `<img src="${m.img}" class="max-h-60 max-w-[80%] mt-2 rounded-lg cursor-pointer object-cover" onclick="window.open('${m.img}')">` : '';
            let timeStr = new Date(m.time).toLocaleString();
            
            // è¯„è®ºæ¸²æŸ“
            let commentsHtml = '';
            if(m.comments && m.comments.length > 0) {
                let cList = m.comments.map(c => {
                    let cName = c.uid === 'me' ? "æˆ‘" : (roles.find(r=>r.id==c.uid)?.name || 'æœªçŸ¥');
                    let replyTarget = c.replyToName ? `å›å¤ <span class="text-zinc-800 font-bold">${c.replyToName}</span>` : '';
                    let cNameEscaped = cName.replace(/'/g, "\\'");
                    return `<div class="text-sm comment-row cursor-pointer" onclick="handleCommentClick(${m.id}, '${c.uid}', '${cNameEscaped}')"><span class="text-[#576b95] font-bold">${cName}</span> ${replyTarget}: <span class="text-zinc-800">${c.content}</span></div>`;
                }).join('');
                commentsHtml = `<div class="bg-zinc-100 p-2 rounded mt-2 flex flex-col gap-1">${cList}</div>`;
            }
            
            let likeBtnText = (m.likes && m.likes.includes('me')) ? 'â¤ï¸' : 'â™¡';
            let delBtn = `<span onclick="delMoment(${m.id})" class="text-xs text-zinc-400 ml-3 cursor-pointer hover:text-red-500">åˆ é™¤</span>`;

            return `<div class="flex gap-3 p-4 border-b border-zinc-100 animate-fade-in group"><img src="${ava}" class="w-10 h-10 rounded-lg bg-zinc-200 shrink-0"><div class="flex-1 min-w-0"><b class="text-[#576b95] cursor-pointer text-[15px]">${name}</b><div class="text-[15px] text-zinc-800 mt-1 whitespace-pre-wrap leading-relaxed">${content}</div>${imgHtml}<div class="flex justify-between items-center mt-2 mb-2"><div class="flex items-center"><span class="text-xs text-zinc-400">${timeStr}</span>${delBtn}</div><div class="bg-zinc-100 rounded-md flex items-center shadow-sm opacity-90"><button onclick="toggleLike(${m.id})" class="px-3 py-1 text-zinc-600 active:scale-90 transition-transform">${likeBtnText}</button><div class="w-[1px] h-3 bg-zinc-300"></div><button onclick="addComment(${m.id})" class="px-3 py-1 text-zinc-600 active:scale-90 transition-transform">ğŸ’¬</button></div></div>${commentsHtml}</div></div>`;
        }).join('');
    }

    function toggleLike(mid) { let m = mnts.find(x => x.id === mid); if(!m) return; if(!m.likes) m.likes = []; if(m.likes.includes('me')) { m.likes = m.likes.filter(x => x !== 'me'); } else { m.likes.push('me'); } saveAll(); renderMnts(); }
    function handleCommentClick(mid, targetUid, targetName) { if(targetUid === 'me') { if(confirm("åˆ é™¤è¿™æ¡è¯„è®ºï¼Ÿ")) { let m = mnts.find(x => x.id === mid); if(m && m.comments) { let idx = m.comments.findIndex(c => c.uid === 'me'); if(idx > -1) m.comments.splice(idx, 1); saveAll(); renderMnts(); } } return; } addComment(mid, targetUid, targetName); }
    function addComment(mid, replyToUid = null, replyToName = null) { let promptText = replyToName ? `å›å¤ ${replyToName}:` : "è¯„è®º:"; let content = prompt(promptText); if(!content) return; let m = mnts.find(x => x.id === mid); if(!m) return; if(!m.comments) m.comments = []; let newComment = { uid: 'me', content: content, time: Date.now() }; if(replyToUid && replyToName) { newComment.replyTo = replyToUid; newComment.replyToName = replyToName; } m.comments.push(newComment); saveAll(); renderMnts(); setTimeout(() => triggerAiReplyToComment(mid, content, replyToUid), 2000); }
    function delMoment(mid) { if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡æœ‹å‹åœˆå—ï¼Ÿ")) return; mnts = mnts.filter(x => x.id !== mid); saveAll(); renderMnts(); }
    function submitMoment() { let txt = $('in-m-t').value; let img = $('in-m-img').value; if(!txt && !img) return alert("å†™ç‚¹ä»€ä¹ˆå§"); let newId = Date.now(); mnts.unshift({ id: newId, r: 'u', content: txt, img: img, time: Date.now(), likes: [], comments: [] }); saveAll(); $('in-m-t').value = ''; $('in-m-img').value = ''; go('pg-wechat'); tab('moments'); setTimeout(() => triggerAiReaction(newId, txt), 2000); }
    function handlePlusBtn() { if(curTab==='cont') openRoleEdit(null); else if(curTab==='moments') go('pg-moments-pub'); else { let n=prompt("è§’è‰²å"); let r=roles.find(x=>x.name===n); if(r) enterChat(r.id); else alert("æœªæ‰¾åˆ°"); } }
    function addEmj() { let u=prompt("å›¾ç‰‡ç›´é“¾"), n=prompt("å«ä¹‰"); if(u&&n){ emjs.push({url:u,note:n}); saveAll(); renderEmj(); } }
    function renderEmj() { $('emj-box').innerHTML = emjs.map((e,i)=>`<div class="relative"><img src="${e.url}" class="w-full h-14 object-cover border rounded-lg"><span onclick="emjs.splice(${i},1);saveAll();renderEmj()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">Ã—</span></div>`).join(''); }

    // ================== 9. å¤–å–æ¨¡å—é€»è¾‘ ==================
    function toTakeoutTab(tab) { ['pg-takeout-home', 'pg-takeout-cart', 'pg-takeout-me'].forEach(id => { $(id).classList.remove('active'); }); $('pg-takeout-' + tab).classList.add('active'); if(tab === 'home') renderFoodList(); if(tab === 'cart') renderCart(); if(tab === 'me') updatePendingBadge(); }
    function handleSearchInput() { let val = $('takeout-search').value; let btn = $('btn-clear-search'); if(val.length > 0) btn.classList.remove('hidden'); else btn.classList.add('hidden'); renderFoodList(); }
    function clearSearch() { $('takeout-search').value = ''; $('btn-clear-search').classList.add('hidden'); renderFoodList(); }
    function renderFoodList() {
        const term = $('takeout-search').value.toLowerCase(); const list = $('takeout-list');
        const filtered = foods.filter(f => f.name.toLowerCase().includes(term) || f.store.toLowerCase().includes(term));
        list.innerHTML = filtered.map(f => `<div onclick="showFoodDetail(${f.id})" class="food-card flex flex-col h-full cursor-pointer active:opacity-90"><div class="food-img-box"><img src="${f.img}" loading="lazy"><div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2 pt-6"><span class="text-white text-[10px] font-light">30åˆ†é’Ÿé€è¾¾</span></div></div><div class="p-2 flex flex-col flex-1"><h3 class="font-bold text-sm text-zinc-800 truncate">${f.name}</h3><div class="text-[10px] text-zinc-400 mt-0.5 mb-2 truncate">ğŸ  ${f.store} | æœˆå”®${f.sales}+</div><div class="mt-auto flex justify-between items-center"><span class="text-red-500 font-bold text-base"><span class="text-xs">Â¥</span>${f.price}</span><button onclick="event.stopPropagation(); addToCart(${f.id})" class="bg-[#FFD101] w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm text-black active:bg-yellow-500">+</button></div></div></div>`).join('');
        updateCartBadge();
    }
    function showFoodDetail(fid) {
        let f = foods.find(x => x.id === fid); if(!f) return; let modal = $('food-detail-modal'); let body = modal.querySelector('.food-modal-body');
        body.innerHTML = `<div class="relative w-full h-64 bg-zinc-200 shrink-0"><img src="${f.img}" class="w-full h-full object-cover"><button onclick="closeFoodDetail()" class="absolute top-4 left-4 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur">âœ•</button></div><div class="p-5 flex-1 overflow-y-auto"><h2 class="text-2xl font-bold text-zinc-900 mb-1">${f.name}</h2><div class="text-zinc-500 text-sm mb-4">æœˆå”® ${f.sales}+ Â· å¥½è¯„ç‡ 98%</div><div class="text-zinc-600 text-sm leading-relaxed mb-6">è¿™æ˜¯ä¸€æ®µå…³äº ${f.name} çš„ç¾å‘³æè¿°ã€‚ä¸¥é€‰é£Ÿæï¼Œç°ç‚¹ç°åšï¼Œç¾å‘³ä¸ç”¨ç­‰ã€‚æ¥è‡ª ${f.store} çš„åŒ å¿ƒä¹‹ä½œã€‚</div></div><div class="p-4 border-t flex justify-between items-center bg-white safe-area-pb"><div class="flex flex-col"><span class="text-red-500 text-2xl font-bold"><span class="text-sm">Â¥</span>${f.price}</span><span class="text-xs text-zinc-400">æ— é—¨æ§›é…é€</span></div><button onclick="addToCart(${f.id}); closeFoodDetail()" class="bg-[#FFD101] text-black px-8 py-3 rounded-full font-bold shadow-md active:scale-95 transition-transform">åŠ å…¥è´­ç‰©è½¦</button></div>`;
        modal.classList.add('active');
    }
    function closeFoodDetail() { $('food-detail-modal').classList.remove('active'); }
    function addToCart(id) { let item = cart.find(x => x.id === id); if(item) { item.count++; } else { cart.push({id: id, count: 1}); } saveAll(); updateCartBadge(); let btn = event.target; let oldTxt = btn.innerText; btn.innerText = "âœ”"; setTimeout(() => btn.innerText = oldTxt, 500); }
    function updateCartBadge() { let total = cart.reduce((a, b) => a + b.count, 0); const badge = $('cart-badge'); if(total > 0) { badge.innerText = total; badge.classList.remove('hidden'); badge.classList.add('cart-badge-ani'); setTimeout(()=>badge.classList.remove('cart-badge-ani'), 300); } else { badge.classList.add('hidden'); } }
    function renderCart() { const list = $('cart-list'); if(cart.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><span class="text-6xl mb-4">ğŸ›’</span><span>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</span></div>`; $('cart-total').innerText = '0.00'; return; } let total = 0; list.innerHTML = cart.map(c => { let f = foods.find(x => x.id === c.id); if(!f) return ''; let subtotal = f.price * c.count; total += subtotal; return `<div class="bg-white p-3 rounded-xl flex gap-3 items-center"><img src="${f.img}" class="w-16 h-16 rounded-lg object-cover bg-zinc-100"><div class="flex-1"><b class="text-sm block truncate">${f.name}</b><span class="text-xs text-zinc-400">${f.store}</span><div class="flex justify-between items-center mt-2"><span class="text-red-500 font-bold">Â¥${f.price}</span><div class="flex items-center gap-3"><button onclick="changeCartCount(${f.id}, -1)" class="w-6 h-6 rounded border border-zinc-200 text-zinc-500 flex items-center justify-center">-</button><span class="text-sm font-bold w-4 text-center">${c.count}</span><button onclick="changeCartCount(${f.id}, 1)" class="w-6 h-6 rounded bg-[#FFD101] text-black flex items-center justify-center text-sm">+</button></div></div></div></div>`; }).join(''); $('cart-total').innerText = total.toFixed(2); }
    function changeCartCount(id, delta) { let item = cart.find(x => x.id === id); if(!item) return; item.count += delta; if(item.count <= 0) { cart = cart.filter(x => x.id !== id); } saveAll(); renderCart(); updateCartBadge(); }
    function clearCart() { if(confirm("ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ")) { cart = []; saveAll(); renderCart(); updateCartBadge(); } }
    
    function doCheckout() { if(cart.length === 0) return alert("è¯·å…ˆé€‰è´­å•†å“"); let total = parseFloat($('cart-total').innerText); if (takeoutCtx.fromChat) { createCustomCheckoutModal(total); } else { if(confirm(`ç¡®è®¤æ”¯ä»˜ Â¥${total} ä¸‹å•å—ï¼Ÿ`)) { processSelfPay(total); } } }
    function createCustomCheckoutModal(total) {
        let roleName = curRole ? curRole.name : 'å¥½å‹'; let overlay = document.createElement('div'); overlay.className = "fixed inset-0 bg-black/50 z-[100] flex items-end";
        overlay.innerHTML = `<div class="bg-white w-full rounded-t-2xl p-6 animate-fade-in"><h3 class="text-lg font-bold mb-4 text-center">å¤–å–æ”¯ä»˜ Â¥${total.toFixed(2)}</h3><div class="space-y-3"><button onclick="handlePayOption('self', ${total})" class="w-full py-3 bg-[#07c160] text-white rounded-lg font-bold">è‡ªå·±æ”¯ä»˜</button><button onclick="handlePayOption('friend', ${total})" class="w-full py-3 bg-[#FFD101] text-black rounded-lg font-bold flex items-center justify-center gap-2"><span>æ‰¾ ${roleName} ä»£ä»˜</span></button><button onclick="document.body.removeChild(this.parentNode.parentNode.parentNode)" class="w-full py-3 text-zinc-400">å–æ¶ˆ</button></div></div>`;
        document.body.appendChild(overlay); window.handlePayOption = (type, amt) => { document.body.removeChild(overlay); if(type === 'self') processSelfPay(amt); if(type === 'friend') processFriendPay(amt); };
    }
    function processSelfPay(total) { if(balance < total) return alert(`ä½™é¢ä¸è¶³ (å½“å‰ Â¥${balance.toFixed(2)})`); balance -= total; createOrder(total, 'paid'); alert("æ”¯ä»˜æˆåŠŸï¼"); saveAll(); go('pg-takeout-pending'); renderPendingOrders(); }
    function processFriendPay(total) { 
        let firstItem = foods.find(f => f.id === cart[0].id) || {name: "æœªçŸ¥å•†å“", img:""}; 
        let itemCount = cart.reduce((a,b)=>a+b.count,0); 
        let payMsg = { r: 'u', type: 'pay_request', status: 'pending', total: total, itemDisplay: `${firstItem.name} ç­‰ ${itemCount} ä»¶`, img: firstItem.img, time: new Date().toLocaleString(), t: `[ä»£ä»˜è¯·æ±‚] Â¥${total}` }; 
        curRole.history.push(payMsg); saveAll(); createOrder(total, 'wait_pay'); go('pg-chat-room'); renderMsgs(); 
        setTimeout(() => triggerAiPayDecision(curRole.history.length - 1, total), 1500); 
    }
    function createOrder(total, status) { let newOrder = { id: Date.now(), items: JSON.parse(JSON.stringify(cart)), total: total, time: Date.now(), status: status === 'paid' ? 'delivering' : 'pending_pay' }; orders.unshift(newOrder); cart = []; saveAll(); }

    // ================== 10. è´­ç‰©å•†åŸæ¨¡å—é€»è¾‘ ==================
    function toShopTab(tab) { ['pg-shop-home', 'pg-shop-cart', 'pg-shop-me'].forEach(id => { $(id).classList.remove('active'); }); $('pg-shop-' + tab).classList.add('active'); if(tab==='home') renderShopList(); if(tab==='cart') renderShopCart(); if(tab==='me') updateShopPendingBadge(); }
    function handleShopSearch() { let val = $('shop-search').value; if(val.length > 0) $('btn-shop-clear').classList.remove('hidden'); else $('btn-shop-clear').classList.add('hidden'); renderShopList(); }
    function clearShopSearch() { $('shop-search').value = ''; $('btn-shop-clear').classList.add('hidden'); renderShopList(); }
    
    function renderShopList() {
        const term = $('shop-search').value.toLowerCase(); const list = $('shop-list');
        const filtered = shopGoods.filter(g => g.name.toLowerCase().includes(term) || g.store.toLowerCase().includes(term));
        list.innerHTML = filtered.map(g => `<div onclick="showShopDetail(${g.id})" class="food-card flex flex-col h-full cursor-pointer active:opacity-90"><div class="food-img-box"><img src="${g.img}" class="p-4 bg-white object-contain"><div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/20 to-transparent p-2"></div></div><div class="p-2 flex flex-col flex-1"><h3 class="font-bold text-sm text-zinc-800 line-clamp-2 leading-tight h-10">${g.name}</h3><div class="text-[10px] text-[#ff6700] border border-[#ff6700] px-1 rounded w-fit mt-1">åŒ…é‚®</div><div class="text-[10px] text-zinc-400 mt-1 truncate">${g.store} | ${g.sales}+äººä»˜æ¬¾</div><div class="mt-auto flex justify-between items-center"><span class="text-[#ff6700] font-bold text-base"><span class="text-xs">Â¥</span>${g.price}</span><button onclick="event.stopPropagation(); addToShopCart(${g.id})" class="bg-[#ff6700]/10 text-[#ff6700] w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm active:bg-[#ff6700] active:text-white">+</button></div></div></div>`).join('');
        updateShopCartBadge();
    }
    function showShopDetail(gid) {
        let g = shopGoods.find(x => x.id === gid); if(!g) return; let modal = $('shop-detail-modal'); let body = modal.querySelector('.food-modal-body');
        let isFav = shopFavs.includes(gid);
        body.innerHTML = `<div class="relative w-full h-80 bg-white shrink-0 flex items-center justify-center"><img src="${g.img}" class="w-2/3 h-2/3 object-contain"><button onclick="closeShopDetail()" class="absolute top-4 left-4 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur">âœ•</button></div><div class="p-4 flex-1 overflow-y-auto"><div class="flex justify-between items-start"><span class="text-[#ff6700] text-3xl font-bold"><span class="text-base">Â¥</span>${g.price}</span><span class="text-xs text-zinc-400 mt-2">æœˆé”€ ${g.sales}+</span></div><h2 class="text-lg font-bold text-zinc-900 mt-2 leading-snug">${g.name}</h2><div class="mt-6 bg-zinc-50 p-3 rounded-lg text-xs text-zinc-500"><p>âœ… æ­£å“ä¿éšœ Â· æé€Ÿé€€æ¬¾ Â· èµ è¿è´¹é™©</p><p class="mt-1">${g.store} å‘è´§</p></div></div><div class="p-3 border-t flex gap-3 items-center bg-white safe-area-pb"><div onclick="toggleShopFav(${g.id})" class="flex flex-col items-center gap-1 px-2 cursor-pointer ${isFav?'text-[#ff6700]':'text-zinc-500'}"><div class="text-xl">${isFav?'â­':'â˜†'}</div><span class="text-[10px]">${isFav?'å·²æ”¶è—':'æ”¶è—'}</span></div><button onclick="addToShopCart(${g.id}); closeShopDetail()" class="flex-1 bg-gradient-to-r from-[#ff9000] to-[#ff5000] text-white py-3 rounded-full font-bold shadow-md active:scale-95 transition-transform">åŠ å…¥è´­ç‰©è½¦</button></div>`;
        modal.classList.add('active');
    }
    function closeShopDetail() { $('shop-detail-modal').classList.remove('active'); renderShopList(); }
    function toggleShopFav(gid) { if(shopFavs.includes(gid)) shopFavs = shopFavs.filter(x=>x!==gid); else shopFavs.push(gid); saveAll(); showShopDetail(gid); }

    function addToShopCart(id) { let item = shopCart.find(x => x.id === id); if(item) { item.count++; } else { shopCart.push({id: id, count: 1}); } saveAll(); updateShopCartBadge(); }
    function updateShopCartBadge() { let total = shopCart.reduce((a, b) => a + b.count, 0); const badge = $('shop-cart-badge'); if(total > 0) { badge.innerText = total; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }
    function renderShopCart() { const list = $('shop-cart-list'); if(shopCart.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><span class="text-6xl mb-4">ğŸ›’</span><span>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</span></div>`; $('shop-cart-total').innerText = '0.00'; return; } let total = 0; list.innerHTML = shopCart.map(c => { let g = shopGoods.find(x => x.id === c.id); if(!g) return ''; let subtotal = g.price * c.count; total += subtotal; return `<div class="bg-white p-3 rounded-xl flex gap-3 items-center"><img src="${g.img}" class="w-16 h-16 rounded-lg object-contain bg-zinc-50 border border-zinc-100"><div class="flex-1"><b class="text-sm block line-clamp-1">${g.name}</b><span class="text-xs text-zinc-400 bg-zinc-50 px-1 rounded">${g.store}</span><div class="flex justify-between items-center mt-2"><span class="text-[#ff6700] font-bold">Â¥${g.price}</span><div class="flex items-center gap-3"><button onclick="chgShopCount(${g.id}, -1)" class="w-6 h-6 rounded border text-zinc-500 flex items-center justify-center">-</button><span class="text-sm font-bold w-4 text-center">${c.count}</span><button onclick="chgShopCount(${g.id}, 1)" class="w-6 h-6 rounded border text-zinc-500 flex items-center justify-center">+</button></div></div></div></div>`; }).join(''); $('shop-cart-total').innerText = total.toFixed(2); }
    function chgShopCount(id, delta) { let item = shopCart.find(x => x.id === id); if(!item) return; item.count += delta; if(item.count <= 0) shopCart = shopCart.filter(x => x.id !== id); saveAll(); renderShopCart(); updateShopCartBadge(); }
    function clearShopCart() { if(confirm("æ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ")) { shopCart=[]; saveAll(); renderShopCart(); updateShopCartBadge(); } }

    function doShopCheckout() { if(shopCart.length === 0) return alert("è¯·å…ˆé€‰è´­å•†å“"); let total = parseFloat($('shop-cart-total').innerText); if (takeoutCtx.fromChat) { createShopCheckoutModal(total); } else { if(confirm(`ç¡®è®¤æ”¯ä»˜ Â¥${total} ä¸‹å•å—ï¼Ÿ`)) processShopSelfPay(total); } }
    function createShopCheckoutModal(total) {
        let roleName = curRole ? curRole.name : 'å¥½å‹'; let overlay = document.createElement('div'); overlay.className = "fixed inset-0 bg-black/50 z-[100] flex items-end";
        overlay.innerHTML = `<div class="bg-white w-full rounded-t-2xl p-6 animate-fade-in"><h3 class="text-lg font-bold mb-4 text-center">å•†åŸç»“ç®— Â¥${total.toFixed(2)}</h3><div class="space-y-3"><button onclick="handleShopPayOpt('self', ${total})" class="w-full py-3 bg-[#ff6700] text-white rounded-lg font-bold">è‡ªå·±æ”¯ä»˜</button><button onclick="handleShopPayOpt('friend', ${total})" class="w-full py-3 bg-white border border-[#ff6700] text-[#ff6700] rounded-lg font-bold flex items-center justify-center gap-2"><span>æ‰¾ ${roleName} ä»£ä»˜</span></button><button onclick="document.body.removeChild(this.parentNode.parentNode.parentNode)" class="w-full py-3 text-zinc-400">å–æ¶ˆ</button></div></div>`;
        document.body.appendChild(overlay); window.handleShopPayOpt = (type, amt) => { document.body.removeChild(overlay); if(type === 'self') processShopSelfPay(amt); if(type === 'friend') processShopFriendPay(amt); };
    }
    function processShopSelfPay(total) { if(balance < total) return alert(`ä½™é¢ä¸è¶³ (å½“å‰ Â¥${balance.toFixed(2)})`); balance -= total; createShopOrder(total, 'paid'); alert("æ”¯ä»˜æˆåŠŸï¼å®è´å°†å°½å¿«å‘è´§ã€‚"); saveAll(); openShopOrders('pending'); }
    function processShopFriendPay(total) {
        let firstItem = shopGoods.find(g => g.id === shopCart[0].id) || {name: "æœªçŸ¥å•†å“", img:""};
        let itemCount = shopCart.reduce((a,b)=>a+b.count,0);
        let payMsg = { r: 'u', type: 'pay_request', status: 'pending', total: total, itemDisplay: `[å•†åŸ] ${firstItem.name} ç­‰ ${itemCount} ä»¶`, img: firstItem.img, time: new Date().toLocaleString(), t: `[å•†åŸä»£ä»˜] Â¥${total}` };
        curRole.history.push(payMsg); saveAll(); createShopOrder(total, 'wait_pay'); go('pg-chat-room'); renderMsgs();
        setTimeout(() => triggerAiPayDecision(curRole.history.length - 1, total), 1500);
    }
    function createShopOrder(total, status) { let newOrder = { id: Date.now(), items: JSON.parse(JSON.stringify(shopCart)), total: total, time: Date.now(), status: status === 'paid' ? 'shipping' : 'pending_pay' }; shopOrders.unshift(newOrder); shopCart = []; saveAll(); }

    function openShopOrders(type) {
        go('pg-shop-orders'); let list = $('shop-order-list'); $('shop-order-title').innerText = type==='pending' ? 'å¾…æ”¶è´§' : 'å·²ä¹°åˆ°';
        let filtered = type==='pending' ? shopOrders.filter(o => o.status === 'shipping') : shopOrders.filter(o => o.status !== 'shipping' && o.status !== 'pending_pay');
        if(filtered.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— ç›¸å…³è®¢å•</div>`; return; }
        list.innerHTML = filtered.map(o => { let firstG = shopGoods.find(g => g.id === o.items[0].id) || {name:'æœªçŸ¥',store:''}; let count = o.items.reduce((a,b)=>a+b.count,0); let btn = o.status === 'shipping' ? `<button onclick="confirmShopRec(${o.id})" class="border border-[#ff6700] text-[#ff6700] px-3 py-1 rounded-full text-xs">ç¡®è®¤æ”¶è´§</button>` : `<span class="text-zinc-400 text-xs">äº¤æ˜“å®Œæˆ</span>`; return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-2"><b class="text-sm">${firstG.store}</b><span class="text-xs text-[#ff6700]">${o.status==='shipping'?'å•†å®¶å·²å‘è´§':'å·²å®Œæˆ'}</span></div><div class="flex gap-3 mb-2"><img src="${firstG.img}" class="w-16 h-16 rounded bg-zinc-50 object-contain"><div><div class="text-sm font-bold line-clamp-1">${firstG.name}</div><div class="text-xs text-zinc-400 mt-1">å…± ${count} ä»¶</div></div></div><div class="flex justify-between items-center border-t pt-2"><span class="font-bold">Â¥${o.total.toFixed(2)}</span>${btn}</div></div>`; }).join(''); }
    function confirmShopRec(oid) { let o = shopOrders.find(x=>x.id===oid); if(o){ o.status='completed'; saveAll(); openShopOrders('pending'); updateShopPendingBadge(); } }
    function updateShopPendingBadge() { let c = shopOrders.filter(o => o.status === 'shipping').length; let b = $('badge-shop-pending'); if(c>0){b.innerText=c;b.classList.remove('hidden');}else{b.classList.add('hidden');} }
    function renderFavs() { let list = $('shop-fav-list'); if(shopFavs.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">è¿˜æ²¡æœ‰æ”¶è—å•†å“</div>`; return; } list.innerHTML = shopFavs.map(id => { let g = shopGoods.find(x=>x.id===id); if(!g) return ''; return `<div onclick="showShopDetail(${g.id})" class="bg-white p-3 rounded-xl flex gap-3"><img src="${g.img}" class="w-20 h-20 rounded bg-zinc-50 object-contain"><div class="flex-1"><b class="text-sm">${g.name}</b><div class="mt-4 flex justify-between"><span class="text-[#ff6700] font-bold">Â¥${g.price}</span><span class="text-xs text-zinc-400">å·²æ”¶è—</span></div></div></div>`; }).join(''); }
    function saveNewGoods() { let s=$('sf-store').value, n=$('sf-name').value, p=parseFloat($('sf-price').value), i=$('sf-img').value; if(!s||!n||isNaN(p)) return alert("è¯·å¡«å†™å®Œæ•´"); shopGoods.push({id:Date.now(), store:s, name:n, price:p, sales:0, img:i||"https://img.icons8.com/color/480/box.png"}); saveAll(); alert("å‘å¸ƒæˆåŠŸ"); $('sf-name').value=''; go('pg-shop-me'); }

    // ================== 11. AI ä»£ä»˜ & æœ‹å‹åœˆäº’åŠ¨ (å¢å¼ºç‰ˆ) ==================
    async function triggerAiPayDecision(msgIdx, amount) {
        let msg = curRole.history[msgIdx];
        if (!msg || msg.type !== 'pay_request') { msg = curRole.history.findLast(m => m.type === 'pay_request' && m.status === 'pending'); }
        if (!msg || msg.status !== 'pending') return;
        
        let loadingMsg = { r: 'ai', t: '', loading: true }; curRole.history.push(loadingMsg); renderMsgs();
        let cfg = await getAICfg();
        
        let recentMsgs = curRole.history.slice(-15).filter(m => !m.loading && m.type === 'text').map(m => {
            let roleName = m.r === 'u' ? 'æˆ‘' : curRole.name; return `${roleName}: ${m.t}`;
        }).join('\n');

        let userMask = curRole.userMask || {}; let userName = userMask.name || "æˆ‘"; let userPersona = userMask.info || "æ™®é€šæœ‹å‹";

        let sysPrompt = `ä½ æ­£åœ¨è¿›è¡Œä¸€åœºå®Œå…¨æ²‰æµ¸å¼çš„è§’è‰²æ‰®æ¼”ã€‚\nã€ä½ çš„èº«ä»½ã€‘: ${curRole.name}\nã€ä½ çš„è®¾å®šã€‘: ${curRole.info}\nã€å¯¹æ‰‹æˆè§’è‰²ã€‘: ${userName} (è®¾å®š: ${userPersona})\n\nã€å½“å‰äº‹ä»¶ã€‘\n${userName} åˆšåˆšç»™ä½ å‘æ¥äº†ä¸€ä¸ªã€ä»£ä»˜è¯·æ±‚ã€‘ï¼Œé‡‘é¢æ˜¯ ${amount.toFixed(2)} å…ƒã€‚\n\nã€å†³ç­–é€»è¾‘ã€‘\n1. ç»“åˆä¸‹æ–¹çš„ã€è¿‘æœŸèŠå¤©å›é¡¾ã€‘ã€‚å¦‚æœåˆšæ‰èŠå¾—å¼€å¿ƒï¼Œå¯ä»¥åŒæ„ï¼›å¦‚æœåµæ¶æˆ–å…³ç³»ä¸€èˆ¬ï¼Œå¯ä»¥æ‹’ç»ã€‚\n2. ä¸¥ç¦å‡ºæˆï¼ä½ æ˜¯çœŸå®çš„äººï¼Œè¿™æ˜¯çœŸå®çš„é’±ã€‚**ç»å¯¹ç¦æ­¢**æåŠâ€œè™šæ‹Ÿâ€ã€â€œæ¸¸æˆå¸â€ã€â€œAIâ€ã€â€œæ¨¡æ‹Ÿâ€ã€‚\n3. å›å¤è¦ç®€çŸ­è‡ªç„¶ï¼Œå£è¯­åŒ–ã€‚\n\nã€è¿‘æœŸèŠå¤©å›é¡¾ã€‘\n${recentMsgs}\n(æ­¤å¤„å‘æ¥äº†ä»£ä»˜è¯·æ±‚)\n\nã€å›å¤æ ¼å¼ã€‘\nè¯·ä¸¥æ ¼æŒ‰æ­¤æ ¼å¼è¾“å‡ºï¼š\n[CMD:ACCEPT] ä½ çš„å›å¤å†…å®¹  (å¦‚åŒæ„)\n[CMD:REJECT] ä½ çš„å›å¤å†…å®¹  (å¦‚æ‹’ç»)`;

        let messages = [ { role: 'system', content: sysPrompt }, { role: 'user', content: "ï¼ˆç³»ç»Ÿæç¤ºï¼šè¯·ç«‹åˆ»åšå‡ºå†³ç­–å¹¶å›å¤ï¼Œä¿æŒäººè®¾ã€‚ï¼‰" } ];
        
        try {
            let replyContent = ""; let isAccept = false;
            if (cfg.key) {
                let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: messages }) });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                let data = await res.json(); 
                let raw = data.choices[0].message.content;
                if (raw.includes('[CMD:ACCEPT]')) { isAccept = true; replyContent = raw.replace('[CMD:ACCEPT]', '').trim(); } 
                else if (raw.includes('[CMD:REJECT]')) { isAccept = false; replyContent = raw.replace('[CMD:REJECT]', '').trim(); }
                else { isAccept = !raw.includes("ä¸") && !raw.includes("æ²¡é’±") && !raw.includes("æ‹’"); replyContent = raw; }
            } else { isAccept = Math.random() > 0.4; replyContent = isAccept ? "è¡Œå§ï¼Œè¿™æ¬¡è¯·ä½ åƒã€‚" : "è‡ªå·±ä»˜ï¼Œæˆ‘å¯æ²¡é’±ã€‚"; }
            
            curRole.history.pop(); 
            msg.status = isAccept ? 'paid' : 'rejected';
            
            let pendingFoodOrder = orders.find(o => o.status === 'pending_pay');
            if (pendingFoodOrder) { if (isAccept) pendingFoodOrder.status = 'delivering'; else pendingFoodOrder.status = 'cancelled'; }
            let pendingShopOrder = shopOrders.find(o => o.status === 'pending_pay');
            if (pendingShopOrder) { if (isAccept) pendingShopOrder.status = 'shipping'; else pendingShopOrder.status = 'cancelled'; }
            saveAll();

            if (!replyContent) replyContent = isAccept ? "å·²æ”¯ä»˜ã€‚" : "å·²æ‹’ç»ã€‚";
            curRole.history.push({ r: 'ai', t: replyContent, type: 'text' });
        } catch (e) { 
            console.error("Pay Error", e); curRole.history.pop(); msg.status = 'rejected'; 
            curRole.history.push({ r: 'ai', t: `(ç³»ç»Ÿ: å†³ç­–å¤±è´¥ï¼Œæ— æ³•æ”¯ä»˜)`, type: 'text' });
        } finally { saveAll(); renderMsgs(); }
    }
    
    function shareOrder(oid) {
        if (!curRole) return alert("è¯·å…ˆä»èŠå¤©ç•Œé¢è¿›å…¥"); let o = orders.find(x => x.id === oid); let firstItem = foods.find(f => f.id === o.items[0].id); let count = o.items.reduce((a,b)=>a+b.count,0);
        let shareMsg = { r: 'u', type: 'order_share', itemDisplay: `${firstItem.name} ç­‰`, count: count, img: firstItem.img, t: `[åˆ†äº«å¤–å–] ${firstItem.name}` };
        curRole.history.push(shareMsg); saveAll(); go('pg-chat-room'); renderMsgs(); setTimeout(() => triggerAiShareReaction(shareMsg), 1500);
    }
    async function triggerAiShareReaction(shareMsg) {
        let loadingMsg = { r: 'ai', t: '', loading: true }; curRole.history.push(loadingMsg); renderMsgs(); let cfg = await getAICfg();
        let sysPrompt = `ä½ æ˜¯${curRole.name}ã€‚\nã€å½“å‰äº‹ä»¶ã€‘ï¼šç”¨æˆ·ç»™ä½ åˆ†äº«äº†ä¸€ä¸ªå¤–å–é“¾æ¥ï¼Œåƒçš„æ˜¯ï¼š${shareMsg.itemDisplay}ã€‚\nã€ä½ çš„äººè®¾ã€‘ï¼š${curRole.info}ã€‚\nã€è¦æ±‚ã€‘ï¼šæ ¹æ®äººè®¾åšå‡ºååº”ã€‚ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼Œå£è¯­åŒ–ã€‚`;
        try {
            let replyContent = ""; if (cfg.key) { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }] }) }); if(!res.ok) throw new Error("API Error"); let data = await res.json(); replyContent = data.choices[0].message.content; } else { replyContent = "çœ‹ç€ä¸é”™ï¼(è¯·é…ç½®API Keyä»¥è§£é”äººè®¾å›å¤)"; }
            curRole.history.pop(); curRole.history.push({ r: 'ai', t: replyContent, type: 'text' });
        } catch (e) { console.error(e); curRole.history.pop(); } finally { saveAll(); renderMsgs(); }
    }
    function renderPendingOrders() { const list = $('order-pending-list'); let pending = orders.filter(o => o.status === 'delivering'); if(pending.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— è¿›è¡Œä¸­çš„è®¢å•</div>`; return; } list.innerHTML = pending.map(o => { let firstItem = foods.find(f => f.id === o.items[0].id) || {name: 'æœªçŸ¥å•†å“', store: 'æœªçŸ¥åº—é“º'}; let count = o.items.reduce((a,b)=>a+b.count, 0); return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-3 pb-2 border-b border-dashed"><b class="text-sm">${firstItem.store}</b><span class="text-xs text-[#FFD101] font-bold">éª‘æ‰‹èµ¶å¾€ä¸­...</span></div><div class="flex gap-3 mb-3"><img src="${firstItem.img}" class="w-16 h-16 rounded bg-zinc-100 object-cover"><div class="flex-1"><div class="text-sm font-bold">${firstItem.name} ç­‰</div><div class="text-xs text-zinc-500 mt-1">å…± ${count} ä»¶å•†å“</div></div><div class="flex flex-col items-end justify-center"><span class="font-bold">Â¥${o.total.toFixed(2)}</span></div></div><div class="flex justify-end"><button onclick="confirmReceipt(${o.id})" class="bg-[#FFD101] px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm">ç¡®è®¤æ”¶è´§</button></div></div>`; }).join(''); }
    function confirmReceipt(oid) { let o = orders.find(x => x.id === oid); if(o) { o.status = 'completed'; saveAll(); renderPendingOrders(); alert("å·²ç¡®è®¤æ”¶è´§ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´ï¼"); } }
    function renderAllOrders() { const list = $('order-history-list'); if(orders.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— å†å²è®¢å•</div>`; return; } list.innerHTML = orders.map(o => { let firstItem = foods.find(f => f.id === o.items[0].id) || {name: 'æœªçŸ¥', img: ''}; let statusText = o.status === 'delivering' ? 'è¿›è¡Œä¸­' : (o.status === 'pending_pay' ? 'å¾…ä»˜æ¬¾' : (o.status==='cancelled'?'å·²å–æ¶ˆ':'å·²å®Œæˆ')); let count = o.items.reduce((a,b)=>a+b.count,0); let shareBtn = takeoutCtx.fromChat ? `<button onclick="shareOrder(${o.id})" class="border border-blue-500 text-blue-500 px-3 py-1 rounded text-xs ml-2">åˆ†äº«ç»™TA</button>` : ''; return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-2"><b class="text-sm">${firstItem.store}</b><span class="text-xs text-zinc-400">${statusText}</span></div><div class="flex gap-3 items-center"><img src="${firstItem.img}" class="w-12 h-12 rounded bg-gray-100 object-cover"><div><div class="text-xs text-zinc-500">${firstItem.name} ç­‰ ${count} ä»¶</div><span class="font-bold text-sm">Â¥${o.total.toFixed(2)}</span></div></div><div class="mt-3 flex justify-end gap-2">${shareBtn}<button class="border border-zinc-200 px-3 py-1 rounded text-xs">è¯„ä»·</button></div></div>`; }).join(''); }
    function saveNewFood() { let s = $('tf-store').value; let n = $('tf-name').value; let p = parseFloat($('tf-price').value); let i = $('tf-img').value; if(!s || !n || isNaN(p)) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯"); foods.push({ id: Date.now(), store: s, name: n, price: p, sales: 0, img: i || "https://img.icons8.com/color/96/hamburger.png" }); saveAll(); alert("ä¸Šæ¶æˆåŠŸï¼"); $('tf-name').value = ''; go('pg-takeout-me'); }
    function updatePendingBadge() { let count = orders.filter(o => o.status === 'delivering').length; let b = $('badge-pending'); if(count > 0) { b.innerText = count; b.classList.remove('hidden'); } else { b.classList.add('hidden'); } }

    async function triggerAiReaction(mid, userContent) {
        let activeRoles = roles.filter(r => chats.includes(r.id)); if(activeRoles.length === 0) activeRoles = roles; if(activeRoles.length === 0) return;
        let selectedRoles = activeRoles.sort(() => 0.5 - Math.random()).slice(0, 2); let cfg = await getAICfg(); if(!cfg.key) return;
        for (let role of selectedRoles) { if(Math.random() > 0.5) continue; let prompt = `ç”¨æˆ·åœ¨æœ‹å‹åœˆå‘äº†ä¸€æ¡åŠ¨æ€ï¼šâ€œ${userContent}â€ã€‚ä½ æ˜¯${role.name}ï¼Œè¯·æ ¹æ®ä½ ä»¬çš„å…³ç³»åšå‡ºååº”ã€‚è¾“å‡ºæŒ‡ä»¤ï¼š\n- ç‚¹èµè¾“å‡º: [LIKE]\n- è¯„è®ºè¾“å‡º: [COMMENT:ä½ çš„è¯„è®ºå†…å®¹]\n- ç‚¹èµå¹¶è¯„è®º: [LIKE][COMMENT:...]\n- æ— ååº”: [IGNORE]\nä¸è¦è¾“å‡ºå…¶ä»–åˆ†æå†…å®¹ã€‚`; try { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] }) }); let data = await res.json(); let reply = data.choices[0].message.content; let m = mnts.find(x => x.id === mid); if(!m) return; if(reply.includes('[LIKE]')) { if(!m.likes) m.likes = []; if(!m.likes.includes(role.id)) m.likes.push(role.id); } let commMatch = reply.match(/\[COMMENT:(.*?)\]/); if(commMatch) { if(!m.comments) m.comments = []; m.comments.push({ uid: role.id, content: commMatch[1], time: Date.now() }); } saveAll(); if(curTab === 'moments') renderMnts(); } catch (e) { console.error("AI Reaction Error", e); } }
    }
    async function triggerAiReplyToComment(mid, userComment, replyToUid) {
        let m = mnts.find(x => x.id === mid); if (!m) return; let targetRole = null; let systemPrompt = "";
        if (replyToUid) { targetRole = roles.find(r => r.id === replyToUid); if (targetRole) { let prevComment = m.comments.findLast(c => c.uid === replyToUid && c.time < Date.now()); let prevContent = prevComment ? prevComment.content : "ï¼ˆæœªçŸ¥è¯„è®ºï¼‰"; systemPrompt = `æƒ…æ™¯ï¼šä½ åœ¨æœ‹å‹åœˆè¯„è®ºäº†ï¼šâ€œ${prevContent}â€ã€‚\nç”¨æˆ·å›å¤ä½ è¯´ï¼šâ€œ${userComment}â€ã€‚\nè¯·å›å¤ç”¨æˆ·ï¼Œä¿æŒè¿ç»­å¯¹è¯ã€‚ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼Œä¸è¦å¸¦åå­—å‰ç¼€ã€‚`; } } else if (m.r !== 'u') { targetRole = roles.find(r => r.id === m.r); if (targetRole) { systemPrompt = `æƒ…æ™¯ï¼šä½ å‘äº†ä¸€æ¡æœ‹å‹åœˆï¼šâ€œ${m.content}â€ã€‚\nä½ çš„å¥½å‹è¯„è®ºè¯´ï¼šâ€œ${userComment}â€ã€‚\nè¯·å›å¤ä»–ã€‚ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ã€‚`; } }
        if (targetRole && systemPrompt) { let cfg = await getAICfg(); if(!cfg.key) return; try { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: systemPrompt }] }) }); let data = await res.json(); let reply = data.choices[0].message.content.replace(/^["â€œ]|["â€]$/g, '').trim(); if(!m.comments) m.comments = []; m.comments.push({ uid: targetRole.id, content: reply, time: Date.now(), replyToName: "æˆ‘" }); saveAll(); if(curTab === 'moments') renderMnts(); } catch (e) { console.error("AI Reply Error", e); } }
    }
    
    function triggerRolePost(force = false) { if(!force) return; let r = roles[0]; if(!r) return; mnts.unshift({ id: Date.now(), r: r.id, content: `[${r.name}] æµ‹è¯•è‡ªåŠ¨å‘åœˆ`, img: "", time: Date.now(), likes:[], comments:[] }); saveAll(); renderMnts(); }
    function renderWallet() { $('wallet-num').innerText = parseFloat(balance).toFixed(2); }
    function walletOp(type) { let val = prompt(type === 'add' ? "è¯·è¾“å…¥å……å€¼é‡‘é¢" : "è¯·è¾“å…¥æç°é‡‘é¢"); if(val === null) return; let num = parseFloat(val); if(isNaN(num) || num <= 0) return alert("é‡‘é¢ä¸æ­£ç¡®"); if(type === 'add') { balance += num; alert(`æˆåŠŸå……å€¼ Â¥${num}`); } else { if(num > balance) return alert("ä½™é¢ä¸è¶³"); balance -= num; alert(`æˆåŠŸæç° Â¥${num}`); } saveAll(); renderWallet(); }
    function renderChatInfo() { if(!curRole) return; $('info-mask-status').innerText = (curRole.userMask && curRole.userMask.name) ? `å½“å‰: ${curRole.userMask.name}` : "é»˜è®¤"; }
    function loadMaskEdit() { if(!curRole) return; let m = curRole.userMask || {}; $('in-mask-n').value = m.name || ''; $('in-mask-a').value = m.ava || ''; $('in-mask-i').value = m.info || ''; }
    function saveMask() { if(!curRole) return; curRole.userMask = { name: $('in-mask-n').value, ava: $('in-mask-a').value, info: $('in-mask-i').value }; saveAll(); alert("é¢å…·å·²ä¿å­˜ï¼"); go('pg-chat-info'); }
    function closeAllMenus() { }

    // ================== 12. ç³»ç»Ÿå¯åŠ¨å…¥å£ (æ ¸å¿ƒ) ==================
    window.onload = async () => {
        try {
            console.log("System Launching...");
            // 1. åˆå§‹åŒ–æ•°æ®åº“
            await initDB();
            
            // 2. åŠ è½½æ•°æ®
            await loadAllData();
            
            // 3. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
            let rIds = roles.map(r => r.id);
            if (chats.some(cid => !rIds.includes(cid))) {
                chats = chats.filter(cid => rIds.includes(cid));
                await saveAll();
            }
            
            // 4. æ¸²æŸ“ç•Œé¢
            await renderProfile();
            await loadSettings();
            
            // 5. è¿›å…¥ä¸»ç•Œé¢
            tab('chat'); 
            
            console.log("AI OS Launched (IndexedDB Mode)");
        } catch (e) {
            console.error("Launch Error:", e);
            alert("ç³»ç»Ÿå¯åŠ¨å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚");
        }
    };
</script>
</body>
</html>
