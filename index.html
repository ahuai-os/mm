ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¸æ·®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* === åŸºç¡€ç³»ç»Ÿæ ·å¼ === */
        body { background: #f7f7f7; margin: 0; padding: 0; width: 100vw; height: 100vh; height: 100dvh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .phone { width: 100%; height: 100%; background: #f7f7f7; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; }
        .page { position: absolute; inset: 0; background: #f7f7f7; display: none; flex-direction: column; z-index: 10; }
        .active { display: flex !important; }
        #pg-home { background: url('https://img.heliar.top/file/1770365294783_IMG_20260206_160700.jpg') center top / cover no-repeat; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); padding-bottom: max(env(safe-area-inset-bottom), 15px); height: auto; min-height: 60px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); padding-bottom: max(env(safe-area-inset-bottom), 20px); }

        /* === èŠå¤©æ°”æ³¡æ ·å¼ === */
        .bubble { width: fit-content; max-width: 100%; word-wrap: break-word; white-space: pre-wrap; }
        .bubble-user { background: #95ec69; color: #000; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.6; position: relative; margin-right: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: left; }
        .bubble-user::after { content: ''; position: absolute; right: -5px; top: 12px; border-left: 5px solid #95ec69; border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
        .bubble-ai { background: #fff; color: #000; border: 1px solid #ededed; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.6; position: relative; margin-left: 6px; text-align: left; }
        .bubble-ai::after { content: ''; position: absolute; left: -5px; top: 12px; border-right: 5px solid #fff; border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
        
        /* === å°å‰§åœºä¸åŠ¨ç”» === */
        .story-text-container { background: rgba(255, 255, 255, 0.98); color: #1f1f1f; padding: 20px 24px; border-radius: 6px; font-family: "Songti SC", "SimSun", "STSong", "Times New Roman", serif !important; font-size: 18px; line-height: 1.9; text-align: justify; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .story-p { text-indent: 2em; margin-bottom: 1em; display: block; font-family: inherit; }
        .moment-cover { height: 320px; background-position: center; background-size: cover; position: relative; margin-bottom: 30px; }
        .drawer { transition: height 0.3s ease; height: 0; background: #f7f7f7; overflow: hidden; border-top: 1px solid #e5e5e5; }
        .drawer-open { height: 280px; } 
        .role-chip { transition: all 0.2s; border: 1px solid #ddd; background: white; color: #666; }
        .role-chip.selected { background: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 2px 4px rgba(59,130,246,0.3); }
        .dot-ani { display: flex; gap: 4px; padding: 4px 0; }
        .dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: dot-pulse 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .indent-8 { text-indent: 2em; }
        img { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }

        /* === å°å‰§åœºç›®å½• === */
        .catalog-drawer { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; opacity: 0; transition: opacity 0.3s; }
        .catalog-drawer.active { display: flex; opacity: 1; }
        .catalog-content { background: #fff; width: 80%; max-width: 300px; height: 100%; margin-left: auto; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .catalog-drawer.active .catalog-content { transform: translateX(0); }
        .chapter-item { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .chapter-item:active { background: #f9f9f9; }
        .chapter-item.active { background: #f0fdf4; color: #166534; font-weight: bold; }

        /* === å¤–å–ä¸å•†åŸæ ·å¼ === */
        .food-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.03); transition: transform 0.1s; }
        .food-card:active { transform: scale(0.98); }
        .food-img-box { width: 100%; aspect-ratio: 1/1; background: #f0f0f0; position: relative; flex-shrink: 0; }
        .food-img-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .cart-badge-ani { animation: pop-scale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-scale { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.3); } 100% { transform: scale(1); opacity: 1; } }
        .food-modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: flex; align-items: flex-end; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .food-modal-mask.active { opacity: 1; pointer-events: auto; }
        .food-modal-body { background: white; width: 100%; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); overflow: hidden; max-height: 85vh; display: flex; flex-direction: column; }
        .food-modal-mask.active .food-modal-body { transform: translateY(0); }
        /* === éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ === */
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin-slow { animation: spin-slow 15s linear infinite; }
        .spin-paused { animation-play-state: paused; }
        /* è‡ªå®šä¹‰è¿›åº¦æ¡ */
        input[type=range].music-range { -webkit-appearance: none; width: 100%; background: transparent; height: 4px; border-radius: 2px; }
        input[type=range].music-range::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer; margin-top: -4px; }
        input[type=range].music-range::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.3); border-radius: 2px; }
        /* === èŠå¤©å¡ç‰‡æ ·å¼ === */
        .msg-card { background: white; border-radius: 12px; padding: 12px; width: 240px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; overflow: hidden; border: 1px solid #eee; }
        .card-header-pay { background: #FFD101; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-header-pay-shop { background: #ff6700; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-header-share { background: #ff6b6b; height: 6px; position: absolute; top:0; left:0; width: 100%; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #333; display: flex; align-items: center; gap: 6px; }
        .card-content { display: flex; gap: 8px; align-items: center; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 10px; }
        .card-img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; background: #eee; }
        .card-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .card-price { font-size: 16px; font-weight: bold; color: #e64340; }
        .card-desc { font-size: 12px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
        .status-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: auto; }
        .st-pending { color: #f6a623; background: #fff7e6; }
        .st-paid { color: #52c41a; background: #f6ffed; }
        .st-rejected { color: #ff4d4f; background: #fff1f0; }
        .card-btn { width: 100%; text-align: center; font-size: 13px; padding: 6px 0; border-top: 1px solid #eee; color: #576b95; font-weight: 500; cursor: pointer; }
        .card-btn:active { background: #f5f5f5; }

        /* === å……å€¼é¡µé¢å…‰æ ‡åŠ¨ç”» === */
        @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .animate-pulse { animation: cursor-blink 1s step-end infinite; }
    </style>
</head>
<body>
<div class="phone">
    <div id="pg-home" class="page active">
        <div class="absolute right-8 top-16 text-right text-white font-extralight text-7xl select-none z-10" style="text-shadow: 0 2px 10px rgba(0,0,0,0.3);">09<br>41</div>
        <div class="absolute bottom-32 w-full flex flex-wrap justify-center gap-5 z-10 px-4">
            <div onclick="go('pg-wechat')" class="w-16 h-16 bg-[#07c160] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ’¬</div>
            <div onclick="toTakeoutTab('home'); go('pg-takeout-home')" class="w-16 h-16 bg-[#FFD101] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ¥¡</div>
            <div onclick="toShopTab('home'); go('pg-shop-home')" class="w-16 h-16 bg-[#ff6700] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ›ï¸</div>
            <div onclick="go('pg-wb')" class="w-16 h-16 bg-blue-500 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ“–</div>
            <div onclick="go('pg-memory')" class="w-16 h-16 bg-yellow-500 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ§ </div>
            <div onclick="go('pg-theater')" class="w-16 h-16 bg-purple-600 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ­</div>
            <div onclick="toBankTab('home'); go('pg-bank')" class="w-16 h-16 bg-gradient-to-br from-[#ff4b4b] to-[#e60012] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸ’³</div>
<div onclick="toMusicTab('player'); go('pg-music-player')" class="w-16 h-16 bg-gradient-to-br from-[#ff5a5f] to-[#ff4b8b] rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">ğŸµ</div>
            <div onclick="go('pg-set')" class="w-16 h-16 bg-zinc-700 rounded-2xl flex items-center justify-center text-4xl shadow-lg cursor-pointer hover:scale-105 transition-transform">âš™ï¸</div>
        </div>
    </div>

    <div id="pg-wechat" class="page">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0 z-20 relative">
            <span onclick="go('pg-home')" class="text-zinc-600 text-sm pb-1 cursor-pointer">é€€å‡º</span>
            <b id="we-title" class="pb-1 text-lg">å¾®ä¿¡</b>
            <div class="relative">
                <span onclick="handlePlusBtn(event)" class="text-2xl pb-1 cursor-pointer inline-block w-8 text-right">ï¼‹</span>
                
                                <div id="plus-dropdown" class="hidden absolute top-10 right-[-5px] bg-[#4c4c4c] text-white rounded-lg shadow-lg z-50 w-36 py-1">
                    <div class="absolute -top-1.5 right-3 w-0 h-0 border-l-[6px] border-r-[6px] border-b-[8px] border-l-transparent border-r-transparent border-b-[#4c4c4c]"></div>
                    <div onclick="openSingleChatSelector()" class="px-4 py-3 border-b border-[#5c5c5c] flex items-center gap-3 active:bg-[#5a5a5a] cursor-pointer">
                        <span class="text-lg">ğŸ’¬</span><span class="text-sm tracking-wide">å‘èµ·èŠå¤©</span>
                    </div>
                    <div onclick="openGroupChatSelector()" class="px-4 py-3 flex items-center gap-3 active:bg-[#5a5a5a] cursor-pointer">
                        <span class="text-lg">ğŸ‘¥</span><span class="text-sm tracking-wide">å‘èµ·ç¾¤èŠ</span>
                    </div>
                </div>
            </div>
        </header>
        <div class="flex-1 overflow-y-auto no-scrollbar relative" onclick="closeAllMenus()">
            <div id="sub-chat" class="bg-white divide-y"></div>
            <div id="sub-cont" class="hidden bg-white divide-y"></div>
            <div id="sub-moments" class="hidden bg-white h-full overflow-y-auto no-scrollbar">
                <div id="moment-bg" class="moment-cover" onclick="triggerRolePost(true)">
                    <div class="absolute -bottom-4 right-4 flex items-end gap-3">
                        <b class="text-white text-lg u-name shadow-sm font-bold mb-3 drop-shadow-md" style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></b>
                        <img class="w-20 h-20 rounded-xl u-ava border-2 border-white bg-zinc-100 shadow-md">
                    </div>
                </div>
                <div id="mnts-list" class="mt-16 p-0 pb-32"></div>
            </div>
            <div id="sub-me" class="hidden bg-zinc-100 h-full">
                <div onclick="go('pg-prof')" class="bg-white p-6 mt-4 flex items-center gap-4 active:bg-zinc-50 cursor-pointer">
                    <img class="w-16 h-16 rounded-lg u-ava bg-zinc-200">
                    <div class="flex flex-col"><b class="text-xl u-name"></b><span class="text-sm text-zinc-400">å¾®ä¿¡å·: AI_OS_User</span></div>
                </div>
                <div class="mt-4 bg-white divide-y">
                    <div onclick="go('pg-wallet')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><div class="flex items-center gap-3"><span class="text-green-600 text-xl font-bold">ğŸ’°</span><span>æ”¯ä»˜/é’±åŒ…</span></div><span class="text-zinc-300">ã€‰</span></div>
                </div>
                <div class="mt-4 bg-white divide-y">
                    <div onclick="go('pg-emj')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span>è¡¨æƒ…åŒ…ç®¡ç†</span><span class="text-zinc-300">ã€‰</span></div>
                </div>
                <div class="mt-8 p-4">
                    <button onclick="cleanBadData()" class="w-full py-3 bg-yellow-50 text-yellow-600 rounded-lg text-sm border border-yellow-200 font-bold mb-3">ğŸ› ï¸ æ·±åº¦æ¸…ç†åæ•°æ®</button>
                    <button onclick="hardReset()" class="w-full py-3 bg-red-50 text-red-500 rounded-lg text-sm border border-red-100">âš ï¸ æ ¼å¼åŒ–é‡ç½®</button>
                </div>
            </div>
        </div>
        <footer class="bg-[#f7f7f7] border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 shadow-lg">
            <div onclick="tab('chat')" id="t-chat" class="text-center flex-1 py-1">ğŸ’¬<br>å¾®ä¿¡</div>
            <div onclick="tab('cont')" id="t-cont" class="text-center flex-1 py-1">ğŸ‘¥<br>é€šè®¯å½•</div>
            <div onclick="tab('moments')" id="t-moments" class="text-center flex-1 py-1">ğŸ§­<br>æœ‹å‹åœˆ</div>
            <div onclick="tab('me')" id="t-me" class="text-center flex-1 py-1">ğŸ‘¤<br>æˆ‘</div>
        </footer>
    </div>
    <div id="pg-takeout-home" class="page bg-[#f5f5f5] z-[40]">
        <header class="bg-[#FFD101] p-3 pb-2 pt-12 rounded-b-xl shadow-sm sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div onclick="go('pg-home')" class="bg-white/20 p-1 rounded-full text-zinc-800 font-bold px-2 text-xs">âœ• é€€å‡º</div>
                <div class="flex-1 bg-white h-9 rounded-full flex items-center px-3 gap-2 relative">
                    <span class="text-zinc-400">ğŸ”</span>
                    <input id="takeout-search" oninput="handleSearchInput()" class="bg-transparent outline-none text-sm w-full" placeholder="æœç´¢ç‚¸é¸¡ã€å¥¶èŒ¶...">
                    <div id="btn-clear-search" onclick="clearSearch()" class="hidden w-5 h-5 bg-zinc-200 rounded-full flex items-center justify-center text-zinc-500 text-[10px] cursor-pointer">âœ•</div>
                </div>
            </div>
        </header>
        <div id="takeout-list" class="p-3 pb-24 grid grid-cols-2 gap-2 overflow-y-auto h-full"></div>
        <div id="food-detail-modal" class="food-modal-mask" onclick="if(event.target===this) closeFoodDetail()"><div class="food-modal-body"></div></div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div>
            <div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5 relative">ğŸ›’<span id="cart-badge" class="absolute -top-1 right-8 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span></div>è´­ç‰©è½¦</div>
            <div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-takeout-cart" class="page bg-[#f5f5f5] z-[40]">
        <header class="bg-white p-4 pt-12 border-b flex justify-between items-center sticky top-0 z-20"><b class="text-lg">è´­ç‰©è½¦</b><span onclick="clearCart()" class="text-sm text-zinc-500">æ¸…ç©º</span></header>
        <div class="bg-red-50 text-red-500 text-xs px-4 py-2 flex justify-between items-center"><span>ğŸ”¥ æ»¡20å‡3ï¼Œæ»¡50å‡8</span><span class="text-red-400">å»å‡‘å• ></span></div>
        <div id="cart-list" class="p-4 pb-32 space-y-3 overflow-y-auto h-full"></div>
        <div class="absolute bottom-14 w-full bg-white border-t p-3 flex justify-between items-center z-30 pb-safe">
            <div class="flex items-baseline gap-1"><span class="text-xs text-zinc-500">åˆè®¡:</span><span class="text-red-500 font-bold text-lg">Â¥<span id="cart-total">0.00</span></span></div>
            <button onclick="doCheckout()" class="bg-[#FFD101] text-black px-8 py-2.5 rounded-full font-bold shadow-md active:scale-95 transition-transform">å»ç»“ç®—</button>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div><div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-takeout-me" class="page bg-[#f5f5f5] z-[40]">
        <div class="bg-[#FFD101] pt-14 pb-10 px-6 flex items-center gap-4 rounded-b-[30px]"><img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white"><div><b class="u-name text-xl block text-[#1f1f1f]"></b><span class="text-xs bg-black/10 px-2 py-0.5 rounded text-[#1f1f1f]">é»„é‡‘ä¼šå‘˜ ğŸ’</span></div></div>
        <div class="mx-4 -mt-6 bg-white rounded-xl shadow-sm p-4 grid grid-cols-3 gap-4 text-center relative z-10">
            <div onclick="go('pg-takeout-orders')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-xl">ğŸ“„</div><span class="text-xs font-bold text-zinc-700">å…¨éƒ¨è®¢å•</span></div>
            <div onclick="go('pg-takeout-pending')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center text-xl">ğŸ›µ</div><span class="text-xs font-bold text-zinc-700">å¾…æ”¶è´§</span><div id="badge-pending" class="absolute top-3 left-[45%] bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</div></div>
            <div onclick="go('pg-takeout-add')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-xl">â•</div><span class="text-xs font-bold text-zinc-700">æ·»åŠ å•†å“</span></div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toTakeoutTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ¥¡</div>é¦–é¡µ</div><div onclick="toTakeoutTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toTakeoutTab('me')" class="text-center flex-1 py-1 cursor-pointer text-zinc-800 font-bold"><div class="text-xl mb-0.5">ğŸ™‚</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-takeout-orders" class="page bg-[#f5f5f5] z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">æˆ‘çš„è®¢å•</b></header><div id="order-history-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div></div>
    <div id="pg-takeout-pending" class="page bg-[#f5f5f5] z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">å¾…æ”¶è´§</b></header><div id="order-pending-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div></div>
    <div id="pg-takeout-add" class="page bg-white z-[50]"><header class="bg-white h-12 flex items-center px-4 border-b"><span onclick="go('pg-takeout-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">ä¸Šæ¶æ–°å¤–å–</b><button onclick="saveNewFood()" class="ml-auto text-[#FFD101] font-bold text-sm bg-black px-3 py-1 rounded-full">ä¸Šæ¶</button></header><div class="p-6 space-y-5"><div><label class="block text-xs font-bold text-zinc-500 mb-1">åº—é“ºåç§°</label><input id="tf-store" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: éº¦å½“åŠ³"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">å•†å“åç§°</label><input id="tf-name" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: åŒå±‚å‰å£«æ±‰å ¡"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">ä»·æ ¼ (Â¥)</label><input id="tf-price" type="number" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="25.5"></div><div><label class="block text-xs font-bold text-zinc-500 mb-1">å›¾ç‰‡é“¾æ¥</label><input id="tf-img" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="http://..."></div></div></div>

    <div id="pg-shop-home" class="page bg-[#f2f2f2] z-[40]">
        <header class="bg-[#ff6700] p-3 pb-2 pt-12 rounded-b-xl shadow-sm sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div onclick="go('pg-home')" class="bg-white/20 p-1 rounded-full text-white font-bold px-2 text-xs">âœ• é€€å‡º</div>
                <div class="flex-1 bg-white h-9 rounded-full flex items-center px-3 gap-2 relative">
                    <span class="text-zinc-400">ğŸ”</span>
                    <input id="shop-search" oninput="handleShopSearch()" class="bg-transparent outline-none text-sm w-full" placeholder="æœå¥½ç‰©...">
                    <div id="btn-shop-clear" onclick="clearShopSearch()" class="hidden w-5 h-5 bg-zinc-200 rounded-full flex items-center justify-center text-zinc-500 text-[10px] cursor-pointer">âœ•</div>
                </div>
            </div>
        </header>
        <div id="shop-list" class="p-3 pb-24 grid grid-cols-2 gap-2 overflow-y-auto h-full"></div>
        <div id="shop-detail-modal" class="food-modal-mask" onclick="if(event.target===this) closeShopDetail()"><div class="food-modal-body"></div></div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div>
            <div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5 relative">ğŸ›’<span id="shop-cart-badge" class="absolute -top-1 right-8 bg-[#ff6700] text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span></div>è´­ç‰©è½¦</div>
            <div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-shop-cart" class="page bg-[#f2f2f2] z-[40]">
        <header class="bg-white p-4 pt-12 border-b flex justify-between items-center sticky top-0 z-20"><b class="text-lg">è´­ç‰©è½¦</b><span onclick="clearShopCart()" class="text-sm text-zinc-500">æ¸…ç©º</span></header>
        <div id="shop-cart-list" class="p-4 pb-32 space-y-3 overflow-y-auto h-full"></div>
        <div class="absolute bottom-14 w-full bg-white border-t p-3 flex justify-between items-center z-30 pb-safe">
            <div class="flex items-baseline gap-1"><span class="text-xs text-zinc-500">åˆè®¡:</span><span class="text-[#ff6700] font-bold text-lg">Â¥<span id="shop-cart-total">0.00</span></span></div>
            <button onclick="doShopCheckout()" class="bg-gradient-to-r from-[#ff9000] to-[#ff5000] text-white px-8 py-2.5 rounded-full font-bold shadow-md active:scale-95 transition-transform">ç«‹å³è´­ä¹°</button>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div><div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-shop-me" class="page bg-[#f2f2f2] z-[40]">
        <div class="bg-gradient-to-r from-[#ff9000] to-[#ff5000] pt-14 pb-10 px-6 flex items-center gap-4 rounded-b-[30px]"><img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white"><div><b class="u-name text-xl block text-white"></b><span class="text-xs bg-white/20 px-2 py-0.5 rounded text-white">æ·˜æ°”å€¼ 1000</span></div></div>
        <div class="mx-4 -mt-6 bg-white rounded-xl shadow-sm p-4 grid grid-cols-4 gap-2 text-center relative z-10">
            <div onclick="go('pg-shop-favs')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">â­</div><span class="text-xs font-bold text-zinc-700">æ”¶è—å¤¹</span></div>
            <div onclick="openShopOrders('pending')" class="flex flex-col items-center gap-2 active:opacity-50 relative"><div class="text-xl">ğŸ“¦</div><span class="text-xs font-bold text-zinc-700">å¾…æ”¶è´§</span><div id="badge-shop-pending" class="absolute top-0 right-4 bg-[#ff6700] text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</div></div>
            <div onclick="openShopOrders('history')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">ğŸ“œ</div><span class="text-xs font-bold text-zinc-700">å·²ä¹°åˆ°</span></div>
            <div onclick="go('pg-shop-add')" class="flex flex-col items-center gap-2 active:opacity-50"><div class="text-xl">â•</div><span class="text-xs font-bold text-zinc-700">æ·»åŠ </span></div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14"><div onclick="toShopTab('home')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›ï¸</div>é¦–é¡µ</div><div onclick="toShopTab('cart')" class="text-center flex-1 py-1 cursor-pointer"><div class="text-xl mb-0.5">ğŸ›’</div>è´­ç‰©è½¦</div><div onclick="toShopTab('me')" class="text-center flex-1 py-1 cursor-pointer text-[#ff6700] font-bold"><div class="text-xl mb-0.5">ğŸ˜</div>æˆ‘çš„</div></footer>
    </div>
    <div id="pg-shop-orders" class="page bg-[#f2f2f2] z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base" id="shop-order-title">æˆ‘çš„è®¢å•</b></header>
        <div id="shop-order-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div>
    </div>
    <div id="pg-shop-favs" class="page bg-[#f2f2f2] z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b sticky top-0"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">æˆ‘çš„æ”¶è—</b></header>
        <div id="shop-fav-list" class="p-3 space-y-3 overflow-y-auto h-full pb-20"></div>
    </div>
    <div id="pg-shop-add" class="page bg-white z-[50]">
        <header class="bg-white h-12 flex items-center px-4 border-b"><span onclick="go('pg-shop-me')" class="text-zinc-500 text-lg mr-4">ã€ˆ</span><b class="text-base">å‘å¸ƒæ–°å•†å“</b><button onclick="saveNewGoods()" class="ml-auto text-white font-bold text-sm bg-[#ff6700] px-3 py-1 rounded-full">å‘å¸ƒ</button></header>
        <div class="p-6 space-y-5">
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">åº—é“ºåç§°</label><input id="sf-store" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: ä¼˜è¡£åº“æ——èˆ°åº—"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å•†å“åç§°</label><input id="sf-name" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="ä¾‹å¦‚: çº¯æ£‰Tæ¤"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">ä»·æ ¼ (Â¥)</label><input id="sf-price" type="number" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="99.00"></div>
            <div><label class="block text-xs font-bold text-zinc-500 mb-1">å›¾ç‰‡é“¾æ¥</label><input id="sf-img" class="w-full bg-zinc-50 p-3 rounded-lg border-none outline-none" placeholder="http://..."></div>
        </div>
    </div>

    <div id="pg-bank" class="page bg-[#f5f5f5] z-[40]">
        <div id="bank-tab-home" class="flex-1 flex flex-col h-full overflow-y-auto no-scrollbar">
            <header class="bg-gradient-to-b from-[#e60012] to-[#f03b42] p-4 pt-12 pb-8 flex flex-col shrink-0 text-white rounded-b-3xl">
                <div class="flex justify-between items-center mb-4">
                    <span onclick="go('pg-home')" class="text-white text-xs bg-black/20 px-3 py-1.5 rounded-full cursor-pointer">âœ• é€€å‡º</span>
                    <span class="font-bold text-lg tracking-wider">ä¸€å¡é€š</span>
                    <span class="text-xl">ğŸ§</span>
                </div>
            </header>
            <div class="bg-white mx-4 -mt-6 rounded-xl shadow-sm p-4 grid grid-cols-4 gap-y-5 text-center relative z-10">
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-red-50 w-10 h-10 flex items-center justify-center rounded-full text-red-500">ğŸ’°</div><span class="text-[11px] text-zinc-700 font-bold">æœæœå®</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-blue-50 w-10 h-10 flex items-center justify-center rounded-full text-blue-500">Â¥</div><span class="text-[11px] text-zinc-700 font-bold">å€Ÿé’±</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-orange-50 w-10 h-10 flex items-center justify-center rounded-full text-orange-500">ğŸ”</div><span class="text-[11px] text-zinc-700 font-bold">è½¬è´¦</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl bg-green-50 w-10 h-10 flex items-center justify-center rounded-full text-green-500">ğŸ‘ï¸</div><span class="text-[11px] text-zinc-700 font-bold">è´¦æˆ·æ€»è§ˆ</span></div>
                
                <div onclick="simulateBankIncome()" class="flex flex-col items-center gap-1.5 cursor-pointer active:opacity-50"><div class="text-2xl">ğŸ’³</div><span class="text-[11px] text-[#e60012] font-bold">é“¶è¡Œå¡å…¥è´¦</span></div>
                <div onclick="renderBankRecords(); go('pg-bank-records')" class="flex flex-col items-center gap-1.5 cursor-pointer active:opacity-50"><div class="text-2xl">ğŸ§¾</div><span class="text-[11px] text-zinc-800 font-bold">æ”¶æ”¯æ˜ç»†</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl">â­</div><span class="text-[11px] text-zinc-700">ç†è´¢</span></div>
                <div class="flex flex-col items-center gap-1.5"><div class="text-2xl text-zinc-400">â€¢â€¢â€¢</div><span class="text-[11px] text-zinc-700">å…¨éƒ¨</span></div>
            </div>
            <div class="mx-4 mt-4 bg-white rounded-xl p-4 shadow-sm">
                <b class="text-sm border-l-4 border-[#e60012] pl-2 block mb-3">è´¢å¯Œç²¾é€‰</b>
                <div class="flex justify-between items-center bg-red-50/50 p-3 rounded-lg border border-red-50">
                    <div>
                        <div class="text-[#e60012] font-bold text-lg">0.45%</div>
                        <div class="text-xs text-zinc-400 mt-1">å½“å‰å¹´åˆ©ç‡</div>
                    </div>
                    <div class="text-xs text-zinc-500 space-y-1"><p>âœ… å½“æ—¥èµ·æ¯</p><p>âœ… æœ¬é‡‘æœ‰ä¿éšœ</p></div>
                    <button class="bg-[#e60012] text-white px-4 py-1.5 rounded-full text-xs font-bold">å»çœ‹çœ‹</button>
                </div>
            </div>
        </div>
        
        <div id="bank-tab-me" class="flex-1 flex flex-col h-full overflow-y-auto no-scrollbar hidden bg-[#f5f5f5]">
            <div class="bg-gradient-to-b from-[#fdeeee] to-[#f5f5f5] pt-14 pb-4 px-6 flex items-center gap-4 shrink-0">
                <img class="u-ava w-16 h-16 rounded-full border-2 border-white bg-white shadow-sm">
                <div><b class="u-name text-xl text-zinc-900 block mb-1"></b></div>
            </div>
            <div class="px-4 space-y-3 pb-24">
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <div class="flex justify-between items-center mb-5 border-b border-zinc-50 pb-3">
                        <b class="text-base text-zinc-800">è´¦æˆ·æ€»è§ˆ ğŸ‘ï¸</b>
                    </div>
                    <div class="flex justify-between items-end">
                        <div><div class="text-xs text-zinc-400 mb-1">æ€»èµ„äº§</div><div id="bank-total-assets" class="text-2xl font-bold text-zinc-900">Â¥ 0.00</div></div>
                        <div class="text-right"><div class="text-xs text-zinc-400 mb-1">æ˜¨æ—¥æ”¶ç›Š</div><div class="text-base font-bold text-[#e60012]">+0.00</div></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <b class="text-base text-zinc-800 mb-5 block">æœ¬æœˆæ”¶æ”¯</b>
                    <div class="flex justify-between items-end">
                        <div><div class="text-xs text-zinc-400 mb-1">æ”¯å‡º</div><div id="bank-month-expense" class="text-xl font-bold text-zinc-900">Â¥ 0.00</div></div>
                        <div class="text-right"><div class="text-xs text-zinc-400 mb-1">æ”¶å…¥</div><div id="bank-month-income" class="text-xl font-bold text-[#e60012]">Â¥ 0.00</div></div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="bg-white border-t flex justify-around items-center text-[10px] text-zinc-400 shrink-0 safe-area-pb z-30 fixed bottom-0 w-full h-14">
            <div onclick="toBankTab('home')" id="nav-bank-home" class="text-center flex-1 py-1 cursor-pointer text-[#e60012] font-bold"><div class="text-xl mb-0.5">ğŸ </div>é¦–é¡µ</div>
            <div onclick="toBankTab('me')" id="nav-bank-me" class="text-center flex-1 py-1 cursor-pointer text-zinc-400"><div class="text-xl mb-0.5">ğŸ‘¤</div>æˆ‘çš„</div>
        </footer>
    </div>
    <div id="pg-bank-records" class="page bg-[#f5f5f5] z-[50]">
        <header class="bg-white h-14 flex items-end px-4 pb-3 border-b sticky top-0"><span onclick="go('pg-bank')" class="text-zinc-500 text-lg mr-4 cursor-pointer">ã€ˆ</span><b class="text-lg">æ”¶æ”¯æ˜ç»†</b></header>
        <div id="bank-records-list" class="p-3 space-y-2 overflow-y-auto h-full pb-20"></div>
    </div>

    <div id="pg-wallet" class="page bg-gray-50 z-[60]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0"><span onclick="go('pg-wechat')" class="text-zinc-700 text-lg cursor-pointer">ã€ˆ</span><span class="text-zinc-700 text-sm mb-1 cursor-pointer">é›¶é’±æ˜ç»†</span></header>
        <div class="flex flex-col items-center pt-16 px-6">
            <div class="w-20 h-20 bg-[#fbbd08] rounded-full flex items-center justify-center mb-8"><span class="text-white text-5xl font-bold">Â¥</span></div>
            <div class="text-zinc-800 text-lg mb-2">æˆ‘çš„é›¶é’±</div>
            <div class="text-4xl font-bold mb-16 flex items-baseline"><span class="text-2xl mr-1">Â¥</span><span id="wallet-num">0.00</span></div>
            <button onclick="walletOp('add')" class="w-full bg-[#07c160] text-white py-3 rounded-lg font-bold text-lg mb-4 active:bg-[#06ad56]">å……å€¼</button>
            <button onclick="walletOp('sub')" class="w-full bg-white text-zinc-800 py-3 rounded-lg font-bold text-lg border border-zinc-300 active:bg-gray-50">æç°</button>
        </div>
    </div>
    <div id="pg-recharge" class="page bg-[#ededed] z-[70] flex flex-col">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-4 shrink-0 relative">
            <span onclick="go('pg-wallet')" class="text-2xl text-zinc-700 font-light cursor-pointer leading-none pb-1">âœ•</span>
            <b class="text-lg absolute left-1/2 -translate-x-1/2 pb-1">å……å€¼</b>
            <div class="w-8"></div>
        </header>
        <div class="flex-1 p-6">
            <div class="bg-white p-4 rounded-xl flex justify-between items-center mb-6 active:bg-zinc-50">
                <div class="flex items-center gap-3">
                    <span class="text-zinc-500 text-sm">å……å€¼æ–¹å¼</span>
                    <span class="text-green-600 font-bold ml-1 text-lg">ğŸ’³</span>
                    <span class="font-bold text-[#1f1f1f] text-sm">å‚¨è“„å¡ / é›¶é’±é€š</span>
                </div>
                <span class="text-zinc-300">ã€‰</span>
            </div>
            <div class="bg-white p-6 rounded-xl">
                <div class="text-sm text-zinc-500 mb-4">å……å€¼é‡‘é¢</div>
                <div class="flex items-baseline border-b border-zinc-200 pb-2" onclick="focusRechargeInput()">
                    <span class="text-3xl font-bold mr-2">Â¥</span>
                    <span id="recharge-amount-display" class="text-5xl font-bold"></span>
                    <span id="recharge-cursor" class="text-4xl font-light text-[#07c160] animate-pulse ml-1">|</span>
                </div>
            </div>
        </div>
        <div class="bg-[#f7f7f7] shrink-0 safe-area-pb">
            <div class="grid grid-cols-4 bg-[#dadada] gap-[1px] p-[1px]">
                <button onclick="handleRechargeInput('1')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">1</button>
                <button onclick="handleRechargeInput('2')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">2</button>
                <button onclick="handleRechargeInput('3')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">3</button>
                <button onclick="handleRechargeInput('del')" class="bg-white py-5 flex items-center justify-center active:bg-zinc-100 text-xl row-span-2">âŒ«</button>
                <button onclick="handleRechargeInput('4')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">4</button>
                <button onclick="handleRechargeInput('5')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">5</button>
                <button onclick="handleRechargeInput('6')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">6</button>
                <button onclick="handleRechargeInput('7')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">7</button>
                <button onclick="handleRechargeInput('8')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">8</button>
                <button onclick="handleRechargeInput('9')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">9</button>
                <button id="btn-recharge-confirm" onclick="confirmRecharge()" class="bg-[#07c160] text-white font-bold text-lg active:bg-[#06ad56] row-span-2 opacity-40 pointer-events-none flex items-center justify-center transition-opacity">ç¡®å®š</button>
                <button class="bg-[#f7f7f7] py-5 text-xl font-bold pointer-events-none"></button>
                <button onclick="handleRechargeInput('0')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">0</button>
                <button onclick="handleRechargeInput('.')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">.</button>
            </div>
        </div>
    </div>
    <div id="pg-withdraw" class="page bg-[#ededed] z-[70] flex flex-col">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-4 shrink-0 relative">
            <span onclick="go('pg-wallet')" class="text-2xl text-zinc-700 font-light cursor-pointer leading-none pb-1">âœ•</span>
            <b class="text-lg absolute left-1/2 -translate-x-1/2 pb-1">é›¶é’±æç°</b>
            <span class="text-lg text-zinc-600 font-bold pb-1 tracking-widest">Â·Â·Â·</span>
        </header>
        <div class="flex-1 p-6">
            <div class="bg-[#fcfcfc] rounded-xl flex flex-col mb-6 shadow-sm">
                <div class="flex justify-between items-center p-5 bg-[#f8f8f8] rounded-t-xl border-b border-zinc-100">
                    <span class="text-zinc-500 text-sm">åˆ°è´¦é“¶è¡Œå¡</span>
                    <div class="flex flex-col items-end">
                        <div class="flex items-center gap-2"><span class="text-green-600 font-bold text-sm bg-green-100 w-5 h-5 flex items-center justify-center rounded-full">â—</span><span class="text-[#576b95] text-sm font-bold">å‚¨è“„å¡ (2524)</span><span class="text-zinc-300 ml-1">ã€‰</span></div>
                        <span class="text-[10px] text-zinc-400 mt-1">2å°æ—¶å†…åˆ°è´¦</span>
                    </div>
                </div>
                <div class="p-6 pt-5">
                    <div class="text-sm text-zinc-800 mb-4 font-bold">æç°é‡‘é¢</div>
                    <div class="flex items-baseline border-b border-zinc-200 pb-2" onclick="focusWithdrawInput()">
                        <span class="text-4xl font-bold mr-2">Â¥</span>
                        <span id="withdraw-amount-display" class="text-5xl font-bold"></span>
                        <span id="withdraw-cursor" class="text-4xl font-light text-[#07c160] animate-pulse ml-1">|</span>
                    </div>
                    <div class="mt-4 text-xs text-zinc-400 flex items-center">
                        å½“å‰é›¶é’±ä½™é¢ <span id="withdraw-max-text" class="mx-1 font-bold text-zinc-600">0.00</span> å…ƒï¼Œ
                        <span onclick="withdrawAll()" class="text-[#576b95] ml-1 cursor-pointer font-bold">å…¨éƒ¨æç°</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-[#f7f7f7] shrink-0 safe-area-pb">
            <div class="grid grid-cols-4 bg-[#dadada] gap-[1px] p-[1px]">
                <button onclick="handleWithdrawInput('1')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">1</button>
                <button onclick="handleWithdrawInput('2')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">2</button>
                <button onclick="handleWithdrawInput('3')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">3</button>
                <button onclick="handleWithdrawInput('del')" class="bg-white py-5 flex items-center justify-center active:bg-zinc-100 text-xl row-span-2">âŒ«</button>
                <button onclick="handleWithdrawInput('4')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">4</button>
                <button onclick="handleWithdrawInput('5')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">5</button>
                <button onclick="handleWithdrawInput('6')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">6</button>
                <button onclick="handleWithdrawInput('7')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">7</button>
                <button onclick="handleWithdrawInput('8')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">8</button>
                <button onclick="handleWithdrawInput('9')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">9</button>
                <button id="btn-withdraw-confirm" onclick="confirmWithdraw()" class="bg-[#07c160] text-white font-bold text-lg active:bg-[#06ad56] row-span-2 opacity-40 pointer-events-none flex items-center justify-center transition-opacity">æç°</button>
                <button class="bg-[#f7f7f7] py-5 text-xl font-bold pointer-events-none"></button>
                <button onclick="handleWithdrawInput('0')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">0</button>
                <button onclick="handleWithdrawInput('.')" class="bg-white py-5 text-xl font-bold active:bg-zinc-100">.</button>
            </div>
        </div>
    </div>
    <div id="pg-transfer-detail" class="page z-[80] bg-[#191919] text-white flex flex-col items-center">
        <header class="w-full h-16 flex items-end justify-between p-4 shrink-0"><span onclick="go('pg-chat-room')" class="text-white text-lg cursor-pointer">ã€ˆ</span><span class="mb-1 text-sm font-light opacity-80">äº¤æ˜“è¯¦æƒ…</span><div class="w-4"></div></header>
        <div class="mt-10 flex flex-col items-center w-full px-8 animate-fade-in">
            <div class="mb-4 text-[#f79c4a] text-6xl"><div class="w-24 h-24 rounded-full border-4 border-[#f79c4a] flex items-center justify-center mx-auto mb-4"><span id="tx-icon">â³</span></div></div>
            <div id="tx-status" class="text-xl mb-2 text-[#f79c4a]">å¾…æ”¶æ¬¾</div>
            <div class="text-5xl font-bold mb-10 flex items-baseline"><span class="text-3xl mr-2">Â¥</span><span id="tx-amount">0.00</span></div>
            <button id="btn-tx-receive" onclick="doReceiveTransfer()" class="w-2/3 bg-[#07c160] text-white py-4 rounded-lg font-bold text-lg mb-6 active:scale-95 transition-transform shadow-lg hidden">ç¡®è®¤æ”¶æ¬¾</button>
            <div id="link-tx-return" class="text-sm text-zinc-500 mt-auto mb-8 hidden">1å¤©å†…æœªç¡®è®¤ï¼Œå°†é€€è¿˜ç»™å¯¹æ–¹ã€‚<span onclick="doReturnTransfer()" class="text-[#576b95] cursor-pointer ml-1">ç«‹å³é€€è¿˜</span></div>
            <div id="tx-info-box" class="hidden text-zinc-500 text-sm mt-4 text-center space-y-2"><p>è½¬è´¦æ—¶é—´: <span id="tx-time"></span></p><p>æ”¶é’±æ—¶é—´: <span id="tx-time-rcv">--</span></p></div>
        </div>
    </div>

    <div id="pg-theater" class="page bg-zinc-50 z-[50]">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0 sticky top-0 z-20"><button onclick="go('pg-home')" class="text-zinc-600 pb-1 w-10 text-left">ğŸ </button><b class="pb-1 text-lg">æˆ‘çš„å‰§åœº</b><button onclick="go('pg-theater-create')" class="text-blue-600 font-bold pb-1 text-sm w-10 text-right">æ–°å»º</button></header>
        <div id="theater-list" class="p-4 space-y-3 overflow-y-auto pb-20 no-scrollbar"></div>
    </div>
    <div id="pg-theater-create" class="page bg-white z-[60]">
        <header class="h-14 flex items-end justify-between p-3 border-b shrink-0"><button onclick="go('pg-theater')" class="text-zinc-600 pb-1">å–æ¶ˆ</button><b class="pb-1 text-lg">æ–°å»ºå‰§æœ¬</b><button onclick="startTheaterGen()" id="btn-create-th" class="bg-[#07c160] text-white px-3 py-1 rounded text-sm font-bold mb-0.5 shadow-sm">å¼€å§‹ç”Ÿæˆ</button></header>
        <div class="p-5 space-y-5 overflow-y-auto h-full pb-20">
            <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-600 leading-5">ğŸ’¡ æç¤ºï¼šé€‰æ‹©ä¸€ä¸ªå·²æœ‰äººç‰©ï¼Œè®¾å®šèº«ä»½ï¼ŒAIå°†ä¸ºä½ ç”Ÿæˆä¸“å±äº’åŠ¨å°è¯´ã€‚</div>
            <div><label class="block text-sm font-bold text-zinc-800 mb-2">1. é€‰æ‹©è§’è‰²</label><select id="th-role-sel" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none"></select></div>
            <div class="flex gap-3"><div class="flex-1"><label class="block text-sm font-bold text-zinc-800 mb-2">2. ä»–çš„èº«ä»½</label><input id="th-role-job" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none" placeholder="ä¾‹: å‚²å¨‡åŒ»ç”Ÿ"></div><div class="flex-1"><label class="block text-sm font-bold text-zinc-800 mb-2">3. æˆ‘çš„èº«ä»½</label><input id="th-user-job" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none" placeholder="ä¾‹: ç¬¨è›‹æ‚£è€…"></div></div>
            <div><label class="block text-sm font-bold text-zinc-800 mb-2">4. å‰§æƒ…æ¢—æ¦‚</label><textarea id="th-prompt" class="w-full h-32 p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none resize-none text-sm leading-relaxed" placeholder="è¯·è¾“å…¥æ•…äº‹èƒŒæ™¯ã€‚ä¾‹å¦‚ï¼šæˆ‘åœ¨åŒ»é™¢æŒ‚é”™å·é‡åˆ°äº†ä»–..."></textarea></div>
            <div><label class="block text-sm font-bold text-zinc-800 mb-2">5. ç›®æ ‡å­—æ•°</label><input id="th-len" type="number" class="w-full p-3 border border-zinc-200 rounded-xl bg-zinc-50 outline-none" placeholder="20000" value="20000"></div>
        </div>
    </div>
    <div id="pg-theater-read" class="page bg-[#f8f1e5] z-[70]">
        <header class="h-14 bg-[#f8f1e5] flex items-end justify-between p-3 border-b border-[#eaddcf] shrink-0 sticky top-0 z-20 shadow-sm"><button onclick="go('pg-theater')" class="text-[#8c7b6c] pb-1 font-medium">ã€ˆ ä¹¦æ¶</button><b id="th-read-title" class="pb-1 text-[#5c4b3c] text-lg overflow-hidden whitespace-nowrap text-ellipsis max-w-[50%]"></b><button onclick="deleteTheater()" class="text-red-400 text-xs pb-1 px-2">åˆ é™¤</button></header>
        <div id="th-read-content" class="p-6 overflow-y-auto h-full pb-32 text-[#4a3b2c] font-serif text-lg leading-loose text-justify whitespace-pre-wrap scroll-smooth"></div>
        <div class="absolute bottom-0 w-full bg-[#f8f1e5]/95 backdrop-blur border-t border-[#eaddcf] p-4 flex gap-3 z-30 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <button id="btn-th-continue" onclick="continueTheater()" class="flex-1 bg-[#5c4b3c] text-[#f8f1e5] py-3 rounded-lg font-bold shadow-md active:scale-95 transition-transform flex justify-center items-center gap-2"><span>âœï¸ ç»­å†™ä¸‹ä¸€ç« </span></button>
            <button onclick="toggleCatalog()" class="w-14 flex items-center justify-center bg-[#eaddcf] rounded-lg text-lg active:bg-[#d6c4b0] transition-colors relative">ğŸ“‹<span id="chapter-count-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full shadow-sm hidden">0</span></button>
        </div>
        <div id="catalog-drawer" class="catalog-drawer" onclick="if(event.target===this) toggleCatalog()"><div class="catalog-content"><div class="h-14 border-b flex items-end p-4 bg-gray-50"><b class="text-lg text-zinc-700">ğŸ“œ ç« èŠ‚ç›®å½•</b></div><div id="catalog-list" class="flex-1 overflow-y-auto"></div><div class="p-4 border-t bg-gray-50"><button onclick="copyTheater()" class="w-full py-2 border border-zinc-300 rounded text-zinc-600 text-sm">å¤åˆ¶å…¨æ–‡</button></div></div></div>
    </div>

    <div id="pg-chat-room" class="page z-[50]">
        <header class="h-14 bg-[#ededed] flex items-end justify-between p-3 border-b shrink-0">
            <span onclick="go('pg-wechat')" class="text-zinc-600 pb-1 cursor-pointer">ã€ˆ è¿”å›</span>
            <div class="flex flex-col items-center pb-1"><b id="chat-user-name"></b><span id="chat-mode-tag" class="text-[10px] text-zinc-400">çŸ­å¥æ¨¡å¼</span></div>
            <div class="flex items-center gap-4 pb-1">
    <button onclick="deleteCurrentChat()" class="text-red-500 text-sm font-bold active:opacity-50">åˆ é™¤</button>
    <button onclick="go('pg-chat-info')" class="text-zinc-800 text-xl font-bold px-2 tracking-widest">â€¢â€¢â€¢</button>
</div>
        </header>
        <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar bg-[#f2f2f2] bg-cover bg-center"></div>
        <footer class="bg-[#f7f7f7] border-t z-[60] relative shrink-0 safe-area-pb">
            <div class="p-3 flex items-center gap-2">
                <button onclick="togglePnl('emoji')" class="text-3xl text-zinc-600 font-light active:opacity-50 px-1">â˜º</button>
                <input id="chat-in" class="flex-1 border-none rounded bg-white h-10 px-3 outline-none text-base" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button onclick="togglePnl('tools')" class="text-3xl text-zinc-600 font-light active:opacity-50 px-1">âŠ•</button>
                <button onclick="handleSendMsg()" class="bg-[#07c160] text-white px-3 py-1.5 rounded text-sm font-medium whitespace-nowrap">å‘é€</button>
            </div>
                        <div id="chat-pnl" class="drawer bg-[#f7f7f7]"></div>
        </footer>
    </div>

    <div id="pg-story-room" class="page z-[50] bg-[#f8f1e5]">
        <header class="h-14 flex items-end justify-between p-3 border-b border-[#eaddcf] shrink-0 sticky top-0 z-20 shadow-sm">
            <span onclick="exitStoryMode()" class="text-[#8c7b6c] pb-1 cursor-pointer font-bold">ã€ˆ ç»“æŸè§é¢(å›å¾®ä¿¡)</span>
            <b class="pb-1 text-lg truncate text-[#5c4b3c]" id="story-user-name">çº¿ä¸‹è§é¢</b>
            <span class="w-24"></span>
        </header>
        <div id="story-msgs" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"></div>
        <footer class="bg-[#f8f1e5] border-t border-[#eaddcf] z-[60] relative shrink-0 safe-area-pb p-3 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <div class="flex items-center gap-2">
                <textarea id="story-in" class="flex-1 border border-[#eaddcf] rounded-lg bg-white p-2.5 outline-none text-base resize-none" rows="2" placeholder="æå†™åŠ¨ä½œã€è¯­è¨€æˆ–å¿ƒç†æ´»åŠ¨..."></textarea>
                <button onclick="handleSendMsg(null, 'text', false)" class="bg-[#5c4b3c] text-[#f8f1e5] px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap h-full self-stretch flex items-center justify-center shadow-sm active:scale-95 transition-transform">å‘é€</button>
            </div>
        </footer>
    </div>
    <div id="pg-chat-info" class="page z-[60] bg-zinc-100">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0"><span onclick="go('pg-chat-room')" class="text-zinc-600 pb-1 cursor-pointer">ã€ˆ</span><b class="pb-1">èŠå¤©ä¿¡æ¯</b><div class="w-6"></div></header>
        <div class="overflow-y-auto">
            <div id="group-name-edit-box" class="mt-2 bg-white divide-y border-y border-zinc-200 hidden">
                <div onclick="renameGroup()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer">
                    <span class="text-base text-zinc-800">âœï¸ ä¿®æ”¹ç¾¤èŠåç§°</span>
                    <span class="text-zinc-300">ã€‰</span>
                </div>
            </div>
            
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="go('pg-mask-edit')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span class="text-base text-zinc-800">ğŸ­ ç”¨æˆ·é¢å…· (äººè®¾)</span><div class="flex items-center gap-2"><span id="info-mask-status" class="text-xs text-zinc-400">é»˜è®¤</span><span class="text-zinc-300">ã€‰</span></div></div></div>
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="setChatBg()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer"><span class="text-base text-zinc-800">ğŸ–¼ï¸ è®¾ç½®å½“å‰èŠå¤©èƒŒæ™¯</span><span class="text-zinc-300">ã€‰</span></div></div>
            <div class="mt-2 bg-white divide-y border-y border-zinc-200"><div onclick="clearHistory()" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer text-red-600 text-center justify-center font-medium">æ¸…ç©ºèŠå¤©è®°å½•</div></div>
        </div>
    </div>
    <div id="pg-mask-edit" class="page z-[70] bg-white"><header class="h-16 flex items-end justify-between border-b pb-4 px-4 shrink-0"><button onclick="go('pg-chat-info')" class="text-zinc-600">å–æ¶ˆ</button><b>ç¼–è¾‘é¢å…·</b><button onclick="saveMask()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-6 space-y-6"><div class="text-xs text-zinc-400 text-center">ä»…åœ¨ä¸å½“å‰è§’è‰²èŠå¤©æ—¶ç”Ÿæ•ˆã€‚</div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·æ˜µç§°</label><input id="in-mask-n" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: ä½ çš„å­¦ç”Ÿå°æ˜"></div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·å¤´åƒ URL</label><input id="in-mask-a" class="w-full p-3 border rounded-lg bg-zinc-50" placeholder="http://..."></div><div><label class="block text-sm font-bold text-zinc-700 mb-2">é¢å…·äººè®¾è¯¦æƒ…</label><textarea id="in-mask-i" class="w-full h-40 p-3 border rounded-lg bg-zinc-50" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ååŒ»å­¦é™¢çš„å­¦ç”Ÿ..."></textarea></div></div></div>
    <div id="pg-prof" class="page bg-white p-4"><header class="h-16 flex items-end justify-between border-b pb-4 shrink-0"><button onclick="go('pg-wechat')">è¿”å›</button><b>ä¸ªäººä¿¡æ¯</b><div class="w-8"></div></header><div class="mt-4 divide-y"><div onclick="updProf('name','æ˜µç§°')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>æ˜µç§°</span><span class="u-name text-zinc-400"></span></div><div onclick="updProf('ava','å¤´åƒURL')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>å¤´åƒ</span><img class="w-12 h-12 u-ava rounded-lg bg-zinc-100"></div><div onclick="updProf('bg','æœ‹å‹åœˆèƒŒæ™¯URL')" class="py-5 flex justify-between items-center active:bg-zinc-50"><span>æœ‹å‹åœˆèƒŒæ™¯</span><span class="text-zinc-400 text-sm">ç‚¹å‡»æ›´æ¢ ã€‰</span></div><div onclick="updProf('info','äººè®¾ç­¾å')" class="py-5 flex flex-col gap-2 active:bg-zinc-50"><span>èº«ä»½äººè®¾/ç­¾å</span><div id="u-info-box" class="text-sm text-zinc-400 bg-zinc-50 p-4 rounded-lg"></div></div></div></div>
    <div id="pg-moments-pub" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')" class="text-zinc-700">å–æ¶ˆ</button><b class="pb-1">å‘è¡¨æœ‹å‹åœˆ</b><button onclick="submitMoment()" class="bg-[#07c160] text-white px-4 py-1 rounded text-sm font-medium">å‘è¡¨</button></header><div class="flex-1 overflow-y-auto"><textarea id="in-m-t" class="w-full h-40 p-4 outline-none resize-none text-lg" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea><div class="p-4 border-t"><p class="text-xs text-zinc-400 mb-2">é…å›¾é“¾æ¥ (å¯é€‰)</p><input id="in-m-img" class="w-full p-3 bg-zinc-50 rounded-lg text-sm border-none outline-none" placeholder="ç²˜è´´å›¾ç‰‡ç›´é“¾ http://..."></div></div></div>
    <div id="pg-wb" class="page bg-zinc-100"><header class="h-16 bg-white flex items-end justify-between p-4 border-b shrink-0"><button onclick="go('pg-home')" class="text-zinc-600">ğŸ </button><b>ä¸–ç•Œä¹¦</b><button onclick="openWBEdit(null)" class="text-blue-600 font-bold">ï¼‹</button></header><div id="wb-list-box" class="p-4 space-y-3"></div></div>
    <div id="pg-wb-edit" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wb')">å–æ¶ˆ</button><b>ç¼–è¾‘è®¾å®š</b><button onclick="saveWB()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-4 space-y-4 overflow-y-auto no-scrollbar"><input id="in-wb-n" class="w-full p-3 border rounded-lg" placeholder="è®¾å®šæ ‡é¢˜"><textarea id="in-wb-c" class="w-full h-40 p-3 border rounded-lg" placeholder="å†…å®¹..."></textarea><div id="wb-roles-sel" class="flex flex-wrap gap-2 pb-10"></div></div></div>
    <div id="pg-memory" class="page bg-zinc-100"><header class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-home')" class="text-zinc-600">ğŸ </button><b>è®°å¿†æ®¿å ‚</b><div class="w-8"></div></header><div id="memory-list" class="p-4 space-y-4 overflow-y-auto no-scrollbar"></div></div>
<div id="pg-set" class="page bg-zinc-100">
    <header id="set-main-header" class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0">
        <button onclick="go('pg-home')">ğŸ </button>
        <b>ç³»ç»Ÿè®¾ç½®</b>
        <div class="w-8"></div>
    </header>

    <header id="set-api-header" class="h-16 bg-white p-4 border-b flex items-end justify-between shrink-0 hidden">
        <button onclick="toggleSetSub('main')" class="text-zinc-600">ã€ˆ è¿”å›</button>
        <b>API è®¾ç½®</b>
        <div class="w-8"></div>
    </header>

    <div class="flex-1 overflow-y-auto">
        <div id="set-main-list" class="mt-4 bg-white divide-y border-y border-zinc-200">
            <div onclick="toggleSetSub('api')" class="p-4 flex justify-between items-center active:bg-zinc-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ”Œ</span>
                    <span class="text-base text-zinc-800">API é…ç½® (æ ¸å¿ƒå¯¹è¯)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="set-api-status" class="text-xs text-green-500">å·²é…ç½®</span>
                    <span class="text-zinc-300">ã€‰</span>
                </div>
            </div>
            
            <div class="p-4 flex justify-between items-center opacity-40">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ¨</span>
                    <span class="text-base text-zinc-800">ç•Œé¢ä¸»é¢˜ (æ•¬è¯·æœŸå¾…)</span>
                </div>
                <span class="text-zinc-300">ã€‰</span>
            </div>
        </div>

        <div id="set-api-detail" class="p-6 space-y-4 hidden">
            <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-600 mb-2">
                è¯·è¾“å…¥é€‚é… OpenAI æ ¼å¼çš„æ¥å£åœ°å€å’Œå¯†é’¥ã€‚
            </div>
            <input id="in-s-u" class="w-full p-3 border rounded-lg" placeholder="API åœ°å€ (ä¾‹å¦‚: https://api.openai.com)">
            <input id="in-s-k" type="password" class="w-full p-3 border rounded-lg" placeholder="API Key (sk-...)">
            <div class="flex gap-2">
                <input id="in-s-m" class="flex-1 p-3 border rounded-lg" placeholder="æ¨¡å‹åç§° (å¦‚: gpt-4o)">
                <button onclick="fetchModels()" class="bg-blue-600 text-white px-3 rounded-lg text-xs whitespace-nowrap">æ‹‰å–åˆ—è¡¨</button>
            </div>
            <select id="model-select" class="w-full p-3 border rounded-lg hidden" onchange="$('in-s-m').value=this.value"></select>
            <button onclick="saveSettings()" class="w-full bg-zinc-800 text-white py-4 rounded-xl font-bold shadow-lg mt-4">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>
</div>
    <div id="pg-role-edit" class="page z-[100] bg-white"><header class="h-16 p-4 border-b flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')">å–æ¶ˆ</button><b id="role-edit-title">è§’è‰²</b><button onclick="saveRole()" class="text-green-600 font-bold">ä¿å­˜</button></header><div class="p-4 space-y-4 overflow-y-auto no-scrollbar"><input id="in-r-n" class="w-full p-3 border rounded-lg" placeholder="æ˜µç§°"><input id="in-r-a" class="w-full p-3 border rounded-lg" placeholder="å¤´åƒURL"><textarea id="in-r-i" class="w-full h-80 p-3 border rounded-lg" placeholder="è¯¦ç»†äººè®¾..."></textarea><button id="del-role-btn" onclick="deleteRole()" class="w-full py-3 text-red-500 hidden">åˆ é™¤æ­¤è§’è‰²</button></div></div>
    <div id="pg-emj" class="page bg-white"><header class="h-16 border-b p-4 flex items-end justify-between shrink-0"><button onclick="go('pg-wechat')">è¿”å›</button><b>è¡¨æƒ…åŒ…åˆ—è¡¨</b><button onclick="addEmj()" class="text-green-600">æ·»åŠ </button></header><div id="emj-box" class="p-4 grid grid-cols-4 gap-4 overflow-y-auto"></div></div>
</div>
    <div id="pg-diary" class="page bg-[#f5f5f5] z-[70]">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0 sticky top-0 z-20 shadow-sm">
            <span onclick="go('pg-chat-room')" class="text-zinc-600 pb-1 cursor-pointer w-16">ã€ˆ è¿”å›</span>
            <b class="pb-1 text-lg truncate" id="diary-title">Taçš„æ—¥è®°</b>
            <span onclick="generateDiary()" class="text-[#576b95] text-sm pb-1 cursor-pointer font-bold w-16 text-right active:opacity-50 transition-opacity">å·çœ‹ä»Šæ—¥</span>
        </header>
                <div id="diary-list" class="p-4 space-y-4 overflow-y-auto h-full pb-20">
            </div>
    </div>

    <div id="pg-music-player" class="page bg-gradient-to-br from-[#e2eaf5] to-[#f0f4f8] z-[60]">
        <header class="h-16 flex items-center justify-between px-5 pt-4 shrink-0 z-10">
            <div onclick="go('pg-home')" class="w-10 h-10 bg-white/40 rounded-full flex items-center justify-center backdrop-blur shadow-sm cursor-pointer active:scale-95 text-xl text-zinc-700">âˆ¨</div>
            <div class="flex flex-col items-center">
                <b id="music-title" class="text-[17px] text-zinc-800 font-serif tracking-wide drop-shadow-sm">æš‚æ— æ’­æ”¾</b>
                <span id="music-artist" class="text-[11px] text-zinc-500 mt-0.5">æœªçŸ¥æ­Œæ‰‹</span>
            </div>
            <div class="w-10 h-10 bg-white/40 rounded-full flex items-center justify-center backdrop-blur shadow-sm text-xl text-zinc-700">+</div>
        </header>

                <div class="flex-1 flex flex-col items-center relative w-full overflow-hidden pt-10">
                        <input type="file" id="local-cover-input" accept="image/*" class="hidden" onchange="handleCoverUpload(event)">
            
            <div onclick="if(curMusicIdx !== -1) document.getElementById('local-cover-input').click(); else alert('è¯·å…ˆæ’­æ”¾ä¸€é¦–æ­Œå†æ›´æ¢å°é¢å“¦~')" class="relative w-[68vw] max-w-[280px] aspect-square shrink-0 rounded-full border-[6px] border-white/60 flex items-center justify-center shadow-[0_15px_35px_rgba(0,0,0,0.1)] mb-10 mt-2 bg-zinc-100 z-10 cursor-pointer active:scale-95 transition-transform">
                <img id="music-cover" src="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=500&auto=format&fit=crop" class="w-full h-full rounded-full object-cover spin-slow spin-paused shadow-inner">
            </div>
            <div class="text-center space-y-4 mb-auto z-10 px-12 w-full mt-2">
                <div class="text-[17px] text-zinc-800 font-serif tracking-widest drop-shadow-sm truncate">å¾®é£æ‹‚è¿‡ æˆ‘æ—©å·²æ’¤æ‰è´Ÿè·</div>
                <div class="text-[13px] text-zinc-400 font-serif opacity-80 truncate">ç•™å£°è·³åŠ¨çš„çµæ´» é—²è¨€ç¢è¯­å¤š</div>
            </div>

            <div class="absolute right-5 top-[60%] -translate-y-1/2 flex flex-col gap-7 text-2xl text-zinc-500 drop-shadow-sm z-20">
                <span class="active:scale-90 transition-transform cursor-pointer hover:text-zinc-700">ğŸ§</span>
                <span class="active:scale-90 transition-transform cursor-pointer hover:text-zinc-700">â¦</span>
                <span onclick="toggleMusicFav()" id="music-fav-btn" class="active:scale-90 transition-transform cursor-pointer hover:text-red-500">â™¡</span>
                <span class="active:scale-90 transition-transform cursor-pointer hover:text-zinc-700">â€¢â€¢â€¢</span>
            </div>
        </div>
        <div class="w-full px-6 pb-6 shrink-0 relative z-10">
            <div class="flex items-center gap-3 mb-6">
                <span id="music-time-cur" class="text-[10px] text-zinc-500 font-mono w-8 text-right">0:00</span>
                <input type="range" id="music-progress" class="music-range flex-1" value="0" min="0" max="100" onchange="seekMusic(this.value)">
                <span id="music-time-total" class="text-[10px] text-zinc-500 font-mono w-8">0:00</span>
            </div>
            <div class="flex items-center justify-between px-2 mb-4">
                <span class="text-xl text-zinc-600">ğŸ”</span>
                <div class="flex items-center gap-6">
                    <button onclick="prevMusic()" class="w-12 h-12 bg-white/50 rounded-full flex items-center justify-center text-xl shadow-sm active:bg-white/80">â®</button>
                    <button onclick="togglePlay()" id="btn-music-play" class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-2xl shadow-md active:scale-95 transition-transform">â–¶</button>
                    <button onclick="nextMusic()" class="w-12 h-12 bg-white/50 rounded-full flex items-center justify-center text-xl shadow-sm active:bg-white/80">â­</button>
                </div>
                <span onclick="toMusicTab('me')" class="text-xl text-zinc-600 cursor-pointer active:opacity-50">ğŸ‘¤</span>
            </div>
        </div>
    </div>

    <div id="pg-music-me" class="page bg-[#f5f5f5] z-[60]">
        <header class="h-14 bg-white flex items-end justify-between p-3 border-b shrink-0 sticky top-0 z-20 shadow-sm">
            <span onclick="toMusicTab('player')" class="text-zinc-600 pb-1 cursor-pointer w-16 font-bold">ã€ˆ è¿”å›</span>
            <b class="pb-1 text-lg truncate">æˆ‘çš„éŸ³ä¹</b>
            <div class="w-16 text-right pb-1">
                <input type="file" id="local-music-input" accept="audio/*" class="hidden" onchange="handleLocalMusicUpload(event)">
                <span onclick="document.getElementById('local-music-input').click()" class="text-2xl text-zinc-800 font-light cursor-pointer active:opacity-50">ï¼‹</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto pb-20">
            <div class="bg-gradient-to-b from-[#e2eaf5] to-[#f5f5f5] pt-10 pb-8 px-6 flex flex-col items-center gap-3">
                <img class="u-ava w-20 h-20 rounded-full border-4 border-white bg-white shadow-md object-cover">
                <b class="u-name text-xl text-zinc-900 drop-shadow-sm"></b>
            </div>
            
            <div class="mx-4 -mt-4 bg-white rounded-2xl shadow-sm p-4 grid grid-cols-2 gap-4 text-center relative z-10 mb-4">
                <div class="flex flex-col items-center gap-1 active:opacity-50 border-r border-zinc-100">
                    <span class="text-2xl text-red-400">â¤ï¸</span>
                    <span class="text-xs font-bold text-zinc-700">æˆ‘çš„æ”¶è—</span>
                </div>
                <div class="flex flex-col items-center gap-1 active:opacity-50">
                    <span class="text-2xl text-blue-400">ğŸ•’</span>
                    <span class="text-xs font-bold text-zinc-700">æœ€è¿‘å¬æ­Œ</span>
                </div>
            </div>

            <div class="mx-4 bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="p-4 border-b border-zinc-50 flex justify-between items-center bg-gray-50/50">
                    <b class="text-sm text-zinc-800">æœ¬åœ°éŸ³ä¹åº“</b>
                    <span class="text-[10px] text-zinc-400 bg-zinc-200 px-2 py-0.5 rounded-full" id="music-count-badge">0 é¦–</span>
                </div>
                <div id="music-lib-list" class="divide-y divide-zinc-50">
                    </div>
            </div>
        </div>
    </div>
    <script>
    const $ = id => document.getElementById(id);
    const DB_NAME = 'AI_OS_DB';
    const STORE_NAME = 'system_data';
    const DB = 'OS67_'; 
    const DB_VERSION = 1;
    let db;

    // ================== 1. IndexedDB æ ¸å¿ƒå¼•æ“ ==================
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (e) => { console.error("DB Error", e); reject("æ•°æ®åº“æ‰“å¼€å¤±è´¥"); };
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                console.log("IndexedDB è¿æ¥æˆåŠŸ");
                resolve(db);
            };
        });
    }

    function dbGet(key, defaultVal) {
        return new Promise((resolve) => {
            if(!db) return resolve(defaultVal);
            const tx = db.transaction([STORE_NAME], 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result !== undefined ? req.result : defaultVal);
            req.onerror = () => { console.warn(`Read error: ${key}`); resolve(defaultVal); };
        });
    }

    function dbSet(key, val) {
        return new Promise((resolve, reject) => {
            if(!db) return reject("DBæœªåˆå§‹åŒ–");
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const req = store.put(val, key);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }

    // ================== 2. å…¨å±€å˜é‡ä¸æ ¸å¿ƒè¾…åŠ© ==================
    let roles, chats, wbs, emjs, mnts, balance, theaters;
    let foods, cart, orders;          
    let shopGoods, shopCart, shopOrders, shopFavs; 
    let musicLib = [];       // éŸ³ä¹åº“æ•°æ®
    let curAudio = new Audio(); // åŸç”ŸéŸ³é¢‘æ’­æ”¾å™¨
    let isPlaying = false;
    let curMusicIdx = -1;
    let curRole = null, curWB = null, selRids = [], curTab = 'chat';
    let curMsgIdx = -1, lastPnlType = null, curTheater = null;
    let takeoutCtx = { fromChat: false, targetRoleId: null };

    // å¼ºåŠ›æ¸…æ´—æ–‡æœ¬
    function cleanText(text) { 
        if (typeof text !== 'string') return '';
        let res = text.replace(/<think>[\s\S]*?<\/think>/gi, "");
        res = res.replace(/^\(Hello, I am.*?\.\)\s*/i, "").replace(/^Hello, I am.*?\.\s*/i, "");
        res = res.replace(/æˆ‘æ˜¯.*?æ¨¡å‹/g, "").replace(/```.*?/g, "").replace(/```/g, "");
        res = res.replace(/^#\s*.*$/gm, ""); // å»é™¤ç±»ä¼¼ "# ç«¹å¢¨å±…Â·åˆå"
        res = res.replace(/^\[.*?\]$/gm, ""); // å»é™¤ç±»ä¼¼ "[æ—¶é—´ï¼šåˆå]"
        res = res.replace(/^\s*[\r\n]/gm, ""); // å»é™¤ç”±æ­¤äº§ç”Ÿçš„ç©ºè¡Œ
        return res.trim(); 
    }

    async function cleanBadData() {
        if(!confirm("ç¡®å®šè¦æ·±åº¦æ¸…ç†å—ï¼Ÿ")) return;
        let r = await dbGet('OS67_R', []);
        r.forEach(role => {
            if (role.history && Array.isArray(role.history)) {
                role.history = role.history.filter(m => m && typeof m.t === 'string');
            } else { role.history = []; }
            if(!role.mode) role.mode = 'chat';
        });
        await dbSet('OS67_R', r);
        alert(`æ¸…ç†å®Œæˆï¼Œå³å°†åˆ·æ–°`);
        location.reload();
    }

    // ================== 3. æ•°æ®åŠ è½½ä¸ä¿å­˜ ==================
    async function loadAllData() {
        const K = 'OS67_';
        roles = await dbGet(K+'R', []);
        chats = await dbGet(K+'C', []);
        wbs = await dbGet(K+'W', []);
        emjs = await dbGet(K+'E', []);
        mnts = await dbGet(K+'M', []);
        balance = parseFloat(await dbGet(K+'BAL', '0.00'));
        theaters = await dbGet(K+'THEATERS', []);
        musicLib = await dbGet(K+'MUSIC', []);
        foods = await dbGet(K+'FOODS', [
            { id: 1, store: "å¡”æ–¯æ±€ä¸­å›½æ±‰å ¡", name: "é¦™è¾£é¸¡è…¿å ¡å¥—é¤", price: 19.9, sales: 500, img: "https://img.meituan.net/msi/0b17156b82547565d833896409a80374116496.jpg" },
            { id: 2, store: "èœœé›ªå†°åŸ", name: "å†°é²œæŸ æª¬æ°´", price: 4.0, sales: 9999, img: "https://img.meituan.net/msi/86d38e24483584852880092305822365287313.png" },
            { id: 3, store: "éŸ©å¼ç‚¸é¸¡", name: "ç”œè¾£æ— éª¨ç‚¸é¸¡", price: 25.8, sales: 230, img: "https://p0.meituan.net/deal/832c6968037628833959952044565773108620.jpg" },
            { id: 4, store: "å–œèŒ¶ HEYTEA", name: "å¤šè‚‰è‘¡è„(é¦–åˆ›)", price: 28.0, sales: 600, img: "https://img.meituan.net/msi/e4d09320297063f2722b512c1421f18e1467402.jpg" }
        ]);
        cart = await dbGet(K+'CART', []);
        orders = await dbGet(K+'ORDERS', []);

        shopGoods = await dbGet(K+'SHOP_GOODS', [
            { id: 101, store: "å®˜æ–¹æ——èˆ°åº—", name: "æ–°æ¬¾æ™ºèƒ½æ‰‹æœº Pro Max", price: 5999.0, sales: 2000, img: "https://img.icons8.com/color/480/smartphone.png" },
            { id: 102, store: "æ½®ç‰Œé›†åˆ", name: "å®½æ¾çº¯æ£‰æƒ…ä¾£å«è¡£", price: 129.0, sales: 800, img: "https://img.icons8.com/color/480/hoodie-with-pocket.png" },
            { id: 103, store: "ç¾å¦†è‡ªè¥", name: "å¤§ç‰Œå£çº¢ çƒ‚ç•ªèŒ„è‰²", price: 299.0, sales: 5000, img: "https://img.icons8.com/color/480/lipstick.png" },
            { id: 104, store: "ç”Ÿæ´»å®¶å±…", name: "è¶…è½¯æ¯›ç»’å…¬ä»” (å¤§å·)", price: 88.0, sales: 300, img: "https://img.icons8.com/color/480/teddy-bear.png" }
        ]);
        shopCart = await dbGet(K+'SHOP_CART', []);
        shopOrders = await dbGet(K+'SHOP_ORDERS', []);
        shopFavs = await dbGet(K+'SHOP_FAVS', []);

        roles.forEach(r => { if(!r.ava) r.ava = "https://img.icons8.com/color/96/user.png"; });
    }

        async function saveAll() {
        const K = 'OS67_';
        try {
            // ğŸ¯ æ ¸å¿ƒä¿®å¤ï¼šè¿‡æ»¤æ‰è¿‡å¤§çš„éŸ³ä¹æ–‡ä»¶ï¼Œé˜²æ­¢æ•°æ®åº“å´©æºƒ
            let safeMusicLib = musicLib.filter(m => !m.blob || m.blob.size <= 15 * 1024 * 1024);

            await Promise.all([
                dbSet(K+'R', roles), dbSet(K+'C', chats), dbSet(K+'W', wbs),
                dbSet(K+'E', emjs), dbSet(K+'M', mnts), dbSet(K+'BAL', balance.toFixed(2)),
                dbSet(K+'THEATERS', theaters),
                dbSet(K+'MUSIC', safeMusicLib), // ä½¿ç”¨è¿‡æ»¤åçš„å®‰å…¨æ­Œå•ä¿å­˜
                dbSet(K+'FOODS', foods), dbSet(K+'CART', cart), dbSet(K+'ORDERS', orders),
                dbSet(K+'SHOP_GOODS', shopGoods), dbSet(K+'SHOP_CART', shopCart),
                dbSet(K+'SHOP_ORDERS', shopOrders), dbSet(K+'SHOP_FAVS', shopFavs)
            ]);
        } catch (e) { console.error("Save Failed:", e); alert("ä¿å­˜å¤±è´¥ï¼æ£€æŸ¥å­˜å‚¨ç©ºé—´"); }
    }

    function hardReset() {
        if(confirm("ã€é«˜èƒ½è­¦å‘Šã€‘\nè¿™å°†å®Œå…¨æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼\nç¡®å®šç»§ç»­å—ï¼Ÿ")) {
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const req = tx.objectStore(STORE_NAME).clear();
            req.onsuccess = () => { alert("ç³»ç»Ÿå·²é‡ç½®"); location.reload(); };
        }
    }

    // ================== 4. è·¯ç”±ä¸å…¨å±€å¯¼èˆª ==================
    function go(id) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
ã€€ã€€let target = $(id); if(target) target.classList.add('active');
ã€€ã€€if(id === 'pg-set') toggleSetSub('main'); // ç¡®ä¿è¿›å…¥è®¾ç½®é¡µæ—¶æ€»æ˜¯æ˜¾ç¤ºä¸»èœå•
ã€€ã€€if(id === 'pg-music-player') renderMusicPlayer();
        if(id === 'pg-music-me') renderMusicLib();
        if(id==='pg-wb') renderWBList();
        if(id==='pg-emj') renderEmj();
        if(id==='pg-set') loadSettings();
        if(id==='pg-memory') renderMemPage();
        if(id==='pg-wallet') renderWallet();
        if(id==='pg-chat-info') renderChatInfo();
        if(id==='pg-mask-edit') loadMaskEdit();
        if(id==='pg-theater') renderTheaterList();
        if(id==='pg-theater-create') initTheaterCreate();
        if(id==='pg-takeout-home') renderFoodList();
        if(id==='pg-takeout-cart') renderCart();
        if(id==='pg-takeout-me') updatePendingBadge();
        if(id==='pg-takeout-orders') renderAllOrders();
        if(id==='pg-takeout-pending') renderPendingOrders();
        if(id==='pg-shop-favs') renderFavs(); 
        if(id==='pg-shop-home') renderShopList(); 
        if(id==='pg-shop-cart') renderShopCart(); 
        if(id==='pg-shop-me') updateShopPendingBadge(); 
    }

    function tab(t) {
        curTab = t;
        ['chat','cont','moments','me'].forEach(k=>$(`sub-${k}`).classList.add('hidden'));
        $(`sub-${t}`).classList.remove('hidden');
        document.querySelectorAll('footer div').forEach(d=>d.style.color='#999');
        let tIcon = $(`t-${t}`); if(tIcon) tIcon.style.color='#07c160';
        if(t==='chat') renderChatList();
        if(t==='cont') renderCont();
        if(t==='moments') renderMnts();
        if(t==='me') renderProfile();
    }

    // ================== 5. API é…ç½® ==================
    async function getAICfg() {
        let val = await dbGet(DB+'AI', null); 
        if (!val) {
            let local = localStorage.getItem(DB+'AI');
            val = local ? JSON.parse(local) : {};
        }
        return val || {};
    }
    // === æ–°å¢ï¼šæ§åˆ¶è®¾ç½®é¡µé¢çš„è§†å›¾åˆ‡æ¢ ===
    function toggleSetSub(view) {
        if (view === 'api') {
            $('set-main-header').classList.add('hidden');
            $('set-main-list').classList.add('hidden');
            $('set-api-header').classList.remove('hidden');
            $('set-api-detail').classList.remove('hidden');
            loadSettings(); 
        } else {
            $('set-main-header').classList.remove('hidden');
            $('set-main-list').classList.remove('hidden');
            $('set-api-header').classList.add('hidden');
            $('set-api-detail').classList.add('hidden');
            checkApiStatus(); 
        }
    }

    // === æ–°å¢ï¼šæ£€æŸ¥ API çŠ¶æ€ä»¥æ›´æ–°åˆ—è¡¨å‰¯æ ‡é¢˜ ===
    async function checkApiStatus() {
        let cfg = await getAICfg();
        const statusEl = $('set-api-status');
        if (statusEl) {
            if (cfg && cfg.key && cfg.url) {
                statusEl.innerText = "å·²é…ç½®";
                statusEl.className = "text-xs text-green-500";
            } else {
                statusEl.innerText = "æœªè®¾ç½®";
                statusEl.className = "text-xs text-red-500";
            }
        }
    }ã€€ã€€
    async function loadSettings() { 
        let cfg = await getAICfg(); 
        if($('in-s-u')) $('in-s-u').value = cfg.url || ''; 
        if($('in-s-k')) $('in-s-k').value = cfg.key || ''; 
        if($('in-s-m')) $('in-s-m').value = cfg.model || ''; 
    }
    async function saveSettings() { 
    await dbSet(DB+'AI', { 
        url: $('in-s-u').value.trim(), 
        key: $('in-s-k').value.trim(), 
        model: $('in-s-m').value.trim() 
    }); 
    alert("é…ç½®å·²ä¿å­˜ï¼"); 
    toggleSetSub('main'); // ä¿å­˜åè¿”å›è®¾ç½®ä¸»åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ç›´æ¥é€€å‡º
}
    async function fetchModels() { 
        let u=$('in-s-u').value, k=$('in-s-k').value; 
        if(!u||!k) return alert("è¯·å…ˆå¡«å†™ URL å’Œ Key"); 
        try { 
            let res = await fetch(`${u}/v1/models`, { headers:{"Authorization":`Bearer ${k}`} }); 
            let d = await res.json(); 
            if(d.data && Array.isArray(d.data)) { 
                $('model-select').innerHTML = d.data.map(m=>`<option value="${m.id}">${m.id}</option>`).join(''); 
                $('model-select').classList.remove('hidden'); 
                alert("æ‹‰å–æˆåŠŸ"); 
            } else { alert("è·å–å¤±è´¥"); } 
        } catch(e) { alert("ç½‘ç»œè¿æ¥å¤±è´¥"); } 
    }

    // ================== 6. æœ‹å‹åœˆä¸ä¸ªäººä¿¡æ¯ ==================
    async function renderProfile() { 
        let p = await dbGet(DB+'U', null);
        if (!p) {
            let local = localStorage.getItem(DB+'U');
            p = local ? JSON.parse(local) : {name:"æˆ‘çš„æ˜µç§°", ava:"https://img.icons8.com/color/96/user.png", bg:"", info:"æ™®é€šç”¨æˆ·"};
        }
        document.querySelectorAll('.u-name').forEach(e=>e.innerText=p.name);
        document.querySelectorAll('.u-ava').forEach(e=>e.src=p.ava);
        if($('u-info-box')) $('u-info-box').innerText = p.info;
        if($('moment-bg')) $('moment-bg').style.backgroundImage = `url('${p.bg||''}')`;
    }
    async function updProf(k, l) { 
        let p = await dbGet(DB+'U', {name:"æˆ‘çš„æ˜µç§°", ava:"https://img.icons8.com/color/96/user.png", bg:"", info:"æ™®é€šç”¨æˆ·"});
        let n = prompt(`ä¿®æ”¹${l}`, p[k]); 
        if(n!==null) { p[k]=n; await dbSet(DB+'U', p); renderProfile(); } 
    }

    function renderMnts() {
        let p = {name:"æˆ‘", ava:"https://img.icons8.com/color/96/user.png"}; 
        let sorted = mnts.sort((a,b) => b.time - a.time);
        $('mnts-list').innerHTML = sorted.map((m, i) => {
            let isMe = m.r === 'u';
            let role = isMe ? null : roles.find(r=>r.id==m.r);
            let name = isMe ? "æˆ‘" : (role?.name || 'æœªçŸ¥ç”¨æˆ·');
            let ava = isMe ? document.querySelector('.u-ava').src : (role?.ava || '');
            let content = m.content || '';
            let imgHtml = m.img ? `<img src="${m.img}" class="max-h-60 max-w-[80%] mt-2 rounded-lg cursor-pointer object-cover" onclick="window.open('${m.img}')">` : '';
            let timeStr = new Date(m.time).toLocaleString();
            
            let commentsHtml = '';
            if(m.comments && m.comments.length > 0) {
                let cList = m.comments.map(c => {
                    let cName = c.uid === 'me' ? "æˆ‘" : (roles.find(r=>r.id==c.uid)?.name || 'æœªçŸ¥');
                    let replyTarget = c.replyToName ? `å›å¤ <span class="text-zinc-800 font-bold">${c.replyToName}</span>` : '';
                    let cNameEscaped = cName.replace(/'/g, "\\'");
                    return `<div class="text-sm comment-row cursor-pointer" onclick="handleCommentClick(${m.id}, '${c.uid}', '${cNameEscaped}')"><span class="text-[#576b95] font-bold">${cName}</span> ${replyTarget}: <span class="text-zinc-800">${c.content}</span></div>`;
                }).join('');
                commentsHtml = `<div class="bg-zinc-100 p-2 rounded mt-2 flex flex-col gap-1">${cList}</div>`;
            }
            
            let likeBtnText = (m.likes && m.likes.includes('me')) ? 'â¤ï¸' : 'â™¡';
            let delBtn = `<span onclick="delMoment(${m.id})" class="text-xs text-zinc-400 ml-3 cursor-pointer hover:text-red-500">åˆ é™¤</span>`;

            return `<div class="flex gap-3 p-4 border-b border-zinc-100 animate-fade-in group"><img src="${ava}" class="w-10 h-10 rounded-lg bg-zinc-200 shrink-0"><div class="flex-1 min-w-0"><b class="text-[#576b95] cursor-pointer text-[15px]">${name}</b><div class="text-[15px] text-zinc-800 mt-1 whitespace-pre-wrap leading-relaxed">${content}</div>${imgHtml}<div class="flex justify-between items-center mt-2 mb-2"><div class="flex items-center"><span class="text-xs text-zinc-400">${timeStr}</span>${delBtn}</div><div class="bg-zinc-100 rounded-md flex items-center shadow-sm opacity-90"><button onclick="toggleLike(${m.id})" class="px-3 py-1 text-zinc-600 active:scale-90 transition-transform">${likeBtnText}</button><div class="w-[1px] h-3 bg-zinc-300"></div><button onclick="addComment(${m.id})" class="px-3 py-1 text-zinc-600 active:scale-90 transition-transform">ğŸ’¬</button></div></div>${commentsHtml}</div></div>`;
        }).join('');
    }

    function toggleLike(mid) { let m = mnts.find(x => x.id === mid); if(!m) return; if(!m.likes) m.likes = []; if(m.likes.includes('me')) { m.likes = m.likes.filter(x => x !== 'me'); } else { m.likes.push('me'); } saveAll(); renderMnts(); }
    function handleCommentClick(mid, targetUid, targetName) { if(targetUid === 'me') { if(confirm("åˆ é™¤è¿™æ¡è¯„è®ºï¼Ÿ")) { let m = mnts.find(x => x.id === mid); if(m && m.comments) { let idx = m.comments.findIndex(c => c.uid === 'me'); if(idx > -1) m.comments.splice(idx, 1); saveAll(); renderMnts(); } } return; } addComment(mid, targetUid, targetName); }
    function addComment(mid, replyToUid = null, replyToName = null) { let promptText = replyToName ? `å›å¤ ${replyToName}:` : "è¯„è®º:"; let content = prompt(promptText); if(!content) return; let m = mnts.find(x => x.id === mid); if(!m) return; if(!m.comments) m.comments = []; let newComment = { uid: 'me', content: content, time: Date.now() }; if(replyToUid && replyToName) { newComment.replyTo = replyToUid; newComment.replyToName = replyToName; } m.comments.push(newComment); saveAll(); renderMnts(); setTimeout(() => triggerAiReplyToComment(mid, content, replyToUid), 2000); }
    function delMoment(mid) { if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡æœ‹å‹åœˆå—ï¼Ÿ")) return; mnts = mnts.filter(x => x.id !== mid); saveAll(); renderMnts(); }
    function submitMoment() { let txt = $('in-m-t').value; let img = $('in-m-img').value; if(!txt && !img) return alert("å†™ç‚¹ä»€ä¹ˆå§"); let newId = Date.now(); mnts.unshift({ id: newId, r: 'u', content: txt, img: img, time: Date.now(), likes: [], comments: [] }); saveAll(); $('in-m-t').value = ''; $('in-m-img').value = ''; go('pg-wechat'); tab('moments'); setTimeout(() => triggerAiReaction(newId, txt), 2000); }
    function triggerRolePost(force = false) { if(!force) return; let r = roles[0]; if(!r) return; mnts.unshift({ id: Date.now(), r: r.id, content: `[${r.name}] æµ‹è¯•è‡ªåŠ¨å‘åœˆ`, img: "", time: Date.now(), likes:[], comments:[] }); saveAll(); renderMnts(); }

    // ================== 7. ä¸–ç•Œä¹¦ä¸è¡¨æƒ…åŒ… ==================
    function openWBEdit(id) { curWB = id ? wbs.find(x=>x.id===id) : null; $('in-wb-n').value = curWB ? curWB.name : ''; $('in-wb-c').value = curWB ? curWB.content : ''; selRids = curWB ? [...curWB.rids] : []; renderWBSelect(); go('pg-wb-edit'); }
    function renderWBSelect() { $('wb-roles-sel').innerHTML = roles.map(r => `<div onclick="toggleWBR('${r.id}', this)" class="role-chip px-4 py-1.5 rounded-full text-xs cursor-pointer ${selRids.includes(r.id)?'selected':''}">${r.name}</div>`).join(''); }
    function toggleWBR(id, el) { if(selRids.includes(id)) { selRids = selRids.filter(x=>x!==id); el.classList.remove('selected'); } else { selRids.push(id); el.classList.add('selected'); } }
    function saveWB() { let b = { id: curWB?curWB.id:Date.now(), name:$('in-wb-n').value, content:$('in-wb-c').value, rids:selRids }; if(curWB) wbs = wbs.map(x=>x.id===curWB.id?b:x); else wbs.push(b); saveAll(); go('pg-wb'); }
    function renderWBList() { $('wb-list-box').innerHTML = wbs.map(b => `<div class="p-4 bg-white rounded-xl shadow-sm flex justify-between items-center"><div><b>${b.name}</b><p class="text-[10px] text-zinc-400 mt-1">ç»‘å®š: ${b.rids.length}</p></div><button onclick="openWBEdit(${b.id})" class="text-blue-500">ç¼–è¾‘</button></div>`).join(''); }
    
    function addEmj() { let u=prompt("å›¾ç‰‡ç›´é“¾"), n=prompt("å«ä¹‰"); if(u&&n){ emjs.push({url:u,note:n}); saveAll(); renderEmj(); } }
    function renderEmj() { $('emj-box').innerHTML = emjs.map((e,i)=>`<div class="relative"><img src="${e.url}" class="w-full h-14 object-cover border rounded-lg"><span onclick="emjs.splice(${i},1);saveAll();renderEmj()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">Ã—</span></div>`).join(''); }
    
    function closeAllMenus() { }

   // ================== 8. è§’è‰²ç®¡ç†ä¸è®°å¿†æ®¿å ‚ ==================
    function renderCont() { $('sub-cont').innerHTML = roles.map(r => `<div class="p-4 flex justify-between items-center bg-white active:bg-zinc-50 border-b"><div class="flex items-center gap-3"><img src="${r.ava}" class="w-10 h-10 rounded-lg bg-zinc-100"><b>${r.name}</b></div><button onclick="openRoleEdit('${r.id}')" class="text-blue-500 text-xs border border-blue-200 px-3 py-1 rounded-full">è®¾å®š</button></div>`).join(''); }
    function openRoleEdit(id) { curRole = id ? roles.find(x=>x.id==id) : null; $('in-r-n').value = curRole ? curRole.name : ''; $('in-r-a').value = curRole ? curRole.ava : ''; $('in-r-i').value = curRole ? curRole.info : ''; $('del-role-btn').style.display = curRole ? 'block' : 'none'; go('pg-role-edit'); }
    function saveRole() { let r = { id: curRole?curRole.id:Date.now(), name:$('in-r-n').value, ava:$('in-r-a').value, info:$('in-r-i').value, history: curRole?curRole.history:[] }; if(curRole) roles = roles.map(x=>x.id===curRole.id?r:x); else roles.push(r); saveAll(); go('pg-wechat'); tab('cont'); }
    function deleteRole() { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")){ roles=roles.filter(x=>x.id!==curRole.id); chats=chats.filter(id=>id!==curRole.id); saveAll(); go('pg-wechat'); tab('cont'); } }
    
    function renderMemPage() { let html = roles.map(r => { if (!r.memories || r.memories.length === 0) return ''; let volumes = []; for (let i = 0; i < r.memories.length; i += 10) { let chunk = r.memories.slice(i, i + 10); let volNum = Math.floor(i / 10) + 1; let contentHtml = chunk.map((m, idx) => `<div class="mb-2 text-sm text-zinc-600 border-b border-dashed pb-2"><b class="text-yellow-600">${i + idx + 1}:</b> ${m}</div>`).join(''); volumes.push(`<details class="mb-2 ml-4"><summary class="text-sm font-bold text-zinc-500 cursor-pointer p-2 hover:bg-zinc-100 rounded select-none">ğŸ“œ ç¬¬ ${volNum} å· (è®°å½• ${i+1}-${i+chunk.length})</summary><div class="p-3 bg-zinc-50 rounded-lg mt-1 border border-zinc-200">${contentHtml}</div></details>`); } return `<details class="bg-white p-4 rounded-xl shadow-sm group mb-4"><summary class="flex items-center gap-3 cursor-pointer list-none select-none"><img src="${r.ava}" class="w-10 h-10 rounded-lg bg-zinc-100"><div class="flex-1 font-bold text-lg text-zinc-800">${r.name}</div><span class="text-xs text-zinc-400 bg-zinc-100 px-2 py-1 rounded-full">å…± ${r.memories.length} æ¡</span><span class="transition-transform group-open:rotate-90">â–¶</span></summary><div class="mt-4 border-t pt-2 space-y-1">${volumes.join('')}</div></details>`; }).join(''); $('memory-list').innerHTML = html || '<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— è®°å¿†æ¡£æ¡ˆ<br>å¤šèŠèŠå¤©ï¼Œå½“å¯¹è¯è¶…è¿‡20æ¡æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ...</div>'; }
    async function summarizeMemory() { let cfg = await getAICfg(); if (!cfg.key) return; let earlyMsgs = curRole.history.slice(0, 10); let chatText = earlyMsgs.map(m => (m.r === 'u' ? 'ç”¨æˆ·:' : 'ä½ :') + m.t).join('\n'); let prompt = `å‰§æƒ…æ‘˜è¦:\n${chatText}\n\næ¦‚æ‹¬ä¸ºç®€ç»ƒçš„å‰§æƒ…ï¼Œç¬¬ä¸‰äººç§°ï¼Œ100å­—å†…ã€‚`; try { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] }) }); let data = await res.json(); let newSummary = data.choices[0].message.content; if (!curRole.memories) curRole.memories = []; curRole.memories.push(newSummary); curRole.history.splice(0, 10); saveAll(); } catch (e) { console.error(e); } }

    // ================== 9. å°å‰§åœºç³»ç»Ÿ (ç« èŠ‚ä¸é‡å†™) ==================
    function initTheaterCreate() { const sel = $('th-role-sel'); sel.innerHTML = roles.map(r => `<option value="${r.id}">${r.name}</option>`).join(''); if(roles.length === 0) sel.innerHTML = '<option disabled>è¯·å…ˆå»é€šè®¯å½•æ·»åŠ è§’è‰²</option>'; }
    function renderTheaterList() { const list = $('theater-list'); if (theaters.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-32 opacity-50"><div class="text-6xl mb-4">ğŸ“š</div><div class="text-sm text-zinc-500">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</div></div>`; return; } let sorted = theaters.sort((a,b) => b.createTime - a.createTime); list.innerHTML = sorted.map(t => { let r = roles.find(x => x.id == t.roleId); let roleName = r ? r.name : (t.roleName || 'æœªçŸ¥'); let roleJob = t.roleJob || 'ä¸»è§’'; let ava = r ? r.ava : 'https://img.icons8.com/color/96/user.png'; let fullText = getFullText(t); let excerpt = fullText.slice(0, 45).replace(/\n/g, ' ') + '...'; return `<div onclick="openTheater(${t.id})" class="bg-white p-4 rounded-xl border border-zinc-100 shadow-sm flex gap-4 cursor-pointer active:scale-[0.98] transition-all hover:shadow-md group"><div class="relative w-16 h-24 shrink-0 bg-zinc-200 rounded overflow-hidden shadow-inner"><img src="${ava}" class="w-full h-full object-cover opacity-90 group-hover:scale-110 transition-transform duration-500"><div class="absolute bottom-1 left-1 text-[10px] text-white font-light">å‰§æœ¬</div></div><div class="flex-1 min-w-0 flex flex-col py-0.5"><div class="flex justify-between items-start"><h3 class="font-bold text-[16px] text-zinc-800 truncate pr-2">${t.title || 'æ— é¢˜å‰§æœ¬'}</h3></div><p class="text-xs text-[#576b95] mt-1 font-medium">${roleName} <span class="text-zinc-400">é¥°</span> ${roleJob}</p><p class="text-sm text-zinc-400 mt-2 leading-tight line-clamp-2">${excerpt}</p></div></div>`; }).join(''); }
    function getFullText(theater) { if (!theater) return ""; if (Array.isArray(theater.chapters)) { return theater.chapters.map(c => c.text).join('\n\n'); } return theater.content || ""; }
    
    async function startTheaterGen() {
        const roleId = $('th-role-sel').value; const roleJob = $('th-role-job').value || "æœªçŸ¥"; const userJob = $('th-user-job').value || "æ™®é€šäºº"; const promptText = $('th-prompt').value;
        if (!roleId || !promptText) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        let role = roles.find(r => r.id == roleId); let cfg = await getAICfg(); if (!cfg.key) return alert("è¯·å…ˆè®¾ç½® API Key");
        let btn = $('btn-create-th'); btn.innerText = "ç”Ÿæˆä¸­..."; btn.disabled = true; btn.classList.add('opacity-50');
        let newTheater = { id: Date.now(), roleId: role.id, roleName: role.name, roleJob: roleJob, title: promptText.slice(0, 8) + "...", context: `ã€è§’è‰²æ€§æ ¼åŸå‹ã€‘ï¼š${role.name}ï¼ˆæ€§æ ¼å‚è€ƒï¼š${role.info}ï¼‰ã€‚\nã€è®¾å®šã€‘ï¼šèƒŒæ™¯å®Œå…¨ä»¥â€œ${promptText}â€ä¸ºå‡†ã€‚${role.name}ç°åœ¨çš„èº«ä»½æ˜¯${roleJob}ï¼Œæˆ‘æ˜¯${userJob}ã€‚`, prompt: promptText, chapters: [], createTime: Date.now() };
        const sysPrompt = `ä½ æ˜¯ä¸€ä½ç•…é”€å°è¯´å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ã€å¹³è¡Œå®‡å®™è®¾å®šã€‘å†™ä¸€ç¯‡å°è¯´çš„ç¬¬ä¸€ç« ã€‚\nã€æ ¸å¿ƒæŒ‡ä»¤ã€‘\nç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚**ä¸¥ç¦**è¾“å‡ºåºŸè¯æˆ– <think> æ ‡ç­¾ã€‚\nã€å†™ä½œè¦æ±‚ã€‘\né¢˜ç›®è‡ªæ‹Ÿï¼ˆç¬¬ä¸€è¡Œè¾“å‡ºé¢˜ç›®ï¼‰ã€‚æ­£æ–‡çº¦800å­—ã€‚`;
        try {
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `ã€æ–°å‰§æœ¬å¤§çº²ã€‘ï¼š${newTheater.prompt}\nã€è§’è‰²è®¾å®šã€‘ï¼š${newTheater.context}` }] }) });
            let data = await res.json(); 
            let content = cleanText(data.choices[0].message.content);
            let lines = content.split('\n'); let firstLine = lines[0].replace(/[#ã€Šã€‹]/g, '').trim();
            if(firstLine.length < 20) newTheater.title = firstLine;
            newTheater.chapters.push({ id: Date.now(), text: content }); theaters.unshift(newTheater); saveAll(); openTheater(newTheater.id);
        } catch (e) { alert("ç”Ÿæˆå¤±è´¥: " + e.message); } finally { btn.innerText = "å¼€å§‹ç”Ÿæˆ"; btn.disabled = false; btn.classList.remove('opacity-50'); }
    }

    function openTheater(tid) { curTheater = theaters.find(t => t.id == tid); if(!curTheater) return; $('th-read-title').innerText = curTheater.title; if (!curTheater.chapters) { curTheater.chapters = [{ id: Date.now(), text: curTheater.content || "" }]; delete curTheater.content; saveAll(); } renderReaderContent(); updateCatalogList(); go('pg-theater-read'); }
    function renderReaderContent() {
        const contentDiv = $('th-read-content'); contentDiv.innerHTML = "";
        curTheater.chapters.forEach((chap, idx) => {
            let chapDiv = document.createElement('div'); chapDiv.id = `chap-${idx}`; chapDiv.className = "mb-10 pb-6 border-b border-[#eaddcf]/50";
            let chapHeader = document.createElement('div'); chapHeader.className = "text-xs text-[#8c7b6c] mb-4 font-bold flex justify-between items-center select-none"; chapHeader.innerHTML = `<span>â€”â€” ç¬¬ ${idx+1} ç«  â€”â€”</span>`;
            let retryBtn = document.createElement('span'); retryBtn.className = "cursor-pointer text-blue-400 hover:text-blue-600 px-2"; retryBtn.innerText = "ğŸ”„ é‡å†™"; retryBtn.onclick = () => retryChapter(idx); chapHeader.appendChild(retryBtn);
            let textDiv = document.createElement('div'); let htmlText = chap.text.split('\n').map(line => { line = line.trim(); if(!line) return '<br>'; return `<p class="mb-4 indent-8">${line}</p>`; }).join(''); textDiv.innerHTML = htmlText;
            chapDiv.appendChild(chapHeader); chapDiv.appendChild(textDiv); contentDiv.appendChild(chapDiv);
        });
        const badge = $('chapter-count-badge'); badge.innerText = curTheater.chapters.length; badge.classList.remove('hidden');
    }
    
    function toggleCatalog() { const drawer = $('catalog-drawer'); if(drawer.classList.contains('active')) drawer.classList.remove('active'); else { updateCatalogList(); drawer.classList.add('active'); } }
    function updateCatalogList() { 
        if(!curTheater || !curTheater.chapters) return; 
        $('catalog-list').innerHTML = curTheater.chapters.map((c, idx) => { 
            let preview = c.text.slice(0, 15).replace(/\n/g, '') + "..."; 
            return `<div class="chapter-item group"><div onclick="jumpToChapter(${idx})" class="flex flex-col flex-1 min-w-0"><span class="text-sm font-bold text-zinc-700">ç¬¬ ${idx+1} ç« </span><span class="text-xs text-zinc-400 mt-1 truncate">${preview}</span></div><div class="flex items-center gap-3"><span onclick="jumpToChapter(${idx})" class="text-xs text-zinc-300 cursor-pointer">GO</span><span onclick="event.stopPropagation(); deleteChapter(${idx})" class="text-zinc-300 hover:text-red-500 cursor-pointer px-2 py-1">ğŸ—‘ï¸</span></div></div>`; 
        }).join(''); 
    }
    function deleteChapter(idx) { if(!confirm(`ç¡®å®šè¦åˆ é™¤â€œç¬¬ ${idx+1} ç« â€å—ï¼Ÿ`)) return; curTheater.chapters.splice(idx, 1); saveAll(); renderReaderContent(); updateCatalogList(); if(curTheater.chapters.length === 0) toggleCatalog(); }
    function jumpToChapter(idx) { toggleCatalog(); const target = $(`chap-${idx}`); if(target) { target.scrollIntoView({ behavior: 'smooth', block: 'start' }); target.classList.add('bg-yellow-50/50'); setTimeout(() => target.classList.remove('bg-yellow-50/50'), 1000); } }
    
    async function retryChapter(idx) {
        if(!confirm(`ç¡®å®šè¦é‡å†™ç¬¬ ${idx+1} ç« å—ï¼Ÿ`)) return; let cfg = await getAICfg(); if (!cfg.key) return alert("API Key æœªè®¾ç½®");
        let prevText = ""; for(let i=0; i<idx; i++) { prevText += curTheater.chapters[i].text + "\n"; } let contextText = prevText.slice(-3000);
        const chapDiv = $(`chap-${idx}`); const originalContent = chapDiv.innerHTML; chapDiv.innerHTML = `<div class="p-10 flex flex-col items-center justify-center text-[#8c7b6c] animate-pulse"><div class="text-2xl mb-2">âœï¸</div><div>AI æ­£åœ¨é‡æ„æ€è·¯...</div></div>`;
        const sysPrompt = `ä½ æ˜¯ä¸€ä½å°è¯´å®¶ã€‚è¯·é‡å†™è¿™ä¸€ç« èŠ‚ã€‚\nã€è®¾å®šã€‘ï¼š${curTheater.context}\nã€è¦æ±‚ã€‘ï¼š1. æ‰¿æ¥ä¸Šæ–‡ï¼Œé€»è¾‘è¿è´¯ã€‚2. ä¸¥ç¦åºŸè¯å’Œæ€è€ƒæ ‡ç­¾ï¼Œåªè¾“å‡ºæ­£æ–‡ã€‚3. ä¿æŒè®¾å®šã€‚`;
        try {
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `ã€å‰æƒ…å›é¡¾ã€‘ï¼š${contextText || "æ— å‰æ–‡"}\n\nè¯·é‡å†™æœ¬ç« ï¼š` }] }) });
            let data = await res.json(); let newText = cleanText(data.choices[0].message.content); curTheater.chapters[idx].text = newText; saveAll(); renderReaderContent(); setTimeout(() => jumpToChapter(idx), 100);
        } catch (e) { alert("é‡å†™å¤±è´¥: " + e.message); chapDiv.innerHTML = originalContent; }
    }
    async function continueTheater() {
        if(!curTheater) return; let cfg = await getAICfg(); let btn = $('btn-th-continue'); btn.innerHTML = `æ­£åœ¨æ„æ€...`; btn.disabled = true;
        let fullText = getFullText(curTheater); let contextText = fullText.slice(-4000);
        const sysPrompt = `ä½ æ˜¯ä¸€ä½å°è¯´å®¶ã€‚è¯·ç»§ç»­ç»­å†™ä¹‹å‰çš„æ•…äº‹ã€‚\nã€è®¾å®šã€‘\n${curTheater.context}\nã€è¦æ±‚ã€‘\nç›´æ¥è¾“å‡ºå°è¯´æ­£æ–‡ã€‚è¾“å‡ºçº¦800å­—ã€‚`;
        try {
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `ã€å‰æ–‡ã€‘ï¼š...${contextText}\n\nè¯·ç»§ç»­å†™ï¼š` }] }) });
            let data = await res.json(); let newText = cleanText(data.choices[0].message.content); curTheater.chapters.push({ id: Date.now(), text: newText }); saveAll(); renderReaderContent(); $('th-read-content').scrollTop = $('th-read-content').scrollHeight;
        } catch (e) { alert("ç»­å†™å¤±è´¥: " + e.message); } finally { btn.innerHTML = `âœï¸ ç»­å†™ä¸‹ä¸€ç« `; btn.disabled = false; }
    }
    function deleteTheater() { if(confirm("ç¡®å®šè¦æŠŠè¿™æœ¬å°è¯´ä»ä¹¦æ¶ç§»é™¤å—ï¼Ÿ")) { theaters = theaters.filter(t => t.id !== curTheater.id); saveAll(); go('pg-theater'); } }
    function copyTheater() { let text = getFullText(curTheater); if(text) navigator.clipboard.writeText(text).then(()=>alert("å·²å¤åˆ¶å…¨æ–‡")); }
    // ================== 10. èŠå¤©ç³»ç»Ÿ (å®Œæ•´é‡æ„ç‰ˆ) ==================
    function applyChatBg() { if(curRole && curRole.chatBg) { $('chat-msgs').style.backgroundImage = `url('${curRole.chatBg}')`; } else { $('chat-msgs').style.backgroundImage = 'none'; } }
    function setChatBg() { let url = prompt("è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL:", (curRole && curRole.chatBg) ? curRole.chatBg : ""); if(url !== null) { if(curRole) { curRole.chatBg = url; saveAll(); applyChatBg(); } } }
    function enterChat(id) { 
        try {
            curRole = roles.find(x => x.id == id); 
            if (!curRole) { alert("æ•°æ®å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨ä¿®å¤"); chats = chats.filter(c => c != id); saveAll(); renderChatList(); return; }
            if(!chats.includes(curRole.id)) { chats.unshift(curRole.id); saveAll(); } 
            
            if (!curRole.mode) curRole.mode = 'chat'; 
            
            // è·¯ç”±åˆ†å‘ï¼šåˆ¤æ–­è¯¥è§’è‰²ä¸Šæ¬¡æ˜¯åœ¨å¾®ä¿¡é‡Œï¼Œè¿˜æ˜¯åœ¨çº¿ä¸‹è§é¢ä¸­
            if (curRole.mode === 'story') {
                $('story-user-name').innerText = `ä¸ ${curRole.name} çº¿ä¸‹è§é¢`;
                go('pg-story-room');
            } else {
                $('chat-user-name').innerText = curRole.name; 
                updateChatModeUI(); 
                applyChatBg(); 
                go('pg-chat-room'); 
            }
            renderMsgs(); 
        } catch (e) { alert("è¿›å…¥èŠå¤©å¤±è´¥: " + e.message); }
    }
    function toggleChatMode() { if (!curRole) return; curRole.mode = (curRole.mode === 'story') ? 'chat' : 'story'; saveAll(); updateChatModeUI(); renderMsgs(); }
        function updateChatModeUI() { 
        if (!curRole) return; 
        // å› ä¸ºçº¿ä¸Šå’Œçº¿ä¸‹å·²ç»å½»åº•åˆ†ç¦»ä¸ºä¸¤ä¸ªé¡µé¢ï¼Œè¿™é‡Œåªéœ€è¦å›ºå®šæ˜¾ç¤ºå¾®ä¿¡çš„çŠ¶æ€å³å¯
        let modeTag = $('chat-mode-tag');
        if(modeTag) {
            modeTag.innerText = 'çŸ­å¥æ¨¡å¼'; 
            modeTag.className = "text-[10px] text-zinc-400"; 
        }
        let chatIn = $('chat-in');
        if(chatIn) {
            chatIn.placeholder = "è¾“å…¥æ¶ˆæ¯..."; 
        }
    }
    
    function togglePnl(type) { const pnl = $('chat-pnl'); const isOpen = pnl.classList.contains('drawer-open'); if (isOpen && lastPnlType === type) { pnl.classList.remove('drawer-open'); lastPnlType = null; } else { pnl.classList.add('drawer-open'); lastPnlType = type; if (type === 'emoji') renderEmjPnl(); else renderToolsPnl(); } }
    function renderEmjPnl() { if (emjs.length === 0) { $('chat-pnl').innerHTML = `<div class="text-center text-zinc-300 text-xs py-10">æš‚æ— è¡¨æƒ…åŒ…<br>å»â€œæˆ‘-è¡¨æƒ…åŒ…ç®¡ç†â€æ·»åŠ ä¸€äº›å§~</div>`; return; } $('chat-pnl').innerHTML = `<div class="grid grid-cols-5 gap-4 p-4">${emjs.map(e => `<img src="${e.url}" onclick="handleSendMsg('${e.url}','image'); $('chat-pnl').classList.remove('drawer-open');" class="w-full h-14 object-contain bg-white rounded-lg border border-zinc-100 p-1 active:scale-95 transition-transform shadow-sm cursor-pointer">`).join('')}</div>`; }
         function renderToolsPnl() {
        $('chat-pnl').innerHTML = `
            <div class="grid grid-cols-4 gap-6 p-6">
                <div onclick="startTransfer()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center border border-zinc-200 shadow-sm"><span class="text-2xl">ğŸ§§</span></div><span class="text-xs text-zinc-500">è½¬è´¦</span></div>
                <div onclick="openTakeoutFromChat()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-[#FFD101] rounded-xl flex items-center justify-center border border-yellow-300 shadow-sm"><span class="text-2xl">ğŸ¥¡</span></div><span class="text-xs text-zinc-500">ç‚¹å¤–å–</span></div>
                <div onclick="openShopFromChat()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-[#ff6700] rounded-xl flex items-center justify-center border border-orange-300 shadow-sm"><span class="text-2xl">ğŸ›ï¸</span></div><span class="text-xs text-zinc-500">é€›å•†åœº</span></div>
                <div onclick="openDiaryPage()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70"><div class="w-14 h-14 bg-blue-50 rounded-xl flex items-center justify-center border border-blue-200 shadow-sm"><span class="text-2xl">ğŸ“–</span></div><span class="text-xs text-zinc-500">æ—¥è®°</span></div>
                                <div onclick="toMusicTab('player'); go('pg-music-player')" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70">
                    <div class="w-14 h-14 bg-pink-50 border-pink-200 rounded-xl flex items-center justify-center border shadow-sm"><span class="text-2xl">ğŸµ</span></div>
                    <span class="text-xs text-zinc-500">éŸ³ä¹</span>
                </div>
                <div onclick="enterStoryRoom()" class="flex flex-col items-center gap-2 cursor-pointer active:opacity-70">
                    <div class="w-14 h-14 bg-purple-50 border-purple-200 rounded-xl flex items-center justify-center border shadow-sm"><span class="text-2xl">ğŸƒ</span></div>
                    <span class="text-xs text-zinc-500">çº¿ä¸‹è§é¢</span>
                </div>
            </div>`;
    }

    // --- è¿›å…¥/é€€å‡º çº¿ä¸‹äº’åŠ¨é¡µé¢çš„æ ¸å¿ƒæ§åˆ¶ ---
        function enterStoryRoom() {
        if (!curRole) return;
        $('chat-pnl').classList.remove('drawer-open');
        lastPnlType = null;
        
        curRole.mode = 'story';
        $('story-user-name').innerText = `ä¸ ${curRole.name} çº¿ä¸‹è§é¢`;
        
        // æ ¸å¿ƒï¼šåŠ ä¸Š scene: 'story' æ ‡ç­¾
        curRole.history.push({ r: 'system', t: 'ã€ç³»ç»Ÿæç¤ºï¼šä½ ä»¬çš„åœºæ™¯å·²åˆ‡æ¢è‡³çº¿ä¸‹å®ä½“è§é¢ï¼å°±åœ¨æ­¤åˆ»ï¼è¯·æ ¹æ®å½“é¢ç¯å¢ƒè¿›è¡ŒçœŸå®çš„åŠ¨ä½œã€ç¥æ€å’Œè¯­è¨€äº’åŠ¨ï¼Œç»å¯¹ä¸è¦å†åƒå‘å¾®ä¿¡ä¸€æ ·èŠå¤©ï¼ã€‘', type: 'system', scene: 'story' });
        saveAll();
        
        go('pg-story-room');
        renderMsgs();
    }

    function exitStoryMode() {
        if (!curRole) return;
        curRole.mode = 'chat';
        
        // æ ¸å¿ƒï¼šåŠ ä¸Š scene: 'chat' æ ‡ç­¾
        curRole.history.push({ r: 'system', t: 'ã€ç³»ç»Ÿæç¤ºï¼šçº¿ä¸‹è§é¢å·²ç»“æŸï¼Œä½ ä»¬å„è‡ªå›å®¶äº†ã€‚ç°åœ¨ä½ ä»¬æ­£åœ¨é€šè¿‡å¾®ä¿¡çº¿ä¸ŠèŠå¤©ã€‚åªèƒ½æ‰“å­—ï¼Œç»å¯¹ä¸è¦è¾“å‡ºä»»ä½•åŠ¨ä½œæå†™ï¼ã€‘', type: 'system', scene: 'chat' });
        saveAll();
        
        updateChatModeUI();
        applyChatBg();
        go('pg-chat-room');
        renderMsgs();
    }

    function exitStoryMode() {
        if (!curRole) return;
        curRole.mode = 'chat';
        
        // æ ¸å¿ƒï¼šå¼ºè¡Œæ³¨å…¥ç³»ç»Ÿæç¤ºï¼Œå‘Šè¯‰AIçº¿ä¸‹ç»“æŸï¼Œå„è‡ªå›å®¶ç”¨å¾®ä¿¡äº†ï¼
        curRole.history.push({ r: 'system', t: 'ã€ç³»ç»Ÿæç¤ºï¼šçº¿ä¸‹è§é¢å·²ç»“æŸï¼Œä½ ä»¬å„è‡ªå›å®¶äº†ã€‚ç°åœ¨ä½ ä»¬æ­£åœ¨é€šè¿‡å¾®ä¿¡çº¿ä¸ŠèŠå¤©ã€‚åªèƒ½æ‰“å­—ï¼Œç»å¯¹ä¸è¦è¾“å‡ºä»»ä½•åŠ¨ä½œæå†™ï¼ã€‘', type: 'system' });
        saveAll();
        
        updateChatModeUI();
        applyChatBg();
        go('pg-chat-room');
        renderMsgs();
    }
    function openShopFromChat() { if (!curRole) return; takeoutCtx = { fromChat: true, targetRoleId: curRole.id }; $('chat-pnl').classList.remove('drawer-open'); toShopTab('home'); go('pg-shop-home'); }
    function openTakeoutFromChat() { if (!curRole) return; takeoutCtx = { fromChat: true, targetRoleId: curRole.id }; $('chat-pnl').classList.remove('drawer-open'); toTakeoutTab('home'); go('pg-takeout-home'); }

    // è½¬è´¦é€»è¾‘
    function startTransfer() { $('chat-pnl').classList.remove('drawer-open'); lastPnlType = null; let val = prompt("è¯·è¾“å…¥è½¬è´¦é‡‘é¢:"); if (val === null) return; let amt = parseFloat(val); if (isNaN(amt) || amt <= 0.01) return alert("é‡‘é¢æ ¼å¼ä¸æ­£ç¡®"); if (amt > balance) return alert(`å¾®ä¿¡é›¶é’±ä¸è¶³ï¼å½“å‰åªæœ‰ Â¥${balance.toFixed(2)}`); balance -= amt; saveAll(); handleSendMsg(amt.toFixed(2), 'transfer'); }
    function openTransferDetail(idx) { curMsgIdx = idx; let msg = curRole.history[idx]; $('tx-amount').innerText = parseFloat(msg.t).toFixed(2); let statusEl = $('tx-status'), iconEl = $('tx-icon'), btnReceive = $('btn-tx-receive'), linkReturn = $('link-tx-return'), infoBox = $('tx-info-box'); btnReceive.classList.add('hidden'); linkReturn.classList.add('hidden'); infoBox.classList.add('hidden'); statusEl.className = "text-xl mb-2 text-[#f79c4a]"; if (msg.status === 'received') { statusEl.innerText = "å·²æ”¶æ¬¾"; statusEl.className = "text-xl mb-2 text-zinc-500"; iconEl.innerText = "âœ”"; infoBox.classList.remove('hidden'); $('tx-time-rcv').innerText = msg.rcvTime || 'æœªçŸ¥'; } else if (msg.status === 'returned') { statusEl.innerText = "å·²é€€è¿˜"; statusEl.className = "text-xl mb-2 text-red-500"; iconEl.innerText = "â†©"; infoBox.classList.remove('hidden'); $('tx-time-rcv').innerText = "å·²åŸè·¯é€€å›"; } else { if (msg.r === 'ai') { statusEl.innerText = "å¾…ä½ æ”¶æ¬¾"; iconEl.innerText = "ğŸ’°"; btnReceive.classList.remove('hidden'); linkReturn.classList.remove('hidden'); } else { statusEl.innerText = `ç­‰å¾… ${curRole.name} ç¡®è®¤æ”¶æ¬¾`; iconEl.innerText = "â³"; } } go('pg-transfer-detail'); }
    function doReceiveTransfer() { if (curMsgIdx === -1) return; let msg = curRole.history[curMsgIdx]; if (msg.status !== 'pending') return; balance += parseFloat(msg.t); msg.status = 'received'; msg.rcvTime = new Date().toLocaleString(); curRole.history.push({ r: 'system', t: `ä½ å·²æ”¶æ¬¾`, type: 'system' }); saveAll(); renderWallet(); renderMsgs(); openTransferDetail(curMsgIdx); }
    function doReturnTransfer() { if (curMsgIdx === -1) return; let msg = curRole.history[curMsgIdx]; if (msg.status !== 'pending') return; msg.status = 'returned'; msg.rcvTime = new Date().toLocaleString(); curRole.history.push({ r: 'system', t: `ä½ é€€è¿˜äº†${curRole.name}çš„è½¬è´¦`, type: 'system' }); saveAll(); renderMsgs(); openTransferDetail(curMsgIdx); }

         // æ ¸å¿ƒæ”¶å‘æ¶ˆæ¯é€»è¾‘
    async function handleSendMsg(customVal, type='text', isRetry=false) {
                let txt = customVal;
        if (!txt) {
            txt = (curRole.mode === 'story') ? $('story-in').value : $('chat-in').value;
        }
        let targetRole = curRole;
        
        if (txt || type !== 'text') {
            if (!isRetry) { 
                let newMsg = { r: 'u', t: txt, type: type, status: 'pending', time: new Date().toLocaleString(), scene: curRole.mode };
                targetRole.history.push(newMsg);
            }
            if (!customVal) {
                if (curRole.mode === 'story') $('story-in').value = '';
                else $('chat-in').value = '';
            }
            renderMsgs(); 
            if (!isRetry) return; 
        } else {
            if (targetRole.history.length > 0 && targetRole.history[targetRole.history.length-1].loading) return;
        }

        let cfg = await getAICfg(); 
        let globalUser = await dbGet('OS67_U', {}); 
        let worldCtx = wbs.filter(b => b.rids?.includes(targetRole.id)).map(b => b.content).join('\n'); 
        let mask = targetRole.userMask || {}; 
        let effectiveUser = { name: mask.name || globalUser.name || "ç”¨æˆ·", info: mask.info || "æ™®é€šç”¨æˆ·" }; 
        let longTermMem = targetRole.memories ? `è®°å¿†:${targetRole.memories.slice(-3).join('; ')}` : '';
        
        let modeSysPrompt = ""; let modeReinforce = "";
        if (targetRole.mode === 'story') { 
            if (targetRole.isGroup) {
                // ğŸ¯ æ ¸å¿ƒä¿®æ”¹ï¼šå½»åº•ç¦æ­¢ AI ä½¿ç”¨ç¾¤èŠå‰ç¼€æ ¼å¼ï¼Œå¹¶å¼ºåˆ¶è§’è‰²é—´äº’åŠ¨
                modeSysPrompt = `ã€æ¨¡å¼:çº¿ä¸‹æ²‰æµ¸å¼å¤šæ–¹äº’åŠ¨å°è¯´ã€‘
1. æ ¸å¿ƒçŠ¶æ€ï¼šä½ ä»¬ç°åœ¨æ­£ã€èšåœ¨ä¸€èµ·ã€‘çº¿ä¸‹è§é¢ã€‚
2. **å¼ºåˆ¶è¦æ±‚ï¼šè§’è‰²é—´äº’åŠ¨**ã€‚ä¸ä»…è¦å’Œç”¨æˆ·äº’åŠ¨ï¼Œã€è§’è‰²ä¸è§’è‰²ä¹‹é—´ã€‘å¿…é¡»äº§ç”Ÿæ¥è¯ã€çœ¼ç¥äº¤æµæˆ–åŠ¨ä½œç¢°æ’ã€‚
3. **æ§åˆ¶ç¯‡å¹…**ï¼šé¿å…å•ä¸ªè§’è‰²è¾“å‡ºè¿‡é•¿çš„æ–‡å­¦æå†™ã€‚å¢åŠ å¯¹è¯é¢‘ç‡ã€‚
4. **ã€æœ€é‡è¦æ’ç‰ˆè§„åˆ™ã€‘**ï¼šè¿™æ˜¯ä¸€ç¯‡è¿ç»­çš„å°è¯´ï¼è¯·æ— è§†ä½ åº•å±‚çš„â€œè§’è‰²åï¼šâ€ç¾¤èŠè§„åˆ™ï¼**ç»å¯¹ä¸è¦**åœ¨æ®µè½å¼€å¤´åŠ â€œè§’è‰²åï¼šâ€è¿™ç§ç½‘èŠå‰ç¼€ï¼è¯·ç›´æ¥æŠŠè§’è‰²åå­—è‡ªç„¶åœ°æ‰è¿›å¥å­é‡Œï¼Œæ¯”å¦‚å†™æˆï¼šâ€œå¼ ä¸‰é åœ¨æ²™å‘ä¸Šç¬‘ç€è¯´ï¼šâ€˜...â€™â€`;
                modeReinforce = `(Systemå¼ºåˆ¶ï¼šè¿™æ˜¯å¤šäººç¾¤èšçš„å®ä½“å°è¯´æ¨¡å¼ï¼ç¦æ­¢ä½¿ç”¨â€œåå­—ï¼šâ€å‰ç¼€ï¼Œç›´æ¥æŠŠåå­—å†™è¿›å¥å­é‡Œæå†™åŠ¨ä½œå’Œè¯­è¨€ï¼è§’è‰²ä¹‹é—´å¿…é¡»æœ‰äº’åŠ¨ï¼)`;
            } else {
                modeSysPrompt = `ã€æ¨¡å¼:æ²‰æµ¸å¼çº¿ä¸‹äº’åŠ¨ã€‘\n1. è¯·ä½¿ç”¨å‡ºç‰ˆçº§å°è¯´ç¬”æ³•ï¼ŒåŠ¨ä½œæå†™å¿…é¡»ä¸°å¯Œã€‚\n2. æ ¸å¿ƒçŠ¶æ€ï¼šä½ ä»¬ç°åœ¨æ˜¯ã€çº¿ä¸‹ç‰©ç†è§é¢ã€‘çŠ¶æ€ã€‚\n3. **ä¸¥ç¦**è¾“å‡ºç±»ä¼¼â€œ# åœ°ç‚¹â€ã€â€œ[æ—¶é—´]â€çš„åœºæ™¯æ ‡è®°ï¼Œç›´æ¥è¾“å‡ºæ­£æ–‡ï¼`; 
                modeReinforce = `(Systemå¼ºåˆ¶ï¼šå½“å‰æ˜¯çº¿ä¸‹å®ä½“äº’åŠ¨ï¼Œè¯·åŒ…å«ä¸°å¯Œçš„åŠ¨ä½œæå†™)`;
            }
        } else { 
            modeSysPrompt = `ã€æ¨¡å¼:çº¿ä¸Šå¾®ä¿¡çŸ­èŠã€‘\n1. æ ¸å¿ƒçŠ¶æ€ï¼šä½ ä»¬ç°åœ¨æ˜¯ã€éš”ç€æ‰‹æœºå±å¹•ã€‘çš„çº¿ä¸Šç½‘èŠçŠ¶æ€ï¼\n2. ç»å¯¹ç¦æ­¢ç¯å¢ƒ/åŠ¨ä½œæå†™ï¼ç»å¯¹ä¸èƒ½å‡ºç°â€œæŠ±ä½ä½ â€ã€â€œæ‘¸å¤´â€ç­‰çº¿ä¸‹åŠ¨ä½œã€‚\n3. å°±åƒåœ¨å¾®ä¿¡æ‰“å­—ä¸€æ ·ï¼Œç®€çŸ­ã€å£è¯­åŒ–ã€‚`; 
            modeReinforce = `(Systemå¼ºåˆ¶ï¼šç°åœ¨æ˜¯æ‰‹æœºèŠå¤©ï¼éš”ç€å±å¹•ï¼Œç»å¯¹ç¦æ­¢å†™å‡ºåŠ¨ä½œï¼åªèƒ½æ‰“å­—ï¼)`;
        }
        
       let loadingMsg = { r: 'ai', t: '', loading: true, scene: curRole.mode };   
        targetRole.history.push(loadingMsg); 
        renderMsgs();

        try {
            let apiMessages = targetRole.history.filter(m => !m.loading && m.t && m.type !== 'pay_request' && m.type !== 'order_share').map(m => {
                let content = m.t; 
                if (m.type === 'transfer') content = m.r === 'u' ? `[ç³»ç»Ÿï¼šç”¨æˆ·è½¬è´¦ Â¥${m.t}ã€‚å¦‚æ”¶ä¸‹å›å¤[CMD:RECEIVE]ï¼Œæ‹’æ”¶å›å¤[CMD:RETURN]]` : `[æˆ‘ç»™ä½ è½¬è´¦ Â¥${m.t}]`; 
                else if (m.type === 'image') content = `[ç”¨æˆ·å‘å›¾: ${m.t}]`;
                else if (m.r === 'ai') content = cleanText(m.t); 
                return { role: m.r === 'u' ? 'user' : 'assistant', content: content };
            });

            if (apiMessages.length > 0) apiMessages[apiMessages.length-1].content += `\n\n${modeReinforce}`;

            // ğŸ¯ æ–°å¢çš„ç¾¤èŠæŠ¢çº¢åŒ…AIè§„åˆ™ï¼šå¼ºåˆ¶ AI åªèƒ½è®©ä¸€ä¸ªäººæ”¶é’±
            let groupRule = targetRole.isGroup ? `\nã€ç¾¤èŠæŠ¢çº¢åŒ…/è½¬è´¦ç‰¹åˆ«è§„å®šã€‘ï¼šå¦‚æœç”¨æˆ·å‘äº†è½¬è´¦ï¼Œ**ç¾¤é‡Œåªèƒ½æœ‰1ä¸ªè§’è‰²**æŠ¢åˆ°å¹¶è¾“å‡º[CMD:RECEIVE]æŒ‡ä»¤ã€‚å…¶ä»–è§’è‰²ç»å¯¹ä¸èƒ½åŒæ—¶è¯´è‡ªå·±æ”¶åˆ°äº†é’±ï¼Œå…¶ä»–äººåªèƒ½è¡¨è¾¾â€œæ²¡æŠ¢åˆ°â€ã€â€œç¾¡æ…•â€æˆ–â€œæ—è§‚â€ï¼` : "";

            let sysPrompt = `ä½ æ˜¯${targetRole.name}ã€‚${longTermMem}ã€‚èƒŒæ™¯:${targetRole.info}ã€‚ä¸${effectiveUser.name}èŠå¤©ã€‚ä¸–ç•Œ:${worldCtx}ã€‚\n${modeSysPrompt}\nã€å¿…è¯»åŠ¨ä½œæŒ‡ä»¤ã€‘:\nä½œä¸ºçœŸå®çš„äººï¼Œå¦‚æœä½ æƒ³äº§ç”Ÿå®é™…åŠ¨ä½œï¼Œ**å¿…é¡»**åœ¨å›å¤æœ«å°¾é™„å¸¦ä»¥ä¸‹ä»£ç ï¼š\n1. ä¸»åŠ¨ç»™ç”¨æˆ·è½¬è´¦ï¼š[CMD:TRANSFER:æ•°å­—]\n2. æ”¶ä¸‹ç”¨æˆ·çš„è½¬è´¦ï¼š[CMD:RECEIVE]\n3. æ‹’æ”¶/é€€å›è½¬è´¦ï¼š[CMD:RETURN]\n4. å‘æœ‹å‹åœˆï¼š[CMD:POST:å†…å®¹]${groupRule}`;
            
            let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [ { role: 'system', content: sysPrompt }, ...apiMessages ], stream: false }) });
            let data = await res.json(); 
            let rawContent = cleanText(data.choices[0].message.content);
            
            let aiTransfers = [];
            let lines = rawContent.split('\n');
            let currentSpeaker = targetRole.isGroup ? "ç³»ç»Ÿ" : targetRole.name;
            let newLines = [];
            let hasReceived = false; // ğŸ¯ æ–°å¢æ‹¦æˆªå™¨ï¼šæ§åˆ¶åº•å±‚ç³»ç»Ÿåªèƒ½ç»™ä¸€ä¸ªäººç»“ç®—
            
            lines.forEach(line => {
                let cleanLine = line.replace(/\*\*/g, '');
                let matchSpk = cleanLine.match(/^ã€?(.*?)ã€‘?[ï¼š:]/);
                if (matchSpk) currentSpeaker = matchSpk[1].trim();

                let transferMatch = line.match(/\[CMD:TRANSFER:\s*(\d+(\.\d+)?)\s*\]/i) || line.match(/ã€CMD:TRANSFER:\s*(\d+(\.\d+)?)\s*ã€‘/i);
                if (transferMatch) {
                    aiTransfers.push({ amt: parseFloat(transferMatch[1]), spk: currentSpeaker });
                    line = line.replace(transferMatch[0], '').trim();
                }
                
                let postMatch = line.match(/\[CMD:POST:(.*?)\]/i) || line.match(/ã€CMD:POST:(.*?)ã€‘/i); 
                if (postMatch) { 
                    let postContent = postMatch[1]; 
                    line = line.replace(postMatch[0], '').trim(); 
                    let spkId = targetRole.id;
                    if(targetRole.isGroup) {
                        let spkR = roles.find(r => !r.isGroup && (r.name === currentSpeaker || r.name.includes(currentSpeaker)));
                        if(spkR) spkId = spkR.id;
                    }
                    mnts.unshift({ id: Date.now(), r: spkId, content: postContent, img: "", time: Date.now(), likes: [], comments: [] }); 
                    saveAll(); if(curTab === 'moments') renderMnts(); 
                }
                
                let rcvMatch = line.match(/\[CMD:RECEIVE\]/i) || line.match(/ã€CMD:RECEIVEã€‘/i);
                if (rcvMatch) { 
                    line = line.replace(rcvMatch[0], '').trim(); 
                    // é˜²æ­¢AIä¸å¬è¯åœ¨ä¸€æ®µè¯é‡Œçå‘å¤šä¸ªæ¥æ”¶æŒ‡ä»¤
                    if(!hasReceived) {
                        let pendingMsg = targetRole.history.findLast(m => m.r === 'u' && m.type === 'transfer' && m.status === 'pending'); 
                        if (pendingMsg) { 
                            pendingMsg.status = 'received'; pendingMsg.rcvTime = new Date().toLocaleString(); 
                            let rcvName = targetRole.isGroup ? currentSpeaker : targetRole.name;
                            // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œç²¾å‡†æ’­æŠ¥æ˜¯è°æŠ¢äº†é’±
                            targetRole.history.push({ r: 'system', t: `${rcvName} é¢†å–äº†ä½ çš„è½¬è´¦`, type: 'system' }); 
                        }
                        hasReceived = true;
                    }
                }
                
                let retMatch = line.match(/\[CMD:RETURN\]/i) || line.match(/ã€CMD:RETURNã€‘/i);
                if (retMatch) { 
                    line = line.replace(retMatch[0], '').trim(); 
                    let pendingMsg = targetRole.history.findLast(m => m.r === 'u' && m.type === 'transfer' && m.status === 'pending'); 
                    if (pendingMsg) { 
                        pendingMsg.status = 'returned'; pendingMsg.rcvTime = new Date().toLocaleString(); 
                        balance += parseFloat(pendingMsg.t); 
                        let retName = targetRole.isGroup ? currentSpeaker : targetRole.name;
                        targetRole.history.push({ r: 'system', t: `${retName} é€€è¿˜äº†ä½ çš„è½¬è´¦`, type: 'system' }); 
                    } 
                }

                if (line.trim()) newLines.push(line);
            });
            
            rawContent = newLines.join('\n');
            
            loadingMsg.t = rawContent; delete loadingMsg.loading; 
            
            aiTransfers.forEach(tf => {
                if (tf.amt > 0) {
                    targetRole.history.push({ r: 'ai', t: tf.amt.toString(), type: 'transfer', status: 'pending', time: new Date().toLocaleString(), spk: tf.spk, scene: curRole.mode });
                }
            });
            
            if (!loadingMsg.t && loadingMsg.type === 'text') { let idx = targetRole.history.indexOf(loadingMsg); if (idx > -1) targetRole.history.splice(idx, 1); }
            
            saveAll(); renderMsgs();
        } catch (e) { console.error(e); targetRole.history.pop(); renderMsgs(); alert("å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Keyå’Œç½‘ç»œ"); }
    }

    function renderMsgs() {
        if (!curRole || !curRole.history) return; 
        let myAva = document.querySelector('.u-ava')?.src || "https://img.icons8.com/color/96/user.png";
        let userAva = (curRole.userMask && curRole.userMask.ava) ? curRole.userMask.ava : myAva;
        let isStoryMode = curRole.mode === 'story';
        
        let htmlStr = '';
        
        curRole.history.forEach((m, idx) => {
            if (!m) return; 
            
            // æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ï¼šå¦‚æœæ¶ˆæ¯æ²¡æœ‰æ ‡ç­¾ï¼Œé»˜è®¤ç®—æ˜¯å¾®ä¿¡(chat)æ—¶ä»£çš„æ—§æ•°æ®ã€‚
                        // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œæ ¹æ®å†…å®¹ç‰¹å¾åŠ¨æ€åˆ¤æ–­ï¼Œé˜²æ­¢æ—§æ•°æ®æ˜¾ç¤ºé”™åœ°æ–¹
            let msgScene = m.scene;
            if (!msgScene) {
                msgScene = (m.t.includes('*') || m.t.length > 40) ? 'story' : 'chat';
            }
            // å¦‚æœåœ¨å°å‰§åœºæ¨¡å¼ï¼Œå±è”½æ‰€æœ‰å¾®ä¿¡æ¶ˆæ¯ï¼›å¦‚æœåœ¨å¾®ä¿¡æ¨¡å¼ï¼Œå±è”½æ‰€æœ‰å°å‰§åœºæ¶ˆæ¯ã€‚
            if (isStoryMode && msgScene !== 'story') return;
            if (!isStoryMode && msgScene !== 'chat') return;

                        if (m.type === 'system') { 
                // æ ¸å¿ƒè¿‡æ»¤ï¼šå¦‚æœæ˜¯ä¸“é—¨å¡ç»™ AI çœ‹çš„åœºæ™¯æç¤ºï¼Œç›´æ¥éšèº«ï¼Œä¸ç”»åœ¨å±å¹•ä¸Šï¼
                if (m.t.includes('ã€ç³»ç»Ÿæç¤ºï¼š')) return; 
                
                // å…¶ä»–æ­£å¸¸çš„ç³»ç»Ÿæ¶ˆæ¯ï¼ˆæ¯”å¦‚ï¼šå·²æ”¶æ¬¾ã€å‘çº¢åŒ…ï¼‰ä¾ç„¶æ­£å¸¸æ˜¾ç¤º
                htmlStr += `<div class="flex justify-center w-full my-3"><span class="bg-black/10 text-zinc-500 text-[11px] px-3 py-1 rounded-md shadow-sm">${m.t}</span></div>`; 
                return; 
            }
                 // === æ ¸å¿ƒå‡çº§ï¼šç¾¤èŠæ¶ˆæ¯è‡ªåŠ¨æ‹†è§£å¼•æ“ ===
            // ğŸ¯ ä¿®æ”¹ï¼šä»…åœ¨çº¿ä¸Šå¾®ä¿¡æ¨¡å¼ä¸‹æ‹†åˆ†æ°”æ³¡ï¼Œçº¿ä¸‹å°è¯´æ¨¡å¼ä¸æ‹†åˆ†
            if (curRole.isGroup && m.r === 'ai' && !m.loading && (!m.type || m.type === 'text') && !isStoryMode) {
                let parsedBlocks = []; let lines = cleanText(m.t).split('\n'); let curSpk = null; let curTxt = "";
                lines.forEach(line => {
                    let cleanLine = line.replace(/\*\*/g, ''); // æ‰’æ‰AIä¹±åŠ çš„ç²—ä½“æ˜Ÿå·
                    let match = cleanLine.match(/^ã€?(.*?)ã€‘?[ï¼š:]([\s\S]*)$/); 
                    if (match) {
                        if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });
                        curSpk = match[1].trim(); curTxt = match[2] + "\n";
                    } else {
                        if (curSpk) curTxt += line + "\n"; else { curSpk = "ç³»ç»Ÿ"; curTxt += line + "\n"; }
                    }
                });
                if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });

                parsedBlocks.forEach((block, bIdx) => {
                    let spkRole = roles.find(r => !r.isGroup && (r.name === block.name || r.name.includes(block.name) || block.name.includes(r.name)));
                    let spkAva = spkRole ? spkRole.ava : 'https://img.icons8.com/color/96/user-male-circle.png';
                    let fmtTxt = block.text.replace(/\n/g, '<br>');
                    
                    let isLast = bIdx === parsedBlocks.length - 1;
                    
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šç»™æ¯ä¸€ä¸ªæ‹†åˆ†å‡ºæ¥çš„æ°”æ³¡éƒ½åŠ ä¸Šâ€œå•ç‹¬åˆ é™¤â€çš„æŒ‰é’®ï¼
                    let actionBtns = `<div class="text-[10px] text-zinc-400 flex gap-2 px-1 ml-1 items-center mt-1"><span onclick="delSubMsg(${idx}, ${bIdx})" class="cursor-pointer text-zinc-400 hover:text-red-500">åˆ é™¤æ­¤æ¡</span>` + (isLast ? `<span class="text-zinc-300 mx-1">|</span><span onclick="delMsg(${idx})" class="cursor-pointer text-zinc-400 hover:text-red-500">åˆ æ•´ä½“</span><span class="text-zinc-300 mx-1">|</span> <span onclick="retryMsg(${idx})" class="cursor-pointer text-blue-500 font-bold hover:bg-zinc-100 px-1 rounded select-none">â†»é‡è¯´</span>` : '') + `</div>`;

                    htmlStr += `
                    <div class="flex flex-row justify-start items-start gap-2 mb-4 w-full px-2">
                        <img src="${spkAva}" class="w-10 h-10 rounded-lg shrink-0 bg-zinc-300 shadow-sm mt-1">
                        <div class="flex flex-col items-start max-w-[75%] ml-2">
                            <span class="text-[11px] text-zinc-500 ml-1 mb-0.5">${block.name}</span>
                            <div class="bubble bubble-ai shadow-sm">${fmtTxt}</div>
                            ${actionBtns}
                        </div>
                    </div>`;
                });
                return;
            }

            // === ä¸‹æ–¹ä¸ºå¸¸è§„(å•äºº/ç‰¹æ®Šå¡ç‰‡)æ¶ˆæ¯æ¸²æŸ“ ===
            let avaSrc = m.r==='u' ? userAva : curRole.ava;
            let bubbleContent = '', bubbleClass = '', extraStyle = '', containerClass = '', wrapperClass = '', showAva = true;
            let spkNameHtml = '';

                        // ğŸ¯ ä¿®æ”¹ï¼šçº¿ä¸‹æ¨¡å¼ä¸éœ€è¦å•ç‹¬æå–å‘è¨€äººæ˜µç§°å’Œå¤´åƒ
            if (curRole.isGroup && m.r === 'ai' && m.spk && !isStoryMode) {
                let spkRole = roles.find(r => !r.isGroup && (r.name === m.spk || r.name.includes(m.spk) || m.spk.includes(r.name)));
                avaSrc = spkRole ? spkRole.ava : 'https://img.icons8.com/color/96/user-male-circle.png';
                spkNameHtml = `<span class="text-[11px] text-zinc-500 ml-1 mb-0.5">${m.spk}</span>`;
            }

            if (m.type === 'transfer') {
                wrapperClass = m.r === 'u' ? 'flex flex-row justify-end items-start' : 'flex flex-row justify-start items-start';
                containerClass = m.r === 'u' ? 'flex flex-col items-end max-w-[75%] mr-2' : 'flex flex-col items-start max-w-[75%] ml-2';
                bubbleClass = 'bg-[#f79c4a] text-white border-none cursor-pointer active:opacity-80 rounded-xl px-4 py-3 shadow-sm'; 
                let icon = m.status === 'received' ? 'âœ”' : (m.status === 'returned' ? 'â†©' : (m.r==='u' ? 'Â¥' : 'ğŸ’°')); 
                let title = m.r === 'u' ? `è½¬è´¦ç»™å¯¹æ–¹` : 'æ”¶åˆ°è½¬è´¦'; 
                let statusText = m.status === 'received' ? (m.r==='u'?'å·²è¢«é¢†å–':'å·²æ”¶æ¬¾') : (m.status==='returned'?'å·²é€€è¿˜':(m.r==='u'?'ç­‰å¾…å¯¹æ–¹ç¡®è®¤':'å¾…ä½ æ”¶æ¬¾'));
                bubbleContent = `<div onclick="openTransferDetail(${idx})" class="flex items-center gap-3 min-w-[200px]"><div class="w-10 h-10 rounded-full border-2 border-white/30 flex items-center justify-center text-white text-xl">${icon}</div><div class="flex flex-col"><span class="text-base font-bold">Â¥${m.t}</span><span class="text-[10px] opacity-80">${title}</span></div></div><div class="mt-2 pt-1 border-t border-white/20 text-[10px] opacity-70">${statusText}</div>`;
            } else if (m.type === 'pay_request') {
                wrapperClass = 'flex flex-row justify-end items-start'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
                let statusText = m.status==='pending'?'ç­‰å¾…å¯¹æ–¹ä»˜æ¬¾':(m.status==='paid'?'å¯¹æ–¹å·²ä»˜æ¬¾':'å¯¹æ–¹å·²æ‹’ç»');
                let statusClass = m.status==='pending'?'st-pending':(m.status==='paid'?'st-paid':'st-rejected');
                let isShop = m.itemDisplay && m.itemDisplay.startsWith('[å•†åŸ]');
                let payTitle = isShop ? "è¯·å¸®æˆ‘ä»˜å•†åŸè®¢å•" : "è¯·å¸®æˆ‘ä»˜å¤–å–";
                let headerClass = isShop ? "card-header-pay-shop" : "card-header-pay";
                let source = isShop ? "AI å•†åŸ" : "ç¾å›¢å¤–å–";
                bubbleContent = `<div class="msg-card"><div class="${headerClass}"></div><div class="card-title"><span>${isShop?'ğŸ›ï¸':'ğŸ’³'}</span> ${payTitle}</div><div class="card-content"><img src="${m.img || ''}" class="card-img"><div class="card-info"><div class="card-desc">${m.itemDisplay || 'å•†å“'}</div><div class="card-price">Â¥${parseFloat(m.total).toFixed(2)}</div></div></div><div class="flex justify-between items-center text-xs"><span class="text-zinc-400">${source}</span><span class="status-tag ${statusClass}">${statusText}</span></div></div>`;
            } else if (m.type === 'order_share') {
                wrapperClass = 'flex flex-row justify-end items-start'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
                bubbleContent = `<div class="msg-card"><div class="card-header-share"></div><div class="card-title"><span>ğŸ˜‹</span> æˆ‘ç‚¹äº†è¿™å®¶ï¼Œè¶…å¥½åƒ</div><div class="card-content"><img src="${m.img || ''}" class="card-img"><div class="card-info"><div class="card-desc">${m.itemDisplay}</div><div class="text-xs text-zinc-400">å…± ${m.count} ä»¶</div></div></div><div onclick="go('pg-takeout-home')" class="card-btn">å»çœ‹çœ‹</div></div>`;
            } else if (m.type === 'image') {
                wrapperClass = m.r==='u'?'flex flex-row justify-end items-start':'flex flex-row justify-start items-start';
                containerClass = m.r==='u'?'flex flex-col items-end max-w-[75%] mr-2':'flex flex-col items-start max-w-[75%] ml-2';
                bubbleContent = `<img src="${m.t}" class="max-w-[150px] rounded-lg cursor-pointer" onclick="window.open('${m.t}')">`; extraStyle = 'background:transparent;border:none;padding:0;box-shadow:none;';
            } else {
                if (m.loading) { bubbleContent = `<div class="dot-ani"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;} else {
                    let rawText = m.r === 'ai' ? cleanText(m.t) : m.t;
                    
                    // ğŸ¯ æ ¸å¿ƒä¿®æ”¹ 1ï¼šä¸“é—¨é’ˆå¯¹çº¿ä¸‹å°è¯´çš„æ–‡æœ¬å‡€åŒ–ï¼ŒèåŒ–æ‰â€œåå­—ï¼šâ€è¿™ç§ç½‘èŠå‰ç¼€
                    if (isStoryMode && m.r === 'ai') {
                        rawText = rawText.split('\n').map(line => {
                            // å°†å¼€å¤´ç±»ä¼¼ "æµ‹è¯•å°åŠ©æ‰‹22ï¼š" æ›¿æ¢ä¸º "æµ‹è¯•å°åŠ©æ‰‹22"ï¼ˆå·§å¦™å»æ‰å†’å·ï¼Œèå…¥å¥å­ä¸»ä½“ï¼‰
                            return line.replace(/^ã€?([^ã€‘:ï¼š]+)ã€‘?[ï¼š:]\s*/, '$1');
                        }).join('\n');
                    }

                    let formattedText = typeof rawText === 'string' ? rawText.replace(/\*([^*]+)\*/g, '<span class="text-zinc-400 italic text-[15px]">$1</span>') : '';
                    
                    if (isStoryMode && m.r === 'ai') {
                        bubbleContent = formattedText.split('\n').filter(line => line.trim() !== '').map(line => `<span class="story-p">${line}</span>`).join('');
                    } else {
                        bubbleContent = formattedText.replace(/\n/g, '<br>');
                    }
                }
                if (m.r === 'u') { wrapperClass = 'flex flex-row justify-end items-start'; bubbleClass = 'bubble-user shadow-sm'; containerClass = 'flex flex-col items-end max-w-[75%] mr-2'; } 
                else { 
                    if (isStoryMode) { showAva = false; wrapperClass = 'flex justify-center'; containerClass = 'flex flex-col w-[94%]'; bubbleClass = 'story-text-container'; } 
                    else { wrapperClass = 'flex flex-row justify-start items-start'; bubbleClass = 'bubble-ai shadow-sm'; containerClass = 'flex flex-col items-start max-w-[75%] ml-2'; } 
                }
            }
            let avatarHtml = showAva ? `<img src="${avaSrc}" class="w-10 h-10 rounded-lg shrink-0 bg-zinc-300 shadow-sm mt-1">` : ''; 
            let retryBtn = (m.r === 'ai' && !m.loading) ? ` <span class="text-zinc-300 mx-1">|</span> <span onclick="retryMsg(${idx})" class="cursor-pointer text-blue-500 font-bold hover:bg-zinc-100 px-1 rounded select-none">â†»é‡è¯´</span>` : '';
            let footerClass = isStoryMode ? 'justify-end w-full pr-2 mt-1' : 'ml-1 items-center mt-1';
            let innerHtml = m.r === 'u' ? 
                `<div class="${containerClass}"><div class="bubble ${bubbleClass}" style="${extraStyle}">${bubbleContent}</div><div class="text-[10px] text-zinc-400 mt-1 flex gap-3 px-1 mr-1"><span onclick="delMsg(${idx})" class="cursor-pointer">åˆ é™¤</span></div></div>${avatarHtml}` : 
                `<div class="${containerClass}">${spkNameHtml}<div class="bubble ${bubbleClass}" style="${extraStyle}">${bubbleContent}</div><div class="text-[10px] text-zinc-400 flex gap-2 px-1 ${footerClass}"><span onclick="delMsg(${idx})" class="cursor-pointer text-zinc-400 hover:text-red-500">åˆ é™¤</span>${retryBtn}</div></div>`;
            if (m.r === 'ai') innerHtml = avatarHtml + innerHtml;
            htmlStr += `<div class="${wrapperClass} gap-2 mb-4 w-full px-2">${innerHtml}</div>`;
        });
        
                // æ™ºèƒ½åˆ†é…ï¼šå¦‚æœåœ¨å‰§æƒ…æ¨¡å¼ï¼Œå°±æŠŠæ¶ˆæ¯å…¨ä¸¢è¿› story-msgs æ¸²æŸ“ï¼›å¦åˆ™ä¸¢è¿› chat-msgs
        let container = isStoryMode ? $('story-msgs') : $('chat-msgs');
        if (container) {
            container.innerHTML = htmlStr;
            container.scrollTop = container.scrollHeight;
        }
}
    function renderChatList() { $('sub-chat').innerHTML = chats.map(id => { let r = roles.find(x=>x.id==id); if(!r) return ''; let lastMsg = r.history.length > 0 ? r.history[r.history.length-1].t : 'æš‚æ— æ¶ˆæ¯'; return `<div onclick="enterChat('${r.id}')" class="p-4 flex gap-3 bg-white active:bg-zinc-50 border-b"><img src="${r.ava}" class="w-12 h-12 rounded-lg bg-zinc-100"><div class="flex-1 min-w-0"><b class="block truncate">${r.name}</b><p class="text-xs text-zinc-400 truncate">${cleanText(lastMsg)}</p></div></div>`; }).join(''); }

    function renderChatInfo() { 
        if(!curRole) return; 
        $('info-mask-status').innerText = (curRole.userMask && curRole.userMask.name) ? `å½“å‰: ${curRole.userMask.name}` : "é»˜è®¤"; 
        if(curRole.isGroup) $('group-name-edit-box').classList.remove('hidden');
        else $('group-name-edit-box').classList.add('hidden');
    }

    function loadMaskEdit() { if(!curRole) return; let m = curRole.userMask || {}; $('in-mask-n').value = m.name || ''; $('in-mask-a').value = m.ava || ''; $('in-mask-i').value = m.info || ''; }
    function saveMask() { if(!curRole) return; curRole.userMask = { name: $('in-mask-n').value, ava: $('in-mask-a').value, info: $('in-mask-i').value }; saveAll(); alert("é¢å…·å·²ä¿å­˜ï¼"); go('pg-chat-info'); }
    function clearHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")){ curRole.history=[]; saveAll(); renderMsgs(); go('pg-chat-room'); } }
    function clearHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")){ curRole.history=[]; saveAll(); renderMsgs(); go('pg-chat-room'); } }

    // ğŸ‘‡ æ–°å¢ï¼šå½»åº•åˆ é™¤å½“å‰èŠå¤©ä¼šè¯
    function deleteCurrentChat() {
        if (!curRole) return;
        if (confirm("ç¡®å®šè¦åˆ é™¤è¯¥èŠå¤©å—ï¼Ÿ\nåˆ é™¤åæ‰€æœ‰è®°å½•å°†è¢«æ¸…ç©ºï¼Œå¹¶ä»å¾®ä¿¡æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤ã€‚")) {
            // 1. å½»åº•æ¸…ç©ºå½“å‰è§’è‰²çš„èŠå¤©å†å²
            curRole.history = []; 
            // 2. å°†è¯¥è§’è‰²ä»å¾®ä¿¡é¦–é¡µçš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆchatsæ•°ç»„ï¼‰ä¸­å‰”é™¤
            chats = chats.filter(id => id !== curRole.id); 
            
            // 3. ä¿å­˜æ•°æ®
            saveAll(); 
            
            // 4. é‡æ–°æ¸²æŸ“é¦–é¡µæ¶ˆæ¯åˆ—è¡¨ï¼Œå¹¶è·³å›å¾®ä¿¡é¦–é¡µ
            renderChatList(); 
            go('pg-wechat'); 
            tab('chat');
        }
    }
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ï¼šç²¾å‡†å‰¥ç¦»å™¨ï¼Œä¸“é—¨ç”¨æ¥å•æ€ç¾¤èŠé‡Œçš„æŸä¸€ä¸ªäººè¯´çš„è¯
    window.delSubMsg = function(msgIdx, blockIdx) {
        let m = curRole.history[msgIdx];
        if (!m || !m.t) return;
        
        let parsedBlocks = []; let lines = cleanText(m.t).split('\n'); let curSpk = null; let curTxt = "";
        lines.forEach(line => {
            let cleanLine = line.replace(/\*\*/g, '');
            let match = cleanLine.match(/^ã€?(.*?)ã€‘?[ï¼š:]([\s\S]*)$/); 
            if (match) {
                if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });
                curSpk = match[1].trim(); curTxt = match[2] + "\n";
            } else {
                if (curSpk) curTxt += line + "\n"; else { curSpk = "ç³»ç»Ÿ"; curTxt += line + "\n"; }
            }
        });
        if (curSpk) parsedBlocks.push({ name: curSpk, text: curTxt.trim() });
        
        // åˆ æ‰æŒ‡å®šçš„é‚£ä¸ªè§’è‰²çš„é‚£æ®µè¯
        parsedBlocks.splice(blockIdx, 1);
        
        if (parsedBlocks.length === 0) {
            // å¦‚æœå…¨éƒ½åˆ å…‰äº†ï¼Œå°±æŠŠè¿™æ¡å†å²è®°å½•æ•´ä¸ªæ‹”æ‰
            curRole.history.splice(msgIdx, 1);
        } else {
            // å¦åˆ™ï¼ŒæŠŠå‰©ä¸‹çš„äººçš„è¯é‡æ–°æ‹¼è£…å›å»è¦†ç›–åˆ°åº•å±‚
            m.t = parsedBlocks.map(b => `${b.name}ï¼š${b.text}`).join('\n');
        }
        
        saveAll();
        renderMsgs();
    };

    function delMsg(idx) { curRole.history.splice(idx,1); saveAll(); renderMsgs(); }
    function retryMsg(idx) { let lastU = ""; for(let i=idx-1; i>=0; i--){ if(curRole.history[i].r==='u'){ lastU=curRole.history[i].t; break; } } curRole.history.splice(idx,1); saveAll(); renderMsgs(); if(lastU) handleSendMsg(lastU, 'text', true); else handleSendMsg(" ", 'text', true); } 
    
    // ================== 11. å¤–å–æ¨¡å—ä¸ä¸‰é€‰ä¸€æ”¯ä»˜ ==================
    function toTakeoutTab(tab) { ['pg-takeout-home', 'pg-takeout-cart', 'pg-takeout-me'].forEach(id => { $(id).classList.remove('active'); }); $('pg-takeout-' + tab).classList.add('active'); if(tab === 'home') renderFoodList(); if(tab === 'cart') renderCart(); if(tab === 'me') updatePendingBadge(); }
    function handleSearchInput() { let val = $('takeout-search').value; let btn = $('btn-clear-search'); if(val.length > 0) btn.classList.remove('hidden'); else btn.classList.add('hidden'); renderFoodList(); }
    function clearSearch() { $('takeout-search').value = ''; $('btn-clear-search').classList.add('hidden'); renderFoodList(); }
    function renderFoodList() {
        const term = $('takeout-search').value.toLowerCase(); const list = $('takeout-list');
        const filtered = foods.filter(f => f.name.toLowerCase().includes(term) || f.store.toLowerCase().includes(term));
        list.innerHTML = filtered.map(f => `<div onclick="showFoodDetail(${f.id})" class="food-card flex flex-col h-full cursor-pointer active:opacity-90"><div class="food-img-box"><img src="${f.img}" loading="lazy"><div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2 pt-6"><span class="text-white text-[10px] font-light">30åˆ†é’Ÿé€è¾¾</span></div></div><div class="p-2 flex flex-col flex-1"><h3 class="font-bold text-sm text-zinc-800 truncate">${f.name}</h3><div class="text-[10px] text-zinc-400 mt-0.5 mb-2 truncate">ğŸ  ${f.store} | æœˆå”®${f.sales}+</div><div class="mt-auto flex justify-between items-center"><span class="text-red-500 font-bold text-base"><span class="text-xs">Â¥</span>${f.price}</span><button onclick="event.stopPropagation(); addToCart(${f.id})" class="bg-[#FFD101] w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm text-black active:bg-yellow-500">+</button></div></div></div>`).join('');
        updateCartBadge();
    }
    function showFoodDetail(fid) {
        let f = foods.find(x => x.id === fid); if(!f) return; let modal = $('food-detail-modal'); let body = modal.querySelector('.food-modal-body');
        body.innerHTML = `<div class="relative w-full h-64 bg-zinc-200 shrink-0"><img src="${f.img}" class="w-full h-full object-cover"><button onclick="closeFoodDetail()" class="absolute top-4 left-4 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur">âœ•</button><button onclick="deleteFood(${f.id})" class="absolute top-4 right-4 w-8 h-8 bg-red-500/80 rounded-full text-white flex items-center justify-center backdrop-blur shadow-md text-sm">ğŸ—‘ï¸</button></div><div class="p-5 flex-1 overflow-y-auto"><h2 class="text-2xl font-bold text-zinc-900 mb-1">${f.name}</h2><div class="text-zinc-500 text-sm mb-4">æœˆå”® ${f.sales}+ Â· å¥½è¯„ç‡ 98%</div><div class="text-zinc-600 text-sm leading-relaxed mb-6">ä¸¥é€‰é£Ÿæï¼Œç°ç‚¹ç°åšã€‚</div></div><div class="p-4 border-t flex justify-between items-center bg-white safe-area-pb"><div class="flex flex-col"><span class="text-red-500 text-2xl font-bold"><span class="text-sm">Â¥</span>${f.price}</span><span class="text-xs text-zinc-400">æ— é—¨æ§›é…é€</span></div><button onclick="addToCart(${f.id}); closeFoodDetail()" class="bg-[#FFD101] text-black px-8 py-3 rounded-full font-bold shadow-md active:scale-95 transition-transform">åŠ å…¥è´­ç‰©è½¦</button></div>`;
        modal.classList.add('active');
    }
    function deleteFood(fid) { if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤–å–å•†å“å—ï¼Ÿ")) return; foods = foods.filter(x => x.id !== fid); cart = cart.filter(x => x.id !== fid); saveAll(); closeFoodDetail(); renderFoodList(); renderCart(); updateCartBadge(); }
    function closeFoodDetail() { $('food-detail-modal').classList.remove('active'); }
    function addToCart(id) { let item = cart.find(x => x.id === id); if(item) { item.count++; } else { cart.push({id: id, count: 1}); } saveAll(); updateCartBadge(); let btn = event.target; let oldTxt = btn.innerText; btn.innerText = "âœ”"; setTimeout(() => btn.innerText = oldTxt, 500); }
    function updateCartBadge() { let total = cart.reduce((a, b) => a + b.count, 0); const badge = $('cart-badge'); if(total > 0) { badge.innerText = total; badge.classList.remove('hidden'); badge.classList.add('cart-badge-ani'); setTimeout(()=>badge.classList.remove('cart-badge-ani'), 300); } else { badge.classList.add('hidden'); } }
    function renderCart() { const list = $('cart-list'); if(cart.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><span class="text-6xl mb-4">ğŸ›’</span><span>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</span></div>`; $('cart-total').innerText = '0.00'; return; } let total = 0; list.innerHTML = cart.map(c => { let f = foods.find(x => x.id === c.id); if(!f) return ''; let subtotal = f.price * c.count; total += subtotal; return `<div class="bg-white p-3 rounded-xl flex gap-3 items-center"><img src="${f.img}" class="w-16 h-16 rounded-lg object-cover bg-zinc-100"><div class="flex-1"><b class="text-sm block truncate">${f.name}</b><span class="text-xs text-zinc-400">${f.store}</span><div class="flex justify-between items-center mt-2"><span class="text-red-500 font-bold">Â¥${f.price}</span><div class="flex items-center gap-3"><button onclick="changeCartCount(${f.id}, -1)" class="w-6 h-6 rounded border border-zinc-200 text-zinc-500 flex items-center justify-center">-</button><span class="text-sm font-bold w-4 text-center">${c.count}</span><button onclick="changeCartCount(${f.id}, 1)" class="w-6 h-6 rounded bg-[#FFD101] text-black flex items-center justify-center text-sm">+</button></div></div></div></div>`; }).join(''); $('cart-total').innerText = total.toFixed(2); }
    function changeCartCount(id, delta) { let item = cart.find(x => x.id === id); if(!item) return; item.count += delta; if(item.count <= 0) { cart = cart.filter(x => x.id !== id); } saveAll(); renderCart(); updateCartBadge(); }
    function clearCart() { if(confirm("ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ")) { cart = []; saveAll(); renderCart(); updateCartBadge(); } }
    
    function doCheckout() { if(cart.length === 0) return alert("è¯·å…ˆé€‰è´­å•†å“"); let total = parseFloat($('cart-total').innerText); createCustomCheckoutModal(total); }
    function createCustomCheckoutModal(total) {
        let roleName = curRole ? curRole.name : 'å¥½å‹'; let overlay = document.createElement('div'); overlay.className = "fixed inset-0 bg-black/50 z-[100] flex items-end";
        overlay.innerHTML = `<div class="bg-white w-full rounded-t-2xl p-6 animate-fade-in"><h3 class="text-lg font-bold mb-4 text-center">å¤–å–æ”¯ä»˜ Â¥${total.toFixed(2)}</h3><div class="space-y-3"><button onclick="handlePayOption('wechat', ${total})" class="w-full py-3 bg-[#07c160] text-white rounded-lg font-bold">å¾®ä¿¡é›¶é’±æ”¯ä»˜</button><button onclick="handlePayOption('bank', ${total})" class="w-full py-3 bg-[#e60012] text-white rounded-lg font-bold flex items-center justify-center gap-2">ğŸ’³ å‚¨è“„å¡æ”¯ä»˜</button><button onclick="handlePayOption('friend', ${total})" class="w-full py-3 bg-[#FFD101] text-black rounded-lg font-bold flex items-center justify-center gap-2"><span>æ‰¾ ${roleName} ä»£ä»˜</span></button><button onclick="document.body.removeChild(this.parentNode.parentNode.parentNode)" class="w-full py-3 text-zinc-400">å–æ¶ˆ</button></div></div>`;
        document.body.appendChild(overlay); 
        window.handlePayOption = (type, amt) => { 
            document.body.removeChild(overlay); 
            if(type === 'wechat') processSelfPay(amt); 
            if(type === 'bank') processBankPay(amt, 'food');
            if(type === 'friend') { if(!takeoutCtx.fromChat) return alert("è¯·å…ˆåœ¨èŠå¤©å®¤å‘¼å‡ºå¤–å–ï¼"); processFriendPay(amt); }
        };
    }
    function processSelfPay(total) { if(balance < total) return alert(`å¾®ä¿¡é›¶é’±ä¸è¶³ (å½“å‰ Â¥${balance.toFixed(2)})`); balance -= total; createOrder(total, 'paid'); alert("å¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼"); saveAll(); go('pg-takeout-pending'); renderPendingOrders(); }
    function processFriendPay(total) { let firstItem = foods.find(f => f.id === cart[0].id) || {name: "æœªçŸ¥", img:""}; let count = cart.reduce((a,b)=>a+b.count,0); let payMsg = { r: 'u', type: 'pay_request', status: 'pending', total: total, itemDisplay: `${firstItem.name} ç­‰ ${count} ä»¶`, img: firstItem.img, time: new Date().toLocaleString(), t: `[ä»£ä»˜è¯·æ±‚] Â¥${total}` }; curRole.history.push(payMsg); saveAll(); createOrder(total, 'wait_pay'); go('pg-chat-room'); renderMsgs(); setTimeout(() => triggerAiPayDecision(curRole.history.length - 1, total), 1500); }
    function createOrder(total, status) { let newOrder = { id: Date.now(), items: JSON.parse(JSON.stringify(cart)), total: total, time: Date.now(), status: status === 'paid' ? 'delivering' : 'pending_pay' }; orders.unshift(newOrder); cart = []; saveAll(); }
    function renderPendingOrders() { const list = $('order-pending-list'); let pending = orders.filter(o => o.status === 'delivering'); if(pending.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— è¿›è¡Œä¸­çš„è®¢å•</div>`; return; } list.innerHTML = pending.map(o => { let firstItem = foods.find(f => f.id === o.items[0].id) || {name: 'æœªçŸ¥å•†å“', store: 'æœªçŸ¥åº—é“º'}; let count = o.items.reduce((a,b)=>a+b.count, 0); return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-3 pb-2 border-b border-dashed"><b class="text-sm">${firstItem.store}</b><span class="text-xs text-[#FFD101] font-bold">éª‘æ‰‹èµ¶å¾€ä¸­...</span></div><div class="flex gap-3 mb-3"><img src="${firstItem.img}" class="w-16 h-16 rounded bg-zinc-100 object-cover"><div class="flex-1"><div class="text-sm font-bold">${firstItem.name} ç­‰</div><div class="text-xs text-zinc-500 mt-1">å…± ${count} ä»¶å•†å“</div></div><div class="flex flex-col items-end justify-center"><span class="font-bold">Â¥${o.total.toFixed(2)}</span></div></div><div class="flex justify-end"><button onclick="confirmReceipt(${o.id})" class="bg-[#FFD101] px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm">ç¡®è®¤æ”¶è´§</button></div></div>`; }).join(''); }
    function confirmReceipt(oid) { let o = orders.find(x => x.id === oid); if(o) { o.status = 'completed'; saveAll(); renderPendingOrders(); alert("å·²ç¡®è®¤æ”¶è´§ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´ï¼"); } }
    function renderAllOrders() { const list = $('order-history-list'); if(orders.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— å†å²è®¢å•</div>`; return; } list.innerHTML = orders.map(o => { let firstItem = foods.find(f => f.id === o.items[0].id) || {name: 'æœªçŸ¥', img: ''}; let statusText = o.status === 'delivering' ? 'è¿›è¡Œä¸­' : (o.status === 'pending_pay' ? 'å¾…ä»˜æ¬¾' : (o.status==='cancelled'?'å·²å–æ¶ˆ':'å·²å®Œæˆ')); let count = o.items.reduce((a,b)=>a+b.count,0); let shareBtn = takeoutCtx.fromChat ? `<button onclick="shareOrder(${o.id})" class="border border-blue-500 text-blue-500 px-3 py-1 rounded text-xs ml-2">åˆ†äº«ç»™TA</button>` : ''; return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-2"><b class="text-sm">${firstItem.store}</b><span class="text-xs text-zinc-400">${statusText}</span></div><div class="flex gap-3 items-center"><img src="${firstItem.img}" class="w-12 h-12 rounded bg-gray-100 object-cover"><div><div class="text-xs text-zinc-500">${firstItem.name} ç­‰ ${count} ä»¶</div><span class="font-bold text-sm">Â¥${o.total.toFixed(2)}</span></div></div><div class="mt-3 flex justify-end gap-2">${shareBtn}<button class="border border-zinc-200 px-3 py-1 rounded text-xs">è¯„ä»·</button></div></div>`; }).join(''); }
    function saveNewFood() { let s = $('tf-store').value; let n = $('tf-name').value; let p = parseFloat($('tf-price').value); let i = $('tf-img').value; if(!s || !n || isNaN(p)) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯"); foods.push({ id: Date.now(), store: s, name: n, price: p, sales: 0, img: i || "https://img.icons8.com/color/96/hamburger.png" }); saveAll(); alert("ä¸Šæ¶æˆåŠŸï¼"); $('tf-name').value = ''; go('pg-takeout-me'); }
    function updatePendingBadge() { let count = orders.filter(o => o.status === 'delivering').length; let b = $('badge-pending'); if(count > 0) { b.innerText = count; b.classList.remove('hidden'); } else { b.classList.add('hidden'); } }

    // ================== 12. è´­ç‰©å•†åŸæ¨¡å— ==================
    function toShopTab(tab) { ['pg-shop-home', 'pg-shop-cart', 'pg-shop-me'].forEach(id => { $(id).classList.remove('active'); }); $('pg-shop-' + tab).classList.add('active'); if(tab==='home') renderShopList(); if(tab==='cart') renderShopCart(); if(tab==='me') updateShopPendingBadge(); }
    function handleShopSearch() { let val = $('shop-search').value; if(val.length > 0) $('btn-shop-clear').classList.remove('hidden'); else $('btn-shop-clear').classList.add('hidden'); renderShopList(); }
    function clearShopSearch() { $('shop-search').value = ''; $('btn-shop-clear').classList.add('hidden'); renderShopList(); }
    function renderShopList() {
        const term = $('shop-search').value.toLowerCase(); const list = $('shop-list');
        const filtered = shopGoods.filter(g => g.name.toLowerCase().includes(term) || g.store.toLowerCase().includes(term));
        list.innerHTML = filtered.map(g => `<div onclick="showShopDetail(${g.id})" class="food-card flex flex-col h-full cursor-pointer active:opacity-90"><div class="food-img-box"><img src="${g.img}" class="p-4 bg-white object-contain"><div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/20 to-transparent p-2"></div></div><div class="p-2 flex flex-col flex-1"><h3 class="font-bold text-sm text-zinc-800 line-clamp-2 leading-tight h-10">${g.name}</h3><div class="text-[10px] text-[#ff6700] border border-[#ff6700] px-1 rounded w-fit mt-1">åŒ…é‚®</div><div class="text-[10px] text-zinc-400 mt-1 truncate">${g.store} | ${g.sales}+äººä»˜æ¬¾</div><div class="mt-auto flex justify-between items-center"><span class="text-[#ff6700] font-bold text-base"><span class="text-xs">Â¥</span>${g.price}</span><button onclick="event.stopPropagation(); addToShopCart(${g.id})" class="bg-[#ff6700]/10 text-[#ff6700] w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm active:bg-[#ff6700] active:text-white">+</button></div></div></div>`).join('');
        updateShopCartBadge();
    }
    function showShopDetail(gid) {
        let g = shopGoods.find(x => x.id === gid); if(!g) return; let modal = $('shop-detail-modal'); let body = modal.querySelector('.food-modal-body');
        let isFav = shopFavs.includes(gid);
        body.innerHTML = `<div class="relative w-full h-80 bg-white shrink-0 flex items-center justify-center"><img src="${g.img}" class="w-2/3 h-2/3 object-contain"><button onclick="closeShopDetail()" class="absolute top-4 left-4 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur">âœ•</button><button onclick="deleteShopGoods(${g.id})" class="absolute top-4 right-4 w-8 h-8 bg-red-500/80 rounded-full text-white flex items-center justify-center backdrop-blur shadow-md text-sm">ğŸ—‘ï¸</button></div><div class="p-4 flex-1 overflow-y-auto"><div class="flex justify-between items-start"><span class="text-[#ff6700] text-3xl font-bold"><span class="text-base">Â¥</span>${g.price}</span><span class="text-xs text-zinc-400 mt-2">æœˆé”€ ${g.sales}+</span></div><h2 class="text-lg font-bold text-zinc-900 mt-2 leading-snug">${g.name}</h2><div class="mt-6 bg-zinc-50 p-3 rounded-lg text-xs text-zinc-500"><p>âœ… æ­£å“ä¿éšœ Â· æé€Ÿé€€æ¬¾ Â· èµ è¿è´¹é™©</p><p class="mt-1">${g.store} å‘è´§</p></div></div><div class="p-3 border-t flex gap-3 items-center bg-white safe-area-pb"><div onclick="toggleShopFav(${g.id})" class="flex flex-col items-center gap-1 px-2 cursor-pointer ${isFav?'text-[#ff6700]':'text-zinc-500'}"><div class="text-xl">${isFav?'â­':'â˜†'}</div><span class="text-[10px]">${isFav?'å·²æ”¶è—':'æ”¶è—'}</span></div><button onclick="addToShopCart(${g.id}); closeShopDetail()" class="flex-1 bg-gradient-to-r from-[#ff9000] to-[#ff5000] text-white py-3 rounded-full font-bold shadow-md active:scale-95 transition-transform">åŠ å…¥è´­ç‰©è½¦</button></div>`;
        modal.classList.add('active');
    }
    function deleteShopGoods(gid) { if(!confirm("ç¡®å®šè¦ä¸‹æ¶è¿™ä¸ªå•†å“å—ï¼Ÿ")) return; shopGoods = shopGoods.filter(x => x.id !== gid); shopCart = shopCart.filter(x => x.id !== gid); shopFavs = shopFavs.filter(x => x !== gid); saveAll(); closeShopDetail(); renderShopList(); renderShopCart(); updateShopCartBadge(); if ($('pg-shop-favs').classList.contains('active')) renderFavs(); }
    function closeShopDetail() { $('shop-detail-modal').classList.remove('active'); renderShopList(); }
    function toggleShopFav(gid) { if(shopFavs.includes(gid)) shopFavs = shopFavs.filter(x=>x!==gid); else shopFavs.push(gid); saveAll(); showShopDetail(gid); }
    function addToShopCart(id) { let item = shopCart.find(x => x.id === id); if(item) { item.count++; } else { shopCart.push({id: id, count: 1}); } saveAll(); updateShopCartBadge(); }
    function updateShopCartBadge() { let total = shopCart.reduce((a, b) => a + b.count, 0); const badge = $('shop-cart-badge'); if(total > 0) { badge.innerText = total; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }
    function renderShopCart() { const list = $('shop-cart-list'); if(shopCart.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><span class="text-6xl mb-4">ğŸ›’</span><span>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</span></div>`; $('shop-cart-total').innerText = '0.00'; return; } let total = 0; list.innerHTML = shopCart.map(c => { let g = shopGoods.find(x => x.id === c.id); if(!g) return ''; let subtotal = g.price * c.count; total += subtotal; return `<div class="bg-white p-3 rounded-xl flex gap-3 items-center"><img src="${g.img}" class="w-16 h-16 rounded-lg object-contain bg-zinc-50 border border-zinc-100"><div class="flex-1"><b class="text-sm block line-clamp-1">${g.name}</b><span class="text-xs text-zinc-400 bg-zinc-50 px-1 rounded">${g.store}</span><div class="flex justify-between items-center mt-2"><span class="text-[#ff6700] font-bold">Â¥${g.price}</span><div class="flex items-center gap-3"><button onclick="chgShopCount(${g.id}, -1)" class="w-6 h-6 rounded border text-zinc-500 flex items-center justify-center">-</button><span class="text-sm font-bold w-4 text-center">${c.count}</span><button onclick="chgShopCount(${g.id}, 1)" class="w-6 h-6 rounded border text-zinc-500 flex items-center justify-center">+</button></div></div></div></div>`; }).join(''); $('shop-cart-total').innerText = total.toFixed(2); }
    function chgShopCount(id, delta) { let item = shopCart.find(x => x.id === id); if(!item) return; item.count += delta; if(item.count <= 0) shopCart = shopCart.filter(x => x.id !== id); saveAll(); renderShopCart(); updateShopCartBadge(); }
    function clearShopCart() { if(confirm("æ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ")) { shopCart=[]; saveAll(); renderShopCart(); updateShopCartBadge(); } }

    function doShopCheckout() { if(shopCart.length === 0) return alert("è¯·å…ˆé€‰è´­å•†å“"); let total = parseFloat($('shop-cart-total').innerText); createShopCheckoutModal(total); }
    function createShopCheckoutModal(total) {
        let roleName = curRole ? curRole.name : 'å¥½å‹'; let overlay = document.createElement('div'); overlay.className = "fixed inset-0 bg-black/50 z-[100] flex items-end";
        overlay.innerHTML = `<div class="bg-white w-full rounded-t-2xl p-6 animate-fade-in"><h3 class="text-lg font-bold mb-4 text-center">å•†åŸæ”¯ä»˜ Â¥${total.toFixed(2)}</h3><div class="space-y-3"><button onclick="handleShopPayOpt('wechat', ${total})" class="w-full py-3 bg-[#07c160] text-white rounded-lg font-bold">å¾®ä¿¡é›¶é’±æ”¯ä»˜</button><button onclick="handleShopPayOpt('bank', ${total})" class="w-full py-3 bg-[#e60012] text-white rounded-lg font-bold flex items-center justify-center gap-2">ğŸ’³ å‚¨è“„å¡æ”¯ä»˜</button><button onclick="handleShopPayOpt('friend', ${total})" class="w-full py-3 bg-white border border-[#ff6700] text-[#ff6700] rounded-lg font-bold flex items-center justify-center gap-2"><span>æ‰¾ ${roleName} ä»£ä»˜</span></button><button onclick="document.body.removeChild(this.parentNode.parentNode.parentNode)" class="w-full py-3 text-zinc-400">å–æ¶ˆ</button></div></div>`;
        document.body.appendChild(overlay); 
        window.handleShopPayOpt = (type, amt) => { 
            document.body.removeChild(overlay); 
            if(type === 'wechat') processShopSelfPay(amt); 
            if(type === 'bank') processBankPay(amt, 'shop');
            if(type === 'friend') { if(!takeoutCtx.fromChat) return alert("è¯·å…ˆåœ¨èŠå¤©å®¤å‘¼å‡ºå•†åŸï¼"); processShopFriendPay(amt); }
        };
    }
    function processShopSelfPay(total) { if(balance < total) return alert(`å¾®ä¿¡é›¶é’±ä¸è¶³ (å½“å‰ Â¥${balance.toFixed(2)})`); balance -= total; createShopOrder(total, 'paid'); alert("å¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼å®è´å°†å°½å¿«å‘è´§ã€‚"); saveAll(); openShopOrders('pending'); }
    function processShopFriendPay(total) { let firstItem = shopGoods.find(g => g.id === shopCart[0].id) || {name: "æœªçŸ¥", img:""}; let count = shopCart.reduce((a,b)=>a+b.count,0); let payMsg = { r: 'u', type: 'pay_request', status: 'pending', total: total, itemDisplay: `[å•†åŸ] ${firstItem.name} ç­‰ ${count} ä»¶`, img: firstItem.img, time: new Date().toLocaleString(), t: `[å•†åŸä»£ä»˜] Â¥${total}` }; curRole.history.push(payMsg); saveAll(); createShopOrder(total, 'wait_pay'); go('pg-chat-room'); renderMsgs(); setTimeout(() => triggerAiPayDecision(curRole.history.length - 1, total), 1500); }
    function createShopOrder(total, status) { let newOrder = { id: Date.now(), items: JSON.parse(JSON.stringify(shopCart)), total: total, time: Date.now(), status: status === 'paid' ? 'shipping' : 'pending_pay' }; shopOrders.unshift(newOrder); shopCart = []; saveAll(); }
    function openShopOrders(type) { go('pg-shop-orders'); let list = $('shop-order-list'); $('shop-order-title').innerText = type==='pending' ? 'å¾…æ”¶è´§' : 'å·²ä¹°åˆ°'; let filtered = type==='pending' ? shopOrders.filter(o => o.status === 'shipping') : shopOrders.filter(o => o.status !== 'shipping' && o.status !== 'pending_pay'); if(filtered.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">æš‚æ— ç›¸å…³è®¢å•</div>`; return; } list.innerHTML = filtered.map(o => { let firstG = shopGoods.find(g => g.id === o.items[0].id) || {name:'æœªçŸ¥',store:''}; let count = o.items.reduce((a,b)=>a+b.count,0); let btn = o.status === 'shipping' ? `<button onclick="confirmShopRec(${o.id})" class="border border-[#ff6700] text-[#ff6700] px-3 py-1 rounded-full text-xs">ç¡®è®¤æ”¶è´§</button>` : `<span class="text-zinc-400 text-xs">äº¤æ˜“å®Œæˆ</span>`; return `<div class="bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-2"><b class="text-sm">${firstG.store}</b><span class="text-xs text-[#ff6700]">${o.status==='shipping'?'å•†å®¶å·²å‘è´§':'å·²å®Œæˆ'}</span></div><div class="flex gap-3 mb-2"><img src="${firstG.img}" class="w-16 h-16 rounded bg-zinc-50 object-contain"><div><div class="text-sm font-bold line-clamp-1">${firstG.name}</div><div class="text-xs text-zinc-400 mt-1">å…± ${count} ä»¶</div></div></div><div class="flex justify-between items-center border-t pt-2"><span class="font-bold">Â¥${o.total.toFixed(2)}</span>${btn}</div></div>`; }).join(''); }
    function confirmShopRec(oid) { let o = shopOrders.find(x=>x.id===oid); if(o){ o.status='completed'; saveAll(); openShopOrders('pending'); updateShopPendingBadge(); } }
    function updateShopPendingBadge() { let c = shopOrders.filter(o => o.status === 'shipping').length; let b = $('badge-shop-pending'); if(c>0){b.innerText=c;b.classList.remove('hidden');}else{b.classList.add('hidden');} }
    function renderFavs() { let list = $('shop-fav-list'); if(shopFavs.length === 0) { list.innerHTML = `<div class="text-center text-zinc-400 mt-20 text-sm">è¿˜æ²¡æœ‰æ”¶è—å•†å“</div>`; return; } list.innerHTML = shopFavs.map(id => { let g = shopGoods.find(x=>x.id===id); if(!g) return ''; return `<div onclick="showShopDetail(${g.id})" class="bg-white p-3 rounded-xl flex gap-3"><img src="${g.img}" class="w-20 h-20 rounded bg-zinc-50 object-contain"><div class="flex-1"><b class="text-sm">${g.name}</b><div class="mt-4 flex justify-between"><span class="text-[#ff6700] font-bold">Â¥${g.price}</span><span class="text-xs text-zinc-400">å·²æ”¶è—</span></div></div></div>`; }).join(''); }
    function saveNewGoods() { let s=$('sf-store').value, n=$('sf-name').value, p=parseFloat($('sf-price').value), i=$('sf-img').value; if(!s||!n||isNaN(p)) return alert("è¯·å¡«å†™å®Œæ•´"); shopGoods.push({id:Date.now(), store:s, name:n, price:p, sales:0, img:i||"https://img.icons8.com/color/480/box.png"}); saveAll(); alert("å‘å¸ƒæˆåŠŸ"); $('sf-name').value=''; go('pg-shop-me'); }

    // ================== 13. AI äº’åŠ¨åé¦ˆå¼•æ“ ==================
    async function triggerAiPayDecision(msgIdx, amount) {
        let msg = curRole.history[msgIdx]; if (!msg || msg.type !== 'pay_request') { msg = curRole.history.findLast(m => m.type === 'pay_request' && m.status === 'pending'); } if (!msg || msg.status !== 'pending') return;
        let loadingMsg = { r: 'ai', t: '', loading: true }; curRole.history.push(loadingMsg); renderMsgs(); let cfg = await getAICfg();
        let recentMsgs = curRole.history.slice(-15).filter(m => !m.loading && m.type === 'text').map(m => { let roleName = m.r === 'u' ? 'æˆ‘' : curRole.name; return `${roleName}: ${m.t}`; }).join('\n');
        let userMask = curRole.userMask || {}; let userName = userMask.name || "æˆ‘"; let userPersona = userMask.info || "æ™®é€šæœ‹å‹";
        let sysPrompt = `ä½ æ­£åœ¨è§’è‰²æ‰®æ¼”ã€‚\nã€ä½ çš„èº«ä»½ã€‘: ${curRole.name}\nã€ä½ çš„è®¾å®šã€‘: ${curRole.info}\nã€å¯¹æ‰‹è§’è‰²ã€‘: ${userName} (è®¾å®š: ${userPersona})\n\nã€å½“å‰äº‹ä»¶ã€‘\n${userName} ç»™ä½ å‘äº†ä»£ä»˜è¯·æ±‚ï¼Œé‡‘é¢ ${amount.toFixed(2)} å…ƒã€‚\n\nã€é€»è¾‘ã€‘\nç»“åˆã€è¿‘æœŸèŠå¤©ã€‘ã€‚ä¸¥ç¦å‡ºæˆï¼\n\nã€è¿‘æœŸèŠå¤©ã€‘\n${recentMsgs}\n\nã€å›å¤æ ¼å¼ã€‘\nè¯·ä¸¥æ ¼æŒ‰æ­¤æ ¼å¼è¾“å‡ºï¼š\n[CMD:ACCEPT] ä½ çš„å›å¤  (å¦‚åŒæ„)\n[CMD:REJECT] ä½ çš„å›å¤  (å¦‚æ‹’ç»)`;
        try {
            let replyContent = ""; let isAccept = false;
            if (cfg.key) { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [ { role: 'system', content: sysPrompt } ] }) }); let data = await res.json(); let raw = data.choices[0].message.content; if (raw.includes('[CMD:ACCEPT]')) { isAccept = true; replyContent = raw.replace('[CMD:ACCEPT]', '').trim(); } else if (raw.includes('[CMD:REJECT]')) { isAccept = false; replyContent = raw.replace('[CMD:REJECT]', '').trim(); } else { isAccept = !raw.includes("ä¸") && !raw.includes("æ²¡é’±") && !raw.includes("æ‹’"); replyContent = raw; } } 
            else { isAccept = Math.random() > 0.4; replyContent = isAccept ? "è¡Œå§ï¼Œè¿™æ¬¡è¯·ä½ ã€‚" : "è‡ªå·±ä»˜ï¼Œæˆ‘å¯æ²¡é’±ã€‚"; }
            curRole.history.pop(); msg.status = isAccept ? 'paid' : 'rejected';
            let pendingFoodOrder = orders.find(o => o.status === 'pending_pay'); if (pendingFoodOrder) { if (isAccept) pendingFoodOrder.status = 'delivering'; else pendingFoodOrder.status = 'cancelled'; }
            let pendingShopOrder = shopOrders.find(o => o.status === 'pending_pay'); if (pendingShopOrder) { if (isAccept) pendingShopOrder.status = 'shipping'; else pendingShopOrder.status = 'cancelled'; }
            saveAll();
            if (!replyContent) replyContent = isAccept ? "å·²æ”¯ä»˜ã€‚" : "å·²æ‹’ç»ã€‚";
            curRole.history.push({ r: 'ai', t: replyContent, type: 'text' });
        } catch (e) { console.error("Pay Error", e); curRole.history.pop(); msg.status = 'rejected'; curRole.history.push({ r: 'ai', t: `(å†³ç­–å¤±è´¥)`, type: 'text' }); } finally { saveAll(); renderMsgs(); }
    }
    
    function shareOrder(oid) { if (!curRole) return alert("è¯·å…ˆä»èŠå¤©ç•Œé¢è¿›å…¥"); let o = orders.find(x => x.id === oid); let firstItem = foods.find(f => f.id === o.items[0].id); let count = o.items.reduce((a,b)=>a+b.count,0); let shareMsg = { r: 'u', type: 'order_share', itemDisplay: `${firstItem.name} ç­‰`, count: count, img: firstItem.img, t: `[åˆ†äº«å¤–å–] ${firstItem.name}` }; curRole.history.push(shareMsg); saveAll(); go('pg-chat-room'); renderMsgs(); setTimeout(() => triggerAiShareReaction(shareMsg), 1500); }
    async function triggerAiShareReaction(shareMsg) { let loadingMsg = { r: 'ai', t: '', loading: true }; curRole.history.push(loadingMsg); renderMsgs(); let cfg = await getAICfg(); let sysPrompt = `ä½ æ˜¯${curRole.name}ã€‚\nã€äº‹ä»¶ã€‘ï¼šç”¨æˆ·ç»™ä½ åˆ†äº«äº†å¤–å–ï¼š${shareMsg.itemDisplay}ã€‚\nã€äººè®¾ã€‘ï¼š${curRole.info}ã€‚\nã€è¦æ±‚ã€‘ï¼šåšå‡ºååº”ï¼Œå£è¯­åŒ–ã€‚`; try { let replyContent = ""; if (cfg.key) { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sysPrompt }] }) }); let data = await res.json(); replyContent = data.choices[0].message.content; } else { replyContent = "çœ‹ç€ä¸é”™ï¼"; } curRole.history.pop(); curRole.history.push({ r: 'ai', t: replyContent, type: 'text' }); } catch (e) { curRole.history.pop(); } finally { saveAll(); renderMsgs(); } }
    
    async function triggerAiReaction(mid, userContent) { let activeRoles = roles.filter(r => chats.includes(r.id)); if(activeRoles.length === 0) activeRoles = roles; if(activeRoles.length === 0) return; let selectedRoles = activeRoles.sort(() => 0.5 - Math.random()).slice(0, 2); let cfg = await getAICfg(); if(!cfg.key) return; for (let role of selectedRoles) { if(Math.random() > 0.5) continue; let prompt = `ç”¨æˆ·åœ¨æœ‹å‹åœˆå‘ï¼šâ€œ${userContent}â€ã€‚ä½ æ˜¯${role.name}ã€‚è¾“å‡ºæŒ‡ä»¤ï¼š\n[LIKE]\n[COMMENT:ä½ çš„è¯„è®º]\n[LIKE][COMMENT:...]\n[IGNORE]`; try { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] }) }); let data = await res.json(); let reply = data.choices[0].message.content; let m = mnts.find(x => x.id === mid); if(!m) return; if(reply.includes('[LIKE]')) { if(!m.likes) m.likes = []; if(!m.likes.includes(role.id)) m.likes.push(role.id); } let commMatch = reply.match(/\[COMMENT:(.*?)\]/); if(commMatch) { if(!m.comments) m.comments = []; m.comments.push({ uid: role.id, content: commMatch[1], time: Date.now() }); } saveAll(); if(curTab === 'moments') renderMnts(); } catch (e) {} } }
    async function triggerAiReplyToComment(mid, userComment, replyToUid) { let m = mnts.find(x => x.id === mid); if (!m) return; let targetRole = null; let systemPrompt = ""; if (replyToUid) { targetRole = roles.find(r => r.id === replyToUid); if (targetRole) { let prevComment = m.comments.findLast(c => c.uid === replyToUid && c.time < Date.now()); let prevContent = prevComment ? prevComment.content : "ï¼ˆæœªçŸ¥è¯„è®ºï¼‰"; systemPrompt = `æƒ…æ™¯ï¼šä½ åœ¨æœ‹å‹åœˆè¯„è®ºäº†ï¼šâ€œ${prevContent}â€ã€‚\nç”¨æˆ·å›å¤ä½ ï¼šâ€œ${userComment}â€ã€‚\nè¯·å›å¤ç”¨æˆ·ï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚`; } } else if (m.r !== 'u') { targetRole = roles.find(r => r.id === m.r); if (targetRole) { systemPrompt = `æƒ…æ™¯ï¼šä½ å‘äº†æœ‹å‹åœˆï¼šâ€œ${m.content}â€ã€‚\nå¥½å‹è¯„è®ºï¼šâ€œ${userComment}â€ã€‚\nè¯·å›å¤ä»–ã€‚`; } } if (targetRole && systemPrompt) { let cfg = await getAICfg(); if(!cfg.key) return; try { let res = await fetch(`${cfg.url}/v1/chat/completions`, { method: 'POST', headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: systemPrompt }] }) }); let data = await res.json(); let reply = data.choices[0].message.content.replace(/^["â€œ]|["â€]$/g, '').trim(); if(!m.comments) m.comments = []; m.comments.push({ uid: targetRole.id, content: reply, time: Date.now(), replyToName: "æˆ‘" }); saveAll(); if(curTab === 'moments') renderMnts(); } catch (e) {} } }

    // ================== 14. å‚¨è“„å¡ã€é’±åŒ…ã€å……æä¸è”ä»˜æ ¸å¿ƒ ==================
    function renderWallet() { $('wallet-num').innerText = parseFloat(balance).toFixed(2); }
    function getBankRecords() { return JSON.parse(localStorage.getItem('OS67_BANK') || '[]'); }
    function addBankRecord(title, amount, isIncome) { let r = getBankRecords(); r.unshift({ id: Date.now(), title, amount, isIncome, time: new Date().toLocaleString() }); localStorage.setItem('OS67_BANK', JSON.stringify(r)); updateBankUI(); }
    function getBankBalance() { let r = getBankRecords(); return r.reduce((sum, item) => item.isIncome ? sum + item.amount : sum - item.amount, 0); }
    function updateBankUI() { let r = getBankRecords(); let income = 0, expense = 0, total = 0; r.forEach(item => { if (item.isIncome) { income += item.amount; total += item.amount; } else { expense += item.amount; total -= item.amount; } }); if($('bank-total-assets')) $('bank-total-assets').innerText = 'Â¥ ' + total.toFixed(2); if($('bank-month-income')) $('bank-month-income').innerText = 'Â¥ ' + income.toFixed(2); if($('bank-month-expense')) $('bank-month-expense').innerText = 'Â¥ ' + expense.toFixed(2); }
    
    window.processBankPay = function(total, type) { let bankBal = getBankBalance(); if(bankBal < total) return alert(`å‚¨è“„å¡ä½™é¢ä¸è¶³ï¼\nå½“å‰æ€»èµ„äº§: Â¥${bankBal.toFixed(2)}\nè¯·å…ˆå»é“¶è¡ŒAppç‚¹å‡»â€œé“¶è¡Œå¡å…¥è´¦â€ã€‚`); addBankRecord(type === 'food' ? 'å¤–å–æ¶ˆè´¹' : 'å•†åŸæ¶ˆè´¹', total, false); if(type === 'food') { createOrder(total, 'paid'); alert("å‚¨è“„å¡æ”¯ä»˜æˆåŠŸï¼"); go('pg-takeout-pending'); renderPendingOrders(); } else { createShopOrder(total, 'paid'); alert("å‚¨è“„å¡æ”¯ä»˜æˆåŠŸï¼"); openShopOrders('pending'); } };
    window.simulateBankIncome = function() { let val = prompt("ã€æ¨¡æ‹Ÿå‚¨è“„å¡å…¥è´¦ã€‘\nè¯·è¾“å…¥é‡‘é¢ï¼š"); if(val === null) return; let num = parseFloat(val); if(isNaN(num) || num <= 0) return alert("é‡‘é¢æ— æ•ˆï¼"); addBankRecord('å¤–éƒ¨è½¬å…¥/å‘å·¥èµ„', num, true); alert(`æˆåŠŸå…¥è´¦ Â¥${num.toFixed(2)}ï¼`); }
    function toBankTab(tab) { $('bank-tab-home').classList.add('hidden'); $('bank-tab-me').classList.add('hidden'); $('nav-bank-home').className = "text-center flex-1 py-1 cursor-pointer text-zinc-400"; $('nav-bank-me').className = "text-center flex-1 py-1 cursor-pointer text-zinc-400"; $('bank-tab-' + tab).classList.remove('hidden'); $('nav-bank-' + tab).classList.add('text-[#e60012]', 'font-bold'); $('nav-bank-' + tab).classList.remove('text-zinc-400'); if (tab === 'me') updateBankUI(); }
    function renderBankRecords() { let list = $('bank-records-list'); let records = getBankRecords(); if(records.length === 0) { list.innerHTML = '<div class="text-center text-zinc-400 mt-32 text-sm">æš‚æ— æ”¶æ”¯æ˜ç»†</div>'; return; } list.innerHTML = records.map(r => `<div class="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm border-b border-zinc-50"><div class="flex flex-col"><b class="text-base text-zinc-800">${r.title}</b><span class="text-xs text-zinc-400 mt-1">${r.time}</span></div><div class="font-bold text-lg ${r.isIncome ? 'text-[#e60012]' : 'text-zinc-800'}">${r.isIncome ? '+' : '-'}${r.amount.toFixed(2)}</div></div>`).join(''); }

    function walletOp(type) { if(type === 'add') { initRechargePage(); go('pg-recharge'); } else { initWithdrawPage(); go('pg-withdraw'); } }

    let rechargeInputVal = ""; function initRechargePage() { rechargeInputVal = ""; updateRechargeDisplay(); }
    window.handleRechargeInput = function(key) { if (key === 'del') rechargeInputVal = rechargeInputVal.slice(0, -1); else if (key === '.') { if (!rechargeInputVal.includes('.') && rechargeInputVal.length > 0) rechargeInputVal += key; else if (rechargeInputVal.length === 0) rechargeInputVal = "0."; } else { if (rechargeInputVal === '0' && key !== '.') rechargeInputVal = key; else if (rechargeInputVal.includes('.')) { if (rechargeInputVal.split('.')[1].length < 2) rechargeInputVal += key; } else if (rechargeInputVal.length < 8) rechargeInputVal += key; } updateRechargeDisplay(); }
    function updateRechargeDisplay() { $('recharge-amount-display').innerText = rechargeInputVal; $('recharge-cursor').style.display = rechargeInputVal.length > 0 ? 'none' : 'inline'; const btn = $('btn-recharge-confirm'); let num = parseFloat(rechargeInputVal); if (!isNaN(num) && num > 0) btn.classList.remove('opacity-40', 'pointer-events-none'); else btn.classList.add('opacity-40', 'pointer-events-none'); }
    window.confirmRecharge = function() { let num = parseFloat(rechargeInputVal); if (isNaN(num) || num <= 0) return; let bankBal = getBankBalance(); if (bankBal < num) return alert(`å‚¨è“„å¡ä½™é¢ä¸è¶³ï¼å½“å‰ä»…æœ‰ Â¥${bankBal.toFixed(2)}`); balance += num; saveAll(); renderWallet(); addBankRecord('å¾®ä¿¡å……å€¼æ‰£æ¬¾', num, false); let toast = document.createElement('div'); toast.className = "fixed inset-0 z-[100] flex items-center justify-center bg-white animate-fade-in"; toast.innerHTML = `<div class="flex flex-col items-center"><div class="w-20 h-20 bg-[#07c160] rounded-full flex items-center justify-center mb-4"><span class="text-white text-4xl">âœ”</span></div><b class="text-xl mb-2">å……å€¼æˆåŠŸ</b><div class="text-4xl font-bold">Â¥${num.toFixed(2)}</div></div>`; document.body.appendChild(toast); setTimeout(() => { document.body.removeChild(toast); go('pg-wallet'); initRechargePage(); }, 1500); }
    window.focusRechargeInput = function() { $('recharge-cursor').style.display = 'inline'; }

    let withdrawInputVal = ""; function initWithdrawPage() { withdrawInputVal = ""; $('withdraw-max-text').innerText = parseFloat(balance).toFixed(2); updateWithdrawDisplay(); }
    window.withdrawAll = function() { if(balance <= 0) return; withdrawInputVal = parseFloat(balance).toFixed(2); updateWithdrawDisplay(); }
    window.handleWithdrawInput = function(key) { if (key === 'del') withdrawInputVal = withdrawInputVal.slice(0, -1); else if (key === '.') { if (!withdrawInputVal.includes('.') && withdrawInputVal.length > 0) withdrawInputVal += key; else if (withdrawInputVal.length === 0) withdrawInputVal = "0."; } else { if (withdrawInputVal === '0' && key !== '.') withdrawInputVal = key; else if (withdrawInputVal.includes('.')) { if (withdrawInputVal.split('.')[1].length < 2) withdrawInputVal += key; } else if (withdrawInputVal.length < 8) withdrawInputVal += key; } updateWithdrawDisplay(); }
    function updateWithdrawDisplay() { $('withdraw-amount-display').innerText = withdrawInputVal; $('withdraw-cursor').style.display = withdrawInputVal.length > 0 ? 'none' : 'inline'; const btn = $('btn-withdraw-confirm'); let num = parseFloat(withdrawInputVal); if (!isNaN(num) && num > 0) btn.classList.remove('opacity-40', 'pointer-events-none'); else btn.classList.add('opacity-40', 'pointer-events-none'); }
    window.confirmWithdraw = function() { let num = parseFloat(withdrawInputVal); if (isNaN(num) || num <= 0) return; if (num > balance) return alert("å¾®ä¿¡é›¶é’±ä½™é¢ä¸è¶³ï¼"); balance -= num; saveAll(); renderWallet(); addBankRecord('å¾®ä¿¡æç°å…¥è´¦', num, true); let toast = document.createElement('div'); toast.className = "fixed inset-0 z-[100] flex items-center justify-center bg-[#f7f7f7] animate-fade-in"; toast.innerHTML = `<div class="flex flex-col items-center mt-20"><div class="w-16 h-16 bg-[#07c160] rounded-full flex items-center justify-center mb-6"><span class="text-white text-3xl">âœ”</span></div><b class="text-xl mb-4">æç°å‘èµ·æˆåŠŸ</b><div class="text-4xl font-bold mb-2">Â¥${num.toFixed(2)}</div><div class="text-sm text-zinc-400">é¢„è®¡2å°æ—¶å†…åˆ°è´¦</div></div>`; document.body.appendChild(toast); setTimeout(() => { document.body.removeChild(toast); go('pg-wallet'); initWithdrawPage(); }, 1800); }
    window.focusWithdrawInput = function() { $('withdraw-cursor').style.display = 'inline'; }

    // å…¨å±€ç‚¹å‡»å…³é—­ä¸‹æ‹‰èœå•
    function closeAllMenus() { 
        let drop = $('plus-dropdown'); 
        if(drop && !drop.classList.contains('hidden')) drop.classList.add('hidden'); 
    }

    // ================== å‘èµ·èŠå¤© & ç¾¤èŠå¼¹çª—é€»è¾‘ ==================
    window.handlePlusBtn = function(e) {
        if(e) e.stopPropagation();
        if (curTab === 'cont') openRoleEdit(null); 
        else if (curTab === 'moments') go('pg-moments-pub');
        else {
            let drop = $('plus-dropdown');
            if (drop) drop.classList.toggle('hidden');
        }
    };

    // --- å•äººèŠå¤© ---
    window.openSingleChatSelector = function() {
        $('plus-dropdown').classList.add('hidden');
        const list = document.getElementById('role-selector-list');
        let realRoles = roles.filter(r => !r.isGroup); // è¿‡æ»¤æ‰ç¾¤èŠï¼Œåªæ‹‰å–å•äºº
        if (realRoles.length === 0) list.innerHTML = `<div class="py-20 text-center text-zinc-400">æš‚æ— è§’è‰²ï¼Œè¯·å…ˆå»â€œé€šè®¯å½•â€æ·»åŠ </div>`;
        else list.innerHTML = realRoles.map(r => `<div onclick="selectRoleToChat('${r.id}')" class="p-4 flex items-center gap-4 active:bg-zinc-100 border-b border-zinc-50 cursor-pointer"><img src="${r.ava}" class="w-12 h-12 rounded-lg object-cover bg-zinc-200 shrink-0"><div class="flex-1 min-w-0"><b class="block text-base text-zinc-800 truncate">${r.name}</b><p class="text-xs text-zinc-400 truncate mt-1">${r.info || 'ç‚¹å‡»å¼€å§‹å¯¹è¯'}</p></div></div>`).join('');
        document.getElementById('role-selector-modal').style.display = 'flex';
    };
    window.closeRoleSelector = function() { document.getElementById('role-selector-modal').style.display = 'none'; };
    window.selectRoleToChat = function(rid) { window.closeRoleSelector(); if (typeof enterChat === 'function') enterChat(rid); };

        // --- å¤šäººç¾¤èŠ (å®Œç¾ä¿®å¤é€‰ä¸­ Bug) ---
    let selectedGroupIds = [];
    window.openGroupChatSelector = function() {
        $('plus-dropdown').classList.add('hidden');
        selectedGroupIds = [];
        renderGroupSelectorList();
        document.getElementById('group-selector-modal').style.display = 'flex';
    };

    window.renderGroupSelectorList = function() {
        const list = document.getElementById('group-selector-list');
        let realRoles = roles.filter(r => !r.isGroup);
        $('group-sel-count').innerText = selectedGroupIds.length;
        if (realRoles.length === 0) { list.innerHTML = `<div class="py-20 text-center text-zinc-400">è§’è‰²ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºç¾¤èŠ</div>`; return; }
        list.innerHTML = realRoles.map(r => {
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå°†æ•°å­—IDå¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç¡®ä¿å¯¹æ¯”æˆåŠŸï¼
            let strId = String(r.id);
            let isSel = selectedGroupIds.includes(strId);
            return `
            <div onclick="toggleGroupRole('${strId}')" class="p-4 flex items-center gap-4 active:bg-zinc-100 border-b border-zinc-50 cursor-pointer">
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 transition-colors ${isSel ? 'border-[#07c160] bg-[#07c160]' : 'border-zinc-300'}">${isSel ? '<span class="text-white text-xs">âœ”</span>' : ''}</div>
                <img src="${r.ava}" class="w-12 h-12 rounded-lg object-cover bg-zinc-200 shrink-0">
                <div class="flex-1 min-w-0"><b class="block text-base text-zinc-800 truncate">${r.name}</b></div>
            </div>`;
        }).join('');
    };

    window.toggleGroupRole = function(rid) {
        let strId = String(rid); // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²å¤„ç†
        if (selectedGroupIds.includes(strId)) selectedGroupIds = selectedGroupIds.filter(id => id !== strId);
        else selectedGroupIds.push(strId);
        renderGroupSelectorList();
    };

    window.closeGroupSelector = function() { document.getElementById('group-selector-modal').style.display = 'none'; };

    window.confirmCreateGroup = function() {
        if (selectedGroupIds.length < 2) return alert("è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªè§’è‰²å‘èµ·ç¾¤èŠå“¦");
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šè¿‡æ»¤å‡ºé€‰ä¸­çš„è§’è‰²æ—¶ï¼ŒåŒæ ·å¼ºåˆ¶è½¬æ¢IDè¿›è¡ŒåŒ¹é…
        let selectedRoles = roles.filter(r => selectedGroupIds.includes(String(r.id)));
        let groupName = selectedRoles.map(r => r.name).join('ã€');
        if (groupName.length > 12) groupName = groupName.substring(0, 12) + '...';
        
        let groupInfo = `ã€ç³»ç»Ÿå¼ºåˆ¶è®¾å®šï¼šè¿™æ˜¯ä¸€ä¸ªå¤šäººç¾¤èŠã€‘\nä½ ç°åœ¨çš„èº«ä»½ä¸æ˜¯å•ä¸ªäººï¼Œè€Œæ˜¯ç¾¤é‡Œçš„å¤šä¸ªæˆå‘˜ã€‚è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹ç¾¤æˆå‘˜çš„æ€§æ ¼è®¾å®šï¼Œå¹¶æ ¹æ®ç”¨æˆ·çš„å‘è¨€ï¼Œè‡ªç”±åˆ¤æ–­è®©å“ªä¸ªè§’è‰²ï¼ˆæˆ–å“ªå‡ ä¸ªè§’è‰²ï¼‰è¿›è¡Œå›å¤ã€‚å›å¤æ—¶å¿…é¡»å¸¦ä¸Šäººåä½œä¸ºå‰ç¼€ï¼ˆæ ¼å¼ä¸º"è§’è‰²åï¼šè¯´çš„è¯"ï¼‰ã€‚\nã€ç¾¤æˆå‘˜åˆ—è¡¨åŠè®¾å®šã€‘ï¼š\n` + selectedRoles.map(r => `- ${r.name}: ${r.info}`).join('\n');
        
        let newGroup = {
            id: 'group_' + Date.now(),
            isGroup: true,
            memberIds: selectedGroupIds,
            name: groupName + ` (${selectedGroupIds.length})`,
            ava: 'https://img.icons8.com/color/96/user-group-man-man.png',
            info: groupInfo,
            history: []
        };
        
        roles.unshift(newGroup);
        chats.unshift(newGroup.id);
        saveAll();
        closeGroupSelector();
        enterChat(newGroup.id);
    };
ã€€ã€€    // ================== æ–°å¢ï¼šè§’è‰²æ—¥è®°ç³»ç»Ÿ ==================
    function openDiaryPage() {
        if (!curRole) return;
        if (curRole.isGroup) return alert("ç¾¤èŠæš‚æ—¶ä¸æ”¯æŒå·çœ‹æ—¥è®°å“¦~");
        
        $('chat-pnl').classList.remove('drawer-open');
        lastPnlType = null;
        
        $('diary-title').innerText = `${curRole.name} çš„æ—¥è®°`;
        if (!curRole.diaries) curRole.diaries = [];
        
        renderDiaryList();
        go('pg-diary');
    }

    function renderDiaryList() {
        const list = $('diary-list');
        if (!curRole || !curRole.diaries || curRole.diaries.length === 0) {
            list.innerHTML = `<div class="flex flex-col items-center justify-center mt-32 opacity-50"><div class="text-6xl mb-4">âœï¸</div><div class="text-sm text-zinc-500">Taè¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°...<br>ç‚¹å‡»å³ä¸Šè§’è®©Taå†™ä¸€ç¯‡å§ï¼</div></div>`;
            return;
        }
        
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
        let sorted = [...curRole.diaries].sort((a, b) => b.timestamp - a.timestamp);
        
        list.innerHTML = sorted.map(d => `
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-zinc-100 relative group animate-fade-in">
                <div class="flex justify-between items-center mb-3 border-b border-zinc-50 pb-2">
                    <span class="text-sm font-bold text-[#576b95]">${d.date}</span>
                    <span onclick="deleteDiary(${d.id})" class="text-xs text-zinc-300 cursor-pointer hover:text-red-500">åˆ é™¤</span>
                </div>
                <div class="text-[15px] text-zinc-800 leading-loose whitespace-pre-wrap font-serif text-justify">${d.content}</div>
            </div>
        `).join('');
    }

    function deleteDiary(id) {
        if (!confirm("ç¡®å®šè¦é”€æ¯è¿™ç¯‡æ—¥è®°å—ï¼Ÿ")) return;
        curRole.diaries = curRole.diaries.filter(d => d.id !== id);
        saveAll();
        renderDiaryList();
    }

    async function generateDiary() {
        if (!curRole) return;
        let cfg = await getAICfg();
        if (!cfg.key) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Keyï¼");
        
        // ğŸ¯ ä¼˜åŒ–ï¼šæ—¥è®°ç´ æä¼šåŒæ—¶æŠ“å–â€œå¾®ä¿¡â€å’Œâ€œçº¿ä¸‹â€çš„æ‰€æœ‰æ–‡æœ¬è®°å½•ï¼Œä¿è¯ç´ æå®Œæ•´
        let recentMsgs = (curRole.history || [])
            .filter(m => !m.loading && m.type === 'text')
            .slice(-30) // å–æœ€è¿‘30æ¡ï¼Œç´ ææ›´ä¸°å¯Œ
            .map(m => {
                let roleName = m.r === 'u' ? 'ç”¨æˆ·' : curRole.name;
                // æ ‡æ³¨åœºæ™¯ï¼Œå¸® AI æ›´å¥½åœ°ç†è§£ä¸Šä¸‹æ–‡
                let sceneLabel = m.scene === 'story' ? '[çº¿ä¸‹è§é¢]' : '[å¾®ä¿¡èŠå¤©]';
                return `${sceneLabel} ${roleName}: ${m.t}`;
            }).join('\n');

        let btn = document.querySelector('[onclick="generateDiary()"]');
        let oldText = btn ? btn.innerText : "å·çœ‹ä»Šæ—¥";
        if(btn) {
            btn.innerText = "æ’°å†™ä¸­...";
            btn.style.pointerEvents = 'none';
            btn.classList.add('opacity-50');
        }

        let todayStr = new Date().toLocaleDateString();
        let prompt = `ä½ ç°åœ¨æ˜¯${curRole.name}ã€‚ä½ çš„æ€§æ ¼è®¾å®šæ˜¯ï¼š${curRole.info}ã€‚
        è¯·æ ¹æ®ä»¥ä¸‹è¿™æ®µæ—¶é—´ä½ å’Œç”¨æˆ·çš„äº’åŠ¨è®°å½•ï¼ˆåŒ…å«å¾®ä¿¡èŠå¤©å’Œçº¿ä¸‹è§é¢ï¼‰ï¼Œä»¥ã€ç¬¬ä¸€äººç§°ã€‘å†™ä¸€ç¯‡ç§˜å¯†æ—¥è®°ã€‚
        è¦æ±‚ï¼š
        1. è¯­æ°”å¿…é¡»ç¬¦åˆä½ çš„æ€§æ ¼ï¼Œåƒæ˜¯åœ¨è‡ªè¨€è‡ªè¯­ã€‚
        2. ä¸¥ç¦è¾“å‡ºåºŸè¯æˆ– <think> æ ‡ç­¾ï¼Œç›´æ¥è¾“å‡ºæ—¥è®°æ­£æ–‡ã€‚
        ã€äº’åŠ¨è®°å½•å¦‚ä¸‹ã€‘ï¼š
        ${recentMsgs ? recentMsgs : "(æ­¤åˆ»ä½ æ­£ä¸€ä¸ªäººå¾…ç€ï¼Œå†™å†™å¯¹ç”¨æˆ·çš„æ€å¿µæˆ–è¿‘å†µå§)"}`;

        try {
            let res = await fetch(`${cfg.url}/v1/chat/completions`, {
                method: 'POST',
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cfg.key}` },
                body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] })
            });
            
            // --- æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ å®‰å…¨æ€§æ£€æŸ¥ï¼Œé˜²æ­¢ reading '0' æŠ¥é”™ ---
            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.error?.message || `HTTP é”™è¯¯ ${res.status}`);
            }

            let data = await res.json();
            
            if (!data.choices || data.choices.length === 0) {
                throw new Error("API æœªèƒ½ç”Ÿæˆæœ‰æ•ˆå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹è®¾ç½®æˆ–ä½™é¢");
            }

            let diaryContent = cleanText(data.choices[0].message.content);

            if (!curRole.diaries) curRole.diaries = [];
            let existingIdx = curRole.diaries.findIndex(d => d.date === todayStr);
            if (existingIdx > -1) {
                curRole.diaries[existingIdx].content = diaryContent;
                curRole.diaries[existingIdx].timestamp = Date.now();
            } else {
                curRole.diaries.push({ id: Date.now(), date: todayStr, content: diaryContent, timestamp: Date.now() });
            }
            
            saveAll();
            renderDiaryList();
        } catch (e) {
            console.error("Diary Generation Error:", e);
            alert("ç”Ÿæˆå¤±è´¥è¯¦æƒ…: " + e.message); // ä¼šå¼¹å‡ºå…·ä½“çš„æŠ¥é”™åŸå› 
        } finally {
            if(btn) {
                btn.innerText = oldText;
                btn.style.pointerEvents = 'auto';
                btn.classList.remove('opacity-50');
            }
        }
    } 
    // ================== 15. éŸ³ä¹æ’­æ”¾å™¨ä¸æœ¬åœ°ä¸Šä¼ é€»è¾‘ ==================
    function toMusicTab(tab) {
        $('pg-music-player').classList.remove('active');
        $('pg-music-me').classList.remove('active');
        $('pg-music-' + tab).classList.add('active');
        if(tab === 'me') renderMusicLib();
        if(tab === 'player') renderMusicPlayer();
    }

    // ç›‘å¬åŸç”Ÿ Audio äº‹ä»¶åŒæ­¥ UI
    curAudio.ontimeupdate = () => {
        if (isNaN(curAudio.duration)) return;
        $('music-progress').value = (curAudio.currentTime / curAudio.duration) * 100;
        $('music-time-cur').innerText = formatTime(curAudio.currentTime);
        $('music-time-total').innerText = formatTime(curAudio.duration);
    };
    curAudio.onended = () => nextMusic();

    function formatTime(seconds) {
        let m = Math.floor(seconds / 60);
        let s = Math.floor(seconds % 60);
        return m + ":" + (s < 10 ? "0" + s : s);
    }

    function renderMusicPlayer() {
        if (curMusicIdx === -1 && musicLib.length > 0) curMusicIdx = 0;
        if (curMusicIdx === -1) return; // æ²¡æ­Œ       
                let m = musicLib[curMusicIdx];
        $('music-title').innerText = m.title;
        $('music-artist').innerText = m.artist;
        
        // ğŸ¯ æ–°å¢ï¼šå¦‚æœæœ‰è‡ªå®šä¹‰å°é¢å°±ç”¨è‡ªå®šä¹‰çš„ï¼Œæ²¡æœ‰å°±ç”¨é»˜è®¤çš„æ˜Ÿç©ºå›¾
        $('music-cover').src = m.cover || "https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=500&auto=format&fit=crop";
        // æ›´æ–°æ’­æ”¾æŒ‰é’®å’Œæ—‹è½¬åŠ¨ç”»
        let cover = $('music-cover');
        let playBtn = $('btn-music-play');
        if (isPlaying) {
            playBtn.innerHTML = '<span class="text-3xl font-bold -mt-1">||</span>';
            cover.classList.remove('spin-paused');
        } else {
            playBtn.innerText = 'â–¶';
            cover.classList.add('spin-paused');
        }
    }

    function togglePlay() {
        if (curMusicIdx === -1) {
            if (musicLib.length > 0) playMusicIndex(0);
            else alert("æœ¬åœ°éŸ³ä¹åº“ä¸ºç©ºï¼Œè¯·å…ˆå»â€œæˆ‘â€çš„é¡µé¢ä¸Šä¼ éŸ³ä¹~");
            return;
        }
        if (isPlaying) {
            curAudio.pause();
            isPlaying = false;
        } else {
            // å¦‚æœ audio çš„ src ä¸ºç©ºï¼Œéœ€è¦å…ˆèµ‹å€¼
            if(!curAudio.src) loadAudioSource(musicLib[curMusicIdx]);
            curAudio.play().catch(e => alert("æ’­æ”¾å¤±è´¥, å¯èƒ½æ˜¯æµè§ˆå™¨é™åˆ¶è‡ªåŠ¨æ’­æ”¾"));
            isPlaying = true;
        }
        renderMusicPlayer();
    }

    function loadAudioSource(m) {
        // ä½¿ç”¨ URL.createObjectURL è¯»å–å­˜å‚¨åœ¨ DB çš„ Blob æˆ– File å¯¹è±¡
        if (m.blob) {
            curAudio.src = URL.createObjectURL(m.blob);
        } else if (m.url) { // å…¼å®¹ç›´é“¾
            curAudio.src = m.url;
        }
    }

    function playMusicIndex(idx) {
        if(idx < 0 || idx >= musicLib.length) return;
        curMusicIdx = idx;
        let m = musicLib[idx];
        loadAudioSource(m);
        curAudio.play();
        isPlaying = true;
        renderMusicPlayer();
    }

    function nextMusic() {
        if(musicLib.length <= 1) return;
        let next = curMusicIdx + 1;
        if(next >= musicLib.length) next = 0;
        playMusicIndex(next);
    }

    function prevMusic() {
        if(musicLib.length <= 1) return;
        let prev = curMusicIdx - 1;
        if(prev < 0) prev = musicLib.length - 1;
        playMusicIndex(prev);
    }

    function seekMusic(val) {
        if (isNaN(curAudio.duration)) return;
        curAudio.currentTime = (val / 100) * curAudio.duration;
    }

    function toggleMusicFav() {
        let btn = $('music-fav-btn');
        if (btn.innerText === 'â™¡') { btn.innerText = 'â¤ï¸'; btn.classList.add('text-red-500'); }
        else { btn.innerText = 'â™¡'; btn.classList.remove('text-red-500'); }
    }

    // --- æœ¬åœ°ä¸Šä¼ ä¸åˆ—è¡¨æ¸²æŸ“ ---
// --- æœ¬åœ°å°é¢ä¸Šä¼ å¤„ç† ---
    function handleCoverUpload(event) {
        if (curMusicIdx === -1) return;
        const file = event.target.files[0];
        if (!file) return;

        // ä½¿ç”¨ FileReader è¯»å–å›¾ç‰‡ï¼Œè½¬æ¢ä¸º Base64 æ ¼å¼å­˜å…¥æ•°æ®åº“
        const reader = new FileReader();
        reader.onload = function(e) {
            // å°†å›¾ç‰‡æ•°æ®ç»‘å®šåˆ°å½“å‰æ­£åœ¨æ’­æ”¾çš„è¿™é¦–æ­Œä¸Š
            musicLib[curMusicIdx].cover = e.target.result;
            
            saveAll().then(() => {
                renderMusicPlayer(); // åˆ·æ–° UIï¼Œç«‹å³æ˜¾ç¤ºæ–°å°é¢
            }).catch(err => {
                alert("å°é¢ä¿å­˜å¤±è´¥ï¼Œå›¾ç‰‡å¯èƒ½è¿‡å¤§ï¼");
            });
        };
        reader.readAsDataURL(file);
        
        event.target.value = ''; // æ¸…ç©º input æ–¹ä¾¿é‡å¤ä¸Šä¼ 
    }ã€€
    function handleLocalMusicUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // ğŸ¯ æ ¸å¿ƒåˆ¤æ–­ï¼šæ–‡ä»¶æ˜¯å¦è¶…è¿‡ 15MB
        const isOversize = file.size > 15 * 1024 * 1024;
        
        let newId = Date.now();
        let newMusic = {
            id: newId,
            title: file.name.replace(/\.[^/.]+$/, ""), 
            artist: isOversize ? "æœ¬åœ°è¯•å¬ (ä¸ä¿å­˜)" : "æœ¬åœ°ä¸Šä¼ ",
            blob: file 
        };
        
        musicLib.push(newMusic);
        
        // å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œç›´æ¥æ’­æ”¾ï¼Œä¸å¼ºè¡Œå­˜å…¥æ•°æ®åº“
        if (isOversize) {
            alert("æ–‡ä»¶è¾ƒå¤§ï¼Œå·²å¼€å¯ä¸´æ—¶æ’­æ”¾ï¼ˆåˆ·æ–°é¡µé¢åä¼šæ¶ˆå¤±å“¦ï¼‰ğŸµ");
            renderMusicLib();
            if(musicLib.length === 1) { curMusicIdx = 0; renderMusicPlayer(); }
            event.target.value = '';
            return;
        }

        saveAll().then(() => {
            alert("æ­Œæ›²ä¸Šä¼ å¹¶æ°¸ä¹…ä¿å­˜æˆåŠŸï¼");
            renderMusicLib();
            if(musicLib.length === 1) { curMusicIdx = 0; renderMusicPlayer(); }
        }).catch(e => {
            alert("æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè½¬ä¸ºä¸´æ—¶è¯•å¬ï¼ˆåˆ·æ–°åæ¶ˆå¤±ï¼‰ã€‚");
            renderMusicLib();
            if(musicLib.length === 1) { curMusicIdx = 0; renderMusicPlayer(); }
        });
        
        event.target.value = ''; 
    }

    function renderMusicLib() {
        $('music-count-badge').innerText = musicLib.length + ' é¦–';
        let list = $('music-lib-list');
        if (musicLib.length === 0) {
            list.innerHTML = `<div class="py-12 flex flex-col items-center justify-center text-zinc-400 opacity-60"><span class="text-4xl mb-2">ğŸ“¥</span><span class="text-sm">ç‚¹å‡»å³ä¸Šè§’ + ä¸Šä¼ æœ¬åœ°éŸ³ä¹</span></div>`;
            return;
        }
        list.innerHTML = musicLib.map((m, i) => {
            let isCur = (curMusicIdx === i);
            let titleColor = isCur ? "text-[#ff5a5f] font-bold" : "text-zinc-800";
            return `
            <div class="p-4 flex items-center justify-between active:bg-zinc-50 cursor-pointer group" onclick="playMusicIndex(${i}); toMusicTab('player')">
                <div class="flex items-center gap-4 min-w-0">
                    <span class="text-xs text-zinc-400 font-mono w-4">${i+1}</span>
                    <div class="flex flex-col min-w-0">
                        <span class="${titleColor} text-[15px] truncate">${m.title}</span>
                        <span class="text-[11px] text-zinc-400 mt-0.5 flex items-center gap-1"><span class="border border-red-500/30 text-red-500 text-[8px] px-1 rounded scale-90 origin-left">SQ</span> ${m.artist}</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    ${isCur && isPlaying ? `<span class="text-[#ff5a5f] text-xs">ğŸµ æ’­æ”¾ä¸­</span>` : ''}
                    <button onclick="event.stopPropagation(); deleteMusic(${m.id})" class="text-zinc-300 hover:text-red-500 px-2">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        }).join('');
    }

    function deleteMusic(id) {
        if(!confirm("ç¡®å®šä»è®¾å¤‡åˆ é™¤è¿™é¦–æ­Œå—ï¼Ÿ")) return;
        musicLib = musicLib.filter(m => m.id !== id);
        if (curMusicIdx >= musicLib.length) curMusicIdx = musicLib.length - 1;
        if (musicLib.length === 0) {
            curAudio.pause();
            isPlaying = false;
            curMusicIdx = -1;
            $('music-title').innerText = "æš‚æ— æ’­æ”¾";
        }
        saveAll();
        renderMusicLib();
    }
ã€€ã€€
    // ================== ç³»ç»Ÿå¯åŠ¨å…¥å£ ==================
    window.onload = async () => {
        try {
            console.log("System Launching...");
            await initDB();
            await loadAllData();

            // ğŸ‘‡ æ–°å¢ï¼šè‡ªåŠ¨ä¿®å¤æ—§æ•°æ®é€»è¾‘
            let needsSave = false;
            roles.forEach(role => {
                if (role.history) {
                    role.history.forEach(msg => {
                        // å¦‚æœè¿™æ¡æ¶ˆæ¯æ²¡æœ‰ scene æ ‡ç­¾ï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®
                        if (!msg.scene) {
                            // é€»è¾‘åˆ¤æ–­ï¼šå¦‚æœæ–‡å­—é‡ŒåŒ…å«æ˜Ÿå· * (åŠ¨ä½œæå†™) æˆ–è€…æ˜¯é•¿å¥å­ï¼Œå°±æŠŠå®ƒå½’ç±»åˆ°çº¿ä¸‹æ¨¡å¼
                            if (msg.t.includes('*') || msg.t.length > 40) {
                                msg.scene = 'story';
                            } else {
                                msg.scene = 'chat';
                            }
                            needsSave = true;
                        }
                    });
                }
            });
            if (needsSave) {
                await saveAll();
                console.log("æ—§æ•°æ®å·²è‡ªåŠ¨å®Œæˆåœºæ™¯åˆ†ç±»ä¿®å¤");
            }
            // ğŸ‘† ä¿®å¤é€»è¾‘ç»“æŸ
            let rIds = roles.map(r => r.id);
            if (chats.some(cid => !rIds.includes(cid))) { chats = chats.filter(cid => rIds.includes(cid)); await saveAll(); }
            await renderProfile();
            await loadSettings();
            tab('chat'); 
            console.log("AI OS Launched.");
        } catch (e) {
            console.error("Launch Error:", e); alert("ç³»ç»Ÿå¯åŠ¨å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚");
        }
    };
</script>

<div id="role-selector-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; flex-direction: column; justify-content: flex-end;" onclick="if(event.target===this) closeRoleSelector()">
    <div class="bg-white w-full rounded-t-2xl max-h-[75vh] flex flex-col animate-fade-in" onclick="event.stopPropagation()">
        <div class="p-4 border-b flex justify-between items-center shrink-0">
            <b class="text-lg">å‘èµ·èŠå¤©</b>
            <button onclick="closeRoleSelector()" class="w-8 h-8 bg-zinc-100 rounded-full text-zinc-500 font-bold active:scale-95">âœ•</button>
        </div>
        <div id="role-selector-list" class="flex-1 overflow-y-auto pb-10 no-scrollbar"></div>
    </div>
</div>
<div id="group-selector-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; flex-direction: column; justify-content: flex-end;" onclick="if(event.target===this) closeGroupSelector()">
    <div class="bg-white w-full rounded-t-2xl max-h-[80vh] flex flex-col animate-fade-in" onclick="event.stopPropagation()">
        <div class="p-4 border-b flex justify-between items-center shrink-0">
            <button onclick="closeGroupSelector()" class="text-zinc-500 font-bold w-12 text-left">å–æ¶ˆ</button>
            <b class="text-lg">å‘èµ·ç¾¤èŠ</b>
            <button onclick="confirmCreateGroup()" class="bg-[#07c160] text-white px-3 py-1.5 rounded text-sm font-bold w-16">å®Œæˆ(<span id="group-sel-count">0</span>)</button>
        </div>
        <div id="group-selector-list" class="flex-1 overflow-y-auto pb-10 no-scrollbar">
            </div>
    </div>
</div>
</body>
</html>
